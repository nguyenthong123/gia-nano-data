<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Quản Lý Sản Phẩm</title>
	<link rel="icon"
		href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgC6ibu0IT2Ihhik57NmlGYZgx57h3XvSk5dLipgo7cZTS0pEV7dmPGQZhwXAxTFqFH9l2C74l14MamphdzEWaRBZbeWSUsyIh2Wd-wKuPv274PMjrAgMtirxbfrK-eUcFp5Rx0cFL7uPMA93RBiWrnp5sghMDD78oBCEk3FA_QbZUY4eG3jTZK_nt65vM/s1600/logo12.png"
		type="image/png">
	<link
		href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Dancing+Script:wght@700&display=swap"
		rel="stylesheet">
	<style>
		:root {
			--primary: #FFD700;
			--primary-dark: #FFC000;
			--accent: #FDB931;
			--dark: #121212;
			--dark-card: #1e1e1e;
			--text-light: #ffffff;
			--text-gray: #a0a0a0;
			--success: #00c853;
			--danger: #ff3d00;
			--glass: rgba(255, 255, 255, 0.05);
			--glass-border: rgba(255, 255, 255, 0.1);
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Plus Jakarta Sans', sans-serif;
		}

		body {
			background-color: var(--dark);
			color: var(--text-light);
			min-height: 100vh;
			overflow-x: hidden;
		}

		/* Gradient backgrounds */
		.bg-gradient {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: radial-gradient(circle at 50% 50%, #1e1e1e 0%, #121212 100%);
			z-index: -1;
		}

		.bg-blob {
			position: fixed;
			width: 500px;
			height: 500px;
			background: var(--primary);
			filter: blur(150px);
			opacity: 0.05;
			z-index: -1;
			border-radius: 50%;
		}

		.blob-1 {
			top: -200px;
			right: -200px;
		}

		.blob-2 {
			bottom: -200px;
			left: -200px;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 40px 20px;
		}

		/* Header */
		header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 50px;
			animation: fadeInDown 0.8s ease-out;
		}

		.header-left h1 {
			font-size: 2.5rem;
			font-weight: 800;
			background: linear-gradient(to right, var(--primary), #fff);
			-webkit-background-clip: text;
			background-clip: text;
			-webkit-text-fill-color: transparent;
			letter-spacing: -1px;
		}

		.header-left p {
			color: var(--text-gray);
			font-size: 1rem;
			margin-top: 5px;
		}

		.header-right {
			display: flex;
			gap: 15px;
			align-items: center;
		}

		.user-chip {
			background: var(--glass);
			border: 1px solid var(--glass-border);
			padding: 8px 15px;
			border-radius: 30px;
			display: flex;
			align-items: center;
			gap: 10px;
			backdrop-filter: blur(10px);
		}

		.user-chip span {
			font-weight: 600;
			font-size: 0.9rem;
		}

		.user-chip .avatar {
			width: 30px;
			height: 30px;
			background: var(--primary);
			color: var(--dark);
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 800;
			font-size: 0.8rem;
		}

		/* Buttons */
		.btn {
			padding: 12px 24px;
			border-radius: 14px;
			font-weight: 700;
			cursor: pointer;
			transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			border: none;
			display: inline-flex;
			align-items: center;
			gap: 10px;
			text-decoration: none;
			font-size: 0.95rem;
		}

		.btn-primary {
			background: var(--primary);
			color: var(--dark);
		}

		.btn-primary:hover {
			transform: translateY(-3px) scale(1.02);
			box-shadow: 0 10px 20px rgba(255, 215, 0, 0.2);
			background: #fff;
		}

		.btn-glass {
			background: var(--glass);
			color: var(--text-light);
			border: 1px solid var(--glass-border);
			backdrop-filter: blur(10px);
		}

		.btn-glass:hover {
			background: rgba(255, 255, 255, 0.1);
			border-color: var(--primary);
		}

		/* Actions Bar */
		.actions-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
			gap: 20px;
			animation: fadeIn 1s ease-out 0.2s both;
		}

		.search-box {
			position: relative;
			flex: 1;
			max-width: 400px;
		}

		.search-box input {
			width: 100%;
			background: var(--glass);
			border: 1px solid var(--glass-border);
			padding: 14px 20px 14px 50px;
			border-radius: 16px;
			color: #fff;
			outline: none;
			transition: 0.3s;
			font-size: 1rem;
		}

		.search-box input:focus {
			border-color: var(--primary);
			background: rgba(255, 255, 255, 0.08);
			box-shadow: 0 0 20px rgba(255, 215, 0, 0.05);
		}

		.search-box svg {
			position: absolute;
			left: 20px;
			top: 50%;
			transform: translateY(-50%);
			color: var(--text-gray);
		}

		/* Product Grid */
		.product-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
			gap: 25px;
			animation: fadeInUp 0.8s ease-out 0.4s both;
		}

		.product-card {
			background: var(--dark-card);
			border: 1px solid var(--glass-border);
			border-radius: 24px;
			overflow: hidden;
			transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
			position: relative;
		}

		.product-card:hover {
			transform: translateY(-10px);
			border-color: var(--primary);
			box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
		}

		.product-img {
			width: 100%;
			height: 200px;
			background: #252525;
			position: relative;
			overflow: hidden;
		}

		.product-img img {
			width: 100%;
			height: 100%;
			object-fit: cover;
			transition: 0.5s;
		}

		.product-card:hover .product-img img {
			transform: scale(1.1);
		}

		.product-badge {
			position: absolute;
			top: 15px;
			right: 15px;
			background: rgba(0, 0, 0, 0.6);
			backdrop-filter: blur(5px);
			padding: 5px 12px;
			border-radius: 20px;
			font-size: 0.75rem;
			font-weight: 700;
			color: var(--primary);
			z-index: 2;
		}

		.product-info {
			padding: 20px;
		}

		.product-info h3 {
			font-size: 1.1rem;
			font-weight: 700;
			margin-bottom: 8px;
			color: #fff;
		}

		.product-info .category {
			font-size: 0.85rem;
			color: var(--text-gray);
			margin-bottom: 15px;
			display: block;
		}

		.product-footer {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding-top: 15px;
			border-top: 1px solid var(--glass-border);
		}

		.product-price {
			font-size: 1.2rem;
			font-weight: 800;
			color: var(--primary);
		}

		.product-actions {
			display: flex;
			gap: 8px;
		}

		.action-btn {
			width: 36px;
			height: 36px;
			border-radius: 10px;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: 0.3s;
			border: 1px solid var(--glass-border);
			background: var(--glass);
		}

		.btn-edit:hover {
			background: var(--primary);
			color: var(--dark);
			border-color: var(--primary);
		}

		.btn-delete:hover {
			background: var(--danger);
			color: white;
			border-color: var(--danger);
		}

		/* Empty State */
		.empty-state {
			grid-column: 1 / -1;
			padding: 100px 0;
			text-align: center;
			background: var(--glass);
			border: 2px dashed var(--glass-border);
			border-radius: 24px;
		}

		.empty-state svg {
			width: 80px;
			height: 80px;
			color: var(--glass-border);
			margin-bottom: 20px;
		}

		.empty-state h2 {
			font-size: 1.5rem;
			color: var(--text-gray);
			font-weight: 600;
		}

		/* Modal */
		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			backdrop-filter: blur(10px);
			align-items: center;
			justify-content: center;
			padding: 20px;
		}

		.modal.active {
			display: flex;
		}

		.modal-content {
			background: var(--dark-card);
			width: 100%;
			max-width: 600px;
			border-radius: 30px;
			border: 1px solid var(--glass-border);
			position: relative;
			padding: 40px;
			box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
			animation: modalZoom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
		}

		@keyframes modalZoom {
			from {
				opacity: 0;
				transform: scale(0.9) translateY(20px);
			}

			to {
				opacity: 1;
				transform: scale(1) translateY(0);
			}
		}

		.modal-header {
			margin-bottom: 30px;
		}

		.modal-header h2 {
			font-size: 1.8rem;
			font-weight: 800;
		}

		.close-modal {
			position: absolute;
			top: 25px;
			right: 25px;
			width: 40px;
			height: 40px;
			background: var(--glass);
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: 0.3s;
		}

		.close-modal:hover {
			background: var(--danger);
			transform: rotate(90deg);
		}

		/* Form */
		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			font-size: 0.85rem;
			font-weight: 700;
			color: var(--text-gray);
			margin-bottom: 10px;
			text-transform: uppercase;
			letter-spacing: 1px;
		}

		.form-input,
		.form-select {
			width: 100%;
			background: var(--glass);
			border: 1px solid var(--glass-border);
			padding: 14px 20px;
			border-radius: 14px;
			color: #fff;
			outline: none;
			font-size: 1rem;
			transition: 0.3s;
		}

		.form-input:focus,
		.form-select:focus {
			border-color: var(--primary);
			background: rgba(255, 255, 255, 0.08);
		}

		.form-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
		}

		/* Image Upload */
		.image-upload-wrapper {
			position: relative;
			width: 100%;
			height: 180px;
			border: 2px dashed var(--glass-border);
			border-radius: 20px;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: 0.3s;
			overflow: hidden;
			background: var(--glass);
		}

		.image-upload-wrapper:hover {
			border-color: var(--primary);
			background: rgba(255, 215, 0, 0.05);
		}

		.image-preview {
			width: 100%;
			height: 100%;
			object-fit: contain;
			display: none;
		}

		.upload-placeholder {
			text-align: center;
			color: var(--text-gray);
		}

		.upload-placeholder svg {
			width: 40px;
			height: 40px;
			margin-bottom: 10px;
		}

		#fileInput {
			display: none;
		}

		/* Loader */
		.loader-overlay {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			backdrop-filter: blur(10px);
			z-index: 2000;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}

		.spinner {
			width: 50px;
			height: 50px;
			border: 4px solid var(--glass-border);
			border-top: 4px solid var(--primary);
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		/* Animations */
		@keyframes fadeInDown {
			from {
				opacity: 0;
				transform: translateY(-30px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		@keyframes fadeInUp {
			from {
				opacity: 0;
				transform: translateY(30px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
			}

			to {
				opacity: 1;
			}
		}

		/* Floating menu adjustments */
		.floating-menu {
			position: fixed;
			bottom: 40px;
			left: 40px;
			z-index: 1000;
		}

		.fab-btn {
			width: 65px;
			height: 65px;
			background: var(--primary);
			border-radius: 50%;
			box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			border: none;
		}

		.fab-btn:hover {
			transform: scale(1.1) rotate(90deg);
			background: #fff;
		}

		.fab-btn svg {
			width: 30px;
			height: 30px;
			color: var(--dark);
		}

		.fab-menu-list {
			position: absolute;
			bottom: 85px;
			left: 0;
			background: var(--dark-card);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			width: 260px;
			padding: 10px;
			display: none;
			backdrop-filter: blur(20px);
			box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
			animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
		}

		.fab-menu-list.active {
			display: block;
		}

		.menu-item {
			display: flex;
			align-items: center;
			gap: 15px;
			padding: 15px 20px;
			color: var(--text-light);
			text-decoration: none;
			border-radius: 12px;
			transition: 0.3s;
			font-weight: 600;
		}

		.menu-item:hover {
			background: var(--glass);
			color: var(--primary);
		}

		.menu-item svg {
			width: 22px;
			height: 22px;
		}

		.menu-item span {
			font-size: 0.95rem;
		}

		@keyframes slideUp {
			from {
				opacity: 0;
				transform: translateY(30px) scale(0.9);
			}

			to {
				opacity: 1;
				transform: translateY(0) scale(1);
			}
		}

		/* Mobile Adjustments */
		@media (max-width: 768px) {
			header {
				flex-direction: column;
				align-items: flex-start;
				gap: 20px;
			}

			.header-left h1 {
				font-size: 2rem;
			}

			.actions-bar {
				flex-direction: column;
				align-items: stretch;
			}

			.form-grid {
				grid-template-columns: 1fr;
			}

			.modal-content {
				padding: 30px 20px;
			}
		}
	</style>
</head>

<body>
	<div class="bg-gradient"></div>
	<div class="bg-blob blob-1"></div>
	<div class="bg-blob blob-2"></div>

	<div id="loader" class="loader-overlay">
		<div class="spinner"></div>
		<p style="margin-top: 20px; font-weight: 700;">Đang xử lý dữ liệu...</p>
	</div>

	<div class="container">
		<header>
			<div class="header-left">
				<h1>Hệ Thống Quản Lý Sản Phẩm</h1>
				<p>Dành riêng cho Doanh nghiệp: Chuyên nghiệp - Hiệu quả</p>
			</div>
			<div class="header-right">
				<div class="user-chip" id="userChip" style="display: none;">
					<div class="avatar" id="userAvatar">U</div>
					<span id="userName">User</span>
				</div>
				<a href="index.html" class="btn btn-glass">Trang chủ</a>
				<button class="btn btn-primary" onclick="logout()">
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
						stroke-linecap="round" stroke-linejoin="round">
						<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
						<polyline points="16 17 21 12 16 7"></polyline>
						<line x1="21" y1="12" x2="9" y2="12"></line>
					</svg>
					Đăng xuất
				</button>
			</div>
		</header>

		<!-- Content -->
		<div id="products" class="tab-content active">
			<div class="actions-bar">
				<div class="search-box">
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
						stroke-linecap="round" stroke-linejoin="round">
						<circle cx="11" cy="11" r="8"></circle>
						<line x1="21" y1="21" x2="16.65" y2="16.65"></line>
					</svg>
					<input type="text" placeholder="Tìm kiếm sản phẩm..." oninput="filterProducts(this.value)">
				</div>
				<button class="btn btn-primary" onclick="openModal('create')">
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
						stroke-linecap="round" stroke-linejoin="round">
						<line x1="12" y1="5" x2="12" y2="19"></line>
						<line x1="5" y1="12" x2="19" y2="12"></line>
					</svg>
					Thêm sản phẩm mới
				</button>
			</div>

			<div class="product-grid" id="productGrid">
				<!-- JS will render products here -->
			</div>
		</div>

	</div>

	<!-- Floating Action Menu -->
	<div class="floating-menu">
		<div class="fab-menu-list" id="fabMenu">
			<a href="len-don.html" class="menu-item" style="color: var(--primary);">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M12 5v14M5 12h14" />
				</svg>
				<span>Lên đơn hàng mới</span>
			</a>
			<a href="quan-ly-don-khach.html" class="menu-item">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
					<line x1="3" y1="10" x2="21" y2="10" />
					<line x1="9" y1="21" x2="9" y2="10" />
					<line x1="15" y1="21" x2="15" y2="10" />
				</svg>
				<span>Danh sách đơn hàng</span>
			</a>
			<a href="san-pham-khach.html" class="menu-item active">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<rect x="3" y="3" width="7" height="7" />
					<rect x="14" y="3" width="7" height="7" />
					<rect x="14" y="14" width="7" height="7" />
					<rect x="3" y="14" width="7" height="7" />
				</svg>
				<span>Quản lý sản phẩm</span>
			</a>
			<a href="quan-ly-don-khach.html?tab=customers" class="menu-item">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
					<circle cx="9" cy="7" r="4" />
					<path d="M23 21v-2a4 4 0 0 0-3-3.87" />
					<path d="M16 3.13a4 4 0 0 1 0 7.75" />
				</svg>
				<span>Danh sách khách hàng</span>
			</a>
		</div>
		<button class="fab-btn" onclick="toggleFabMenu(event)">
			<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
				<line x1="3" y1="12" x2="21" y2="12" />
				<line x1="3" y1="6" x2="21" y2="6" />
				<line x1="3" y1="18" x2="21" y2="18" />
			</svg>
		</button>
	</div>

	<!-- Confirm Modal -->
	<div id="confirmModal" class="modal">
		<div class="modal-content" style="max-width: 400px; text-align: center;">
			<div style="margin-bottom: 20px;">
				<div
					style="width: 60px; height: 60px; background: rgba(255, 61, 0, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
					<svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2">
						<path
							d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
						</path>
						<line x1="12" y1="9" x2="12" y2="13"></line>
						<line x1="12" y1="17" x2="12.01" y2="17"></line>
					</svg>
				</div>
				<h2 id="confirmTitle" style="font-size: 1.5rem; margin-bottom: 10px;">Xác nhận xóa</h2>
				<p id="confirmMessage" style="color: var(--text-gray); font-size: 0.95rem; line-height: 1.6;">Bạn có
					chắc chắn muốn xóa sản phẩm này không? Hành động này không thể hoàn tác.</p>
			</div>
			<div style="display: flex; gap: 15px;">
				<button class="btn btn-glass" style="flex: 1; justify-content: center;"
					onclick="closeConfirmModal()">HỦY</button>
				<button id="confirmExecuteBtn" class="btn btn-primary"
					style="flex: 1; justify-content: center; background: var(--danger); color: white;">XÓA NGAY</button>
			</div>
		</div>
	</div>

	<!-- Product Modal -->
	<div id="productModal" class="modal">
		<div class="modal-content">
			<div class="close-modal" onclick="closeModal()">
				<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
					stroke-linecap="round" stroke-linejoin="round">
					<line x1="18" y1="6" x2="6" y2="18"></line>
					<line x1="6" y1="6" x2="18" y2="18"></line>
				</svg>
			</div>
			<div class="modal-header">
				<h2 id="modalTitle">Thêm Sản Phẩm</h2>
				<p style="color: var(--text-gray);">Điền thông tin sản phẩm của bạn vào bên dưới</p>
			</div>
			<form id="productForm">
				<input type="hidden" id="editId">
				<div class="form-group">
					<label>Hình ảnh sản phẩm</label>
					<div class="image-upload-wrapper" onclick="document.getElementById('fileInput').click()">
						<div class="upload-placeholder" id="uploadPlaceholder">
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
								stroke-linecap="round" stroke-linejoin="round">
								<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
								<circle cx="8.5" cy="8.5" r="1.5"></circle>
								<polyline points="21 15 16 10 5 21"></polyline>
							</svg>
							<p>Nhấn để tải hình lên</p>
							<span style="font-size: 0.7rem; opacity: 0.6;">JPG, PNG hoặc WebP</span>
						</div>
						<img id="imagePreview" class="image-preview" src="">
					</div>
					<input type="file" id="fileInput" accept="image/*" onchange="previewImage(event)">
				</div>

				<div class="form-group">
					<label>Tên sản phẩm</label>
					<input type="text" id="productName" class="form-input" placeholder="Ví dụ: Tấm ốp Nano 400x9mm..."
						required>
				</div>

				<div class="form-grid">
					<div class="form-group">
						<label>Ngành hàng</label>
						<input type="text" id="productCategory" class="form-input" list="categoryList"
							placeholder="Chọn hoặc nhập mới..." required>
						<datalist id="categoryList">
							<option value="Tấm Pima">
							<option value="Duraflex">
							<option value="Weber">
							<option value="Phụ Kiện">
						</datalist>
					</div>
					<div class="form-group">
						<label>Giá bán (VNĐ)</label>
						<input type="text" id="productPrice" class="form-input" placeholder="0"
							oninput="formatPriceInput(this)" required>
					</div>
				</div>

				<div style="margin-top: 20px;">
					<button type="submit" class="btn btn-primary"
						style="width: 100%; justify-content: center; padding: 16px;">
						<span id="submitBtnText">LƯU SẢN PHẨM</span>
					</button>
				</div>
			</form>
		</div>
	</div>

	<script>
		// --- CONFIG ---
		const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzM8tzbdJJvXE0r6NcP8cJGO2RHsgYUR6Jy73U4NDLkSQRjT3fus_i4lugwVQZIKI8zhw/exec';
		const PLACEHOLDER_IMG = "data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22400%22%20height%3D%22300%22%20viewBox%3D%220%200%20400%20300%22%3E%3Crect%20width%3D%22400%22%20height%3D%22300%22%20fill%3D%22%232c2c2c%22%2F%3E%3Ctext%20x%3D%2250%25%22%20y%3D%2250%25%22%20dominant-baseline%3D%22middle%22%20text-anchor%3D%22middle%22%20font-family%3D%22sans-serif%22%20font-size%3D%2220%22%20fill%3D%22%23555%22%3ENo%20Image%3C%2Ftext%3E%3C%2Fsvg%3E";

		let currentProducts = [];
		let userData = null;
		let isUploading = false;

		// --- HELPERS ---
		function handleImgError(img) {
			img.onerror = null;
			img.src = PLACEHOLDER_IMG;
		}

		function updateLoader(msg) {
			const loader = document.getElementById('loader');
			if (loader) {
				loader.style.display = 'flex';
				const p = loader.querySelector('p');
				if (p) p.innerText = msg;
			}
		}

		function hideLoader() {
			const loader = document.getElementById('loader');
			if (loader) {
				setTimeout(() => {
					loader.style.display = 'none';
				}, 500);
			}
		}

		document.addEventListener('DOMContentLoaded', () => {
			// Check Auth
			const userStr = localStorage.getItem('userLoggedIn');
			if (!userStr) {
				window.location.href = 'index.html';
				return;
			}
			userData = JSON.parse(userStr);

			// Update Header User Info
			document.getElementById('userChip').style.display = 'flex';
			document.getElementById('userName').innerText = userData.name || userData.email;
			document.getElementById('userAvatar').innerText = (userData.name || 'U').charAt(0).toUpperCase();

			loadProducts();
		});

		function logout() {
			localStorage.removeItem('userLoggedIn');
			window.location.href = 'index.html';
		}

		// --- CORE FUNCTIONS ---

		function toggleFabMenu(e) {
			e.stopPropagation();
			document.getElementById('fabMenu').classList.toggle('active');
		}

		// Close menu when clicking outside
		document.addEventListener('click', () => {
			document.getElementById('fabMenu').classList.remove('active');
		});

		async function loadProducts() {
			const grid = document.getElementById('productGrid');
			try {
				if (SCRIPT_URL.includes('AKfycbxoK')) {
					grid.innerHTML = `<div class="empty-state"><h2>Chưa cấu hình Script kết nối Sheet</h2></div>`;
					return;
				}

				// Fetch JSON data first (optional fallback/speed)
				let jsonData = [];
				try {
					const jsonRes = await fetch('data/data_san_pham_kh.json');
					if (jsonRes.ok) {
						jsonData = await jsonRes.json();
						// Normalize JSON if needed
						jsonData = jsonData.map(item => {
							// Assuming JSON structure matches what we expect or normalizing key access later
							// But let's verify if filtering by user is needed. 
							// The original logic filtered by email in JSON too.
							return item;
						}).filter(item => {
							const email = item.tendangnhap || item.ten_dang_nhap;
							return email === userData.email;
						});
					}
				} catch (e) { console.warn("JSON load skip", e); }

				// Fetch Sheet data
				const url = `${SCRIPT_URL}?action=read&username=${encodeURIComponent(userData.email)}&t=${new Date().getTime()}`;
				const response = await fetch(url);
				const result = await response.json();

				if (result.success && result.data) {
					// Merge logic: prefer sheet data
					// Sheet data already normalized by GAS return
					const sheetData = result.data; // Array of objects

					// If needed, merge with JSON (if JSON has items not in Sheet). 
					// However, for strict management, we might just rely on Sheet now.
					// Let's stick to Sheet data primarily as user wanted "nóng" (hot/live) data.
					currentProducts = sheetData;
					renderProducts(currentProducts);
					updateCategoryDatalist(currentProducts);
				} else {
					grid.innerHTML = `<div class="empty-state"><h2>Lỗi: ${result.message}</h2></div>`;
				}
			} catch (err) {
				console.error("Load failed", err);
				grid.innerHTML = `<div class="empty-state"><h2>Không thể kết nối với hệ thống</h2></div>`;
			}
		}

		function renderProducts(products) {
			const grid = document.getElementById('productGrid');
			if (products.length === 0) {
				grid.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg>
                        <h2>Bạn chưa có sản phẩm nào</h2>
                        <p style="color: var(--text-gray); margin-top: 10px;">Nhấn nút "Thêm sản phẩm mới" để bắt đầu.</p>
                    </div>
                `;
				return;
			}

			grid.innerHTML = products.map(p => {
				let imgUrl = (p.image_san_pham || p.imagesanpham || '').trim();
				if (!imgUrl) imgUrl = PLACEHOLDER_IMG;

				const name = p.ten_san_pham || p.tensanpham || 'Sản phẩm chưa đặt tên';
				const category = p.ten_nghanh_hang || p.tennganhhang || 'Chưa phân loại';
				const price = parseFloat(p.gia_san_pham || p.giasanpham) || 0;
				const id = p.id_san_pham || p.idsanpham;

				return `
                <div class="product-card">
                    <div class="product-badge">${category}</div>
                    <div class="product-img">
                        <img src="${imgUrl}" alt="${name}" onerror="handleImgError(this)">
                    </div>
                    <div class="product-info">
                        <h3>${name}</h3>
                        <span class="category">Mã SP: ${id}</span>
                        <div class="product-footer">
                            <span class="product-price">${formatCurrency(price)}</span>
                            <div class="product-actions">
                                <div class="action-btn btn-edit" onclick="openModal('edit', '${id}')" title="Chỉnh sửa">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                </div>
                                <div class="action-btn btn-delete" onclick="deleteProduct('${id}')" title="Xóa">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
		}

		function filterProducts(query) {
			const q = query.toLowerCase();
			const filtered = currentProducts.filter(p => {
				const name = (p.ten_san_pham || p.tensanpham || '').toLowerCase();
				const cat = (p.ten_nghanh_hang || p.tennganhhang || '').toLowerCase();
				return name.includes(q) || cat.includes(q);
			});
			renderProducts(filtered);
		}

		function updateCategoryDatalist(products) {
			const cats = new Set(products.map(p => p.ten_nghanh_hang || p.tennganhhang).filter(Boolean));
			const datalist = document.getElementById('categoryList');
			datalist.innerHTML = Array.from(cats).map(c => `<option value="${c}">`).join('');
		}

		// --- MODAL & FORM ---

		function openModal(mode, id = null) {
			const modal = document.getElementById('productModal');
			const title = document.getElementById('modalTitle');
			const btnText = document.getElementById('submitBtnText');
			const form = document.getElementById('productForm');

			// Reset form
			form.reset();
			document.getElementById('imagePreview').style.display = 'none';
			document.getElementById('uploadPlaceholder').style.display = 'block';

			if (mode === 'edit') {
				title.innerText = "Chỉnh Sửa Sản Phẩm";
				btnText.innerText = "CẬP NHẬT SẢN PHẨM";
				document.getElementById('editId').value = id;

				const product = currentProducts.find(p => (p.id_san_pham || p.idsanpham) === id);
				if (product) {
					document.getElementById('productName').value = product.ten_san_pham || product.tensanpham;
					document.getElementById('productCategory').value = product.ten_nghanh_hang || product.tennganhhang;
					formatPriceInput(document.getElementById('productPrice')); // Helper call might fail if clean value needed
					document.getElementById('productPrice').value = formatCurrencyNoSymbol(product.gia_san_pham || product.giasanpham);

					const imgUrl = product.image_san_pham || product.imagesanpham;
					if (imgUrl) {
						document.getElementById('imagePreview').src = imgUrl;
						document.getElementById('imagePreview').style.display = 'block';
						document.getElementById('uploadPlaceholder').style.display = 'none';
					}
				}
			} else {
				title.innerText = "Thêm Sản Phẩm Mới";
				btnText.innerText = "LƯU SẢN PHẨM";
				document.getElementById('editId').value = '';
			}

			modal.classList.add('active');
		}

		function closeModal() {
			document.getElementById('productModal').classList.remove('active');
		}

		function previewImage(event) {
			const file = event.target.files[0];
			if (file) {
				const reader = new FileReader();
				reader.onload = function (e) {
					document.getElementById('imagePreview').src = e.target.result;
					document.getElementById('imagePreview').style.display = 'block';
					document.getElementById('uploadPlaceholder').style.display = 'none';
				}
				reader.readAsDataURL(file);
			}
		}

		// Form Submission
		document.getElementById('productForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			const editId = document.getElementById('editId').value;
			const fileInput = document.getElementById('fileInput');
			const file = fileInput.files[0];

			updateLoader('Đang xử lý dữ liệu...');

			try {
				let imageUrl = '';

				// Keep old image if editing and no new file
				if (editId && !file) {
					const p = currentProducts.find(x => (x.id_san_pham || x.idsanpham) === editId);
					imageUrl = p ? (p.image_san_pham || p.imagesanpham) : '';
				}

				// Upload file if new file selected
				if (file) {
					if (file.size > 5 * 1024 * 1024) throw new Error("File ảnh quá lớn (>5MB)");

					updateLoader('Đang tải ảnh lên máy chủ...');
					const base64 = await toBase64(file);
					// Extract base64 pure string
					const cleanBase64 = base64.split(',')[1];

					const uploadPayload = {
						action: 'upload',
						file: cleanBase64,
						filename: file.name,
						mimeType: file.type
					};

					const fd = new URLSearchParams();
					fd.append('payload', JSON.stringify(uploadPayload));

					const uploadRes = await fetch(SCRIPT_URL, {
						method: 'POST',
						body: fd
					});

					const uploadData = await uploadRes.json();
					if (uploadData.success) {
						imageUrl = uploadData.url;
					} else {
						throw new Error('Lỗi tải ảnh: ' + uploadData.message);
					}
				}

				updateLoader('Đang lưu thông tin sản phẩm...');

				const pData = {
					ten_san_pham: document.getElementById('productName').value,
					ten_nghanh_hang: document.getElementById('productCategory').value,
					gia_san_pham: parsePrice(document.getElementById('productPrice').value),
					image_san_pham: imageUrl,
					ten_dang_nhap: userData.email,
					trang_thai_xoa_sp: 'ACTIVE'
				};
				if (editId) pData.id_san_pham = editId;

				const payload = {
					action: editId ? 'update' : 'create',
					idValue: editId,
					data: pData
				};

				const fdProduct = new URLSearchParams();
				fdProduct.append('payload', JSON.stringify(payload));

				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: fdProduct
				});

				const result = await response.json();
				if (result.success) {
					closeModal();
					await loadProducts();
					// Removed alert per user request
				} else {
					alert("Lỗi từ server: " + result.message);
				}
			} catch (err) {
				console.error('Error detail:', err);
				alert("Lỗi: " + err.message);
			} finally {
				hideLoader();
			}
		});

		async function deleteProduct(id) {
			if (!id) return;
			const p = currentProducts.find(x => (x.id_san_pham || x.idsanpham) === id);

			// Show custom confirm modal
			const modal = document.getElementById('confirmModal');
			document.getElementById('confirmMessage').innerText = `Bạn có chắc chắn muốn xóa sản phẩm "${p ? (p.ten_san_pham || p.tensanpham) : 'này'}"?`;
			document.getElementById('confirmExecuteBtn').onclick = async () => {
				closeConfirmModal();
				await executeDelete(id);
			};
			modal.classList.add('active');
		}

		function closeConfirmModal() {
			document.getElementById('confirmModal').classList.remove('active');
		}

		async function executeDelete(id) {
			updateLoader('Đang xóa sản phẩm...');
			try {
				const fdDelete = new URLSearchParams();
				fdDelete.append('payload', JSON.stringify({
					action: 'delete',
					idValue: id
				}));

				const res = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: fdDelete
				});
				const result = await res.json();
				if (result.success) {
					await loadProducts();
					// Removed alert per user request (previously "Optional alert or toast")
				} else {
					alert("Lỗi xóa: " + result.message);
				}
			} catch (e) {
				alert("Lỗi kết nối: " + e.message);
			} finally {
				hideLoader();
			}
		}

		// --- UTILS ---
		function formatCurrency(val) {
			if (!val) return '0 đ';
			return new Intl.NumberFormat('vi-VN').format(val) + ' đ';
		}

		function formatCurrencyNoSymbol(val) {
			if (!val) return '0';
			return new Intl.NumberFormat('vi-VN').format(val);
		}

		function parsePrice(str) {
			if (!str) return 0;
			return parseFloat(String(str).replace(/[^\d]/g, '')) || 0;
		}

		function formatPriceInput(input) {
			let value = input.value.replace(/\D/g, '');
			if (value) {
				input.value = new Intl.NumberFormat('vi-VN').format(value);
			}
		}

		function toBase64(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = () => resolve(reader.result);
				reader.onerror = error => reject(error);
			});
		}
	</script>
</body>

</html>