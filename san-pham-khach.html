<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Quản Lý Sản Phẩm - Khách Hàng</title>
	<link rel="icon"
		href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgC6ibu0IT2Ihhik57NmlGYZgx57h3XvSk5dLipgo7cZTS0pEV7dmPGQZhwXAxTFqFH9l2C74l14MamphdzEWaRBZbeWSUsyIh2Wd-wKuPv274PMjrAgMtirxbfrK-eUcFp5Rx0cFL7uPMA93RBiWrnp5sghMDD78oBCEk3FA_QbZUY4eG3jTZK_nt65vM/s1600/logo12.png"
		type="image/png">
	<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
		rel="stylesheet">
	<style>
		:root {
			--primary: #FFD700;
			--primary-dark: #FFC000;
			--accent: #FDB931;
			--dark: #121212;
			--dark-card: #1e1e1e;
			--text-light: #ffffff;
			--text-gray: #a0a0a0;
			--success: #00c853;
			--danger: #ff3d00;
			--glass: rgba(255, 255, 255, 0.05);
			--glass-border: rgba(255, 255, 255, 0.1);
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Plus Jakarta Sans', sans-serif;
		}

		body {
			background-color: var(--dark);
			color: var(--text-light);
			min-height: 100vh;
			overflow-x: hidden;
		}

		/* Gradient backgrounds */
		.bg-gradient {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: radial-gradient(circle at 50% 50%, #1e1e1e 0%, #121212 100%);
			z-index: -1;
		}

		.bg-blob {
			position: fixed;
			width: 500px;
			height: 500px;
			background: var(--primary);
			filter: blur(150px);
			opacity: 0.05;
			z-index: -1;
			border-radius: 50%;
		}

		.blob-1 {
			top: -200px;
			right: -200px;
		}

		.blob-2 {
			bottom: -200px;
			left: -200px;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 40px 20px;
		}

		/* Header */
		header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 50px;
			animation: fadeInDown 0.8s ease-out;
		}

		.header-left h1 {
			font-size: 2.5rem;
			font-weight: 800;
			background: linear-gradient(to right, var(--primary), #fff);
			-webkit-background-clip: text;
			background-clip: text;
			-webkit-text-fill-color: transparent;
			letter-spacing: -1px;
		}

		.header-left p {
			color: var(--text-gray);
			font-size: 1rem;
			margin-top: 5px;
		}

		.header-right {
			display: flex;
			gap: 15px;
			align-items: center;
		}

		.user-chip {
			background: var(--glass);
			border: 1px solid var(--glass-border);
			padding: 8px 15px;
			border-radius: 30px;
			display: flex;
			align-items: center;
			gap: 10px;
			backdrop-filter: blur(10px);
		}

		.user-chip span {
			font-weight: 600;
			font-size: 0.9rem;
		}

		.user-chip .avatar {
			width: 30px;
			height: 30px;
			background: var(--primary);
			color: var(--dark);
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 800;
			font-size: 0.8rem;
		}

		/* Buttons */
		.btn {
			padding: 12px 24px;
			border-radius: 14px;
			font-weight: 700;
			cursor: pointer;
			transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			border: none;
			display: inline-flex;
			align-items: center;
			gap: 10px;
			text-decoration: none;
			font-size: 0.95rem;
		}

		.btn-primary {
			background: var(--primary);
			color: var(--dark);
		}

		.btn-primary:hover {
			transform: translateY(-3px) scale(1.02);
			box-shadow: 0 10px 20px rgba(255, 215, 0, 0.2);
			background: #fff;
		}

		.btn-glass {
			background: var(--glass);
			color: var(--text-light);
			border: 1px solid var(--glass-border);
			backdrop-filter: blur(10px);
		}

		.btn-glass:hover {
			background: rgba(255, 255, 255, 0.1);
			border-color: var(--primary);
		}

		/* Actions Bar */
		.actions-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
			gap: 20px;
			animation: fadeIn 1s ease-out 0.2s both;
		}

		.search-box {
			position: relative;
			flex: 1;
			max-width: 400px;
		}

		.search-box input {
			width: 100%;
			background: var(--glass);
			border: 1px solid var(--glass-border);
			padding: 14px 20px 14px 50px;
			border-radius: 16px;
			color: #fff;
			outline: none;
			transition: 0.3s;
			font-size: 1rem;
		}

		.search-box input:focus {
			border-color: var(--primary);
			background: rgba(255, 255, 255, 0.08);
			box-shadow: 0 0 20px rgba(255, 215, 0, 0.05);
		}

		.search-box svg {
			position: absolute;
			left: 20px;
			top: 50%;
			transform: translateY(-50%);
			color: var(--text-gray);
		}

		/* Product Grid */
		.product-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
			gap: 25px;
			animation: fadeInUp 0.8s ease-out 0.4s both;
		}

		.product-card {
			background: var(--dark-card);
			border: 1px solid var(--glass-border);
			border-radius: 24px;
			overflow: hidden;
			transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
			position: relative;
		}

		.product-card:hover {
			transform: translateY(-10px);
			border-color: var(--primary);
			box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
		}

		.product-img {
			width: 100%;
			height: 200px;
			background: #252525;
			position: relative;
			overflow: hidden;
		}

		.product-img img {
			width: 100%;
			height: 100%;
			object-fit: cover;
			transition: 0.5s;
		}

		.product-card:hover .product-img img {
			transform: scale(1.1);
		}

		.product-badge {
			position: absolute;
			top: 15px;
			right: 15px;
			background: rgba(0, 0, 0, 0.6);
			backdrop-filter: blur(5px);
			padding: 5px 12px;
			border-radius: 20px;
			font-size: 0.75rem;
			font-weight: 700;
			color: var(--primary);
			z-index: 2;
		}

		.product-info {
			padding: 20px;
		}

		.product-info h3 {
			font-size: 1.1rem;
			font-weight: 700;
			margin-bottom: 8px;
			color: #fff;
		}

		.product-info .category {
			font-size: 0.85rem;
			color: var(--text-gray);
			margin-bottom: 15px;
			display: block;
		}

		.product-footer {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding-top: 15px;
			border-top: 1px solid var(--glass-border);
		}

		.product-price {
			font-size: 1.2rem;
			font-weight: 800;
			color: var(--primary);
		}

		.product-actions {
			display: flex;
			gap: 8px;
		}

		.action-btn {
			width: 36px;
			height: 36px;
			border-radius: 10px;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: 0.3s;
			border: 1px solid var(--glass-border);
			background: var(--glass);
		}

		.btn-edit:hover {
			background: var(--primary);
			color: var(--dark);
			border-color: var(--primary);
		}

		.btn-delete:hover {
			background: var(--danger);
			color: white;
			border-color: var(--danger);
		}

		/* Empty State */
		.empty-state {
			grid-column: 1 / -1;
			padding: 100px 0;
			text-align: center;
			background: var(--glass);
			border: 2px dashed var(--glass-border);
			border-radius: 24px;
		}

		.empty-state svg {
			width: 80px;
			height: 80px;
			color: var(--glass-border);
			margin-bottom: 20px;
		}

		.empty-state h2 {
			font-size: 1.5rem;
			color: var(--text-gray);
			font-weight: 600;
		}

		/* Modal */
		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			backdrop-filter: blur(10px);
			align-items: center;
			justify-content: center;
			padding: 20px;
		}

		.modal.active {
			display: flex;
		}

		.modal-content {
			background: var(--dark-card);
			width: 100%;
			max-width: 600px;
			border-radius: 30px;
			border: 1px solid var(--glass-border);
			position: relative;
			padding: 40px;
			box-shadow: 0 30px 60px rgba(0, 0, 0, 0.5);
			animation: modalZoom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
		}

		@keyframes modalZoom {
			from {
				opacity: 0;
				transform: scale(0.9) translateY(20px);
			}

			to {
				opacity: 1;
				transform: scale(1) translateY(0);
			}
		}

		.modal-header {
			margin-bottom: 30px;
		}

		.modal-header h2 {
			font-size: 1.8rem;
			font-weight: 800;
		}

		.close-modal {
			position: absolute;
			top: 25px;
			right: 25px;
			width: 40px;
			height: 40px;
			background: var(--glass);
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: 0.3s;
		}

		.close-modal:hover {
			background: var(--danger);
			transform: rotate(90deg);
		}

		/* Form */
		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			font-size: 0.85rem;
			font-weight: 700;
			color: var(--text-gray);
			margin-bottom: 10px;
			text-transform: uppercase;
			letter-spacing: 1px;
		}

		.form-input,
		.form-select {
			width: 100%;
			background: var(--glass);
			border: 1px solid var(--glass-border);
			padding: 14px 20px;
			border-radius: 14px;
			color: #fff;
			outline: none;
			font-size: 1rem;
			transition: 0.3s;
		}

		.form-input:focus,
		.form-select:focus {
			border-color: var(--primary);
			background: rgba(255, 255, 255, 0.08);
		}

		.form-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
		}

		/* Image Upload */
		.image-upload-wrapper {
			position: relative;
			width: 100%;
			height: 180px;
			border: 2px dashed var(--glass-border);
			border-radius: 20px;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: 0.3s;
			overflow: hidden;
			background: var(--glass);
		}

		.image-upload-wrapper:hover {
			border-color: var(--primary);
			background: rgba(255, 215, 0, 0.05);
		}

		.image-preview {
			width: 100%;
			height: 100%;
			object-fit: contain;
			display: none;
		}

		.upload-placeholder {
			text-align: center;
			color: var(--text-gray);
		}

		.upload-placeholder svg {
			width: 40px;
			height: 40px;
			margin-bottom: 10px;
		}

		#fileInput {
			display: none;
		}

		/* Loader */
		.loader-overlay {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			backdrop-filter: blur(10px);
			z-index: 2000;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}

		.spinner {
			width: 50px;
			height: 50px;
			border: 4px solid var(--glass-border);
			border-top: 4px solid var(--primary);
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		/* Animations */
		@keyframes fadeInDown {
			from {
				opacity: 0;
				transform: translateY(-30px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		@keyframes fadeInUp {
			from {
				opacity: 0;
				transform: translateY(30px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
			}

			to {
				opacity: 1;
			}
		}

		/* Mobile Adjustments */
		@media (max-width: 768px) {
			header {
				flex-direction: column;
				align-items: flex-start;
				gap: 20px;
			}

			.header-left h1 {
				font-size: 2rem;
			}

			.actions-bar {
				flex-direction: column;
				align-items: stretch;
			}

			.form-grid {
				grid-template-columns: 1fr;
			}

			.modal-content {
				padding: 30px 20px;
			}
		}
	</style>
</head>

<body>
	<div class="bg-gradient"></div>
	<div class="bg-blob blob-1"></div>
	<div class="bg-blob blob-2"></div>

	<div id="loader" class="loader-overlay">
		<div class="spinner"></div>
		<p style="margin-top: 20px; font-weight: 700;">Đang xử lý dữ liệu...</p>
	</div>

	<div class="container">
		<header>
			<div class="header-left">
				<h1>Kho Sản Phẩm Của Tôi</h1>
				<p>Quản lý danh mục sản phẩm cá nhân</p>
			</div>
			<div class="header-right">
				<div class="user-chip">
					<div class="avatar" id="userAvatar">?</div>
					<span id="userName">Khách hàng</span>
				</div>
				<a href="index.html" class="btn btn-glass">
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
						stroke-linecap="round" stroke-linejoin="round">
						<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
						<polyline points="9 22 9 12 15 12 15 22"></polyline>
					</svg>
					Trang chủ
				</a>
			</div>
		</header>

		<div class="actions-bar">
			<div class="search-box">
				<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
					stroke-linecap="round" stroke-linejoin="round">
					<circle cx="11" cy="11" r="8"></circle>
					<line x1="21" y1="21" x2="16.65" y2="16.65"></line>
				</svg>
				<input type="text" id="searchInput" placeholder="Tìm kiếm sản phẩm..." oninput="filterProducts()">
			</div>
			<button class="btn btn-primary" onclick="openModal('create')">
				<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
					stroke-linecap="round" stroke-linejoin="round">
					<line x1="12" y1="5" x2="12" y2="19"></line>
					<line x1="5" y1="12" x2="19" y2="12"></line>
				</svg>
				THÊM SẢN PHẨM MỚI
			</button>
		</div>

		<div id="productGrid" class="product-grid">
			<!-- Products will be loaded here -->
			<div class="empty-state">
				<div class="spinner" style="margin: 0 auto;"></div>
				<p style="margin-top: 20px;">Đang tải sản phẩm...</p>
			</div>
		</div>
	</div>

	<!-- Custom Confirm Modal -->
	<div id="confirmModal" class="modal">
		<div class="modal-content" style="max-width: 400px; text-align: center;">
			<div style="margin-bottom: 25px;">
				<div
					style="width: 70px; height: 70px; background: rgba(255, 61, 0, 0.1); color: var(--danger); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
					<svg width="35" height="35" viewBox="0 0 24 24" fill="none" stroke="currentColor"
						stroke-width="2.5">
						<path
							d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z">
						</path>
						<line x1="12" y1="9" x2="12" y2="13"></line>
						<line x1="12" y1="17" x2="12.01" y2="17"></line>
					</svg>
				</div>
				<h2 id="confirmTitle" style="font-size: 1.5rem; margin-bottom: 10px;">Xác nhận xóa</h2>
				<p id="confirmMessage" style="color: var(--text-gray); font-size: 0.95rem; line-height: 1.6;">Bạn có
					chắc chắn muốn xóa sản phẩm này không? Hành động này không thể hoàn tác.</p>
			</div>
			<div style="display: flex; gap: 15px;">
				<button class="btn btn-glass" style="flex: 1; justify-content: center;"
					onclick="closeConfirmModal()">HỦY</button>
				<button id="confirmExecuteBtn" class="btn btn-primary"
					style="flex: 1; justify-content: center; background: var(--danger); color: white;">XÓA NGAY</button>
			</div>
		</div>
	</div>

	<!-- Product Modal -->
	<div id="productModal" class="modal">
		<div class="modal-content">
			<div class="close-modal" onclick="closeModal()">
				<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
					stroke-linecap="round" stroke-linejoin="round">
					<line x1="18" y1="6" x2="6" y2="18"></line>
					<line x1="6" y1="6" x2="18" y2="18"></line>
				</svg>
			</div>
			<div class="modal-header">
				<h2 id="modalTitle">Thêm Sản Phẩm</h2>
				<p style="color: var(--text-gray);">Điền thông tin sản phẩm của bạn vào bên dưới</p>
			</div>
			<form id="productForm">
				<input type="hidden" id="editId">
				<div class="form-group">
					<label>Hình ảnh sản phẩm</label>
					<div class="image-upload-wrapper" onclick="document.getElementById('fileInput').click()">
						<div class="upload-placeholder" id="uploadPlaceholder">
							<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
								stroke-linecap="round" stroke-linejoin="round">
								<rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
								<circle cx="8.5" cy="8.5" r="1.5"></circle>
								<polyline points="21 15 16 10 5 21"></polyline>
							</svg>
							<p>Nhấn để tải hình lên</p>
							<span style="font-size: 0.7rem; opacity: 0.6;">JPG, PNG hoặc WebP</span>
						</div>
						<img id="imagePreview" class="image-preview" src="">
					</div>
					<input type="file" id="fileInput" accept="image/*" onchange="previewImage(event)">
				</div>

				<div class="form-group">
					<label>Tên sản phẩm</label>
					<input type="text" id="productName" class="form-input" placeholder="Ví dụ: Tấm ốp Nano 400x9mm..."
						required>
				</div>

				<div class="form-grid">
					<div class="form-group">
						<label>Ngành hàng</label>
						<input type="text" id="productCategory" class="form-input" list="categoryList"
							placeholder="Chọn hoặc nhập mới..." required>
						<datalist id="categoryList">
							<option value="Tấm Pima">
							<option value="Duraflex">
							<option value="Weber">
							<option value="Phụ Kiện">
						</datalist>
					</div>
					<div class="form-group">
						<label>Giá bán (VNĐ)</label>
						<input type="text" id="productPrice" class="form-input" placeholder="0"
							oninput="formatPriceInput(this)" required>
					</div>
				</div>

				<div style="margin-top: 20px;">
					<button type="submit" class="btn btn-primary"
						style="width: 100%; justify-content: center; padding: 16px;">
						<span id="submitBtnText">LƯU SẢN PHẨM</span>
					</button>
				</div>
			</form>
		</div>
	</div>

	<script>
		// --- CONFIG ---
		const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzM8tzbdJJvXE0r6NcP8cJGO2RHsgYUR6Jy73U4NDLkSQRjT3fus_i4lugwVQZIKI8zhw/exec';

		let currentProducts = [];
		let userData = null;
		let isUploading = false;

		document.addEventListener('DOMContentLoaded', () => {
			// Check Auth
			const userStr = localStorage.getItem('userLoggedIn');
			if (!userStr) {
				window.location.href = 'index.html';
				return;
			}
			userData = JSON.parse(userStr);

			// Nếu là admin thì vẫn cho xem, nhưng note là của user
			document.getElementById('userName').innerText = userData.name;
			document.getElementById('userAvatar').innerText = userData.name.charAt(0).toUpperCase();

			loadProducts();
		});

		async function loadProducts() {
			const grid = document.getElementById('productGrid');
			try {
				// In real use, we need the SCRIPT_URL to be set correctly.
				// For demonstration, if SCRIPT_URL is placeholder, we show empty
				if (SCRIPT_URL.includes('AKfycbxoK')) {
					console.warn("Vui lòng cập nhật SCRIPT_URL trong file san-pham-khach.html");
					grid.innerHTML = `
                        <div class="empty-state">
                            <h2>Chưa cấu hình Script kết nối Sheet</h2>
                            <p style="margin-top:10px;">Vui lòng triển khai mã GAS và dán URL vào file HTML.</p>
                        </div>
                    `;
					return;
				}

				// 1. Fetch JSON data
				let jsonData = [];
				try {
					const jsonRes = await fetch('data/data_san_pham_kh.json');
					if (jsonRes.ok) {
						const rawJson = await jsonRes.json();
						// Chuẩn hóa key id cho JSON
						jsonData = rawJson.map(item => {
							const newItem = { ...item };
							// Tìm bất kỳ key nào chứa chữ 'id' và 'san' và 'pham' (bất kể dấu cách)
							const idKey = Object.keys(item).find(key =>
								key.replace(/\s+/g, '') === 'id_san_pham' ||
								key.replace(/\s+/g, '') === 'idsanpham'
							);
							if (idKey) {
								newItem.id_san_pham = item[idKey];
								if (idKey !== 'id_san_pham') delete newItem[idKey];
							}
							return newItem;
						}).filter(item => item.ten_dang_nhap === userData.email);
					}
				} catch (e) { console.warn("Không tìm thấy file JSON hoặc lỗi đọc file", e); }

				// 2. Fetch Sheet data
				const response = await fetch(`${SCRIPT_URL}?action=read&username=${encodeURIComponent(userData.email)}`);
				const result = await response.json();

				if (result.success) {
					const sheetData = result.data;

					// 3. Merging logic
					const merged = [];
					const sheetIds = new Set(sheetData.map(s => s.id_san_pham));

					// Ưu tiên Sheet data cho các sản phẩm đã có ID trong JSON
					jsonData.forEach(j => {
						const fromSheet = sheetData.find(s => s.id_san_pham === j.id_san_pham);
						if (fromSheet) {
							if (fromSheet.trang_thai_xoa_sp !== 'DELETED') {
								merged.push(fromSheet);
							}
							// Nếu DELETED thì bỏ qua
						} else {
							merged.push(j);
						}
					});

					// Thêm các sản phẩm mới chỉ có ở Sheet
					sheetData.forEach(s => {
						const inJson = jsonData.find(j => j.id_san_pham === s.id_san_pham);
						if (!inJson && s.trang_thai_xoa_sp !== 'DELETED') {
							merged.push(s);
						}
					});

					currentProducts = merged;
					renderProducts(currentProducts);
					updateCategoryDatalist(currentProducts);
				} else {
					grid.innerHTML = `<div class="empty-state"><h2>Lỗi: ${result.message}</h2></div>`;
				}
			} catch (err) {
				console.error("Load failed", err);
				grid.innerHTML = `<div class="empty-state"><h2>Không thể kết nối với hệ thống</h2></div>`;
			}
		}

		function renderProducts(products) {
			const grid = document.getElementById('productGrid');
			if (products.length === 0) {
				grid.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="15"></line><line x1="15" y1="9" x2="9" y2="15"></line></svg>
                        <h2>Bạn chưa có sản phẩm nào</h2>
                        <p style="color: var(--text-gray); margin-top: 10px;">Nhấn nút "Thêm sản phẩm mới" để bắt đầu.</p>
                    </div>
                `;
				return;
			}

			grid.innerHTML = products.map(p => {
				// Debug dữ liệu
				console.log('Product data:', p);

				// Tìm link ảnh (xử lý cả trường hợp header bị lệch)
				let imgUrl = p.image_san_pham || p.imagesanpham || '';

				// Chuẩn hóa link ảnh Drive
				if (imgUrl && (imgUrl.includes('drive.google.com') || imgUrl.includes('docs.google.com'))) {
					const idMatch = imgUrl.match(/[-\w]{25,}/);
					if (idMatch) imgUrl = `https://lh3.googleusercontent.com/d/${idMatch[0]}`;
				}

				// Ảnh mặc định chất lượng cao từ Unsplash nếu không có ảnh
				const fallbackImg = 'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?auto=format&fit=crop&q=80&w=400';

				return `
                <div class="product-card">
                    <div class="product-badge">${p.id_san_pham || 'NEW'}</div>
                    <div class="product-img">
                        <img src="${imgUrl || fallbackImg}" 
                             alt="${p.ten_san_pham}" 
                             style="width: 100%; height: 100%; object-fit: cover;"
                             onerror="this.onerror=null; this.src='${fallbackImg}'; console.log('Image load failed, using fallback for:', '${p.ten_san_pham}')">
                    </div>
                    <div class="product-info">
                        <span class="category">${p.ten_nghanh_hang || 'Chưa phân loại'}</span>
                        <h3>${p.ten_san_pham}</h3>
                        <div class="product-footer">
                            <div class="product-price">${formatCurrency(p.gia_san_pham)}</div>
                            <div class="product-actions">
                                <div class="action-btn btn-edit" title="Chỉnh sửa" onclick="openModal('edit', '${p.id_san_pham}')">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                </div>
                                <div class="action-btn btn-delete" title="Xóa" onclick="deleteProduct('${p.id_san_pham}')">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
			}).join('');
		}
		function updateCategoryDatalist(products) {
			const datalist = document.getElementById('categoryList');
			const defaultCats = ["Tấm Pima", "Duraflex", "Weber", "Phụ Kiện"];
			const userCats = [...new Set(products.map(p => p.ten_nghanh_hang).filter(c => c))];

			// Hợp nhất danh sách mặc định và danh sách từ user
			const allCats = [...new Set([...defaultCats, ...userCats])];

			datalist.innerHTML = allCats.map(cat => `<option value="${cat}">`).join('');
		}

		function filterProducts() {
			const query = document.getElementById('searchInput').value.toLowerCase();
			const filtered = currentProducts.filter(p =>
				p.ten_san_pham.toLowerCase().includes(query) ||
				p.ten_nghanh_hang.toLowerCase().includes(query)
			);
			renderProducts(filtered);
		}

		// --- CORE CRUD ---

		function openModal(mode, id = null) {
			const modal = document.getElementById('productModal');
			const form = document.getElementById('productForm');
			const title = document.getElementById('modalTitle');
			const submitText = document.getElementById('submitBtnText');

			form.reset();
			document.getElementById('imagePreview').style.display = 'none';
			document.getElementById('uploadPlaceholder').style.display = 'block';
			document.getElementById('editId').value = '';

			if (mode === 'edit') {
				title.innerText = 'Chỉnh Sửa Sản Phẩm';
				submitText.innerText = 'CẬP NHẬT THÔNG TIN';
				const p = currentProducts.find(item => item.id_san_pham === id);
				if (p) {
					document.getElementById('editId').value = p.id_san_pham;
					document.getElementById('productName').value = p.ten_san_pham;
					document.getElementById('productCategory').value = p.ten_nghanh_hang;
					document.getElementById('productPrice').value = formatCurrencyNoSymbol(p.gia_san_pham);

					if (p.image_san_pham) {
						const preview = document.getElementById('imagePreview');
						preview.src = p.image_san_pham;
						preview.style.display = 'block';
						document.getElementById('uploadPlaceholder').style.display = 'none';
					}
				}
			} else {
				title.innerText = 'Thêm Sản Phẩm Mới';
				submitText.innerText = 'LƯU SẢN PHẨM';
			}

			modal.classList.add('active');
			document.body.style.overflow = 'hidden';
		}

		function closeModal() {
			document.getElementById('productModal').classList.remove('active');
			document.body.style.overflow = 'auto';
		}

		function previewImage(event) {
			const file = event.target.files[0];
			if (!file) return;

			const reader = new FileReader();
			reader.onload = function (e) {
				const preview = document.getElementById('imagePreview');
				preview.src = e.target.result;
				preview.style.display = 'block';
				document.getElementById('uploadPlaceholder').style.display = 'none';
			};
			reader.readAsDataURL(file);
		}

		document.getElementById('productForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			const updateLoader = (msg) => {
				document.getElementById('loader').style.display = 'flex';
				document.querySelector('#loader p').innerText = msg;
			};
			const hideLoader = () => document.getElementById('loader').style.display = 'none';

			updateLoader('Đang chuẩn bị dữ liệu...');

			try {
				let imageUrl = document.getElementById('imagePreview').src;
				const fileInput = document.getElementById('fileInput');
				const editId = document.getElementById('editId').value;

				// 1. Upload image if new file selected
				if (fileInput.files.length > 0) {
					updateLoader('Đang tải hình ảnh lên hệ thống... (Vui lòng đợi)');
					const file = fileInput.files[0];
					const base64 = await toBase64(file);

					const uploadRes = await fetch(SCRIPT_URL, {
						method: 'POST',
						body: JSON.stringify({
							action: 'upload',
							file: base64.split(',')[1],
							mimeType: file.type,
							filename: file.name
						})
					});

					if (!uploadRes.ok) throw new Error('Không thể kết nối máy chủ ảnh');

					const uploadData = await uploadRes.json();
					if (uploadData.success) {
						imageUrl = uploadData.url;
					} else {
						throw new Error('Lỗi tải ảnh: ' + uploadData.message);
					}
				} else if (imageUrl.startsWith('data:')) {
					imageUrl = '';
				}

				updateLoader('Đang lưu thông tin sản phẩm vào Sheet...');

				// 2. Prepare Data
				const pData = {
					id_san_pham: editId || '', // ĐẶC BIỆT QUAN TRỌNG: Gửi ID về để Sheet nhận diện
					ten_san_pham: document.getElementById('productName').value,
					ten_nghanh_hang: document.getElementById('productCategory').value,
					gia_san_pham: parsePrice(document.getElementById('productPrice').value),
					image_san_pham: imageUrl,
					ten_dang_nhap: userData.email,
					trang_thai_xoa_sp: 'ACTIVE'
				};

				const payload = {
					action: editId ? 'update' : 'create',
					idValue: editId,
					data: pData
				};

				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify(payload)
				});

				const result = await response.json();
				if (result.success) {
					closeModal();
					await loadProducts();
					alert(editId ? "Cập nhật thành công!" : "Thêm sản phẩm thành công!");
				} else {
					alert("Lỗi từ server: " + result.message);
				}
			} catch (err) {
				console.error('Error detail:', err);
				alert("Lỗi: " + err.message + "\n\nLưu ý: Bạn hãy kiểm tra xem đã phân quyền Apps Script là 'Anyone' chưa nhé.");
			} finally {
				hideLoader();
			}
		});

		async function deleteProduct(id) {
			if (!id) {
				alert("Lỗi: Không tìm thấy mã sản phẩm để xóa. (Có thể sản phẩm này chưa có ID trong Sheet)");
				return;
			}

			const product = currentProducts.find(p => p.id_san_pham === id);
			if (!product) {
				alert("Lỗi: Dữ liệu sản phẩm không hợp lệ.");
				return;
			}

			// Hiện Modal xác nhận thay vì confirm() của trình duyệt
			const modal = document.getElementById('confirmModal');
			document.getElementById('confirmMessage').innerText = `Bạn có chắc chắn muốn xóa sản phẩm "${product.ten_san_pham}"?`;
			document.getElementById('confirmExecuteBtn').onclick = async () => {
				closeConfirmModal();
				await executeDelete(id, product);
			};
			modal.classList.add('active');
		}

		function closeConfirmModal() {
			document.getElementById('confirmModal').classList.remove('active');
		}

		async function executeDelete(id, product) {
			const updateLoader = (msg) => {
				document.getElementById('loader').style.display = 'flex';
				document.querySelector('#loader p').innerText = msg;
			};
			const hideLoader = () => document.getElementById('loader').style.display = 'none';

			updateLoader('Đang thực hiện xóa sản phẩm...');

			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'delete',
						idValue: id,
						data: product
					})
				});
				const result = await response.json();
				if (result.success) {
					await loadProducts();
					alert("Đã xóa sản phẩm thành công.");
				} else {
					alert("Lỗi: " + result.message);
				}
			} catch (err) {
				console.error(err);
				alert("Không thể xóa sản phẩm. Lỗi kết nối.");
			} finally {
				hideLoader();
			}
		}

		// --- UTILS ---
		function formatCurrency(val) {
			if (!val) return '0 đ';
			return new Intl.NumberFormat('vi-VN').format(val) + ' đ';
		}

		function formatCurrencyNoSymbol(val) {
			if (!val) return '0';
			return new Intl.NumberFormat('vi-VN').format(val);
		}

		function parsePrice(str) {
			return parseFloat(str.replace(/\./g, '').replace(/,/g, '')) || 0;
		}

		function formatPriceInput(input) {
			let value = input.value.replace(/\D/g, '');
			if (value) {
				input.value = new Intl.NumberFormat('vi-VN').format(value);
			}
		}

		function toBase64(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = () => resolve(reader.result);
				reader.onerror = error => reject(error);
			});
		}
	</script>
</body>

</html>