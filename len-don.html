<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>H·ªá Th·ªëng L√™n ƒê∆°n H√†ng - Premium</title>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
	<style>
		:root {
			--primary: #2d3436;
			--accent: #f1c40f;
			--success: #27ae60;
			--danger: #e74c3c;
			--bg: #f8f9fa;
			--card-bg: #ffffff;
			--border: #e9ecef;
			--text: #2d3436;
			--text-muted: #6c757d;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Inter', sans-serif;
		}

		body {
			background-color: var(--bg);
			color: var(--text);
			line-height: 1.6;
			padding: 20px;
		}

		.container {
			max-width: 1000px;
			margin: 0 auto;
		}

		/* Header */
		header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
			padding-bottom: 20px;
			border-bottom: 2px solid var(--accent);
		}

		.header-title h1 {
			font-size: 1.8rem;
			font-weight: 800;
			text-transform: uppercase;
			letter-spacing: -0.5px;
		}

		.header-title p {
			color: var(--text-muted);
			font-size: 0.9rem;
		}

		.home-link {
			text-decoration: none;
			color: var(--text);
			font-weight: 600;
			display: flex;
			align-items: center;
			gap: 8px;
			padding: 10px 15px;
			background: #fff;
			border-radius: 10px;
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
			transition: 0.3s;
		}

		.home-link:hover {
			transform: translateY(-2px);
			background: var(--accent);
		}

		/* Customer Search Section */
		.customer-card {
			background: var(--card-bg);
			padding: 25px;
			border-radius: 20px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
			margin-bottom: 25px;
			position: relative;
		}

		.form-group {
			margin-bottom: 15px;
			position: relative;
		}

		.form-group label {
			display: block;
			font-weight: 700;
			margin-bottom: 8px;
			font-size: 0.85rem;
			text-transform: uppercase;
			color: var(--text-muted);
		}

		.form-input {
			width: 100%;
			padding: 14px 20px;
			border: 2px solid var(--border);
			border-radius: 12px;
			font-size: 1rem;
			transition: 0.3s;
			background: #fbfbfb;
		}

		.form-input:focus {
			outline: none;
			border-color: var(--accent);
			background: #fff;
			box-shadow: 0 0 0 4px rgba(241, 196, 15, 0.1);
		}

		/* Autocomplete results */
		#customerResults {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			background: #fff;
			border-radius: 12px;
			box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
			z-index: 100;
			max-height: 250px;
			overflow-y: auto;
			display: none;
		}

		.result-item {
			padding: 12px 20px;
			cursor: pointer;
			border-bottom: 1px solid var(--border);
			transition: 0.2s;
		}

		.result-item:hover {
			background: #f8f9fa;
		}

		.result-item .cust-name {
			font-weight: 700;
			display: block;
		}

		.result-item .cust-info {
			font-size: 0.8rem;
			color: var(--text-muted);
		}

		.selected-customer-box {
			display: none;
			background: #fff8e1;
			padding: 15px;
			border-left: 5px solid var(--accent);
			border-radius: 10px;
			margin-bottom: 15px;
			justify-content: space-between;
			align-items: center;
		}

		/* Order Form Tabs */
		.order-section {
			display: none;
		}

		.order-section.active {
			display: block;
		}

		.tabs-container {
			display: flex;
			gap: 10px;
			margin-bottom: 20px;
		}

		.tab-btn {
			flex: 1;
			padding: 15px;
			border: none;
			background: #fff;
			border-radius: 12px;
			font-weight: 700;
			cursor: pointer;
			transition: 0.3s;
			color: var(--text-muted);
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
		}

		.tab-btn.active {
			background: var(--primary);
			color: var(--accent);
		}

		.tab-btn[data-tab="weber"].active {
			background: #000;
			color: #ffce00;
		}

		.tab-btn[data-tab="pima"].active {
			background: #ffce00;
			color: #000;
		}

		.tab-btn[data-tab="duraflex"].active {
			background: #1a8e44;
			color: #fff;
		}

		.form-card {
			background: var(--card-bg);
			padding: 30px;
			border-radius: 20px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
		}

		/* Item Row */
		.item-list {
			margin-bottom: 20px;
		}

		.item-row {
			display: grid;
			grid-template-columns: 1fr;
			gap: 15px;
			margin-bottom: 20px;
			border: 2px solid var(--border);
			border-radius: 12px;
			padding: 20px;
			background: #fafbfc;
			position: relative;
		}

		.item-row-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 15px;
			padding-bottom: 10px;
			border-bottom: 2px solid var(--accent);
		}

		.item-row-header h4 {
			font-size: 0.9rem;
			color: var(--text-muted);
			text-transform: uppercase;
			letter-spacing: 0.5px;
			margin: 0;
		}

		.item-row-content {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
		}

		.product-info-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			gap: 10px;
			margin-top: 10px;
			padding: 15px;
			background: #fff;
			border-radius: 8px;
			border-left: 3px solid var(--accent);
		}

		.info-item {
			font-size: 0.85rem;
		}

		.info-item label {
			display: block;
			font-weight: 600;
			color: var(--text-muted);
			margin-bottom: 3px;
			font-size: 0.75rem;
			text-transform: uppercase;
		}

		.info-item span {
			display: block;
			color: var(--text);
			font-weight: 500;
		}

		.add-item-btn {
			background: #f1f2f6;
			border: 2px dashed #ccc;
			width: 100%;
			padding: 12px;
			border-radius: 12px;
			cursor: pointer;
			font-weight: 700;
			color: var(--text-muted);
			margin-bottom: 20px;
			transition: 0.3s;
		}

		.add-item-btn:hover {
			background: #e9ecef;
			border-color: var(--primary);
			color: var(--primary);
		}

		/* Summary Section */
		.order-summary {
			background: #f8fafc;
			padding: 20px;
			border-radius: 15px;
			margin-top: 20px;
		}

		.summary-row {
			display: flex;
			justify-content: space-between;
			margin-bottom: 10px;
			font-weight: 500;
		}

		.summary-total {
			font-size: 1.4rem;
			font-weight: 800;
			color: var(--primary);
			border-top: 2px solid var(--accent);
			padding-top: 10px;
			margin-top: 10px;
		}

		.submit-order-btn {
			width: 100%;
			padding: 20px;
			background: var(--primary);
			color: var(--accent);
			border: none;
			border-radius: 15px;
			font-size: 1.2rem;
			font-weight: 800;
			text-transform: uppercase;
			cursor: pointer;
			margin-top: 25px;
			box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
			transition: 0.3s;
		}

		.submit-order-btn:hover {
			transform: translateY(-3px);
			box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
		}

		.submit-order-btn:disabled {
			background: #ccc;
			cursor: not-allowed;
			transform: none;
		}

		.btn-remove {
			background: #fff;
			border: 1px solid var(--danger);
			color: var(--danger);
			width: 40px;
			height: 40px;
			border-radius: 10px;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.btn-remove:hover {
			background: var(--danger);
			color: #fff;
		}

		.promo-tag {
			display: inline-block;
			padding: 4px 10px;
			background: #e3f2fd;
			color: #1976d2;
			border-radius: 6px;
			font-size: 0.75rem;
			font-weight: 700;
			margin-top: 5px;
		}

		/* Loading Overlay */
		#loadingOverlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(255, 255, 255, 0.9);
			z-index: 1000;
			display: none;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}

		.spinner {
			width: 50px;
			height: 50px;
			border: 5px solid #f3f3f3;
			border-top: 5px solid var(--accent);
			border-radius: 50%;
			animation: spin 1s linear infinite;
			margin-bottom: 20px;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		/* Mobile Adjustments */
		@media (max-width: 768px) {
			.item-row {
				grid-template-columns: 1fr 1fr;
			}

			.item-row div:first-child {
				grid-column: 1 / -1;
			}

			.item-row div:last-child {
				grid-column: 1 / -1;
				display: flex;
				justify-content: flex-end;
			}
		}

		/* Delivery Toggle Styles */
		.delivery-toggle {
			display: flex;
			gap: 5px;
			margin-top: 8px;
		}

		.delivery-btn {
			flex: 1;
			padding: 8px 5px;
			border: 1px solid var(--border);
			background: #f1f2f6;
			border-radius: 8px;
			font-size: 0.75rem;
			font-weight: 700;
			cursor: pointer;
			transition: 0.3s;
			text-align: center;
		}

		.delivery-btn.active {
			background: var(--accent);
			color: #000;
			border-color: var(--accent);
		}

		.surplus-info {
			font-size: 0.8rem;
			color: #e67e22;
			font-weight: 600;
			margin-top: 5px;
		}
	</style>
</head>

<body>

	<div id="loadingOverlay">
		<div class="spinner"></div>
		<h2 id="loadingText">ƒêang x·ª≠ l√Ω ƒë∆°n h√†ng...</h2>
	</div>

	<div class="container">
		<header>
			<div class="header-title">
				<h1>H·ªá Th·ªëng L√™n ƒê∆°n</h1>
				<p>T·∫°o ƒë∆°n h√†ng th√¥ng minh cho Weber - Pima - Duraflex</p>
			</div>
			<a href="index.html" class="home-link">
				<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
					<polyline points="9 22 9 12 15 12 15 22"></polyline>
				</svg>
				Trang ch·ªß
			</a>
		</header>

		<!-- Kh√°ch H√†ng Section -->
		<div class="customer-card">
			<div class="form-group" id="customerSearchGroup">
				<label>Ch·ªçn Kh√°ch H√†ng</label>
				<input type="text" id="customerInput" class="form-input" placeholder="Nh·∫≠p t√™n ho·∫∑c m√£ kh√°ch h√†ng..."
					autocomplete="off">
				<div id="customerResults"></div>
			</div>

			<div id="selectedCustomerBox" class="selected-customer-box">
				<div>
					<strong id="selectedCustName" style="font-size: 1.1rem; color: var(--text);"></strong>
					<div id="selectedCustType" style="color: var(--text-muted); font-size: 0.9rem;"></div>
				</div>
				<button class="btn-remove" onclick="resetCustomer()" title="Ch·ªçn l·∫°i">
					<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M18 6L6 18M6 6l12 12"></path>
					</svg>
				</button>
			</div>
		</div>

		<!-- Order Tabs -->
		<div class="tabs-container">
			<button class="tab-btn active" data-tab="weber" onclick="switchTab('weber')">SILICONE WEBER</button>
			<button class="tab-btn" data-tab="pima" onclick="switchTab('pima')">TR·∫¶N NANO PIMA</button>
			<button class="tab-btn" data-tab="duraflex" onclick="switchTab('duraflex')">T·∫§M DURAFLEX</button>
		</div>

		<!-- Weber Section -->
		<div id="weberSection" class="order-section active form-card">
			<h3 style="margin-bottom: 20px;">ƒê∆°n h√†ng Silicone Weber</h3>
			<div id="weberItemList" class="item-list"></div>
			<button class="add-item-btn" onclick="addItemRow('weber')">+ TH√äM S·∫¢N PH·∫®M WEBER</button>
		</div>

		<!-- Pima Section -->
		<div id="pimaSection" class="order-section form-card">
			<h3 style="margin-bottom: 20px;">ƒê∆°n h√†ng Pima Nano</h3>
			<div id="pimaItemList" class="item-list"></div>
			<button class="add-item-btn" onclick="addItemRow('pima')">+ TH√äM S·∫¢N PH·∫®M PIMA</button>
		</div>

		<!-- Duraflex Section -->
		<div id="duraflexSection" class="order-section form-card">
			<h3 style="margin-bottom: 20px;">ƒê∆°n h√†ng T·∫•m Duraflex</h3>
			<div id="duraflexItemList" class="item-list"></div>
			<button class="add-item-btn" onclick="addItemRow('duraflex')">+ TH√äM S·∫¢N PH·∫®M DURAFLEX</button>
		</div>

		<!-- Summary & Submit -->
		<div class="form-card" style="margin-top: 25px;">
			<div class="form-group">
				<label>Ghi ch√∫ ƒë∆°n h√†ng</label>
				<textarea id="orderNotes" class="form-input" style="height: 80px; resize: none;"
					placeholder="Nh·∫≠p y√™u c·∫ßu ƒë·∫∑c bi·ªát, ƒë·ªãa ch·ªâ giao h√†ng..."></textarea>
			</div>

			<div class="order-summary">
				<div class="summary-row">
					<span id="summaryCountLabel">S·ªë l∆∞·ª£ng m·∫∑t h√†ng:</span>
					<span id="summaryCount">0</span>
				</div>
				<div class="summary-row" id="grossTotalRow" style="display: none; color: var(--text-muted);">
					<span>T·ªïng gi√° tr·ªã (Gi√° ch√†nh):</span>
					<span id="summaryGross">0 ƒë</span>
				</div>
				<div class="summary-row" id="pimaSurplusRow" style="display: none; color: #e67e22; font-weight: 700;">
					<span>H·ªó tr·ª£ v·∫≠n chuy·ªÉn:</span>
					<span id="summarySurplus">0 ƒë</span>
				</div>
				<div class="summary-row" id="duraflexDiscountRow"
					style="display: none; color: var(--success); font-weight: 700;">
					<span>Chi·∫øt kh·∫•u Duraflex:</span>
					<span id="summaryDiscount">0 ƒë</span>
				</div>
				<!-- Duraflex Discount Options -->
				<div id="duraflexDiscountOptions"
					style="display: none; margin: 15px 0; border-top: 1px dashed #ddd; padding-top: 15px;">
					<label
						style="font-weight: 700; color: #1a8e44; display: block; margin-bottom: 10px; font-size: 0.9rem; text-align: center;">CH·∫æ
						ƒê·ªò CHI·∫æT KH·∫§U DURAFLEX</label>
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
						<button type="button" id="btnDiscountAuto" class="tab-btn active"
							style="padding: 8px; font-size: 0.8rem;" onclick="setDiscountMode('auto')">KHUY·∫æN M√ÉI (T·ª∞
							ƒê·ªòNG)</button>
						<button type="button" id="btnDiscountManual" class="tab-btn"
							style="padding: 8px; font-size: 0.8rem;" onclick="setDiscountMode('manual')">KHUY·∫æN M√ÉI LINH
							HO·∫†T</button>
					</div>

					<div id="duraflexAutoContainer">
						<div id="duraflexPromoSelection"
							style="padding: 12px; background: #f0fff0; border-radius: 12px; border: 1px solid #48d14d;">
							<label
								style="font-weight: 700; color: #1a8e44; display: block; margin-bottom: 5px; font-size: 0.85rem;">üéÅ
								Khuy·∫øn m√£i b·ªï sung (Duraflex):</label>
							<select id="selectSpecialPromo" class="p-select" style="width: 100%;"
								onchange="handleSpecialPromoChange()"></select>
						</div>
					</div>

					<div id="duraflexManualContainer" style="display: none;">
						<div
							style="padding: 12px; background: #fff5f5; border-radius: 12px; border: 1px solid #ff7675;">
							<label
								style="font-weight: 700; color: #d63031; display: block; margin-bottom: 5px; font-size: 0.85rem;">‚úçÔ∏è
								Nh·∫≠p s·ªë ti·ªÅn chi·∫øt kh·∫•u mong mu·ªën:</label>
							<input type="text" id="inputFlexibleDiscount" class="p-price"
								style="width: 100%; height: 40px; font-size: 1.1rem; text-align: right;"
								placeholder="Vd: 500,000" oninput="handleFlexibleDiscountInput(this)">
						</div>
					</div>
				</div>
				<div class="summary-total"
					style="display: flex; justify-content: space-between; align-items: center; padding-top: 10px; border-top: 2px solid #eee;">
					<span id="summaryTotalLabel" style="font-weight: 800; color: #2d3436;">T·ªîNG C·ªòNG:</span>
					<span id="summaryTotal" style="font-weight: 800; color: #e67e22; font-size: 1.4rem;">0 ƒë</span>
				</div>
			</div>

			<button id="submitOrderBtn" class="submit-order-btn" onclick="submitOrder()">
				X√ÅC NH·∫¨N & L√äN ƒê∆†N
			</button>
		</div>
	</div>

	<script>
		// --- APP CONFIG ---
		const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIHfOV9rW_GQ8_Xv-WWA3KAqPMONiZQPDdOdNOcYmMSMlt93KG3zZJ7Z53OJ-d-LIJZg/exec';
		// N·∫øu ch∆∞a c√≥ URL Apps Script, d√πng URL n√†y ƒë·ªÉ test log
		// 'https://script.google.com/macros/s/AKfycby_...'

		let customers = [];
		let products = { weber: [], pima: [], duraflex: [] };
		let selectedCustomer = null;
		let currentTab = 'weber';
		let duraflexDiscounts = [];
		// computed summary values to send to backend
		let orderComputed = { totalBoxes: 0, totalSupport: 0, totalPackages: 0, discountAmount: 0, totalAfterDiscount: 0 };

		// --- INITIALIZATION ---
		let isEditMode = false;
		let editOrderId = null;
		let manualDiscountId = null; // Store manually selected promo ID for Duraflex
		let duraflexDiscountMode = 'auto'; // 'auto' or 'manual'
		let manualFlexibleDiscount = 0;

		document.addEventListener('DOMContentLoaded', async () => {
			// --- AUTH CHECK ---
			const userData = JSON.parse(localStorage.getItem('userLoggedIn'));
			if (!userData || userData.phan_loai !== 'ad mind') {
				alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!");
				window.location.href = 'index.html';
				return;
			}

			await loadInitialData();
			setupCustomerSearch();

			// Ki·ªÉm tra xem c√≥ ƒëang ·ªü ch·∫ø ƒë·ªô s·ª≠a kh√¥ng
			const editData = localStorage.getItem('editingOrder');
			if (editData) {
				setupEditMode(JSON.parse(editData));
			} else {
				addItemRow('weber'); // Add first row by default
			}
		});

		function setupEditMode(order) {
			console.log('Setting up Edit Mode with Order:', order);
			isEditMode = true;
			editOrderId = order.id;
			localStorage.removeItem('editingOrder');

			document.querySelector('h1').innerText = "Ch·ªânh S·ª≠a ƒê∆°n H√†ng";
			document.getElementById('submitOrderBtn').innerText = "C·∫¨P NH·∫¨T ƒê∆†N H√ÄNG";

			// Select Customer
			const cust = customers.find(c =>
				c.name.trim().toLowerCase() === (order.customer || '').trim().toLowerCase()
			);
			if (cust) {
				selectCustomer(cust.id_name);
			} else {
				// Fallback: put the name in the input if not found in JSON
				document.getElementById('customerInput').value = order.customer || '';
			}

			// Switch Tab
			const category = (order.category || 'weber').toLowerCase();
			switchTab(category);

			// Populate Items
			const list = document.getElementById(`${category}ItemList`);
			list.innerHTML = '';

			order.items.forEach(item => {
				const rowId = Math.floor(Date.now() + Math.random() * 1000);
				const row = createRowElement(category, rowId);
				list.appendChild(row);

				const sel = row.querySelector('.p-select');
				const itemName = (item.name || '').trim();
				// Try to set value directly, if fails, search options
				sel.value = item.name;
				if (!sel.value && itemName) {
					const options = Array.from(sel.options);
					const matched = options.find(o => o.value.trim().toLowerCase() === itemName.toLowerCase());
					if (matched) sel.value = matched.value;
				}

				row.querySelector('.p-qty').value = item.qty || item.quantity || 1;

				if (category === 'pima') {
					const hasSurplus = parseFloat(item.surplus || 0) > 0;
					const isKho = hasSurplus || (item.delivery_type && item.delivery_type.toLowerCase().includes('kho'));
					setDeliveryType(rowId, isKho ? 'kho' : 'chanh');
				} else {
					updateRow(category, rowId);
				}
			});

			document.getElementById('orderNotes').value = order.notes || '';

			// Restore Duraflex Discount Mode if applicable
			if (category === 'duraflex') {
				const savedCk = parseCurrency(order.discount_total || (order.items && order.items[0] ? order.items[0].promo : 0));
				if (savedCk > 0) {
					// Check what 'auto' would give
					calculateTotals();
					const autoCk = orderComputed.discountAmount;

					// If the saved amount is different from auto, OR if we want to be safe,
					// we can always switch to manual if a discount was explicitly saved.
					// However, usually savedCk !== autoCk is the right trigger.
					if (savedCk !== autoCk) {
						duraflexDiscountMode = 'manual';
						manualFlexibleDiscount = savedCk;
						const input = document.getElementById('inputFlexibleDiscount');
						if (input) input.value = formatCurrency(savedCk).replace(' ƒë', '');
						setDiscountMode('manual');
					}
				}
			}

			calculateTotals();
		}

		function createRowElement(tab, rowId) {
			const row = document.createElement('div');
			row.className = 'item-row';
			row.id = `row-${rowId}`;
			let options = `<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>`;
			products[tab].forEach(p => {
				const name = p["t√™n s·∫£n ph·∫©m"] || p["ten_sp"] || p["T√™n s·∫£n ph·∫©m"];
				options += `<option value="${name}">${name}</option>`;
			});

			// Get short index for title
			const currentCount = document.getElementById(`${tab}ItemList`).children.length + 1;

			row.innerHTML = `
                <div class="item-row-header">
                    <h4>S·∫£n ph·∫©m #${currentCount}</h4>
                    <button class="btn-remove" onclick="removeRow(${rowId})" style="position: static; margin: 0;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="item-row-content">
                    <div style="grid-column: 1 / -1;">
                        <label>Ch·ªçn S·∫£n Ph·∫©m</label>
                        <select class="form-input p-select" onchange="updateRow('${tab}', ${rowId})">
                            ${options}
                        </select>
                        <div class="promo-info" id="promo-${rowId}"></div>
                        ${tab === 'pima' ? `
                            <div class="delivery-toggle" id="delivery-toggle-${rowId}">
                                <button class="delivery-btn active" onclick="setDeliveryType('${rowId}', 'chanh')">Ra Ch√†nh</button>
                                <button class="delivery-btn" onclick="setDeliveryType('${rowId}', 'kho')">T·∫°i Kho</button>
                            </div>
                        ` : ''}
                    </div>
                    <div>
                        <label>S·ªë l∆∞·ª£ng</label>
                        <input type="number" class="form-input p-qty" value="1" min="1" oninput="updateRow('${tab}', ${rowId})">
                        <div class="surplus-info" id="surplus-${rowId}"></div>
                    </div>
                    <div>
                        <label>ƒê∆°n gi√°</label>
                        <input type="text" class="form-input p-price" readonly style="background:#eee">
                    </div>
                    <div>
                        <label>Th√†nh ti·ªÅn</label>
                        <input type="text" class="form-input p-total" readonly style="background:#fff8e1; font-weight:800; color:var(--primary)">
                    </div>
                </div>
                <div class="product-info-grid" id="product-info-${rowId}" style="display: none;"></div>
            `;
			return row;
		}

		function addItemRow(tab) {
			const list = document.getElementById(`${tab}ItemList`);
			const rowId = Math.floor(Date.now() + Math.random() * 1000);
			list.appendChild(createRowElement(tab, rowId));
		}

		async function loadInitialData() {
			try {
				const [custRes, pimaRes, weberRes, duraRes, duraCkRes] = await Promise.all([
					fetch('data/gia_khach_hang.json').then(r => r.json()),
					fetch('data/gia_web_nano.json').then(r => r.json()),
					fetch('data/gia_silicon_weber.json').then(r => r.json()),
					fetch('data/gia_duraflex.json').then(r => r.json()),
					fetch('data/chiet_khau_duraflex.json').then(r => r.json())
				]);

				customers = custRes;
				products.pima = pimaRes;
				products.weber = weberRes;
				products.duraflex = duraRes;
				duraflexDiscounts = duraCkRes;
			} catch (e) {
				console.error("L·ªói load data:", e);
			}
		}

		// --- CUSTOMER LOGIC ---
		function setupCustomerSearch() {
			const input = document.getElementById('customerInput');
			const results = document.getElementById('customerResults');

			input.addEventListener('input', (e) => {
				const val = e.target.value.toLowerCase().trim();
				if (!val) { results.style.display = 'none'; return; }

				const filtered = customers.filter(c =>
					c.name.toLowerCase().includes(val) || (c.id_name && c.id_name.toLowerCase().includes(val))
				).slice(0, 10);

				if (filtered.length > 0) {
					results.innerHTML = filtered.map(c => `
                    <div class="result-item" onclick="selectCustomer('${c.id_name}')">
                        <span class="cust-name">${c.name}</span>
                        <span class="cust-info">${c.phan_loai} | ${c.mail || 'Kh√¥ng c√≥ mail'}</span>
                    </div>
                `).join('');
					results.style.display = 'block';
				} else {
					results.style.display = 'none';
				}
			});

			document.addEventListener('click', (e) => {
				if (!input.contains(e.target)) results.style.display = 'none';
			});
		}

		function selectCustomer(id) {
			selectedCustomer = customers.find(c => c.id_name === id);
			document.getElementById('customerSearchGroup').style.display = 'none';
			document.getElementById('selectedCustName').innerText = selectedCustomer.name;
			document.getElementById('selectedCustType').innerText = selectedCustomer.phan_loai;
			document.getElementById('selectedCustomerBox').style.display = 'flex';
			document.getElementById('customerResults').style.display = 'none';
		}

		function resetCustomer() {
			selectedCustomer = null;
			document.getElementById('customerSearchGroup').style.display = 'block';
			document.getElementById('selectedCustomerBox').style.display = 'none';
			document.getElementById('customerInput').value = '';
		}

		// --- TAB LOGIC ---
		function switchTab(tabId) {
			currentTab = tabId;
			document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
			document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');

			document.querySelectorAll('.order-section').forEach(sec => sec.classList.remove('active'));
			document.getElementById(`${tabId}Section`).classList.add('active');

			// N·∫øu tab tr·ªëng, th√™m 1 d√≤ng
			if (document.getElementById(`${tabId}ItemList`).children.length === 0) {
				addItemRow(tabId);
			}

			calculateTotals();
		}

		// --- ITEM LOGIC ---
		// addItemRow function is now defined above, using createRowElement

		function setDeliveryType(rowId, type) {
			const container = document.getElementById(`delivery-toggle-${rowId}`);
			if (!container) return;
			const buttons = container.querySelectorAll('.delivery-btn');
			buttons.forEach(btn => btn.classList.remove('active'));

			const activeBtn = Array.from(buttons).find(btn =>
				(btn.innerText.toLowerCase().includes('kho') && type === 'kho') ||
				(btn.innerText.toLowerCase().includes('chanh') && type === 'chanh')
			);
			if (activeBtn) activeBtn.classList.add('active');

			updateRow('pima', rowId);
		}

		function removeRow(rowId) {
			const row = document.getElementById(`row-${rowId}`);
			if (row) row.remove();
			calculateTotals();
		}

		function updateRow(tab, rowId) {
			const row = document.getElementById(`row-${rowId}`);
			if (!row) return;

			const selectEl = row.querySelector('.p-select');
			const qtyEl = row.querySelector('.p-qty');
			const priceInput = row.querySelector('.p-price');
			const totalInput = row.querySelector('.p-total');
			const promoDiv = document.getElementById(`promo-${rowId}`);
			const infoGrid = document.getElementById(`product-info-${rowId}`);

			if (!selectEl || !qtyEl || !priceInput || !totalInput) return;

			const pName = selectEl.value;
			const qty = parseInt(qtyEl.value) || 0;

			if (!pName) {
				priceInput.value = '';
				totalInput.value = '';
				promoDiv.innerHTML = '';
				if (infoGrid) {
					infoGrid.style.display = 'none';
					infoGrid.innerHTML = '';
				}
				return;
			}

			const product = products[tab].find(p => {
				const name = (p["t√™n s·∫£n ph·∫©m"] || p["ten_sp"] || p["T√™n s·∫£n ph·∫©m"] || '').toString().trim().toLowerCase();
				return name === pName.trim().toLowerCase();
			});

			if (!product) {
				console.warn("Product not found:", pName);
				return;
			}

			let unitPrice = 0;
			let promoText = '';
			let productInfoHTML = '';

			if (tab === 'weber') {
				// Weber: ∆Øu ti√™n gi√° ni√™m y·∫øt
				unitPrice = parseCurrency(product["gi√° ni√™m y·∫øt theo chai"] || product["gia_niem_yet"] || product["gi√° ni√™m y·∫øt"] || "0");
				// Promotion logic: Mua X t·∫∑ng Y
				const bottlesPerBox = parseInt(product["s·ªë chai trong 1 th√πng"] || product["s·ªë chai/th√πng"] || 24);
				const thung = Math.floor(qty / bottlesPerBox);
				if (thung >= 3 && (product["khuy·∫øn m√£i 3 th√πng"] || product["km_3_thung"])) promoText = product["khuy·∫øn m√£i 3 th√πng"] || product["km_3_thung"];
				else if (thung >= 2 && (product["khuy·∫øn m√£i 2 th√πng"] || product["km_2_thung"])) promoText = product["khuy·∫øn m√£i 2 th√πng"] || product["km_2_thung"];
				else if (thung >= 1 && (product["khuy·∫øn m√£i 1 th√πng"] || product["km_1_thung"])) promoText = product["khuy·∫øn m√£i 1 th√πng"] || product["km_1_thung"];

				// Weber product info
				productInfoHTML = `
					<div class="info-item"><label>S·ªë chai/th√πng:</label><span>${bottlesPerBox} chai</span></div>
					<div class="info-item"><label>S·ªë th√πng:</label><span>${thung} th√πng</span></div>
					<div class="info-item"><label>Gi√° b√°n l·∫ª:</label><span>${formatCurrency(parseCurrency(product["gi√° b√°n l·∫ª theo chai"] || "0"))}</span></div>
					${product["t·∫∑ng th√™m"] ? `<div class="info-item" style="grid-column: 1 / -1;"><label>üéÅ T·∫∑ng th√™m:</label><span>${product["t·∫∑ng th√™m"]}</span></div>` : ''}
				`;
			} else if (tab === 'duraflex') {
				unitPrice = parseCurrency(product["gi√° ni√™m y·∫øt"] || product["gia_niem_yet"] || "0");

				// Duraflex product info
				const sheetsPerPackage = parseInt(product["s·ªë t·∫•m trong 1 ki·ªán"] || product["s·ªë t·∫•m/ki·ªán"] || 1);
				const packages = (qty / sheetsPerPackage).toFixed(2);
				productInfoHTML = `
					<div class="info-item"><label>K√≠ch th∆∞·ªõc:</label><span>${product["k√≠ch th∆∞·ªõc"] || 'N/A'}</span></div>
					<div class="info-item"><label>S·ªë kg/t·∫•m:</label><span>${product["s·ªë kg tr√™n t·∫•m"] || 'N/A'} kg</span></div>
					<div class="info-item"><label>S·ªë t·∫•m/ki·ªán:</label><span>${sheetsPerPackage} t·∫•m</span></div>
					<div class="info-item"><label>S·ªë ki·ªán:</label><span>${packages} ki·ªán</span></div>
					<div class="info-item"><label>Chi·∫øt kh·∫•u:</label><span>${product["s·∫£n ph·∫©m ƒë∆∞·ª£c t√≠nh chi·∫øt kh·∫•u"] === "TRUE" || product["s·∫£n ph·∫©m ƒë∆∞·ª£c t√≠nh chi·∫øt kh·∫•u"] === true ? 'C√≥' : 'Kh√¥ng'}</span></div>
				`;
			} else if (tab === 'pima') {
				const priceChanh = parseCurrency(product["gi√° ra ch√†nh hcm"] || product["Gi√° Ra Ch√†nh HCM"] || 0);
				const priceKho = parseCurrency(product["gi√° t·∫°i kho hcm"] || product["Gi√° T·∫°i Kho HCM"] || 0);
				const isKho = row.querySelector('.delivery-btn.active').innerText === 'T·∫°i Kho';

				// Lu√¥n s·ª≠ d·ª•ng gi√° ra ch√†nh l√†m ƒë∆°n gi√° v√† th√†nh ti·ªÅn
				unitPrice = priceChanh;

				if (isKho) {
					const diff = priceChanh - priceKho;
					const surplus = diff * qty;
					if (surplus > 0) {
						row.querySelector(`#surplus-${rowId}`).innerText = `H·ªó tr·ª£ VC: +${formatCurrency(surplus)}`;
						row.setAttribute('data-surplus', surplus);
					} else {
						row.querySelector(`#surplus-${rowId}`).innerText = '';
						row.removeAttribute('data-surplus');
					}
				} else {
					row.querySelector(`#surplus-${rowId}`).innerText = '';
					row.removeAttribute('data-surplus');
				}
				// Pima product info
				productInfoHTML = `
					<div class="info-item"><label>Quy c√°ch:</label><span>${product["quy c√°ch"] || 'N/A'}</span></div>
					<div class="info-item"><label>ƒê·ªô d√†y:</label><span>${product["ƒë·ªô d√†y"] || 'N/A'}</span></div>
					<div class="info-item"><label>ƒê√≥ng g√≥i:</label><span>${product["ƒë√≥ng g√≥i"] || 'N/A'}</span></div>
					<div class="info-item"><label>Tr·ªçng l∆∞·ª£ng:</label><span>${product["tr·ªçng l∆∞·ª£ng"] || 'N/A'} kg</span></div>
					<div class="info-item"><label>Gi√° t·∫°i kho:</label><span>${formatCurrency(priceKho)}</span></div>
					<div class="info-item"><label>Gi√° ra ch√†nh:</label><span>${formatCurrency(priceChanh)}</span></div>
				`;
			}

			// Update product info grid
			if (infoGrid && productInfoHTML) {
				infoGrid.innerHTML = productInfoHTML;
				infoGrid.style.display = 'grid';
			}

			priceInput.value = formatCurrency(unitPrice);
			promoDiv.innerHTML = promoText ? `<span class="promo-tag">üéÅ ${promoText}</span>` : '';
			totalInput.value = formatCurrency(unitPrice * qty);

			calculateTotals();
		}

		function calculateTotals() {
			const list = document.getElementById(`${currentTab}ItemList`);
			const rows = list.querySelectorAll('.item-row');
			// reset computed sums
			orderComputed.totalBoxes = 0;
			orderComputed.totalSupport = 0;
			orderComputed.totalPackages = 0;
			orderComputed.discountAmount = 0;
			orderComputed.totalAfterDiscount = 0;
			let total = 0;
			let count = 0;
			let totalKien = 0; // D√†nh cho Duraflex

			rows.forEach(row => {
				const sub = parseCurrency(row.querySelector('.p-total').value);
				console.log('Row subtotal:', sub); // Debug
				if (sub > 0) {
					total += sub;
					count++;

					if (currentTab === 'duraflex') {
						const pName = row.querySelector('.p-select').value;
						const product = products.duraflex.find(p => (p["t√™n s·∫£n ph·∫©m"] || p["ten_sp"] || p["T√™n s·∫£n ph·∫©m"]) === pName);
						if (product && (product["s·∫£n ph·∫©m ƒë∆∞·ª£c t√≠nh chi·∫øt kh·∫•u"] === "TRUE" || product["s·∫£n ph·∫©m ƒë∆∞·ª£c t√≠nh chi·∫øt kh·∫•u"] === true)) {
							const qty = parseInt(row.querySelector('.p-qty').value) || 0;
							const kien = parseInt(product["s·ªë t·∫•m trong 1 ki·ªán"] || product["s·ªë t·∫•m/ki·ªán"] || 1);
							totalKien += (qty / kien);
						}
					}

					// If we are in weber tab, count boxes for orderComputed
					if (currentTab === 'weber') {
						const pName = row.querySelector('.p-select').value;
						const product = products.weber.find(p => (p["t√™n s·∫£n ph·∫©m"] || p["ten_sp"] || p["T√™n s·∫£n ph·∫©m"]) === pName);
						if (product) {
							const bottlesPerBox = parseInt(product["s·ªë chai trong 1 th√πng"] || product["s·ªë chai/th√πng"] || 1);
							const qty = parseInt(row.querySelector('.p-qty').value) || 0;
							const boxes = Math.floor(qty / (bottlesPerBox || 1));
							orderComputed.totalBoxes += boxes;
							row.setAttribute('data-boxes', boxes);
						}
					}
				}
			});

			console.log('Total calculated:', total, 'Count:', count); // Debug

			// Update item count label and value based on current tab
			const countLabel = document.getElementById('summaryCountLabel');
			const countDisplay = document.getElementById('summaryCount');

			if (currentTab === 'duraflex') {
				countLabel.innerText = 'T·ªïng s·ªë ki·ªán trong ƒë∆°n:';
				countDisplay.innerText = totalKien.toFixed(2);
			} else {
				countLabel.innerText = 'S·ªë l∆∞·ª£ng m·∫∑t h√†ng:';
				countDisplay.innerText = count;
			}			// Duraflex Discount
			const discountRow = document.getElementById('duraflexDiscountRow');
			const grossRow = document.getElementById('grossTotalRow');
			const surplusRow = document.getElementById('pimaSurplusRow');
			const totalLabel = document.getElementById('summaryTotalLabel');
			let finalTotal = total; // Default to total

			if (currentTab === 'duraflex') {
				const discountOptions = document.getElementById('duraflexDiscountOptions');
				if (discountOptions) discountOptions.style.display = 'block';

				let totalCk = 0;

				if (duraflexDiscountMode === 'auto') {
					// 1. Auto Discount (Numeric packages only)
					const numericDiscounts = duraflexDiscounts.filter(d => /^[0-9]+$/.test(String(d["g√≥i chi·∫øt kh·∫•u theo ki·ªán"]).trim()));
					const applied = numericDiscounts.filter(d => parseInt(d["g√≥i chi·∫øt kh·∫•u theo ki·ªán"] || '0') <= Math.floor(totalKien));

					let autoCk = 0;
					if (applied && applied.length) {
						const best = applied.reduce((a, b) => parseInt(a["g√≥i chi·∫øt kh·∫•u theo ki·ªán"] || 0) > parseInt(b["g√≥i chi·∫øt kh·∫•u theo ki·ªán"] || 0) ? a : b);
						autoCk = parseInt(best["s·ªë ti·ªÅn chi·∫øt kh·∫•u"] || 0) || 0;
					}

					// 2. Special/Manual Promotions (Text based)
					const specialPromos = duraflexDiscounts.filter(d => !/^[0-9]+$/.test(String(d["g√≥i chi·∫øt kh·∫•u theo ki·ªán"]).trim()));
					updateSpecialPromoDropdown(specialPromos);

					let manualPromoCk = 0;
					if (manualDiscountId) {
						const chosen = specialPromos.find(d => String(d["g√≥i chi·∫øt kh·∫•u theo ki·ªán"]) === manualDiscountId);
						if (chosen) manualPromoCk = parseInt(chosen["s·ªë ti·ªÅn chi·∫øt kh·∫•u"] || 0);
					}
					totalCk = autoCk + manualPromoCk;
				} else {
					// Flexible/Manual Mode
					totalCk = manualFlexibleDiscount;
				}

				orderComputed.totalPackages = totalKien;
				orderComputed.discountAmount = totalCk;
				orderComputed.totalAfterDiscount = total - totalCk;

				if (totalCk > 0) {
					grossRow.style.display = 'flex';
					discountRow.style.display = 'flex';
					document.getElementById('summaryGross').innerText = formatCurrency(total);
					document.getElementById('summaryDiscount').innerText = `- ${formatCurrency(totalCk)}`;
					totalLabel.innerText = "S·ªê TI·ªÄN C√íN L·∫†I:";
					finalTotal = total - totalCk;
				} else {
					grossRow.style.display = 'none';
					discountRow.style.display = 'none';
					totalLabel.innerText = "T·ªîNG C·ªòNG:";
					finalTotal = total;
				}
				surplusRow.style.display = 'none';
			} else if (currentTab === 'pima') {
				// Pima Surplus Summary
				let totalSurplus = 0;
				rows.forEach(row => {
					totalSurplus += parseInt(row.getAttribute('data-surplus') || 0);
				});

				console.log('Pima total:', total, 'surplus:', totalSurplus); // Debug

				if (totalSurplus > 0) {
					grossRow.style.display = 'flex';
					surplusRow.style.display = 'flex';
					document.getElementById('summaryGross').innerText = formatCurrency(total);
					document.getElementById('summarySurplus').innerText = `- ${formatCurrency(totalSurplus)}`;
					totalLabel.innerText = "S·ªê TI·ªÄN C√íN L·∫†I:";
					finalTotal = total - totalSurplus;
					orderComputed.totalSupport = totalSurplus;
					orderComputed.totalAfterSupport = finalTotal;
				} else {
					grossRow.style.display = 'none';
					surplusRow.style.display = 'none';
					totalLabel.innerText = "T·ªîNG C·ªòNG:";
					finalTotal = total;
				}
				discountRow.style.display = 'none';
			} else {
				// Weber or no discount
				grossRow.style.display = 'none';
				surplusRow.style.display = 'none';
				discountRow.style.display = 'none';
				totalLabel.innerText = "T·ªîNG C·ªòNG:";
				finalTotal = total;
			}

			// If not duraflex, hide options
			if (currentTab !== 'duraflex') {
				const opts = document.getElementById('duraflexDiscountOptions');
				if (opts) opts.style.display = 'none';
			}

			console.log('Final total to display:', finalTotal); // Debug
			document.getElementById('summaryTotal').innerText = formatCurrency(finalTotal > 0 ? finalTotal : 0);
		}

		// --- HELPERS ---
		function formatCurrency(num) {
			if (num === null || num === undefined || isNaN(num)) return "0 ƒë";
			return new Intl.NumberFormat('vi-VN').format(Math.round(num)) + ' ƒë';
		}

		// H√†m ƒë·ªãnh d·∫°ng s·ªë khi ƒëang nh·∫≠p (kh√¥ng c√≥ ch·ªØ ƒë)
		function formatNumberInput(num) {
			if (num === null || num === undefined || isNaN(num)) return "0";
			return new Intl.NumberFormat('vi-VN').format(Math.round(num));
		}

		function parseCurrency(str) {
			if (!str) return 0;
			return parseInt(str.toString().replace(/[^0-9]/g, '')) || 0;
		}

		function handleSpecialPromoChange() {
			const sel = document.getElementById('selectSpecialPromo');
			manualDiscountId = sel.value === "none" ? null : sel.value;
			calculateTotals();
		}

		function setDiscountMode(mode) {
			duraflexDiscountMode = mode;
			const btnAuto = document.getElementById('btnDiscountAuto');
			const btnManual = document.getElementById('btnDiscountManual');
			const containerAuto = document.getElementById('duraflexAutoContainer');
			const containerManual = document.getElementById('duraflexManualContainer');

			if (mode === 'auto') {
				btnAuto.classList.add('active');
				btnManual.classList.remove('active');
				containerAuto.style.display = 'block';
				containerManual.style.display = 'none';
			} else {
				btnAuto.classList.remove('active');
				btnManual.classList.add('active');
				containerAuto.style.display = 'none';
				containerManual.style.display = 'block';

				// Initialize manual discount with auto discount if currently 0
				if (manualFlexibleDiscount === 0) {
					manualFlexibleDiscount = orderComputed.discountAmount || 0;
					const input = document.getElementById('inputFlexibleDiscount');
					if (input) input.value = formatCurrency(manualFlexibleDiscount).replace(' ƒë', '');
				}
			}
			calculateTotals();
		}

		function handleFlexibleDiscountInput(el) {
			const raw = el.value.replace(/[^0-9]/g, '');
			manualFlexibleDiscount = parseInt(raw) || 0;
			el.value = formatCurrency(manualFlexibleDiscount).replace(' ƒë', '');
			calculateTotals();
		}

		function updateSpecialPromoDropdown(promos) {
			const container = document.getElementById('duraflexPromoSelection');
			const select = document.getElementById('selectSpecialPromo');

			if (currentTab !== 'duraflex' || promos.length === 0) {
				container.style.display = 'none';
				return;
			}

			container.style.display = 'block';

			// Keep current selection if valid
			const currentVal = select.value;

			let html = '<option value="none">-- Kh√¥ng ch·ªçn khuy·∫øn m√£i b·ªï sung --</option>';
			promos.forEach(p => {
				const id = String(p["g√≥i chi·∫øt kh·∫•u theo ki·ªán"]);
				const amount = parseInt(p["s·ªë ti·ªÅn chi·∫øt kh·∫•u"] || 0);
				html += `<option value="${id}" ${id === manualDiscountId ? 'selected' : ''}>${id} (-${formatCurrency(amount)})</option>`;
			});

			select.innerHTML = html;
		}

		// --- SUBMISSION ---
		async function submitOrder() {
			console.log('Submit button clicked!'); // Debug
			console.log('Selected customer:', selectedCustomer); // Debug

			if (!selectedCustomer) { alert("Vui l√≤ng ch·ªçn kh√°ch h√†ng!"); return; }

			const list = document.getElementById(`${currentTab}ItemList`);
			const rows = list.querySelectorAll('.item-row');
			const items = [];

			rows.forEach(row => {
				const pName = row.querySelector('.p-select').value;
				const qty = parseInt(row.querySelector('.p-qty').value) || 0;
				const price = parseCurrency(row.querySelector('.p-price').value);
				const sub = parseCurrency(row.querySelector('.p-total').value);
				const promo = row.querySelector('.promo-tag') ? row.querySelector('.promo-tag').innerText : '';

				if (pName && qty > 0) {
					const deliveryToggle = row.querySelector('.delivery-toggle');
					const deliveryType = deliveryToggle ? (deliveryToggle.querySelector('.delivery-btn.active').innerText) : '';
					const surplus = parseInt(row.getAttribute('data-surplus') || 0);

					let boxes = 0;
					let packages = 0;

					if (currentTab === 'weber') {
						const product = products.weber.find(p => (p["t√™n s·∫£n ph·∫©m"] || p["ten_sp"] || p["T√™n s·∫£n ph·∫©m"]) === pName);
						if (product) {
							const bPerBox = parseInt(product["s·ªë chai trong 1 th√πng"] || product["s·ªë chai/th√πng"] || 1);
							boxes = qty / bPerBox;
						}
					} else if (currentTab === 'duraflex') {
						const product = products.duraflex.find(p => (p["t√™n s·∫£n ph·∫©m"] || p["ten_sp"] || p["T√™n s·∫£n ph·∫©m"]) === pName);
						if (product) {
							const sPerPackage = parseInt(product["s·ªë t·∫•m trong 1 ki·ªán"] || product["s·ªë t·∫•m/ki·ªán"] || 1);
							packages = qty / sPerPackage;
						}
					}

					items.push({
						name: pName,
						quantity: qty,
						unit_price: price,
						subtotal: sub,
						promo_note: promo,
						delivery_type: deliveryType,
						surplus: surplus,
						boxes: boxes,
						packages: packages,
						discount_amount: currentTab === 'duraflex' ? orderComputed.discountAmount : 0
					});
				}
			});

			console.log('Items collected:', items); // Debug

			if (items.length === 0) { alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m!"); return; }

			if (SCRIPT_URL === 'PASTE_YOUR_APPS_SCRIPT_URL_HERE') {
				alert("VUI L√íNG C·∫§U H√åNH SCRIPT_URL TRONG CODE TR∆Ø·ªöC!");
				console.log("D·ªØ li·ªáu ƒë∆°n h√†ng:", {
					customer: selectedCustomer,
					category: currentTab.toUpperCase(),
					items: items,
					total: parseCurrency(document.getElementById('summaryTotal').innerText),
					notes: document.getElementById('orderNotes').value
				});
				return;
			}

			const overlay = document.getElementById('loadingOverlay');
			overlay.style.display = 'flex';

			try {
				const payload = {
					action: isEditMode ? 'update_order' : 'add',
					orderId: isEditMode ? editOrderId : null,
					customer: selectedCustomer,
					category: currentTab.toUpperCase(),
					items: items,
					total: parseCurrency(document.getElementById('summaryTotal').innerText),
					notes: document.getElementById('orderNotes').value
				};

				// Attach computed metadata per category
				if (currentTab === 'duraflex') {
					payload.total_packages = orderComputed.totalPackages;
					payload.discount_total = orderComputed.discountAmount;
					payload.total_after_discount = orderComputed.totalAfterDiscount || payload.total;
				} else if (currentTab === 'weber') {
					payload.total_boxes = orderComputed.totalBoxes;
				} else if (currentTab === 'pima') {
					payload.total_support = orderComputed.totalSupport;
					payload.total_after_support = orderComputed.totalAfterSupport || payload.total;
				}

				console.log('Sending payload:', payload); // Debug

				// Send as application/x-www-form-urlencoded to avoid preflight CORS
				const form = new URLSearchParams();
				form.append('payload', JSON.stringify(payload));

				const res = await fetch(SCRIPT_URL, {
					method: 'POST',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
					body: form.toString()
				});

				if (!res.ok) {
					throw new Error('Network response was not ok: ' + res.statusText);
				}
				const json = await res.json();
				console.log('Response received:', json); // Debug
				if (json && json.result === 'success') {
					alert(isEditMode ? "ƒê√£ c·∫≠p nh·∫≠t ƒë∆°n h√†ng!" : `ƒê√£ g·ª≠i th√¥ng tin ƒë∆°n h√†ng! M√£: ${json.orderId}`);
					window.location.href = 'quan-ly-don-hang.html';
				} else {
					throw new Error((json && json.message) || 'Unknown error from server');
				}
			} catch (e) {
				console.error('Error submitting order:', e); // Debug
				alert("L·ªói khi g·ª≠i ƒë∆°n h√†ng: " + e.message);
			} finally {
				overlay.style.display = 'none';
			}
		}
	</script>

</body>

</html>