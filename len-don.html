<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>H·ªá Th·ªëng L√™n ƒê∆°n H√†ng - Premium</title>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
	<style>
		:root {
			--primary: #2d3436;
			--accent: #f1c40f;
			--success: #27ae60;
			--danger: #e74c3c;
			--bg: #f8f9fa;
			--card-bg: #ffffff;
			--border: #e9ecef;
			--text: #2d3436;
			--text-muted: #6c757d;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Inter', sans-serif;
		}

		body {
			background-color: var(--bg);
			color: var(--text);
			line-height: 1.6;
			padding: 20px;
		}

		.container {
			max-width: 1000px;
			margin: 0 auto;
		}

		/* Header */
		header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
			padding-bottom: 20px;
			border-bottom: 2px solid var(--accent);
		}

		.header-title h1 {
			font-size: 1.8rem;
			font-weight: 800;
			text-transform: uppercase;
			letter-spacing: -0.5px;
		}

		.header-title p {
			color: var(--text-muted);
			font-size: 0.9rem;
		}

		.home-link {
			text-decoration: none;
			color: var(--text);
			font-weight: 600;
			display: flex;
			align-items: center;
			gap: 8px;
			padding: 10px 15px;
			background: #fff;
			border-radius: 10px;
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
			transition: 0.3s;
		}

		.home-link:hover {
			transform: translateY(-2px);
			background: var(--accent);
		}

		/* Customer Search Section */
		.customer-card {
			background: var(--card-bg);
			padding: 25px;
			border-radius: 20px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
			margin-bottom: 25px;
			position: relative;
		}

		.form-group {
			margin-bottom: 15px;
			position: relative;
		}

		.form-group label {
			display: block;
			font-weight: 700;
			margin-bottom: 8px;
			font-size: 0.85rem;
			text-transform: uppercase;
			color: var(--text-muted);
		}

		.form-input {
			width: 100%;
			padding: 14px 20px;
			border: 2px solid var(--border);
			border-radius: 12px;
			font-size: 1rem;
			transition: 0.3s;
			background: #fbfbfb;
		}

		.form-input:focus {
			outline: none;
			border-color: var(--accent);
			background: #fff;
			box-shadow: 0 0 0 4px rgba(241, 196, 15, 0.1);
		}

		/* Autocomplete results */
		#customerResults {
			position: absolute;
			top: 100%;
			left: 0;
			right: 0;
			background: #fff;
			border-radius: 12px;
			box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
			z-index: 100;
			max-height: 250px;
			overflow-y: auto;
			display: none;
		}

		.result-item {
			padding: 12px 20px;
			cursor: pointer;
			border-bottom: 1px solid var(--border);
			transition: 0.2s;
		}

		.result-item:hover {
			background: #f8f9fa;
		}

		.result-item .cust-name {
			font-weight: 700;
			display: block;
		}

		.result-item .cust-info {
			font-size: 0.8rem;
			color: var(--text-muted);
		}

		.selected-customer-box {
			display: none;
			background: #fff8e1;
			padding: 15px;
			border-left: 5px solid var(--accent);
			border-radius: 10px;
			margin-bottom: 15px;
			justify-content: space-between;
			align-items: center;
		}

		/* Order Form Tabs */
		.order-section {
			display: none;
		}

		.order-section.active {
			display: block;
		}

		.tabs-container {
			display: flex;
			gap: 10px;
			margin-bottom: 20px;
		}

		.tab-btn {
			flex: 1;
			padding: 15px;
			border: none;
			background: #fff;
			border-radius: 12px;
			font-weight: 700;
			cursor: pointer;
			transition: 0.3s;
			color: var(--text-muted);
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
		}

		.tab-btn.active {
			background: var(--primary);
			color: var(--accent);
		}

		.tab-btn[data-tab="weber"].active {
			background: #000;
			color: #ffce00;
		}

		.tab-btn[data-tab="pima"].active {
			background: #ffce00;
			color: #000;
		}

		.tab-btn[data-tab="duraflex"].active {
			background: #1a8e44;
			color: #fff;
		}

		.form-card {
			background: var(--card-bg);
			padding: 30px;
			border-radius: 20px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
		}

		/* Item Row */
		.item-list {
			margin-bottom: 20px;
		}

		.item-row {
			display: grid;
			grid-template-columns: 2fr 1fr 1fr 1.2fr 0.5fr;
			gap: 15px;
			margin-bottom: 15px;
			align-items: end;
			border-bottom: 1px dashed var(--border);
			padding-bottom: 15px;
		}

		.item-row:last-child {
			border-bottom: none;
		}

		.add-item-btn {
			background: #f1f2f6;
			border: 2px dashed #ccc;
			width: 100%;
			padding: 12px;
			border-radius: 12px;
			cursor: pointer;
			font-weight: 700;
			color: var(--text-muted);
			margin-bottom: 20px;
			transition: 0.3s;
		}

		.add-item-btn:hover {
			background: #e9ecef;
			border-color: var(--primary);
			color: var(--primary);
		}

		/* Summary Section */
		.order-summary {
			background: #f8fafc;
			padding: 20px;
			border-radius: 15px;
			margin-top: 20px;
		}

		.summary-row {
			display: flex;
			justify-content: space-between;
			margin-bottom: 10px;
			font-weight: 500;
		}

		.summary-total {
			font-size: 1.4rem;
			font-weight: 800;
			color: var(--primary);
			border-top: 2px solid var(--accent);
			padding-top: 10px;
			margin-top: 10px;
		}

		.submit-order-btn {
			width: 100%;
			padding: 20px;
			background: var(--primary);
			color: var(--accent);
			border: none;
			border-radius: 15px;
			font-size: 1.2rem;
			font-weight: 800;
			text-transform: uppercase;
			cursor: pointer;
			margin-top: 25px;
			box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
			transition: 0.3s;
		}

		.submit-order-btn:hover {
			transform: translateY(-3px);
			box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
		}

		.submit-order-btn:disabled {
			background: #ccc;
			cursor: not-allowed;
			transform: none;
		}

		.btn-remove {
			background: #fff;
			border: 1px solid var(--danger);
			color: var(--danger);
			width: 40px;
			height: 40px;
			border-radius: 10px;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.btn-remove:hover {
			background: var(--danger);
			color: #fff;
		}

		.promo-tag {
			display: inline-block;
			padding: 4px 10px;
			background: #e3f2fd;
			color: #1976d2;
			border-radius: 6px;
			font-size: 0.75rem;
			font-weight: 700;
			margin-top: 5px;
		}

		/* Loading Overlay */
		#loadingOverlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(255, 255, 255, 0.9);
			z-index: 1000;
			display: none;
			flex-direction: column;
			align-items: center;
			justify-content: center;
		}

		.spinner {
			width: 50px;
			height: 50px;
			border: 5px solid #f3f3f3;
			border-top: 5px solid var(--accent);
			border-radius: 50%;
			animation: spin 1s linear infinite;
			margin-bottom: 20px;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		/* Mobile Adjustments */
		@media (max-width: 768px) {
			.item-row {
				grid-template-columns: 1fr 1fr;
			}

			.item-row div:first-child {
				grid-column: 1 / -1;
			}

			.item-row div:last-child {
				grid-column: 1 / -1;
				display: flex;
				justify-content: flex-end;
			}
		}

		/* Delivery Toggle Styles */
		.delivery-toggle {
			display: flex;
			gap: 5px;
			margin-top: 8px;
		}

		.delivery-btn {
			flex: 1;
			padding: 8px 5px;
			border: 1px solid var(--border);
			background: #f1f2f6;
			border-radius: 8px;
			font-size: 0.75rem;
			font-weight: 700;
			cursor: pointer;
			transition: 0.3s;
			text-align: center;
		}

		.delivery-btn.active {
			background: var(--accent);
			color: #000;
			border-color: var(--accent);
		}

		.surplus-info {
			font-size: 0.8rem;
			color: #e67e22;
			font-weight: 600;
			margin-top: 5px;
		}
	</style>
</head>

<body>

	<div id="loadingOverlay">
		<div class="spinner"></div>
		<h2 id="loadingText">ƒêang x·ª≠ l√Ω ƒë∆°n h√†ng...</h2>
	</div>

	<div class="container">
		<header>
			<div class="header-title">
				<h1>H·ªá Th·ªëng L√™n ƒê∆°n</h1>
				<p>T·∫°o ƒë∆°n h√†ng th√¥ng minh cho Weber - Pima - Duraflex</p>
			</div>
			<a href="index.html" class="home-link">
				<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
					<polyline points="9 22 9 12 15 12 15 22"></polyline>
				</svg>
				Trang ch·ªß
			</a>
		</header>

		<!-- Kh√°ch H√†ng Section -->
		<div class="customer-card">
			<div class="form-group" id="customerSearchGroup">
				<label>Ch·ªçn Kh√°ch H√†ng</label>
				<input type="text" id="customerInput" class="form-input" placeholder="Nh·∫≠p t√™n ho·∫∑c m√£ kh√°ch h√†ng..."
					autocomplete="off">
				<div id="customerResults"></div>
			</div>

			<div id="selectedCustomerBox" class="selected-customer-box">
				<div>
					<strong id="selectedCustName" style="font-size: 1.1rem; color: var(--text);"></strong>
					<div id="selectedCustType" style="color: var(--text-muted); font-size: 0.9rem;"></div>
				</div>
				<button class="btn-remove" onclick="resetCustomer()" title="Ch·ªçn l·∫°i">
					<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M18 6L6 18M6 6l12 12"></path>
					</svg>
				</button>
			</div>
		</div>

		<!-- Order Tabs -->
		<div class="tabs-container">
			<button class="tab-btn active" data-tab="weber" onclick="switchTab('weber')">SILICONE WEBER</button>
			<button class="tab-btn" data-tab="pima" onclick="switchTab('pima')">TR·∫¶N NANO PIMA</button>
			<button class="tab-btn" data-tab="duraflex" onclick="switchTab('duraflex')">T·∫§M DURAFLEX</button>
		</div>

		<!-- Weber Section -->
		<div id="weberSection" class="order-section active form-card">
			<h3 style="margin-bottom: 20px;">ƒê∆°n h√†ng Silicone Weber</h3>
			<div id="weberItemList" class="item-list"></div>
			<button class="add-item-btn" onclick="addItemRow('weber')">+ TH√äM S·∫¢N PH·∫®M WEBER</button>
		</div>

		<!-- Pima Section -->
		<div id="pimaSection" class="order-section form-card">
			<h3 style="margin-bottom: 20px;">ƒê∆°n h√†ng Pima Nano</h3>
			<div id="pimaItemList" class="item-list"></div>
			<button class="add-item-btn" onclick="addItemRow('pima')">+ TH√äM S·∫¢N PH·∫®M PIMA</button>
		</div>

		<!-- Duraflex Section -->
		<div id="duraflexSection" class="order-section form-card">
			<h3 style="margin-bottom: 20px;">ƒê∆°n h√†ng T·∫•m Duraflex</h3>
			<div id="duraflexItemList" class="item-list"></div>
			<button class="add-item-btn" onclick="addItemRow('duraflex')">+ TH√äM S·∫¢N PH·∫®M DURAFLEX</button>
		</div>

		<!-- Summary & Submit -->
		<div class="form-card" style="margin-top: 25px;">
			<div class="form-group">
				<label>Ghi ch√∫ ƒë∆°n h√†ng</label>
				<textarea id="orderNotes" class="form-input" style="height: 80px; resize: none;"
					placeholder="Nh·∫≠p y√™u c·∫ßu ƒë·∫∑c bi·ªát, ƒë·ªãa ch·ªâ giao h√†ng..."></textarea>
			</div>

			<div class="order-summary">
				<div class="summary-row">
					<span id="summaryCountLabel">S·ªë l∆∞·ª£ng m·∫∑t h√†ng:</span>
					<span id="summaryCount">0</span>
				</div>
				<div class="summary-row" id="grossTotalRow" style="display: none; color: var(--text-muted);">
					<span>T·ªïng gi√° tr·ªã (Gi√° ch√†nh):</span>
					<span id="summaryGross">0 ƒë</span>
				</div>
				<div class="summary-row" id="pimaSurplusRow" style="display: none; color: #e67e22; font-weight: 700;">
					<span>H·ªó tr·ª£ v·∫≠n chuy·ªÉn:</span>
					<span id="summarySurplus">0 ƒë</span>
				</div>
				<div class="summary-row" id="duraflexDiscountRow"
					style="display: none; color: var(--success); font-weight: 700;">
					<span>Chi·∫øt kh·∫•u Duraflex:</span>
					<span id="summaryDiscount">0 ƒë</span>
				</div>
				<div class="summary-row summary-total">
					<span id="summaryTotalLabel">T·ªîNG C·ªòNG:</span>
					<span id="summaryTotal">0 ƒë</span>
				</div>
			</div>

			<button id="submitOrderBtn" class="submit-order-btn" onclick="submitOrder()">
				X√ÅC NH·∫¨N & L√äN ƒê∆†N
			</button>
		</div>
	</div>

	<script>
		// --- APP CONFIG ---
		const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIHfOV9rW_GQ8_Xv-WWA3KAqPMONiZQPDdOdNOcYmMSMlt93KG3zZJ7Z53OJ-d-LIJZg/exec';
		// N·∫øu ch∆∞a c√≥ URL Apps Script, d√πng URL n√†y ƒë·ªÉ test log
		// 'https://script.google.com/macros/s/AKfycby_...'

		let customers = [];
		let products = { weber: [], pima: [], duraflex: [] };
		let selectedCustomer = null;
		let currentTab = 'weber';
		let duraflexDiscounts = [];
		// computed summary values to send to backend
		let orderComputed = { totalBoxes: 0, totalSupport: 0, totalPackages: 0, discountAmount: 0, totalAfterDiscount: 0 };

		// --- INITIALIZATION ---
		let isEditMode = false;
		let editOrderId = null;

		document.addEventListener('DOMContentLoaded', async () => {
			await loadInitialData();
			setupCustomerSearch();

			// Ki·ªÉm tra xem c√≥ ƒëang ·ªü ch·∫ø ƒë·ªô s·ª≠a kh√¥ng
			const editData = localStorage.getItem('editingOrder');
			if (editData) {
				setupEditMode(JSON.parse(editData));
			} else {
				addItemRow('weber'); // Add first row by default
			}
		});

		function setupEditMode(order) {
			isEditMode = true;
			editOrderId = order.id;
			localStorage.removeItem('editingOrder'); // X√≥a sau khi ƒë√£ l·∫•y d·ªØ li·ªáu

			document.querySelector('h1').innerText = "Ch·ªânh S·ª≠a ƒê∆°n H√†ng";
			document.getElementById('submitOrderBtn').innerText = "C·∫¨P NH·∫¨T ƒê∆†N H√ÄNG";

			// Select Customer
			const cust = customers.find(c => c.name === order.customer);
			if (cust) selectCustomer(cust.id_name);

			// Switch Tab
			switchTab(order.category.toLowerCase());

			// Populate Items
			const list = document.getElementById(`${currentTab}ItemList`);
			list.innerHTML = '';

			order.items.forEach(item => {
				const rowId = Date.now() + Math.random();
				const row = createRowElement(currentTab, rowId);
				list.appendChild(row);

				const sel = row.querySelector('.p-select');
				sel.value = item.name;
				row.querySelector('.p-qty').value = item.qty;
				updateRow(currentTab, rowId);
			});

			document.getElementById('orderNotes').value = order.notes || '';
			calculateTotals();
		}

		function createRowElement(tab, rowId) {
			const row = document.createElement('div');
			row.className = 'item-row';
			row.id = `row-${rowId}`;
			let options = `<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>`;
			products[tab].forEach(p => {
				const name = p["t√™n s·∫£n ph·∫©m"] || p["ten_sp"] || p["T√™n s·∫£n ph·∫©m"];
				options += `<option value="${name}">${name}</option>`;
			});
			row.innerHTML = `
            <div>
                <label>S·∫£n ph·∫©m</label>
                <select class="form-input p-select" onchange="updateRow('${tab}', ${rowId})">
                    ${options}
                </select>
                <div class="promo-info" id="promo-${rowId}"></div>
                ${tab === 'pima' ? `
                    <div class="delivery-toggle" id="delivery-toggle-${rowId}">
                        <button class="delivery-btn active" onclick="setDeliveryType('${rowId}', 'chanh')">Ra Ch√†nh</button>
                        <button class="delivery-btn" onclick="setDeliveryType('${rowId}', 'kho')">T·∫°i Kho</button>
                    </div>
                ` : ''}
            </div>
            <div>
                <label>S·ªë l∆∞·ª£ng</label>
                <input type="number" class="form-input p-qty" value="1" min="1" oninput="updateRow('${tab}', ${rowId})">
                <div class="surplus-info" id="surplus-${rowId}"></div>
            </div>
            <div>
                <label>ƒê∆°n gi√°</label>
                <input type="text" class="form-input p-price" readonly style="background:#eee">
            </div>
            <div>
                <label>Th√†nh ti·ªÅn</label>
                <input type="text" class="form-input p-total" readonly style="background:#fff8e1; font-weight:800; color:var(--primary)">
            </div>
            <div>
                <button class="btn-remove" onclick="removeRow(${rowId})">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        `;
			return row;
		}

		function addItemRow(tab) {
			const list = document.getElementById(`${tab}ItemList`);
			const rowId = Date.now();
			list.appendChild(createRowElement(tab, rowId));
		}

		async function loadInitialData() {
			try {
				const [custRes, pimaRes, weberRes, duraRes, duraCkRes] = await Promise.all([
					fetch('data/gia_khach_hang.json').then(r => r.json()),
					fetch('data/gia_web_nano.json').then(r => r.json()),
					fetch('data/gia_silicon_weber.json').then(r => r.json()),
					fetch('data/gia_duraflex.json').then(r => r.json()),
					fetch('data/chiet_khau_duraflex.json').then(r => r.json())
				]);

				customers = custRes;
				products.pima = pimaRes;
				products.weber = weberRes;
				products.duraflex = duraRes;
				duraflexDiscounts = duraCkRes;
			} catch (e) {
				console.error("L·ªói load data:", e);
			}
		}

		// --- CUSTOMER LOGIC ---
		function setupCustomerSearch() {
			const input = document.getElementById('customerInput');
			const results = document.getElementById('customerResults');

			input.addEventListener('input', (e) => {
				const val = e.target.value.toLowerCase().trim();
				if (!val) { results.style.display = 'none'; return; }

				const filtered = customers.filter(c =>
					c.name.toLowerCase().includes(val) || (c.id_name && c.id_name.toLowerCase().includes(val))
				).slice(0, 10);

				if (filtered.length > 0) {
					results.innerHTML = filtered.map(c => `
                    <div class="result-item" onclick="selectCustomer('${c.id_name}')">
                        <span class="cust-name">${c.name}</span>
                        <span class="cust-info">${c.phan_loai} | ${c.mail || 'Kh√¥ng c√≥ mail'}</span>
                    </div>
                `).join('');
					results.style.display = 'block';
				} else {
					results.style.display = 'none';
				}
			});

			document.addEventListener('click', (e) => {
				if (!input.contains(e.target)) results.style.display = 'none';
			});
		}

		function selectCustomer(id) {
			selectedCustomer = customers.find(c => c.id_name === id);
			document.getElementById('customerSearchGroup').style.display = 'none';
			document.getElementById('selectedCustName').innerText = selectedCustomer.name;
			document.getElementById('selectedCustType').innerText = selectedCustomer.phan_loai;
			document.getElementById('selectedCustomerBox').style.display = 'flex';
			document.getElementById('customerResults').style.display = 'none';
		}

		function resetCustomer() {
			selectedCustomer = null;
			document.getElementById('customerSearchGroup').style.display = 'block';
			document.getElementById('selectedCustomerBox').style.display = 'none';
			document.getElementById('customerInput').value = '';
		}

		// --- TAB LOGIC ---
		function switchTab(tabId) {
			currentTab = tabId;
			document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
			document.querySelector(`.tab-btn[data-tab="${tabId}"]`).classList.add('active');

			document.querySelectorAll('.order-section').forEach(sec => sec.classList.remove('active'));
			document.getElementById(`${tabId}Section`).classList.add('active');

			// N·∫øu tab tr·ªëng, th√™m 1 d√≤ng
			if (document.getElementById(`${tabId}ItemList`).children.length === 0) {
				addItemRow(tabId);
			}

			calculateTotals();
		}

		// --- ITEM LOGIC ---
		// addItemRow function is now defined above, using createRowElement

		function setDeliveryType(rowId, type) {
			const container = document.getElementById(`delivery-toggle-${rowId}`);
			if (!container) return;
			const buttons = container.querySelectorAll('.delivery-btn');
			buttons.forEach(btn => btn.classList.remove('active'));

			const activeBtn = Array.from(buttons).find(btn =>
				(btn.innerText.toLowerCase().includes('kho') && type === 'kho') ||
				(btn.innerText.toLowerCase().includes('chanh') && type === 'chanh')
			);
			if (activeBtn) activeBtn.classList.add('active');

			updateRow('pima', rowId);
		}

		function removeRow(rowId) {
			const row = document.getElementById(`row-${rowId}`);
			if (row) row.remove();
			calculateTotals();
		}

		function updateRow(tab, rowId) {
			const row = document.getElementById(`row-${rowId}`);
			const pName = row.querySelector('.p-select').value;
			const qty = parseInt(row.querySelector('.p-qty').value) || 0;
			const priceInput = row.querySelector('.p-price');
			const promoDiv = row.querySelector(`#promo-${rowId}`);
			const totalInput = row.querySelector('.p-total');

			if (!pName) {
				priceInput.value = '';
				totalInput.value = '';
				promoDiv.innerHTML = '';
				return;
			}

			const product = products[tab].find(p => (p["t√™n s·∫£n ph·∫©m"] || p["ten_sp"] || p["T√™n s·∫£n ph·∫©m"]) === pName);
			let unitPrice = 0;
			let promoText = '';

			if (tab === 'weber') {
				// Weber: ∆Øu ti√™n gi√° ni√™m y·∫øt
				unitPrice = parseCurrency(product["gi√° ni√™m y·∫øt theo chai"] || product["gia_niem_yet"] || product["gi√° ni√™m y·∫øt"] || "0");
				// Promotion logic: Mua X t·∫∑ng Y
				// Gi·∫£ ƒë·ªãnh: km_1_thung: "T·∫∑ng 1 s√∫ng", km_3_thung: "Mua 3 t·∫∑ng 1"
				const thung = Math.floor(qty / (parseInt(product["s·ªë chai trong 1 th√πng"] || product["s·ªë chai/th√πng"] || 24)));
				if (thung >= 3 && (product["khuy·∫øn m√£i 3 th√πng"] || product["km_3_thung"])) promoText = product["khuy·∫øn m√£i 3 th√πng"] || product["km_3_thung"];
				else if (thung >= 2 && (product["khuy·∫øn m√£i 2 th√πng"] || product["km_2_thung"])) promoText = product["khuy·∫øn m√£i 2 th√πng"] || product["km_2_thung"];
				else if (thung >= 1 && (product["khuy·∫øn m√£i 1 th√πng"] || product["km_1_thung"])) promoText = product["khuy·∫øn m√£i 1 th√πng"] || product["km_1_thung"];
			} else if (tab === 'duraflex') {
				unitPrice = parseCurrency(product["gi√° ni√™m y·∫øt"] || product["gia_niem_yet"] || "0");
			} else {
				const priceChanh = parseCurrency(product["gi√° ra ch√†nh"] || product["gia_ra_chanh"] || product["gi√° hcm"] || "0");
				const priceKho = parseCurrency(product["gi√° t·∫°i kho"] || product["gia_tai_kho"] || priceChanh);

				const toggle = document.getElementById(`delivery-toggle-${rowId}`);
				const isKho = toggle && toggle.querySelector('.delivery-btn.active').innerText.toLowerCase().includes('kho');

				unitPrice = isKho ? priceKho : priceChanh;

				if (isKho) {
					const diff = priceChanh - priceKho;
					const surplus = diff * qty;
					if (surplus > 0) {
						row.querySelector(`#surplus-${rowId}`).innerText = `Ph·∫ßn d∆∞: +${formatCurrency(surplus)}`;
						row.setAttribute('data-surplus', surplus);
					} else {
						row.querySelector(`#surplus-${rowId}`).innerText = '';
						row.removeAttribute('data-surplus');
					}
				} else {
					row.querySelector(`#surplus-${rowId}`).innerText = '';
					row.removeAttribute('data-surplus');
				}
			}

			priceInput.value = formatCurrency(unitPrice);
			promoDiv.innerHTML = promoText ? `<span class="promo-tag">üéÅ ${promoText}</span>` : '';
			totalInput.value = formatCurrency(unitPrice * qty);

			calculateTotals();
		}

		function calculateTotals() {
			const list = document.getElementById(`${currentTab}ItemList`);
			const rows = list.querySelectorAll('.item-row');
			// reset computed sums
			orderComputed.totalBoxes = 0;
			orderComputed.totalSupport = 0;
			orderComputed.totalPackages = 0;
			orderComputed.discountAmount = 0;
			orderComputed.totalAfterDiscount = 0;
			let total = 0;
			let count = 0;
			let totalKien = 0; // D√†nh cho Duraflex

			rows.forEach(row => {
				const sub = parseCurrency(row.querySelector('.p-total').value);
				console.log('Row subtotal:', sub); // Debug
				if (sub > 0) {
					total += sub;
					count++;

					if (currentTab === 'duraflex') {
						const pName = row.querySelector('.p-select').value;
						const product = products.duraflex.find(p => (p["t√™n s·∫£n ph·∫©m"] || p["ten_sp"] || p["T√™n s·∫£n ph·∫©m"]) === pName);
						if (product && (product["s·∫£n ph·∫©m ƒë∆∞·ª£c t√≠nh chi·∫øt kh·∫•u"] === "TRUE" || product["s·∫£n ph·∫©m ƒë∆∞·ª£c t√≠nh chi·∫øt kh·∫•u"] === true)) {
							const qty = parseInt(row.querySelector('.p-qty').value) || 0;
							const kien = parseInt(product["s·ªë t·∫•m trong 1 ki·ªán"] || product["s·ªë t·∫•m/ki·ªán"] || 1);
							totalKien += (qty / kien);
						}
					}

					// If we are in weber tab, count boxes for orderComputed
					if (currentTab === 'weber') {
						const pName = row.querySelector('.p-select').value;
						const product = products.weber.find(p => (p["t√™n s·∫£n ph·∫©m"] || p["ten_sp"] || p["T√™n s·∫£n ph·∫©m"]) === pName);
						if (product) {
							const bottlesPerBox = parseInt(product["s·ªë chai trong 1 th√πng"] || product["s·ªë chai/th√πng"] || 1);
							const qty = parseInt(row.querySelector('.p-qty').value) || 0;
							const boxes = Math.floor(qty / (bottlesPerBox || 1));
							orderComputed.totalBoxes += boxes;
							row.setAttribute('data-boxes', boxes);
						}
					}
				}
			});

		console.log('Total calculated:', total, 'Count:', count); // Debug

		// Update item count label and value based on current tab
		const countLabel = document.getElementById('summaryCountLabel');
		const countDisplay = document.getElementById('summaryCount');
		
		if (currentTab === 'duraflex') {
			countLabel.innerText = 'T·ªïng s·ªë ki·ªán trong ƒë∆°n:';
			countDisplay.innerText = totalKien.toFixed(2);
		} else {
			countLabel.innerText = 'S·ªë l∆∞·ª£ng m·∫∑t h√†ng:';
			countDisplay.innerText = count;
		}			// Duraflex Discount
			const discountRow = document.getElementById('duraflexDiscountRow');
			const grossRow = document.getElementById('grossTotalRow');
			const surplusRow = document.getElementById('pimaSurplusRow');
			const totalLabel = document.getElementById('summaryTotalLabel');
			let finalTotal = total; // Default to total

			if (currentTab === 'duraflex') {
				// choose the best discount where g√≥i chi·∫øt kh·∫•u theo ki·ªán <= totalKien
				const applied = duraflexDiscounts.filter(d => parseInt(d["g√≥i chi·∫øt kh·∫•u theo ki·ªán"] || '0') <= Math.floor(totalKien));
				let ckAmount = 0;
				if (applied && applied.length) {
					const best = applied.reduce((a, b) => parseInt(a["g√≥i chi·∫øt kh·∫•u theo ki·ªán"] || 0) > parseInt(b["g√≥i chi·∫øt kh·∫•u theo ki·ªán"] || 0) ? a : b);
					ckAmount = parseInt(best["s·ªë ti·ªÅn chi·∫øt kh·∫•u"] || 0) || 0;
				}

				orderComputed.totalPackages = totalKien;
				orderComputed.discountAmount = ckAmount;
				orderComputed.totalAfterDiscount = total - ckAmount;

				if (ckAmount > 0) {
					grossRow.style.display = 'flex';
					discountRow.style.display = 'flex';
					document.getElementById('summaryGross').innerText = formatCurrency(total);
					document.getElementById('summaryDiscount').innerText = `- ${formatCurrency(ckAmount)}`;
					totalLabel.innerText = "S·ªê TI·ªÄN C√íN L·∫†I:";
					finalTotal = total - ckAmount;
				} else {
					grossRow.style.display = 'none';
					discountRow.style.display = 'none';
					totalLabel.innerText = "T·ªîNG C·ªòNG:";
					finalTotal = total;
				}
				surplusRow.style.display = 'none';
			} else if (currentTab === 'pima') {
				// Pima Surplus Summary
				let totalSurplus = 0;
				rows.forEach(row => {
					totalSurplus += parseInt(row.getAttribute('data-surplus') || 0);
				});

				console.log('Pima total:', total, 'surplus:', totalSurplus); // Debug

				if (totalSurplus > 0) {
					grossRow.style.display = 'flex';
					surplusRow.style.display = 'flex';
					document.getElementById('summaryGross').innerText = formatCurrency(total + totalSurplus);
					document.getElementById('summarySurplus').innerText = `- ${formatCurrency(totalSurplus)}`;
					totalLabel.innerText = "S·ªê TI·ªÄN C√íN L·∫†I:";
					finalTotal = total; // S·ªë ti·ªÅn c√≤n l·∫°i = total (ƒë√£ t√≠nh theo gi√° kho)
					orderComputed.totalSupport = totalSurplus;
					orderComputed.totalAfterSupport = finalTotal;
				} else {
					grossRow.style.display = 'none';
					surplusRow.style.display = 'none';
					totalLabel.innerText = "T·ªîNG C·ªòNG:";
					finalTotal = total; // Ensure finalTotal is set even when no surplus
				}
				discountRow.style.display = 'none';
			} else {
				// Weber or no discount
				grossRow.style.display = 'none';
				surplusRow.style.display = 'none';
				discountRow.style.display = 'none';
				totalLabel.innerText = "T·ªîNG C·ªòNG:";
				finalTotal = total;
			}

			console.log('Final total to display:', finalTotal); // Debug
			document.getElementById('summaryTotal').innerText = formatCurrency(finalTotal > 0 ? finalTotal : 0);
		}

		// --- HELPERS ---
		function formatCurrency(num) {
			if (!num) return "";
			return new Intl.NumberFormat('vi-VN').format(num) + ' ƒë';
		}

		function parseCurrency(str) {
			if (!str) return 0;
			return parseInt(str.toString().replace(/[^0-9]/g, '')) || 0;
		}

		// --- SUBMISSION ---
		async function submitOrder() {
			console.log('Submit button clicked!'); // Debug
			console.log('Selected customer:', selectedCustomer); // Debug

			if (!selectedCustomer) { alert("Vui l√≤ng ch·ªçn kh√°ch h√†ng!"); return; }

			const list = document.getElementById(`${currentTab}ItemList`);
			const rows = list.querySelectorAll('.item-row');
			const items = [];

			rows.forEach(row => {
				const pName = row.querySelector('.p-select').value;
				const qty = parseInt(row.querySelector('.p-qty').value) || 0;
				const price = parseCurrency(row.querySelector('.p-price').value);
				const sub = parseCurrency(row.querySelector('.p-total').value);
				const promo = row.querySelector('.promo-tag') ? row.querySelector('.promo-tag').innerText : '';

				if (pName && qty > 0) {
					const deliveryToggle = row.querySelector('.delivery-toggle');
					const deliveryType = deliveryToggle ? (deliveryToggle.querySelector('.delivery-btn.active').innerText) : '';
					const surplus = parseInt(row.getAttribute('data-surplus') || 0);

					items.push({
						name: pName,
						quantity: qty,
						unit_price: price,
						subtotal: sub,
						promo_note: promo,
						delivery_type: deliveryType,
						surplus: surplus
					});
				}
			});

			console.log('Items collected:', items); // Debug

			if (items.length === 0) { alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m!"); return; }

			if (SCRIPT_URL === 'PASTE_YOUR_APPS_SCRIPT_URL_HERE') {
				alert("VUI L√íNG C·∫§U H√åNH SCRIPT_URL TRONG CODE TR∆Ø·ªöC!");
				console.log("D·ªØ li·ªáu ƒë∆°n h√†ng:", {
					customer: selectedCustomer,
					category: currentTab.toUpperCase(),
					items: items,
					total: parseCurrency(document.getElementById('summaryTotal').innerText),
					notes: document.getElementById('orderNotes').value
				});
				return;
			}

			const overlay = document.getElementById('loadingOverlay');
			overlay.style.display = 'flex';

			try {
				const payload = {
					action: isEditMode ? 'update_order' : 'add',
					orderId: isEditMode ? editOrderId : null,
					customer: selectedCustomer,
					category: currentTab.toUpperCase(),
					items: items,
					total: parseCurrency(document.getElementById('summaryTotal').innerText),
					notes: document.getElementById('orderNotes').value
				};

				// Attach computed metadata per category
				if (currentTab === 'duraflex') {
					payload.total_packages = orderComputed.totalPackages;
					payload.discount_total = orderComputed.discountAmount;
					payload.total_after_discount = orderComputed.totalAfterDiscount || payload.total;
				} else if (currentTab === 'weber') {
					payload.total_boxes = orderComputed.totalBoxes;
				} else if (currentTab === 'pima') {
					payload.total_support = orderComputed.totalSupport;
					payload.total_after_support = orderComputed.totalAfterSupport || payload.total;
				}

				console.log('Sending payload:', payload); // Debug

				// Send as application/x-www-form-urlencoded to avoid preflight CORS
				const form = new URLSearchParams();
				form.append('payload', JSON.stringify(payload));

				const res = await fetch(SCRIPT_URL, {
					method: 'POST',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
					body: form.toString()
				});

				if (!res.ok) {
					throw new Error('Network response was not ok: ' + res.statusText);
				}
				const json = await res.json();
				console.log('Response received:', json); // Debug
				if (json && json.result === 'success') {
					alert(isEditMode ? "ƒê√£ c·∫≠p nh·∫≠t ƒë∆°n h√†ng!" : `ƒê√£ g·ª≠i th√¥ng tin ƒë∆°n h√†ng! M√£: ${json.orderId}`);
					window.location.href = 'quan-ly-don-hang.html';
				} else {
					throw new Error((json && json.message) || 'Unknown error from server');
				}
			} catch (e) {
				console.error('Error submitting order:', e); // Debug
				alert("L·ªói khi g·ª≠i ƒë∆°n h√†ng: " + e.message);
			} finally {
				overlay.style.display = 'none';
			}
		}
	</script>

</body>

</html>