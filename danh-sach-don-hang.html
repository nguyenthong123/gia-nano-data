<!DOCTYPE html>
<html lang="vi">

<head>
	<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-QFQ2HMYTDH"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push(arguments); }
		gtag('js', new Date());

		gtag('config', 'G-QFQ2HMYTDH');
	</script>

	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/svg+xml"
		href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23FACC15'/><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' fill='white' font-size='60' font-family='sans-serif' font-weight='800'>DV</text></svg>">
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@600;800&display=swap"
		rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script src="security-utils.js"></script>
	<script src="assets/theme-toggle.js"></script>
	<script>
		const session = SecurityProvider.validateAccess();
		const currentUser = session ? session.user : null;
	</script>
	<link rel="stylesheet" href="assets/theme.css">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
			text-rendering: optimizeLegibility;
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
			font-weight: 500;
		}

		body {
			background-color: var(--bg-body);
			color: var(--text-main);
			min-height: 100vh;
			padding: 20px;
			-webkit-text-size-adjust: 100%;
			background-image: var(--bg-gradient-1), var(--bg-gradient-2);
			background-attachment: fixed;
		}

		.container {
			max-width: 1200px;
			margin: 20px auto;
		}

		.header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 20px;
		}

		.header h1 {
			font-size: 2rem;
			font-weight: 800;
			color: #0f172a;
			margin: 0;
			letter-spacing: -0.5px;
		}

		/* Tabs */
		.tabs-nav {
			display: flex;
			gap: 10px;
			margin-bottom: 25px;
			background: white;
			padding: 5px;
			border-radius: 12px;
			border: 1px solid var(--glass-border);
			width: fit-content;
		}

		.tab-btn {
			padding: 10px 24px;
			border-radius: 8px;
			border: none;
			background: transparent;
			color: var(--text-muted);
			font-weight: 700;
			cursor: pointer;
			transition: 0.3s;
		}

		.tab-btn.active {
			background: var(--primary);
			color: #0f172a !important;
			box-shadow: 0 4px 12px rgba(250, 204, 21, 0.4);
		}

		.content-section {
			display: none;
		}

		.content-section.active {
			display: block;
			animation: fadeIn 0.4s ease-out;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* Dashboard Styles */
		.db-grid {
			display: grid;
			grid-template-columns: repeat(4, 1fr);
			gap: 20px;
			margin-bottom: 30px;
		}

		.db-card {
			background: var(--card-bg);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			padding: 24px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
		}

		.db-val {
			font-size: 1.6rem;
			font-weight: 800;
			margin-top: 8px;
			color: #0f172a;
		}

		.db-label {
			font-size: 0.85rem;
			color: var(--text-muted);
			font-weight: 500;
		}

		.chart-row {
			display: grid;
			grid-template-columns: 2fr 1fr;
			gap: 20px;
			margin-bottom: 25px;
		}

		.full-row {
			grid-template-columns: 1fr !important;
		}

		.chart-card {
			background: white;
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			padding: 25px;
			height: 400px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
		}

		.chart-title {
			font-size: 1.2rem;
			font-weight: 800;
			margin-bottom: 24px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			color: #0f172a;
		}

		/* Order List Specifics */
		.filters {
			display: flex;
			gap: 15px;
			margin-bottom: 25px;
		}

		.search-box {
			flex: 1;
		}

		input,
		select {
			width: 100%;
			padding: 12px 16px;
			background: white !important;
			border: 1px solid #94a3b8;
			border-radius: 12px;
			color: #0f172a !important;
			outline: none;
			font-weight: 600;
		}

		input::placeholder {
			color: #64748b;
		}

		.order-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
			gap: 20px;
		}

		.order-card {
			background: white;
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			padding: 24px;
			transition: 0.3s;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
		}

		.order-card:hover {
			transform: translateY(-5px);
			border-color: var(--primary);
			box-shadow: 0 8px 25px rgba(250, 204, 21, 0.2);
		}

		.order-header {
			display: flex;
			justify-content: space-between;
			margin-bottom: 15px;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
			padding-bottom: 10px;
		}

		.order-id {
			font-weight: 800;
			color: #0f172a;
			font-size: 1.1rem;
		}

		.order-date {
			font-size: 0.85rem;
			color: #334155;
			font-weight: 600;
		}

		.cust-name {
			font-size: 1.2rem;
			font-weight: 800;
			margin-bottom: 12px;
			color: #1e293b;
		}

		.order-info {
			font-size: 0.95rem;
			color: #334155;
			margin-bottom: 6px;
			font-weight: 600;
		}

		.order-total {
			font-size: 1.4rem;
			font-weight: 900;
			color: #166534;
			/* Darker green */
			margin-top: 20px;
			text-align: right;
			letter-spacing: -0.5px;
		}

		.status-badge {
			padding: 4px 10px;
			border-radius: 20px;
			font-size: 0.7rem;
			font-weight: 700;
			text-transform: uppercase;
		}

		.status-paid {
			background: rgba(34, 197, 94, 0.15);
			color: #166534;
			border: 1px solid rgba(34, 197, 94, 0.3);
		}

		.status-pending {
			background: rgba(250, 204, 21, 0.15);
			color: #854d0e;
			border: 1px solid rgba(250, 204, 21, 0.3);
		}

		.status-cancelled {
			background: rgba(239, 68, 68, 0.1);
			color: #b91c1c;
			border: 1px solid rgba(239, 68, 68, 0.2);
		}

		.btn {
			padding: 10px 20px;
			border-radius: 12px;
			font-weight: 700;
			cursor: pointer;
			transition: 0.3s;
			border: none;
			font-size: 0.9rem;
		}

		.btn-view {
			background: rgba(250, 204, 21, 0.1);
			color: #854d0e;
			border: 2px solid var(--primary) !important;
		}

		.btn-delete {
			background: rgba(239, 68, 68, 0.1);
			color: #ef4444;
			border: 2px solid #ef4444 !important;
		}

		#toast {
			position: fixed;
			top: 20px;
			right: 20px;
			padding: 16px 24px;
			border-radius: 12px;
			background: var(--success);
			color: white;
			font-weight: 600;
			transform: translateX(200%);
			transition: 0.4s;
			z-index: 3000;
		}

		#toast.active {
			transform: translateX(0);
		}

		.back-btn {
			text-decoration: none;
			color: var(--text-muted);
			font-size: 0.9rem;
		}

		/* Modal Styles */
		.modal {
			display: none;
			position: fixed;
			inset: 0;
			background: rgba(15, 23, 42, 0.9);
			backdrop-filter: blur(10px);
			z-index: 4000;
			padding: 40px;
			justify-content: center;
			align-items: center;
		}

		.modal.active {
			display: flex;
		}

		.modal-content {
			width: 100%;
			max-width: 1100px;
			height: 90vh;
			background: white;
			border-radius: 20px;
			position: relative;
			overflow: hidden;
		}

		.close-modal {
			position: absolute;
			top: 20px;
			right: 20px;
			width: 44px;
			height: 44px;
			background: white;
			border: 1px solid #ddd;
			border-radius: 50%;
			font-size: 24px;
			cursor: pointer;
			z-index: 5000;
			display: flex;
			align-items: center;
			justify-content: center;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
		}

		iframe#printFrame {
			width: 100%;
			height: 100%;
			border: none;
		}

		.top-list {
			list-style: none;
		}

		.top-item {
			display: flex;
			justify-content: space-between;
			padding: 12px 0;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
		}

		.top-name {
			font-weight: 500;
			font-size: 0.95rem;
		}

		.top-val {
			font-weight: 700;
			color: var(--success);
		}

		/* Dashboard Stat Filters */
		.db-filters {
			display: flex;
			gap: 10px;
			margin-bottom: 20px;
			flex-wrap: wrap;
		}

		.db-filter-chip {
			padding: 10px 20px;
			border-radius: 20px;
			background: white;
			border: 1.5px solid #cbd5e1;
			color: #334155;
			font-size: 0.85rem;
			font-weight: 700;
			cursor: pointer;
			transition: 0.3s;
		}

		.db-filter-chip:hover {
			border-color: var(--primary);
			color: #0f172a;
		}

		.db-filter-chip.active {
			background: var(--primary);
			color: #0f172a;
			border-color: var(--primary);
			box-shadow: 0 4px 12px rgba(250, 204, 21, 0.3);
		}

		@media (max-width: 800px) {
			body {
				padding: 10px;
			}

			.container {
				margin: 10px auto;
				padding: 5px;
			}

			.header {
				flex-direction: column;
				align-items: flex-start;
				gap: 15px;
			}

			.header h1 {
				font-size: 1.4rem;
			}

			.header div {
				width: 100%;
				justify-content: space-between;
			}

			.db-grid {
				grid-template-columns: 1fr;
				gap: 12px;
			}

			.db-card {
				padding: 15px;
			}

			.db-val {
				font-size: 1.3rem;
			}

			.chart-row {
				grid-template-columns: 1fr;
				gap: 15px;
			}

			.chart-card {
				height: 350px;
				padding: 15px;
			}

			.db-filters {
				overflow-x: auto;
				padding: 5px 0;
				gap: 8px;
				justify-content: flex-start;
				mask-image: linear-gradient(to right, black 90%, transparent 100%);
				-webkit-mask-image: linear-gradient(to right, black 90%, transparent 100%);
			}

			.db-filter-chip {
				flex: 0 0 auto;
				padding: 6px 14px;
				font-size: 0.75rem;
			}

			.tabs-nav {
				width: 100%;
			}

			.tab-btn {
				flex: 1;
				padding: 10px;
				font-size: 0.85rem;
			}

			.filters {
				flex-direction: column;
				gap: 10px;
			}

			#statusFilter {
				width: 100% !important;
			}

			.order-grid {
				grid-template-columns: 1fr;
			}

			.chart-title {
				font-size: 0.95rem;
				flex-direction: column;
				align-items: flex-start;
				gap: 10px;
			}

			.chart-title div {
				width: 100%;
				display: flex;
				gap: 5px !important;
			}

			.chart-title input {
				flex: 1;
				font-size: 0.75rem !important;
			}
		}
	</style>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

	<div id="toast">Th√¥ng b√°o!</div>

	<div class="container">
		<div class="header">
			<h1>üìã Qu·∫£n L√Ω ƒê∆°n H√†ng</h1>
			<div style="display: flex; gap: 15px; align-items: center;">
				<a href="len-don-hang.html" class="btn btn-view" style="background: var(--primary); color: white;">+ ƒê∆†N
					M·ªöI</a>
				<a href="index.html" class="btn btn-glass">
					<i class="fa-solid fa-house"></i> Trang ch·ªß
				</a>
			</div>
		</div>

		<div class="tabs-nav">
			<button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
			<button class="tab-btn" onclick="switchTab('list')">üìã Danh s√°ch</button>
		</div>

		<!-- SECTION: DASHBOARD -->
		<div id="section-dashboard" class="content-section active">
			<div class="db-filters">
				<button class="db-filter-chip active" onclick="filterDashboard('all')">T·∫•t c·∫£ ƒë∆°n</button>
				<button class="db-filter-chip" onclick="filterDashboard('ƒê∆°n ch·ªët')">ƒê∆°n ch·ªët</button>
				<button class="db-filter-chip" onclick="filterDashboard('ƒêang x·ª≠ l√Ω')">ƒêang x·ª≠ l√Ω</button>
				<button class="db-filter-chip" onclick="filterDashboard('ƒê∆°n nh√°p')">ƒê∆°n nh√°p</button>
				<button class="db-filter-chip" onclick="filterDashboard('ƒê√£ h·ªßy')">ƒê√£ h·ªßy</button>
			</div>

			<div class="db-grid">
				<div class="db-card">
					<div class="db-label">T·ªïng doanh thu</div>
					<div id="db-total-rev" class="db-val">0 ƒë</div>
				</div>
				<div class="db-card">
					<div class="db-label">S·ªë l∆∞·ª£ng ƒë∆°n</div>
					<div id="db-total-qty" class="db-val">0</div>
				</div>
				<div class="db-card">
					<div class="db-label">L·ª£i nhu·∫≠n (T·∫°p t√≠nh)</div>
					<div id="db-profit" class="db-val">0 ƒë</div>
				</div>
				<div class="db-card">
					<div class="db-label">S·ªë kh√°ch h√†ng</div>
					<div id="db-total-cust" class="db-val">0</div>
				</div>
			</div>

			<div class="chart-row">
				<div class="chart-card">
					<div class="chart-title">üìà Doanh thu theo th√°ng</div>
					<canvas id="monthlyChart"></canvas>
				</div>
				<div class="chart-card" style="overflow-y: auto;">
					<div class="chart-title">üèÜ S·∫£n ph·∫©m Top</div>
					<div id="topProductsList" class="top-list"></div>
				</div>
			</div>

			<div class="chart-row full-row">
				<div class="chart-card" style="height: auto; min-height: 450px;">
					<div class="chart-title">
						<span>üë• Doanh thu theo kh√°ch h√†ng</span>
						<div style="display: flex; gap: 10px;">
							<input type="date" id="custDateStart" style="width: 150px; font-size: 0.8rem; padding: 6px;"
								onchange="updateCustomerStats()">
							<input type="date" id="custDateEnd" style="width: 150px; font-size: 0.8rem; padding: 6px;"
								onchange="updateCustomerStats()">
						</div>
					</div>
					<div id="customerRevenueStats" class="top-list">
						<!-- Dynamic table/list -->
					</div>
				</div>
			</div>
		</div>

		<!-- SECTION: LIST -->
		<div id="section-list" class="content-section">
			<div id="loader" style="text-align: center; padding: 50px; font-size: 1.2rem; color: var(--text-muted);">üöÄ
				ƒêang t·∫£i ƒë∆°n h√†ng...</div>

			<div class="filters">
				<div class="search-box">
					<input type="text" id="searchInput" placeholder="T√¨m t√™n kh√°ch h√†ng ho·∫∑c m√£ ƒë∆°n..."
						oninput="filterOrders()">
				</div>
				<div id="adminViewMode" style="display: none; align-items: center; gap: 10px;">
					<span style="font-size: 0.85rem; color: var(--text-muted);">Ch·∫ø ƒë·ªô xem:</span>
					<select id="viewModeSelect" style="width: 150px;" onchange="filterOrders()">
						<option value="team">C·∫£ nh√≥m</option>
						<option value="mine">C√° nh√¢n</option>
					</select>
				</div>
			</div>

			<!-- Status Sub-tabs for List View -->
			<div class="db-filters" style="margin-bottom: 25px;" id="listStatusTabs">
				<button class="db-filter-chip active" onclick="filterByStatus('all', this)">T·∫•t c·∫£</button>
				<button class="db-filter-chip" onclick="filterByStatus('ƒê∆°n ch·ªët', this)">ƒê∆°n ch·ªët</button>
				<button class="db-filter-chip" onclick="filterByStatus('ƒêang x·ª≠ l√Ω', this)">ƒêang x·ª≠ l√Ω</button>
				<button class="db-filter-chip" onclick="filterByStatus('ƒê∆°n nh√°p', this)">ƒê∆°n nh√°p</button>
				<button class="db-filter-chip" onclick="filterByStatus('ƒê√£ h·ªßy', this)">ƒê√£ h·ªßy</button>
			</div>

			<div id="orderGrid" class="order-grid"></div>
		</div>
	</div>

	<!-- Modal In Phi·∫øu -->
	<div id="printModal" class="modal">
		<div class="modal-content">
			<button class="close-modal" onclick="closeModal()">√ó</button>
			<iframe src="" id="printFrame"></iframe>
		</div>
	</div>

	<script>
		const ORDER_URL = 'https://script.google.com/macros/s/AKfycby_Uduzhl4k6aVfQEcgRr7XV3Vz-xJSIHIuQ4sD50I8Y0662wEHcWHgQMGJ2IaRgeNL5w/exec';
		// currentUser is already defined in the head script

		let allOrders = [];
		let allDetails = [];
		let charts = {};
		let currentDbStatus = 'all';
		let currentListStatus = 'all';

		async function loadOrders() {
			try {
				if (currentUser.roleId === 'R001') {
					document.getElementById('adminViewMode').style.display = 'flex';
				}

				const res = await fetch(ORDER_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest('get_orders', {
						userEmail: currentUser.email,
						isAdmin: currentUser.roleId === 'R001',
						adminEmail: currentUser.adminEmail || currentUser.email
					})
				});
				const data = await res.json();
				if (data.success) {
					allOrders = data.orders;
					allDetails = data.details || [];
					renderOrders(allOrders);
					initDashboard();
				}
			} catch (e) { showToast("L·ªói t·∫£i ƒë∆°n h√†ng", true); }
			document.getElementById('loader').style.display = 'none';
		}

		function switchTab(tab) {
			document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
			document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));

			event.target.classList.add('active');
			document.getElementById(`section-${tab}`).classList.add('active');
		}

		// --- DASHBOARD LOGIC ---
		function parseVNData(dateStr) {
			try {
				const [time, date] = dateStr.split(' ');
				const [d, m, y] = date.split('/');
				return new Date(`${y}-${m}-${d}T${time}`);
			} catch (e) { return new Date(); }
		}

		function filterDashboard(status) {
			currentDbStatus = status;
			document.querySelectorAll('.db-filter-chip').forEach(c => {
				c.classList.toggle('active', c.innerText.includes(status === 'all' ? 'T·∫•t c·∫£' : status));
			});
			initDashboard();
		}

		function getFilteredOrdersForDb() {
			if (currentDbStatus === 'all') return allOrders;
			return allOrders.filter(o => o.trang_thai_don_hang === currentDbStatus);
		}

		function initDashboard() {
			const activeOrders = getFilteredOrdersForDb();
			if (!activeOrders.length) {
				// Reset displays if no data
				document.getElementById('db-total-rev').innerText = '0 ƒë';
				document.getElementById('db-total-qty').innerText = '0';
				document.getElementById('db-total-cust').innerText = '0';
				document.getElementById('db-profit').innerText = '0 ƒë';
				renderMonthlyChart(activeOrders);
				renderTopProducts(activeOrders);
				updateCustomerStats(activeOrders);
				return;
			}

			// 1. Overview
			const totalRev = activeOrders.reduce((acc, o) => acc + (parseInt(o.so_tien_con_lai) || 0), 0);
			const totalCust = [...new Set(activeOrders.map(o => o.ten_khach_hang))].length;

			document.getElementById('db-total-rev').innerText = formatCurrency(totalRev);
			document.getElementById('db-total-qty').innerText = activeOrders.length;
			document.getElementById('db-total-cust').innerText = totalCust;
			document.getElementById('db-profit').innerText = formatCurrency(totalRev * 0.15); // Mock profit 15%

			// 2. Monthly Chart
			renderMonthlyChart(activeOrders);

			// 3. Top Products
			renderTopProducts(activeOrders);

			// 4. Customer Revenue
			updateCustomerStats(activeOrders);
		}

		function renderMonthlyChart(activeOrders) {
			const monthsData = {};
			activeOrders.forEach(o => {
				const date = parseVNData(o.ngay_len_don);
				const monthKey = `${date.getMonth() + 1}/${date.getFullYear()}`;
				monthsData[monthKey] = (monthsData[monthKey] || 0) + (parseInt(o.so_tien_con_lai) || 0);
			});

			const labels = Object.keys(monthsData).reverse();
			const values = labels.map(label => monthsData[label]);

			const ctx = document.getElementById('monthlyChart').getContext('2d');
			if (charts.monthly) charts.monthly.destroy();

			charts.monthly = new Chart(ctx, {
				type: 'line',
				data: {
					labels: labels,
					datasets: [{
						label: 'Doanh thu',
						data: values,
						borderColor: '#EAB308', /* Yellow-500 */
						backgroundColor: 'rgba(250, 204, 21, 0.1)',
						fill: true,
						tension: 0.4,
						borderWidth: 4,
						pointRadius: 6,
						pointBackgroundColor: '#EAB308'
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: { legend: { display: false } },
					scales: {
						y: {
							beginAtZero: true,
							grid: { color: 'rgba(0,0,0,0.05)' },
							ticks: { color: '#0f172a', font: { weight: '600' } }
						},
						x: {
							grid: { display: false },
							ticks: { color: '#0f172a', font: { weight: '600' } }
						}
					}
				}
			});
		}

		function renderTopProducts(activeOrders) {
			const activeIds = new Set(activeOrders.map(o => o.id_don_hang));
			const prods = {};

			allDetails.forEach(d => {
				if (activeIds.has(d.id_don_hang)) {
					const name = d.ten_san_pham;
					prods[name] = (prods[name] || 0) + (parseFloat(d.so_luong) || 0);
				}
			});

			const sorted = Object.entries(prods)
				.sort((a, b) => b[1] - a[1])
				.slice(0, 8);

			const list = document.getElementById('topProductsList');
			if (!sorted.length) {
				list.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding-top: 20px;">Ch∆∞a c√≥ d·ªØ li·ªáu s·∫£n ph·∫©m</div>';
				return;
			}
			list.innerHTML = sorted.map(([name, qty]) => `
				<div class="top-item">
					<span class="top-name">${name}</span>
					<span class="top-val">${qty} sp</span>
				</div>
			`).join('');
		}

		function updateCustomerStats(activeOrders) {
			const start = document.getElementById('custDateStart').value;
			const end = document.getElementById('custDateEnd').value;

			let filtered = activeOrders || getFilteredOrdersForDb();
			if (start) filtered = filtered.filter(o => parseVNData(o.ngay_len_don) >= new Date(start));
			if (end) filtered = filtered.filter(o => parseVNData(o.ngay_len_don) <= new Date(end));

			const custMap = {};
			filtered.forEach(o => {
				const name = o.ten_khach_hang || "Kh√°ch l·∫°";
				if (!custMap[name]) custMap[name] = { name: name, total: 0, count: 0 };
				custMap[name].total += (parseInt(o.so_tien_con_lai) || 0);
				custMap[name].count++;
			});

			const sortedCust = Object.values(custMap).sort((a, b) => b.total - a.total);

			const container = document.getElementById('customerRevenueStats');
			container.innerHTML = `
				<div style="display: grid; grid-template-columns: 2fr 1fr 1fr; padding-bottom: 10px; font-weight: 800; border-bottom: 1px solid var(--primary);">
					<span>T√™n kh√°ch h√†ng</span>
					<span>S·ªë ƒë∆°n</span>
					<span style="text-align: right;">Doanh thu</span>
				</div>
			` + sortedCust.map(c => `
				<div class="top-item" style="grid-template-columns: 2fr 1fr 1fr; display: grid;">
					<span class="top-name">${c.name}</span>
					<span class="top-val" style="color: var(--accent-purple)">${c.count} ƒë∆°n</span>
					<span class="top-val" style="text-align: right;">${formatCurrency(c.total)}</span>
				</div>
			`).join('');
		}

		// --- LIST LOGIC ---
		function renderOrders(orders) {
			const grid = document.getElementById('orderGrid');
			if (!orders || orders.length === 0) {
				grid.innerHTML = `
					<div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; background: var(--card-bg); border-radius: 20px; border: 1px dashed var(--glass-border);">
						<div style="font-size: 3rem; margin-bottom: 15px;">üîç</div>
						<div style="font-size: 1.2rem; color: var(--text-main); font-weight: 600;">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o</div>
						<div style="color: var(--text-muted); margin-top: 8px;">Th·ª≠ thay ƒë·ªïi t√¨m ki·∫øm ho·∫∑c b·ªô l·ªçc tr·∫°ng th√°i.</div>
					</div>
				`;
				return;
			}
			grid.innerHTML = orders.map(o => {
				const creator = (o.nguoi_len_don || "N/A").toString().split('@')[0];
				return `
					<div class="order-card">
						<div class="order-header">
							<span class="order-id">${o.id_don_hang}</span>
							<span class="order-date">${o.ngay_len_don}</span>
						</div>
						<div class="cust-name">${o.ten_khach_hang || 'Kh√°ch ch∆∞a ƒë·∫∑t t√™n'}</div>
						<div class="order-info">üë§ Ng∆∞·ªùi t·∫°o: ${creator}</div>
						<div class="order-info">üìù Ghi ch√∫: ${o.ghi_chu_don_hang || '-'}</div>
						<div style="margin-top: 10px;">
							<span class="status-badge ${o.trang_thai_don_hang === 'ƒê∆°n ch·ªët' ? 'status-paid' : 'status-pending'}">${o.trang_thai_don_hang}</span>
						</div>
						<div class="order-total">${formatCurrency(o.so_tien_con_lai || 0)}</div>
						<div style="display: flex; gap: 10px; margin-top: 15px;">
							<button class="btn btn-view" style="flex: 1" onclick="editOrder('${o.id_don_hang}')">S·ª¨A</button>
							<button class="btn btn-view" style="flex: 1" onclick="printSlip('${o.id_don_hang}')">IN PHI·∫æU</button>
							<button class="btn btn-delete" onclick="deleteOrder('${o.id_don_hang}')">X√ìA</button>
						</div>
					</div>
				`;
			}).join('');
		}

		function filterByStatus(status, btn) {
			currentListStatus = status;
			// UI Toggle
			const parent = document.getElementById('listStatusTabs');
			parent.querySelectorAll('.db-filter-chip').forEach(c => c.classList.remove('active'));
			if (btn) btn.classList.add('active');
			filterOrders();
		}

		function filterOrders() {
			const q = document.getElementById('searchInput').value.toLowerCase();
			const viewMode = document.getElementById('viewModeSelect')?.value || 'team';

			const filtered = allOrders.filter(o => {
				const matchSearch = (o.ten_khach_hang.toLowerCase().includes(q) || o.id_don_hang.toLowerCase().includes(q));
				const matchStatus = (currentListStatus === "all" || o.trang_thai_don_hang === currentListStatus);

				let matchView = true;
				if (viewMode === 'mine') {
					matchView = (o.nguoi_len_don.toLowerCase().trim() === currentUser.email.toLowerCase().trim());
				}

				return matchSearch && matchStatus && matchView;
			});
			renderOrders(filtered);
		}

		async function deleteOrder(id) {
			if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë∆°n h√†ng " + id + "?")) return;
			try {
				const res = await fetch(ORDER_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest('delete_order', { order_id: id })
				});
				const data = await res.json();
				if (data.success) {
					showToast("ƒê√£ x√≥a ƒë∆°n h√†ng");
					loadOrders();
				}
			} catch (e) { showToast("L·ªói khi x√≥a", true); }
		}

		function editOrder(id) {
			localStorage.setItem('edit_order_id', id);
			window.location.href = `sua-don-hang.html?id=${id}`;
		}

		function printSlip(id) {
			localStorage.setItem('print_order_id', id);
			const modal = document.getElementById('printModal');
			document.getElementById('printFrame').src = `phieu-giao-hang.html?id=${encodeURIComponent(id)}`;
			modal.classList.add('active');
			document.body.style.overflow = 'hidden';
		}

		function closeModal() {
			document.getElementById('printModal').classList.remove('active');
			document.getElementById('printFrame').src = '';
			document.body.style.overflow = 'auto';
		}

		function formatCurrency(val) { return new Intl.NumberFormat('vi-VN').format(val) + ' ƒë'; }
		function showToast(msg, isError = false) {
			const t = document.getElementById('toast');
			t.innerText = msg;
			t.style.background = isError ? 'var(--danger)' : 'var(--success)';
			t.classList.add('active');
			setTimeout(() => t.classList.remove('active'), 3000);
		}

		window.onload = loadOrders;
	</script>
	<script src="chatbot.js"></script>
	<script src="floating-menu.js"></script>
</body>

</html>


</html>