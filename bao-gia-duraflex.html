<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Bảng Báo Giá Duraflex - Premium Solution</title>
	<meta name="description" content="Bảng báo giá tấm Duraflex và chính sách chiết khấu mới nhất.">
	<link rel="icon" href="https://duraflex.com.vn/sites/default/files/styles/medium/public/2025-03/Logo-01_0.png">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
	<style>
		:root {
			--primary-green: #48d14d;
			--dark-green: #38b03c;
			--light-green: #f0fff0;
			--text-white: #ffffff;
			--text-dark: #2d3436;
			--accent-color: #ffd700;
			--bg-body: #f4f7f6;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Inter', sans-serif;
		}

		body {
			background-color: var(--bg-body);
			color: var(--text-dark);
			line-height: 1.6;
		}

		/* Header Styling */
		.header {
			background: linear-gradient(135deg, var(--primary-green), var(--dark-green));
			color: var(--text-white);
			position: relative;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
			z-index: 1001;
		}

		.header-inner {
			max-width: 1200px;
			margin: 0 auto;
			padding: 15px 20px;
			display: flex;
			align-items: center;
			gap: 20px;
		}

		.header-title-group {
			display: flex;
			align-items: center;
			gap: 20px;
			flex: 1;
		}

		.logo-container {
			background: white;
			display: flex;
			align-items: center;
			padding: 8px 15px;
			border-radius: 12px;
			box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
		}

		.logo {
			height: 50px;
			display: block;
		}

		.header h1 {
			font-size: 1.6rem;
			font-weight: 800;
			letter-spacing: -0.5px;
			text-transform: uppercase;
			margin: 0;
		}

		.home-btn {
			background: rgba(255, 255, 255, 0.2);
			width: 40px;
			height: 40px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			text-decoration: none;
			color: white;
			transition: all 0.3s;
			backdrop-filter: blur(5px);
		}

		.home-btn:hover {
			background: white;
			color: var(--primary-green);
			transform: scale(1.1);
		}

		/* Navigation Tabs */
		.nav-tabs {
			display: flex;
			justify-content: center;
			background: white;
			padding: 10px;
			gap: 10px;
			position: sticky;
			top: 0;
			z-index: 1000;
			box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
		}

		.tab-btn {
			padding: 12px 30px;
			border: none;
			background: transparent;
			font-size: 1rem;
			font-weight: 600;
			color: #636e72;
			cursor: pointer;
			border-radius: 10px;
			transition: all 0.3s;
		}

		.tab-btn.active {
			background: var(--primary-green);
			color: white;
			box-shadow: 0 4px 12px rgba(26, 142, 68, 0.3);
		}

		/* Main Content Container */
		.container {
			max-width: 1200px;
			margin: 30px auto;
			padding: 0 20px;
		}

		.tab-content {
			display: none;
			animation: fadeIn 0.5s ease;
		}

		.tab-content.active {
			display: block;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* Controls */
		.controls {
			display: flex;
			flex-wrap: wrap;
			gap: 20px;
			background: white;
			padding: 25px;
			border-radius: 20px;
			margin-bottom: 30px;
			box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
			align-items: flex-end;
		}

		.control-group {
			flex: 1;
			min-width: 250px;
		}

		.control-group label {
			display: block;
			font-weight: 700;
			margin-bottom: 8px;
			color: var(--primary-green);
			font-size: 0.9rem;
			text-transform: uppercase;
		}

		.custom-select {
			width: 100%;
			padding: 14px 20px;
			border: 2px solid #edf2f7;
			border-radius: 12px;
			font-size: 1rem;
			font-weight: 600;
			cursor: pointer;
			appearance: none;
			background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%231a8e44' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
			background-repeat: no-repeat;
			background-position: right 15px center;
			background-size: 18px;
			transition: all 0.3s;
			background-color: #f8fafc;
		}

		.custom-select:focus {
			border-color: var(--primary-green);
			outline: none;
			background-color: #fff;
		}

		/* Table Styling */
		.table-wrapper {
			background: white;
			border-radius: 20px;
			overflow: hidden;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
		}

		table {
			width: 100%;
			border-collapse: collapse;
			text-align: left;
		}

		thead {
			background: var(--dark-green);
			color: white;
		}

		th {
			padding: 20px;
			font-weight: 700;
			text-transform: uppercase;
			font-size: 0.85rem;
			letter-spacing: 0.5px;
		}

		td {
			padding: 18px 20px;
			border-bottom: 1px solid #edf2f7;
			font-weight: 500;
		}

		tr:last-child td {
			border-bottom: none;
		}

		tr:hover {
			background-color: var(--light-green);
		}

		.product-img {
			width: 60px;
			height: 60px;
			object-fit: cover;
			border-radius: 10px;
			border: 1px solid #edf2f7;
			cursor: pointer;
			transition: transform 0.3s;
		}

		.product-img:hover {
			transform: scale(1.1);
		}

		.price-text {
			font-weight: 800;
			color: var(--primary-green);
			font-size: 1.1rem;
		}

		.badge {
			padding: 4px 10px;
			border-radius: 6px;
			font-size: 0.8rem;
			font-weight: 700;
			background: var(--light-green);
			color: var(--primary-green);
		}

		/* Responsive */
		@media (max-width: 768px) {
			.header-inner {
				flex-direction: column;
				gap: 15px;
				padding: 15px;
			}

			.header-title-group {
				width: 100%;
				justify-content: center;
				gap: 10px;
			}

			.logo-container {
				padding: 5px 10px;
			}

			.logo {
				height: 40px;
			}

			.header h1 {
				font-size: 1.2rem;
				text-align: center;
			}

			.home-btn {
				position: absolute;
				left: 15px;
				top: 15px;
			}

			.nav-tabs {
				padding: 5px;
			}

			.tab-btn {
				padding: 10px 15px;
				font-size: 0.9rem;
				flex: 1;
				text-align: center;
			}

			.container {
				margin: 15px auto;
				padding: 0 10px;
			}

			.controls {
				padding: 15px;
				gap: 15px;
				border-radius: 15px;
			}

			.control-group {
				min-width: 100%;
			}

			.custom-select {
				padding: 12px 15px;
				font-size: 0.9rem;
			}

			/* MOBILE CARD LAYOUT */
			.table-wrapper {
				background: transparent;
				box-shadow: none;
				overflow: visible;
				border: none;
			}

			thead {
				display: none;
			}

			table,
			tbody,
			tr,
			td {
				display: block;
			}

			tr {
				background: #fff;
				margin-bottom: 20px;
				border-radius: 16px;
				box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
				padding: 15px;
				display: grid;
				grid-template-columns: 85px 1fr;
				gap: 0 15px;
				position: relative;
				border: 1px solid #edf2f7;
			}

			td {
				padding: 0;
				border: none;
			}

			/* Cấu trúc grid cho card trên mobile */
			tr td:nth-child(1) {
				/* img-cell */
				grid-column: 1;
				grid-row: 1 / 5;
				display: flex;
				align-items: flex-start;
			}

			tr td:nth-child(2) {
				/* name-cell */
				grid-column: 2;
				font-size: 1.05rem;
				font-weight: 800;
				color: var(--dark-green);
				margin-bottom: 5px;
			}

			tr td:nth-child(3),
			tr td:nth-child(4),
			tr td:nth-child(5) {
				grid-column: 2;
				font-size: 0.85rem;
				color: #636e72;
				display: flex;
				align-items: center;
				margin-bottom: 2px;
			}

			tr td:nth-child(3)::before {
				content: "KT: ";
				font-weight: 700;
				margin-right: 5px;
			}

			tr td:nth-child(4)::before {
				content: "Nặng: ";
				font-weight: 700;
				margin-right: 5px;
			}

			tr td:nth-child(5)::before {
				content: "Kiện: ";
				font-weight: 700;
				margin-right: 5px;
			}

			tr td:nth-child(6) {
				/* price-cell */
				grid-column: 2;
				text-align: right;
				border-top: 1px dashed #eee;
				margin-top: 10px;
				padding-top: 10px;
			}

			.product-img {
				width: 85px;
				height: 85px;
				border-radius: 12px;
				border: 1px solid #eee;
			}

			.price-text {
				font-size: 1.2rem;
				display: block;
			}

			.discount-card {
				padding: 20px;
			}

			.discount-grid {
				grid-template-columns: 1fr;
			}
		}

		@media (max-width: 480px) {
			.header h1 {
				font-size: 1rem;
				max-width: 200px;
			}

			.logo-container {
				padding: 4px 8px;
			}

			.logo {
				height: 35px;
			}
		}

		/* Tab 2 Discount styling */
		.discount-card {
			background: white;
			border-radius: 20px;
			padding: 40px;
			margin-bottom: 30px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
		}

		.discount-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
			gap: 20px;
		}

		.d-item {
			background: var(--light-green);
			padding: 20px;
			border-radius: 15px;
			border-left: 5px solid var(--primary-green);
		}

		.d-title {
			font-weight: 800;
			color: var(--dark-green);
			font-size: 1.2rem;
			margin-bottom: 5px;
		}

		.d-val {
			font-weight: 700;
			color: var(--primary-green);
			font-size: 1.5rem;
		}

		.d-label {
			font-size: 0.85rem;
			color: #636e72;
			margin-bottom: 15px;
		}

		/* FAB ADMIN */
		.admin-fab-container {
			position: fixed;
			bottom: 30px;
			left: 30px;
			z-index: 1000;
			display: none;
		}

		.admin-fab-main {
			width: 60px;
			height: 60px;
			background: #2d3436;
			border-radius: 50%;
			box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			cursor: pointer;
			transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			position: relative;
			z-index: 2;
		}

		.admin-fab-main:hover {
			transform: scale(1.1) rotate(90deg);
		}

		.admin-fab-menu {
			position: absolute;
			bottom: 80px;
			left: 0;
			display: flex;
			flex-direction: column;
			gap: 15px;
			opacity: 0;
			pointer-events: none;
			transform: translateY(20px) scale(0.8);
			transition: all 0.3s ease;
		}

		.admin-fab-container.active .admin-fab-menu {
			opacity: 1;
			pointer-events: auto;
			transform: translateY(0) scale(1);
		}

		.fab-sub-item {
			display: flex;
			align-items: center;
			gap: 15px;
			cursor: pointer;
		}

		.fab-sub-btn {
			width: 50px;
			height: 50px;
			background: #fff;
			border-radius: 50%;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
			display: flex;
			align-items: center;
			justify-content: center;
			color: var(--primary-green);
			transition: all 0.3s ease;
		}

		.fab-sub-label {
			background: rgba(0, 0, 0, 0.7);
			color: white;
			padding: 6px 15px;
			border-radius: 20px;
			font-size: 0.9rem;
			font-weight: 600;
			white-space: nowrap;
		}

		.fab-sub-item:hover .fab-sub-btn {
			background: var(--primary-green);
			color: white;
			transform: scale(1.1);
		}

		/* MODAL */
		.modal {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.6);
			backdrop-filter: blur(8px);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 10000;
			padding: 20px;
		}

		.modal-content {
			background: #ffffff;
			border-radius: 24px;
			width: 100%;
			max-width: 650px;
			position: relative;
			box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
			max-height: 90vh;
			overflow: hidden;
			display: flex;
			flex-direction: column;
			animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
		}

		@keyframes modalPop {
			from {
				transform: scale(0.8);
				opacity: 0;
			}

			to {
				transform: scale(1);
				opacity: 1;
			}
		}

		.modal-header {
			background: linear-gradient(135deg, var(--primary-green), var(--dark-green));
			padding: 20px 30px;
			color: white;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.modal-body {
			padding: 30px;
			overflow-y: auto;
		}

		.close-modal {
			cursor: pointer;
			font-size: 24px;
			background: rgba(255, 255, 255, 0.2);
			width: 35px;
			height: 35px;
			display: flex;
			align-items: center;
			justify-content: center;
			border-radius: 50%;
			transition: 0.3s;
		}

		.close-modal:hover {
			background: white;
			color: var(--primary-green);
		}

		.form-group {
			margin-bottom: 20px;
		}

		.form-group label {
			display: block;
			font-weight: 700;
			margin-bottom: 8px;
			font-size: 0.9rem;
		}

		.form-input {
			width: 100%;
			padding: 12px 16px;
			border: 2px solid #edf2f7;
			border-radius: 12px;
			font-size: 1rem;
			transition: 0.3s;
		}

		.form-input:focus {
			border-color: var(--primary-green);
			outline: none;
		}

		.submit-btn {
			width: 100%;
			padding: 15px;
			background: var(--primary-green);
			color: white;
			border: none;
			border-radius: 12px;
			font-size: 1rem;
			font-weight: 800;
			cursor: pointer;
			transition: 0.3s;
			margin-top: 10px;
		}

		.submit-btn:hover {
			background: var(--dark-green);
			transform: translateY(-2px);
		}

		/* Choice Modal Buttons */
		.choice-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
		}

		.choice-card {
			padding: 30px;
			border: 2px solid #edf2f7;
			border-radius: 20px;
			text-align: center;
			cursor: pointer;
			transition: 0.3s;
		}

		.choice-card:hover {
			border-color: var(--primary-green);
			background: var(--light-green);
			transform: translateY(-5px);
		}

		.choice-card i {
			font-size: 2rem;
			color: var(--primary-green);
			margin-bottom: 15px;
			display: block;
		}

		/* Edit Controls */
		.edit-controls {
			display: none;
			gap: 10px;
			margin-top: 10px;
			justify-content: flex-end;
		}

		.edit-mode .edit-controls {
			display: flex;
		}

		.btn-edit,
		.btn-delete {
			padding: 8px 15px;
			border-radius: 8px;
			border: none;
			font-weight: 700;
			font-size: 0.8rem;
			cursor: pointer;
			color: white;
			display: flex;
			align-items: center;
			gap: 5px;
		}

		.btn-edit {
			background: #0984e3;
		}

		.btn-delete {
			background: #d63031;
		}

		/* Lightbox */
		.lightbox {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.9);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 11000;
			opacity: 0;
			transition: 0.3s;
		}

		.lightbox.active {
			display: flex;
			opacity: 1;
		}

		.lightbox-content {
			max-width: 90%;
			max-height: 90%;
			border-radius: 10px;
		}

		#loadingOverlay {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(255, 255, 255, 0.8);
			display: none;
			align-items: center;
			justify-content: center;
			flex-direction: column;
			z-index: 10;
		}

		.spinner {
			width: 40px;
			height: 40px;
			border: 4px solid #f3f3f3;
			border-top: 4px solid var(--primary-green);
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}
	</style>
</head>

<body>

	<header class="header">
		<div class="header-inner">
			<a href="index.html" class="home-btn" title="Về trang chủ">
				<svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
					<path
						d="M8.707 1.5a1 1 0 0 0-1.414 0L.646 8.146a.5.5 0 0 0 .708.708L2 8.207V13.5A1.5 1.5 0 0 0 3.5 15h9a1.5 1.5 0 0 0 1.5-1.5V8.207l.646.647a.5.5 0 0 0 .708-.708L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.707 1.5ZM13 13.5A.5.5 0 0 1 12.5 14h-9a.5.5 0 0 1-.5-.5V7.383l4.747-4.747a.5.5 0 0 1 .708 0L9 7.383V13h-2v-2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5V13h2V13.5Z" />
				</svg>
			</a>
			<div class="header-title-group">
				<div class="logo-container">
					<img src="https://duraflex.com.vn/sites/default/files/styles/medium/public/2025-03/Logo-01_0.png"
						alt="Duraflex Logo" class="logo">
				</div>
				<h1>Bảng Báo Giá Duraflex</h1>
			</div>
		</div>
	</header>

	<nav class="nav-tabs">
		<button class="tab-btn active" onclick="switchTab('price-tab')">Bảng báo giá</button>
		<button class="tab-btn" onclick="switchTab('discount-tab')">Chính sách chiết khấu</button>
	</nav>

	<div class="container">
		<!-- Tab 1: Price List -->
		<div id="price-tab" class="tab-content active">
			<div class="controls">
				<div class="control-group">
					<label>Gói Giá Nét (Kiện)</label>
					<select id="selectNet" class="custom-select" onchange="handleNetChange()">
						<option value="0">Giá niêm yết</option>
						<!-- Options will be populated dynamically -->
					</select>
				</div>
				<div class="control-group">
					<label>Bảng Giá Bán Ra</label>
					<select id="selectRetail" class="custom-select" onchange="handleRetailChange()">
						<option value="0">Giá niêm yết</option>
						<option value="thợ thầu">Giá cho thầu thợ</option>
						<option value="chủ nhà">Giá cho chủ nhà</option>
					</select>
				</div>
			</div>

			<div class="table-wrapper">
				<table id="priceTable">
					<thead>
						<tr>
							<th style="width: 100px;">Hình ảnh</th>
							<th>Tên Sản Phẩm</th>
							<th>Kích Thước</th>
							<th>Số KG / Tấm</th>
							<th>Tấm / Kiện</th>
							<th id="priceHeader">Giá Niêm Yết</th>
						</tr>
					</thead>
					<tbody id="priceTableBody" class="data-list">
						<tr>
							<td colspan="6" style="text-align: center; padding: 50px;">Đang tải dữ liệu...</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>

		<!-- Tab 2: Discount -->
		<div id="discount-tab" class="tab-content">
			<div class="discount-card">
				<h2 style="color: var(--primary-green); margin-bottom: 25px; text-transform: uppercase;">Chính sách ưu
					đãi chiết khấu</h2>
				<div id="discountGrid" class="discount-grid data-list">
					<!-- Data will be loaded here -->
				</div>
			</div>
		</div>
	</div>

	<!-- FAB ADMIN -->
	<div class="admin-fab-container" id="adminFab">
		<div class="admin-fab-menu">
			<div class="fab-sub-item" onclick="openChoiceModal()">
				<span class="fab-sub-label">Thêm mới</span>
				<div class="fab-sub-btn"><svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
						<path
							d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
					</svg></div>
			</div>
			<div class="fab-sub-item" onclick="toggleEditMode()">
				<span class="fab-sub-label" id="editModeLabel">Chế độ Sửa/Xóa</span>
				<div class="fab-sub-btn" id="toggleEditBtn"><svg width="20" height="20" fill="currentColor"
						viewBox="0 0 16 16">
						<path
							d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z" />
					</svg></div>
			</div>
		</div>
		<div class="admin-fab-main" onclick="toggleAdminFab()">
			<svg width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
				<path
					d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z" />
				<path
					d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.292-.16c.765-.417 1.573.391 1.156 1.156l-.16.292a1.873 1.873 0 0 0 1.115 2.693l.319.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.292c.417.765-.391 1.573-1.156 1.156l-.292-.16a1.873 1.873 0 0 0-2.693 1.115l-.094.319c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.693-1.115l-.292.16c-.765.417-1.573-.391-1.156-1.156l.16-.292a1.873 1.873 0 0 0-1.115-2.693l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094a1.873 1.873 0 0 0 1.115-2.693l-.16-.292c-.417-.765.391-1.573 1.156-1.156l.292.16a1.873 1.873 0 0 0 2.693-1.115l.094-.319z" />
			</svg>
		</div>
	</div>

	<!-- Modal Lựa chọn -->
	<div id="choiceModal" class="modal" onclick="if(event.target===this) closeModal('choiceModal')">
		<div class="modal-content">
			<div class="modal-header">
				<h2>Thêm mới dữ liệu</h2>
				<span class="close-modal" onclick="closeModal('choiceModal')">&times;</span>
			</div>
			<div class="modal-body">
				<div class="choice-grid">
					<div class="choice-card" onclick="openProductForm()">
						<svg width="32" height="32" fill="var(--primary-green)" viewBox="0 0 16 16">
							<path
								d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10z" />
						</svg>
						<span style="font-weight: 800; display: block; margin-top: 10px;">Bảng giá</span>
					</div>
					<div class="choice-card" onclick="openDiscountForm()">
						<svg width="32" height="32" fill="var(--primary-green)" viewBox="0 0 16 16">
							<path
								d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm7 4a1 1 0 1 0-2 0 1 1 0 0 0 2 0zM5.854 8.146a.5.5 0 1 0-.708.708L7.293 11l-2.147 2.146a.5.5 0 0 0 .708.708L8 11.707l2.146 2.147a.5.5 0 0 0 .708-.708L8.707 11l2.147-2.146a.5.5 0 0 0-.708-.708L8 10.293 5.854 8.146z" />
						</svg>
						<span style="font-weight: 800; display: block; margin-top: 10px;">Khuyến mãi</span>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal Bảng Giá -->
	<div id="productModal" class="modal" onclick="if(event.target===this) closeModal('productModal')">
		<div class="modal-content">
			<div class="modal-header">
				<h2 id="productModalTitle">Thêm Sản Phẩm</h2>
				<span class="close-modal" onclick="closeModal('productModal')">&times;</span>
			</div>
			<div class="modal-body">
				<form id="productForm" onsubmit="submitForm(event, 'product')">
					<input type="hidden" id="p_id_old" name="id_old">
					<div class="form-group">
						<label>Hình ảnh sản phẩm</label>
						<input type="file" id="p_image_file" class="form-input"
							onchange="updateFileName('p_image_label', this)">
						<label id="p_image_label"
							style="font-weight: 400; color: #666; font-size: 0.8rem; margin-top: 5px;">Chưa chọn
							ảnh</label>
						<input type="hidden" id="p_image_url" name="image">
					</div>
					<div class="form-group">
						<label>Tên sản phẩm</label>
						<input type="text" id="p_name" name="Tên sản phẩm" class="form-input" required>
					</div>
					<div class="form-group">
						<label>ID sản phẩm</label>
						<input type="text" id="p_id" name="id sản phẩm" class="form-input" required>
					</div>
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
						<div class="form-group">
							<label>Kích thước</label>
							<input type="text" id="p_size" name="kích thước" class="form-input" placeholder="1m22x2m44">
						</div>
						<div class="form-group">
							<label>Số KG / Tấm</label>
							<input type="text" id="p_weight" name="số kg trên tấm" class="form-input">
						</div>
					</div>
					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
						<div class="form-group">
							<label>Tấm / Kiện</label>
							<input type="number" id="p_pack" name="số tấm trong 1 kiện" class="form-input">
						</div>
						<div class="form-group">
							<label>Giá niêm yết</label>
							<input type="number" id="p_price" name="giá niêm yết" class="form-input" required>
						</div>
					</div>
					<div class="form-group">
						<label>Tính chiết khấu?</label>
						<select id="p_is_discount" name="sản phẩm được tính chiết khấu" class="custom-select">
							<option value="TRUE">Có</option>
							<option value="FALSE">Không</option>
						</select>
					</div>
					<button type="submit" class="submit-btn" id="p_btnSubmit">LƯU DỮ LIỆU</button>
				</form>
				<div id="loadingOverlay">
					<div class="spinner"></div>
					<p style="margin-top: 15px; font-weight: 700;">Đang xử lý...</p>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal Chiết Khấu -->
	<div id="discountModal" class="modal" onclick="if(event.target===this) closeModal('discountModal')">
		<div class="modal-content">
			<div class="modal-header">
				<h2 id="discountModalTitle">Thêm Gói Chiết Khấu</h2>
				<span class="close-modal" onclick="closeModal('discountModal')">&times;</span>
			</div>
			<div class="modal-body">
				<form id="discountForm" onsubmit="submitForm(event, 'discount')">
					<input type="hidden" id="d_id_old" name="id_old">
					<div class="form-group">
						<label>Gói chiết khấu theo kiện (hoặc Tên khuyến mãi)</label>
						<input type="text" id="d_pack" name="gói chiết khấu theo kiện" class="form-input" required
							placeholder="Vd: 5 hoặc 20 bọc vít">
					</div>
					<div class="form-group">
						<label>% chiết khấu</label>
						<input type="text" id="d_percent" name="% chiết khấu" class="form-input">
					</div>
					<div class="form-group">
						<label>Số tiền chiết khấu (VNĐ)</label>
						<input type="number" id="d_amount" name="số tiền chiết khấu" class="form-input">
					</div>
					<div class="form-group">
						<label>Chiết khấu công bố (VNĐ)</label>
						<input type="number" id="d_public" name="chiết khấu công bố" class="form-input" required>
					</div>
					<button type="submit" class="submit-btn" id="d_btnSubmit">LƯU DỮ LIỆU</button>
				</form>
			</div>
		</div>
	</div>

	<!-- Lightbox -->
	<div id="lightbox" class="lightbox" onclick="this.classList.remove('active')">
		<img class="lightbox-content" id="lightboxImg">
	</div>

	<script>
		// ================= CẤU HÌNH & TRẠNG THÁI =================
		const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwwb2riiQuyvpHmRbc8C8LL9eAuUoE8UpE5-54zfrbqYOcgr7E7ISp76FnQylrgaOti/exec';
		const SHEET_ID = '16-Vj9q8jb3mPyS89YcZpk8lciRYLuEKMNOij8CC8soY';
		const FOLDER_ID = '1Jm6v_wN1YbVM43RYFIMtQqXuaD-bCTnV';

		let duraflexData = [];
		let discountData = [];
		let isEditMode = false;

		// ================= KHỞI TẠO =================
		document.addEventListener('DOMContentLoaded', () => {
			checkAdmin();
			init();
		});

		async function init() {
			try {
				// Tải từ JSON local trước
				const [resPrice, resDiscount] = await Promise.all([
					fetch('data/gia_duraflex.json'),
					fetch('data/chiet_khau_duraflex.json')
				]);

				duraflexData = await resPrice.json();
				discountData = await resDiscount.json();

				// Sau đó tải từ Google Sheets để đè dữ liệu mới nhất
				await loadSheetsData();

				renderDiscountTab();
				populateNetDropdown();
				renderPriceTable();
			} catch (error) {
				console.error("Lỗi khi tải dữ liệu:", error);
			}
		}

		async function loadSheetsData() {
			try {
				const [pRes, dRes] = await Promise.all([
					fetch(`${SCRIPT_URL}?action=read&sheetId=${SHEET_ID}&sheetName=bang_gia_dura`),
					fetch(`${SCRIPT_URL}?action=read&sheetId=${SHEET_ID}&sheetName=chiet_khau_dura`)
				]);

				const pData = await pRes.json();
				const dData = await dRes.json();

				if (pData.success && pData.data.length > 0) {
					// Merge hoặc replace: Ở đây ta sẽ lọc bỏ các item bị đánh dấu xóa
					const activePrices = pData.data.filter(item => item["trạng thái xóa"] !== "DELETED");
					if (activePrices.length > 0) duraflexData = activePrices;
				}

				if (dData.success && dData.data.length > 0) {
					const activeDiscounts = dData.data.filter(item => item["trạng thái xóa"] !== "DELETED");
					if (activeDiscounts.length > 0) discountData = activeDiscounts;
				}
			} catch (e) {
				console.warn("Không thể tải dữ liệu từ Google Sheets, sử dụng JSON local.", e);
			}
		}

		// ================= ADMIN LOGIC =================
		function checkAdmin() {
			const user = JSON.parse(localStorage.getItem('userLoggedIn'));
			const fab = document.getElementById('adminFab');
			if (user && (user.phan_loai === 'admin' || user.phan_loai === 'ad mind')) {
				fab.style.display = 'block';
			}
		}

		function toggleAdminFab() {
			document.getElementById('adminFab').classList.toggle('active');
		}

		function toggleEditMode() {
			isEditMode = !isEditMode;
			const list = document.querySelector('.data-list'); // Just a selector for visual change
			const label = document.getElementById('editModeLabel');
			const btn = document.getElementById('toggleEditBtn');

			if (isEditMode) {
				document.querySelectorAll('.data-list').forEach(el => el.classList.add('edit-mode'));
				label.innerText = "Tắt chế độ Sửa/Xóa";
				btn.style.background = "#2d3436";
				btn.style.color = "#fff";
			} else {
				document.querySelectorAll('.data-list').forEach(el => el.classList.remove('edit-mode'));
				label.innerText = "Chế độ Sửa/Xóa";
				btn.style.background = "#fff";
				btn.style.color = "var(--primary-green)";
			}
			toggleAdminFab();
		}

		// ================= MODAL LOGIC =================
		function openChoiceModal() {
			document.getElementById('choiceModal').style.display = 'flex';
			toggleAdminFab();
		}

		function closeModal(id) {
			document.getElementById(id).style.display = 'none';
		}

		function openProductForm(item = null) {
			closeModal('choiceModal');
			const modal = document.getElementById('productModal');
			const form = document.getElementById('productForm');
			form.reset();

			if (item) {
				document.getElementById('productModalTitle').innerText = "Sửa Sản Phẩm";
				document.getElementById('p_id_old').value = item["id sản phẩm"];
				document.getElementById('p_id').value = item["id sản phẩm"];
				document.getElementById('p_name').value = item["Tên sản phẩm"];
				document.getElementById('p_size').value = item["kích thước"];
				document.getElementById('p_weight').value = item["số kg trên tấm"];
				document.getElementById('p_pack').value = item["số tấm trong 1 kiện"];
				document.getElementById('p_price').value = item["giá niêm yết"];
				document.getElementById('p_is_discount').value = item["sản phẩm được tính chiết khấu"];
				document.getElementById('p_image_url').value = item.image;
				document.getElementById('p_image_label').innerText = "Đã có ảnh (Click để thay đổi)";
			} else {
				document.getElementById('productModalTitle').innerText = "Thêm Sản Phẩm";
				document.getElementById('p_id_old').value = "";
				// Tự động tạo ID: 1 chữ + 2 số (Dxx)
				document.getElementById('p_id').value = "D" + Math.floor(10 + Math.random() * 90);
				document.getElementById('p_image_label').innerText = "Chưa chọn ảnh";
			}
			modal.style.display = 'flex';
		}

		function openDiscountForm(item = null) {
			closeModal('choiceModal');
			const modal = document.getElementById('discountModal');
			const form = document.getElementById('discountForm');
			form.reset();

			if (item) {
				document.getElementById('discountModalTitle').innerText = "Sửa Gói Chiết Khấu";
				document.getElementById('d_id_old').value = item["gói chiết khấu theo kiện"];
				document.getElementById('d_pack').value = item["gói chiết khấu theo kiện"];
				document.getElementById('d_percent').value = item["% chiết khấu"];
				document.getElementById('d_amount').value = item["số tiền chiết khấu"];
				document.getElementById('d_public').value = item["chiết khấu công bố"];
			} else {
				document.getElementById('discountModalTitle').innerText = "Thêm Gói Chiết Khấu";
				document.getElementById('d_id_old').value = "";
			}
			modal.style.display = 'flex';
		}

		function updateFileName(labelId, input) {
			const label = document.getElementById(labelId);
			if (input.files && input.files.length > 0) {
				label.innerText = input.files[0].name;
			}
		}

		// ================= CRUD LOGIC =================
		async function submitForm(event, type) {
			event.preventDefault();
			const loading = document.getElementById('loadingOverlay');
			loading.style.display = 'flex';

			try {
				const form = event.target;
				const formData = new FormData(form);
				const data = Object.fromEntries(formData.entries());

				const sheetName = type === 'product' ? 'bang_gia_dura' : 'chiet_khau_dura';
				const idField = type === 'product' ? 'id sản phẩm' : 'gói chiết khấu theo kiện';

				// Xử lý ảnh nếu là product
				if (type === 'product') {
					const fileInput = document.getElementById('p_image_file');
					if (fileInput.files.length > 0) {
						const file = fileInput.files[0];
						const base64 = await toBase64(file);
						const uploadRes = await fetch(SCRIPT_URL, {
							method: 'POST',
							body: JSON.stringify({
								action: 'upload',
								file: base64.split(',')[1],
								filename: file.name,
								mimeType: file.type,
								folderId: FOLDER_ID
							})
						});
						const uploadData = await uploadRes.json();
						if (uploadData.success) {
							data.image = uploadData.url;
						}
					}
				}

				const action = data.id_old ? 'update' : 'create';
				const res = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: action,
						sheetId: SHEET_ID,
						sheetName: sheetName,
						data: data,
						idField: idField,
						idValue: data.id_old
					})
				});

				const result = await res.json();
				if (result.success) {
					alert("Thành công!");
					location.reload();
				} else {
					alert("Lỗi: " + result.message);
				}
			} catch (e) {
				console.error(e);
				alert("Đã xảy ra lỗi hệ thống!");
			} finally {
				loading.style.display = 'none';
			}
		}

		async function deleteItem(id, type) {
			if (!confirm("Bạn có chắc chắn muốn xóa?")) return;
			const sheetName = type === 'product' ? 'bang_gia_dura' : 'chiet_khau_dura';
			const idField = type === 'product' ? 'id sản phẩm' : 'gói chiết khấu theo kiện';

			try {
				const res = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: 'delete',
						sheetId: SHEET_ID,
						sheetName: sheetName,
						idField: idField,
						idValue: id
					})
				});
				const result = await res.json();
				if (result.success) {
					alert("Đã xóa!");
					location.reload();
				}
			} catch (e) {
				alert("Lỗi khi xóa!");
			}
		}

		function toBase64(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = () => resolve(reader.result);
				reader.onerror = error => reject(error);
			});
		}

		// ================= RENDERING =================
		function switchTab(tabId) {
			document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
			document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));

			document.getElementById(tabId).classList.add('active');
			event.target.classList.add('active');
			// Reset edit mode when switching tabs for clean UX
			if (isEditMode) toggleEditMode();
		}

		function formatCurrency(amount) {
			return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
		}

		function handleNetChange() {
			const retailSelect = document.getElementById('selectRetail');
			if (retailSelect) retailSelect.value = "0";
			renderPriceTable();
		}

		function handleRetailChange() {
			const netSelect = document.getElementById('selectNet');
			if (netSelect) netSelect.value = "0";
			renderPriceTable();
		}

		function populateNetDropdown() {
			const select = document.getElementById('selectNet');
			select.innerHTML = '<option value="0">Giá niêm yết</option>';

			discountData.forEach(item => {
				const id = item["gói chiết khấu theo kiện"];
				if (id) {
					const opt = document.createElement('option');
					opt.value = id;
					opt.textContent = `Gói chiết khấu ${id} (Net kiện)`;
					select.appendChild(opt);
				}
			});
		}

		function renderPriceTable() {
			const body = document.getElementById('priceTableBody');
			const selectedPackageId = document.getElementById('selectNet').value;
			const retailType = document.getElementById('selectRetail').value;
			const priceHeader = document.getElementById('priceHeader');

			if (selectedPackageId !== "0") {
				priceHeader.innerText = `Giá Nét Gói ${selectedPackageId}`;
			} else if (retailType === "thợ thầu") {
				priceHeader.innerText = "Giá Thợ Thầu";
			} else if (retailType === "chủ nhà") {
				priceHeader.innerText = "Giá Chủ Nhà";
			} else {
				priceHeader.innerText = "Giá Niêm Yết";
			}

			let selectedDiscount = null;
			if (selectedPackageId !== "0") {
				selectedDiscount = discountData.find(d => String(d["gói chiết khấu theo kiện"]) === String(selectedPackageId));
			}

			body.innerHTML = '';
			duraflexData.forEach((item, index) => {
				// Hàm helper để convert giá trị sang số (xử lý cả chuỗi định dạng VN)
				const parseVN = (val) => {
					if (typeof val === 'number') return val;
					if (!val) return 0;
					return parseFloat(String(val).replace(/\./g, '').replace(/,/g, '.'));
				};

				const originalPrice = parseVN(item["giá niêm yết"]);
				let finalPrice = originalPrice;

				// Kiểm tra tính chiết khấu (linh hoạt với TRUE, true, "TRUE", "true", "Có")
				const discountValue = item["sản phẩm được tính chiết khấu"];
				const isDiscountable = discountValue === true ||
					(typeof discountValue === 'string' &&
						['TRUE', 'CÓ', 'X'].includes(discountValue.toUpperCase().trim()));

				if (selectedDiscount && isDiscountable) {
					const packVal = selectedDiscount["gói chiết khấu theo kiện"];
					// Chỉ tính toán giá Net nếu gói chiết khấu là con số (kiện)
					const isNumericPack = /^[0-9]+$/.test(String(packVal).trim());

					if (isNumericPack) {
						const disTotal = parseVN(selectedDiscount["chiết khấu công bố"]);
						const k = parseVN(packVal);
						const unitsPerPack = parseVN(item["số tấm trong 1 kiện"]);

						if (unitsPerPack > 0 && k > 0) {
							const deductionPerUnit = disTotal / (unitsPerPack * k);
							finalPrice = Math.round(originalPrice - deductionPerUnit);
						}
					} else {
						// Nếu là khuyến mãi chữ (Vd: 20 bọc vít), giữ nguyên giá niêm yết ở bảng xem trước
						finalPrice = originalPrice;
					}
				} else if (selectedPackageId === "0") {
					if (retailType === "thợ thầu") {
						finalPrice = Math.round(originalPrice * 1.02);
					} else if (retailType === "chủ nhà") {
						finalPrice = Math.round(originalPrice * 1.08);
					}
				}

				const tr = document.createElement('tr');
				// Check for edit mode class
				if (isEditMode) tr.classList.add('edit-mode');

				tr.innerHTML = `
					<td class="img-cell"><img src="${item.image}" alt="${item["Tên sản phẩm"]}" class="product-img" onclick="showLightbox('${item.image}')"></td>
					<td class="name-cell">
						<strong>${item["Tên sản phẩm"]}</strong>
						<div class="edit-controls">
							<button class="btn-edit" onclick="openProductForm(${JSON.stringify(item).replace(/"/g, '&quot;')})">Sửa</button>
							<button class="btn-delete" onclick="deleteItem('${item["id sản phẩm"]}', 'product')">Xóa</button>
						</div>
					</td>
					<td><span class="badge">${item["kích thước"]}</span></td>
					<td>${item["số kg trên tấm"]} kg</td>
					<td>${item["số tấm trong 1 kiện"]}</td>
					<td class="price-cell"><span class="price-text">${formatCurrency(finalPrice)}</span></td>
				`;
				body.appendChild(tr);
			});
		}

		function renderDiscountTab() {
			const grid = document.getElementById('discountGrid');
			grid.innerHTML = '';

			discountData.forEach(item => {
				const div = document.createElement('div');
				div.className = 'd-item';
				if (isEditMode) div.classList.add('edit-mode');

				div.innerHTML = `
					<div class="d-label">Gói chiết khấu ${item["gói chiết khấu theo kiện"]}</div>
					<div class="d-title">Ưu đãi lên đến</div>
					<div class="d-val" style="font-size: 1.2rem; margin-bottom: 15px;">Mức giá ưu đãi công bố:</div>
					<div style="font-size: 1.5rem; font-weight: 800; color: var(--primary-green);">
						${formatCurrency(item["chiết khấu công bố"])}
					</div>
					<div class="edit-controls" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
						<button class="btn-edit" onclick="openDiscountForm(${JSON.stringify(item).replace(/"/g, '&quot;')})">Sửa</button>
						<button class="btn-delete" onclick="deleteItem('${item["gói chiết khấu theo kiện"]}', 'discount')">Xóa</button>
					</div>
				`;
				grid.appendChild(div);
			});
		}

		function showLightbox(src) {
			const lb = document.getElementById('lightbox');
			const img = document.getElementById('lightboxImg');
			img.src = src;
			lb.classList.add('active');
		}
	</script>
</body>

</html>