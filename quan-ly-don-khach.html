<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Qu·∫£n L√Ω ƒê∆°n H√†ng - Kh√°ch H√†ng</title>
	<link rel="icon
		href="
		https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgC6ibu0IT2Ihhik57NmlGYZgx57h3XvSk5dLipgo7cZTS0pEV7dmPGQZhwXAxTFqFH9l2C74l14MamphdzEWaRBZbeWSUsyIh2Wd-wKuPv274PMjrAgMtirxbfrK-eUcFp5Rx0cFL7uPMA93RBiWrnp5sghMDD78oBCEk3FA_QbZUY4eG3jTZK_nt65vM/s1600/logo12.png"
		type="image/png">
	<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
		rel="stylesheet">
	<style>
		:root {
			--primary: #FFD700;
			--primary-dark: #FFC000;
			--accent: #FDB931;
			--dark: #121212;
			--dark-card: #1e1e1e;
			--text-light: #ffffff;
			--text-gray: #a0a0a0;
			--success: #00c853;
			--danger: #ff3d00;
			--glass: rgba(255, 255, 255, 0.05);
			--glass-border: rgba(255, 255, 255, 0.1);
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Plus Jakarta Sans', sans-serif;
		}

		body {
			background-color: var(--dark);
			color: var(--text-light);
			min-height: 100vh;
			overflow-x: hidden;
		}

		.bg-gradient {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: radial-gradient(circle at 50% 50%, #1e1e1e 0%, #121212 100%);
			z-index: -1;
		}

		.container {
			max-width: 1300px;
			margin: 0 auto;
			padding: 40px 20px;
		}

		header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 40px;
		}

		.header-left h1 {
			font-size: 2.2rem;
			font-weight: 800;
			background: linear-gradient(to right, var(--primary), #fff);
			-webkit-background-clip: text;
			background-clip: text;
			-webkit-text-fill-color: transparent;
		}

		/* Tabs */
		.tab-container {
			display: flex;
			gap: 15px;
			margin-bottom: 30px;
			border-bottom: 1px solid var(--glass-border);
			padding-bottom: 10px;
		}

		.tab-btn {
			padding: 12px 25px;
			background: none;
			border: none;
			color: var(--text-gray);
			cursor: pointer;
			font-weight: 600;
			font-size: 1rem;
			transition: all 0.3s;
			position: relative;
		}

		.tab-btn.active {
			color: var(--primary);
		}

		.tab-btn.active::after {
			content: '';
			position: absolute;
			bottom: -11px;
			left: 0;
			width: 100%;
			height: 2px;
			background: var(--primary);
			box-shadow: 0 0 10px var(--primary);
		}

		.tab-content {
			display: none;
			animation: fadeIn 0.4s ease-out;
		}

		.tab-content.active {
			display: block;
		}

		/* Actions Bar */
		.actions-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 25px;
			gap: 20px;
		}

		.search-box {
			flex: 1;
			position: relative;
			max-width: 400px;
		}

		.search-box input {
			width: 100%;
			padding: 12px 20px 12px 45px;
			background: var(--glass);
			border: 1px solid var(--glass-border);
			border-radius: 12px;
			color: white;
			outline: none;
		}

		/* Buttons */
		.btn {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			padding: 12px 24px;
			border-radius: 12px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.3s;
			border: none;
			font-size: 0.95rem;
		}

		.btn-primary {
			background: var(--primary);
			color: var(--dark);
		}

		.btn-glass {
			background: var(--glass);
			border: 1px solid var(--glass-border);
			color: white;
		}

		/* Table */
		.table-wrapper {
			background: var(--glass);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			overflow-x: auto;
			backdrop-filter: blur(10px);
		}

		table {
			width: 100%;
			border-collapse: collapse;
			text-align: left;
		}

		th {
			padding: 20px;
			color: var(--text-gray);
			font-weight: 600;
			border-bottom: 1px solid var(--glass-border);
			font-size: 0.85rem;
			text-transform: uppercase;
			letter-spacing: 1px;
		}

		td {
			padding: 18px 20px;
			border-bottom: 1px solid var(--glass-border);
			font-size: 0.95rem;
		}

		tr:hover {
			background: rgba(255, 255, 255, 0.02);
		}

		.status-badge {
			padding: 5px 12px;
			border-radius: 20px;
			font-size: 0.8rem;
			font-weight: 600;
			background: rgba(0, 200, 83, 0.1);
			color: var(--success);
		}

		/* Modal */
		.modal {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.85);
			backdrop-filter: blur(10px);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 1000;
		}

		.modal.active {
			display: flex;
		}

		.modal-content {
			background: var(--dark-card);
			width: 95%;
			max-width: 900px;
			max-height: 90vh;
			border-radius: 24px;
			border: 1px solid var(--glass-border);
			padding: 40px;
			overflow-y: auto;
			position: relative;
		}

		.modal-header {
			margin-bottom: 30px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		/* Form */
		.form-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
			margin-bottom: 25px;
		}

		.form-group {
			display: flex;
			flex-direction: column;
			gap: 8px;
		}

		.form-group label {
			font-size: 0.9rem;
			color: var(--text-gray);
			font-weight: 500;
		}

		.form-group input,
		.form-group select,
		.form-group textarea {
			padding: 12px 16px;
			background: var(--glass);
			border: 1px solid var(--glass-border);
			border-radius: 12px;
			color: white;
			outline: none;
		}

		/* Choice Modal */
		.choice-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
			margin-top: 20px;
		}

		.choice-card {
			padding: 30px;
			background: var(--glass);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			text-align: center;
			cursor: pointer;
			transition: all 0.3s;
		}

		.choice-card:hover {
			border-color: var(--primary);
			transform: translateY(-5px);
			background: rgba(255, 215, 0, 0.05);
		}

		.choice-card svg {
			color: var(--primary);
			margin-bottom: 15px;
		}

		/* Order Rows (Dynamic Products) */
		.order-items-table {
			margin-top: 20px;
			width: 100%;
		}

		.order-items-table th {
			padding: 10px;
		}

		.order-items-table td {
			padding: 8px;
		}

		.total-section {
			margin-top: 30px;
			padding-top: 20px;
			border-top: 1px solid var(--glass-border);
			display: flex;
			flex-direction: column;
			align-items: flex-end;
			gap: 15px;
		}

		.total-row {
			display: flex;
			gap: 20px;
			font-size: 1.1rem;
		}

		.total-val {
			font-weight: 800;
			color: var(--primary);
			min-width: 150px;
			text-align: right;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* Loader */
		#loader {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			display: none;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			z-index: 2000;
			backdrop-filter: blur(5px);
		}

		.spinner {
			width: 50px;
			height: 50px;
			border: 4px solid var(--glass);
			border-top: 4px solid var(--primary);
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		/* Invoice Styling */
		.invoice-preview {
			background: white;
			color: #333;
			padding: 40px;
			border-radius: 8px;
			min-height: 100%;
		}

		.invoice-header {
			display: flex;
			justify-content: space-between;
			border-bottom: 2px solid #f0f0f0;
			padding-bottom: 20px;
			margin-bottom: 30px;
		}

		.invoice-title {
			color: #1a1a1a;
			font-size: 1.8rem;
			font-weight: 800;
		}

		.invoice-info-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 40px;
			margin-bottom: 30px;
		}

		.info-item label {
			display: block;
			color: #888;
			font-size: 0.8rem;
			text-transform: uppercase;
			margin-bottom: 5px;
		}

		.info-item p {
			font-weight: 600;
			color: #333;
		}

		.invoice-table {
			width: 100%;
			border-collapse: collapse;
			margin-bottom: 30px;
		}

		.invoice-table th {
			background: #f8f9fa;
			color: #555;
			border: none;
			padding: 12px 15px;
			font-size: 0.85rem;
		}

		.invoice-table td {
			padding: 15px;
			border-bottom: 1px solid #f0f0f0;
			color: #444;
		}

		.invoice-summary {
			display: flex;
			flex-direction: column;
			align-items: flex-end;
			gap: 10px;
		}

		.summary-row {
			display: flex;
			justify-content: space-between;
			width: 250px;
		}

		.summary-row.grand-total {
			border-top: 2px solid #333;
			padding-top: 10px;
			margin-top: 10px;
			font-weight: 800;
			font-size: 1.2rem;
			color: #000;
		}

		@media print {
			body * {
				visibility: hidden;
			}

			#invoiceModal,
			#invoiceModal * {
				visibility: visible;
			}

			#invoiceModal {
				position: absolute;
				left: 0;
				top: 0;
				width: 100%;
				background: white !important;
			}

			.modal-header,
			.btn-print-action {
				display: none !important;
			}

			.invoice-preview {
				box-shadow: none;
				border: none;
				padding: 0;
			}
		}
	</style>
</head>

<body>
	<div class="bg-gradient"></div>
	<div id="loader">
		<div class="spinner"></div>
		<p style="margin-top: 20px; font-weight: 600;">Vui l√≤ng ƒë·ª£i...</p>
	</div>

	<div class="container">
		<header>
			<div class="header-left">
				<h1>H·ªá Th·ªëng L√™n ƒê∆°n Kh√°ch H√†ng</h1>
				<p style="color: var(--text-gray); margin-top: 5px;">Qu·∫£n l√Ω d·ªØ li·ªáu chuy√™n nghi·ªáp v√† tinh g·ªçn</p>
			</div>
			<div class="header-right" style="display: flex; gap: 15px;">
				<button class="btn btn-glass" onclick="location.href='index.html'">Trang ch·ªß</button>
				<div id="userChip"
					style="background: var(--glass); border: 1px solid var(--glass-border); padding: 5px 20px; border-radius: 30px; display: flex; align-items: center; gap: 10px;">
					<span id="userName" style="font-weight: 600;">User</span>
				</div>
			</div>
		</header>

		<div class="tab-container">
			<button class="tab-btn active">üì¶ L·ªäCH S·ª¨ ƒê∆†N H√ÄNG</button>
		</div>

		<!-- Tab ƒê∆°n H√†ng -->
		<div id="ordersTab" class="tab-content active">
			<div class="actions-bar">
				<div class="search-box">
					<svg style="position: absolute; left: 15px; top: 12px; color: var(--text-gray);" width="20"
						height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<circle cx="11" cy="11" r="8"></circle>
						<line x1="21" y1="21" x2="16.65" y2="16.65"></line>
					</svg>
					<input type="text" id="orderSearch" placeholder="T√¨m ki·∫øm ƒë∆°n h√†ng, kh√°ch h√†ng..."
						onkeyup="filterOrders()">
				</div>
				<button class="btn btn-primary" onclick="openChoiceModal()">
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
						stroke-width="2.5">
						<line x1="12" y1="5" x2="12" y2="19"></line>
						<line x1="5" y1="12" x2="19" y2="12"></line>
					</svg>
					L√äN ƒê∆†N M·ªöI
				</button>
			</div>
			<div class="table-wrapper">
				<table id="ordersTable">
					<thead>
						<tr>
							<th>ID ƒê∆°n</th>
							<th>T√™n Kh√°ch H√†ng</th>
							<th>T·ªïng Ti·ªÅn</th>
							<th>Ng√†y T·∫°o</th>
							<th>Thao T√°c</th>
						</tr>
					</thead>
					<tbody id="ordersBody"></tbody>
				</table>
			</div>
		</div>
	</div>

	<!-- Modal Ch·ªçn lo·∫°i kh√°ch -->
	<div id="choiceModal" class="modal">
		<div class="modal-content" style="max-width: 500px;">
			<h2 style="text-align: center; margin-bottom: 30px;">B·∫°n mu·ªën l√™n ƒë∆°n cho ai?</h2>
			<div class="choice-grid">
				<div class="choice-card" onclick="startNewCustomerOrder()">
					<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
						<circle cx="8.5" cy="7" r="4"></circle>
						<line x1="20" y1="8" x2="20" y2="14"></line>
						<line x1="17" y1="11" x2="23" y2="11"></line>
					</svg>
					<h3>KH√ÅCH H√ÄNG M·ªöI</h3>
					<p style="font-size: 0.8rem; color: var(--text-gray); margin-top: 5px;">T·∫°o h·ªì s∆° v√† l√™n ƒë∆°n</p>
				</div>
				<div class="choice-card" onclick="startOldCustomerOrder()">
					<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
						<circle cx="8.5" cy="7" r="4"></circle>
						<polyline points="17 11 19 13 23 9"></polyline>
					</svg>
					<h3>KH√ÅCH H√ÄNG C≈®</h3>
					<p style="font-size: 0.8rem; color: var(--text-gray); margin-top: 5px;">Ch·ªçn kh√°ch t·ª´ danh s√°ch</p>
				</div>
			</div>
			<button class="btn btn-glass" style="width: 100%; margin-top: 25px; justify-content: center;"
				onclick="closeChoiceModal()">ƒê√≥ng</button>
		</div>
	</div>

	<!-- Modal Form Kh√°ch H√†ng -->
	<div id="customerModal" class="modal">
		<div class="modal-content" style="max-width: 500px;">
			<div class="modal-header">
				<h2 id="customerModalTitle">Th√™m Kh√°ch H√†ng M·ªõi</h2>
				<button class="btn-glass" style="padding: 5px; border-radius: 5px;"
					onclick="closeCustomerModal()">X</button>
			</div>
			<form id="customerForm">
				<input type="hidden" id="custId">
				<div class="form-group" style="margin-bottom: 20px;">
					<label>T√™n kh√°ch h√†ng *</label>
					<input type="text" id="custName" required placeholder="Nh·∫≠p t√™n kh√°ch h√†ng...">
				</div>
				<div class="form-group" style="margin-bottom: 20px;">
					<label>S·ªë ƒëi·ªán tho·∫°i</label>
					<input type="text" id="custPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i...">
				</div>
				<div class="form-group" style="margin-bottom: 25px;">
					<label>Ghi ch√∫</label>
					<textarea id="custNote" rows="3" placeholder="Ghi ch√∫ th√™m..."></textarea>
				</div>
				<button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">L∆ØU TH√îNG
					TIN</button>
			</form>
		</div>
	</div>

	<!-- Modal L√™n ƒê∆°n H√†ng -->
	<div id="orderModal" class="modal">
		<div class="modal-content" style="max-width: 1100px;">
			<div class="modal-header">
				<h2 id="orderModalTitle">L√™n ƒê∆°n H√†ng M·ªõi</h2>
				<button class="btn-glass" style="padding: 5px; border-radius: 5px;"
					onclick="closeOrderModal()">X</button>
			</div>
			<div class="form-grid">
				<div class="form-group">
					<label>Kh√°ch h√†ng *</label>
					<select id="orderCustSelect" required>
						<option value="">-- Ch·ªçn kh√°ch h√†ng --</option>
					</select>
				</div>
				<div class="form-group">
					<label>Ghi ch√∫ ƒë∆°n h√†ng</label>
					<input type="text" id="orderGlobalNote" placeholder="V√≠ d·ª•: Giao g·∫•p bu·ªïi chi·ªÅu...">
				</div>
			</div>

			<div style="margin: 20px 0; display: flex; justify-content: space-between; align-items: center;">
				<h3 style="font-size: 1rem; color: var(--primary);">DANH S√ÅCH S·∫¢N PH·∫®M TRONG ƒê∆†N</h3>
				<div style="display:flex; gap:8px; align-items:center;">
					<button class="btn btn-glass" type="button" id="addRowButton" style="padding:6px 10px;">+ Th√™m
						d√≤ng</button>
					<button class="btn" type="button" id="draftButton"
						style="background:#fff;border-radius:6px;padding:6px 10px;">ƒê∆°n Nh√°p</button>
					<button class="btn btn-primary" type="button" id="finalizedButton" style="padding:6px 10px;">ƒê∆°n
						Ch·ªët</button>
				</div>
			</div>

			<div class="table-wrapper" style="border-radius: 12px; max-height: 400px;">
				<table class="order-items-table">
					<thead>
						<tr>
							<th style="width: 250px;">Ng√†nh h√†ng</th>
							<th style="width: 300px;">S·∫£n ph·∫©m</th>
							<th style="width: 120px;">ƒê∆°n gi√°</th>
							<th style="width: 80px;">S.L∆∞·ª£ng</th>
							<th>Th√†nh ti·ªÅn</th>
							<th style="width: 40px;"></th>
						</tr>
					</thead>
					<tbody id="orderItemsBody"></tbody>
				</table>
			</div>

			<div class="total-section">
				<div class="total-row">
					<span>Ti·ªÅn h√†ng:</span>
					<span id="totalProductMoney" class="total-val">0 ƒë</span>
				</div>
				<div class="total-row" style="align-items: center;">
					<select id="extraServiceType"
						style="background: var(--glass); border: 1px solid var(--glass-border); color: white; border-radius: 8px; padding: 5px; margin-right: 10px; cursor: pointer;"
						onchange="calculateOrderTotal()">
						<option value="v·∫≠n chuy·ªÉn">Ti·ªÅn v·∫≠n chuy·ªÉn</option>
						<option value="chi·∫øt kh·∫•u">Chi·∫øt kh·∫•u ƒë∆°n</option>
						<option value="kh√°c">D·ªãch v·ª• kh√°c</option>
					</select>
					<div style="position: relative; display: flex; align-items: center;">
						<span id="minusSign"
							style="color: var(--danger); font-weight: 800; margin-right: 5px; display: none;">-</span>
						<input type="text" id="orderExtraService" value="0"
							style="width: 150px; text-align: right; background: var(--glass); border: 1px solid var(--glass-border); color: white; border-radius: 8px; padding: 5px 10px;"
							onkeyup="formatCurrencyInput(this); calculateOrderTotal();">
					</div>
				</div>
				<div class="total-row"
					style="font-size: 1.4rem; margin-top: 10px; border-top: 1px dashed var(--glass-border); padding-top: 15px;">
					<span>T·ªîNG C·ªòNG ƒê∆†N:</span>
					<span id="orderFinalTotal" class="total-val" style="color: var(--primary);">0 ƒë</span>
				</div>
			</div>

			<div style="margin-top: 30px; display: flex; justify-content: flex-end; gap: 15px;">
				<button class="btn btn-glass" onclick="closeOrderModal()">H·ª¶Y</button>
				<button class="btn btn-primary" onclick="saveOrder()">X√ÅC NH·∫¨N L∆ØU ƒê∆†N</button>
			</div>
		</div>
	</div>

	<!-- Modal Xem Chi Ti·∫øt ƒê∆°n H√†ng (Phi·∫øu ƒê∆°n) -->
	<div id="invoiceModal" class="modal">
		<div class="modal-content" style="max-width: 850px; padding: 0; overflow: hidden;">
			<div class="modal-header" style="padding: 20px 40px; background: var(--dark-card); margin-bottom: 0;">
				<h2 style="font-size: 1.2rem;">CHI TI·∫æT ƒê∆†N H√ÄNG</h2>
				<div style="display: flex; gap: 10px;">
					<button class="btn btn-primary btn-print-action" onclick="window.print()"
						style="padding: 8px 15px; font-size: 0.85rem;">üñ®Ô∏è IN PHI·∫æU</button>
					<button class="btn btn-glass" style="padding: 5px 12px;" onclick="closeInvoiceModal()">X</button>
				</div>
			</div>

			<div class="invoice-preview" id="invoiceContent">
				<!-- Content dynamic -->
			</div>
		</div>
	</div>

	<script>
		// --- CONFIG & DATA ---
		const ORDER_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxOQTGo9JGfVthBQ33DMpTEwkZArvWT-7hF9abPSh7LHT3zYQYa8hErzcBarYtCg65WWA/exec';
		const PRODUCT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzM8tzbdJJvXE0r6NcP8cJGO2RHsgYUR6Jy73U4NDLkSQRjT3fus_i4lugwVQZIKI8zhw/exec';
		const KHACH_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxJ_SMcR1BOrVrZ9Ym0pmhuAa4XbP0ASvYPM5LhQxZLenCLvWy-Nc0jBiv3finAByac/exec';

		let userData = {};
		let currentCustomers = [];
		let currentOrders = [];
		let availableProducts = [];
		let editOrderId = null;

		// --- INITIALIZATION ---
		document.addEventListener('DOMContentLoaded', () => {
			const userStr = localStorage.getItem('userLoggedIn');
			if (!userStr) {
				location.href = 'index.html';
				return;
			}
			userData = JSON.parse(userStr);
			document.getElementById('userName').innerText = userData.name;

			loadAllData();
		});

		async function loadAllData() {
			showLoader(true);
			try {
				await Promise.all([
					fetchCustomers(),
					fetchOrders(),
					fetchProducts()
				]);
				renderCustomers();
				renderDetailedOrders();
			} catch (err) {
				console.error("Load failed", err);
			} finally {
				showLoader(false);
			}
		}

		async function fetchCustomers() {
			try {
				const url = `${KHACH_SCRIPT_URL}?action=read&username=${encodeURIComponent(userData.email)}`;
				const res = await fetch(url);
				const json = await res.json();
				if (json.success) {
					currentCustomers = json.data;
				}
			} catch (e) { console.error("Customer fetch error", e); }
		}

		async function fetchOrders() {
			let jsonData = [];
			try {
				const res = await fetch('data/data_don_hang.json');
				if (res.ok) {
					const raw = await res.json();
					jsonData = raw.map(item => {
						const newItem = {};
						Object.keys(item).forEach(k => {
							const normK = k.replace(/\s+/g, '').toLowerCase();
							newItem[normK] = item[k];
						});
						return newItem;
					}).filter(item => item.mailƒëƒÉngnh·∫≠p === userData.email);
				}
			} catch (e) { console.warn("No local order JSON or error", e); }

			try {
				const res = await fetch(`${ORDER_SCRIPT_URL}?action=read_orders&email=${encodeURIComponent(userData.email)}`);
				const json = await res.json();
				if (json.success) {
					const sheetData = json.data;
					// Merge orders by ID. Each order might have multiple rows.
					// We'll prioritize sheet data if the order ID exists in sheet.
					const merged = [...sheetData];
					const sheetOrderIds = new Set(sheetData.map(s => s.idƒë∆°nh√†ng));

					jsonData.forEach(j => {
						if (!sheetOrderIds.has(j.idƒë∆°nh√†ng)) merged.push(j);
					});
					currentOrders = merged;
				} else {
					currentOrders = jsonData;
				}
			} catch (e) { currentOrders = jsonData; }
		}

		async function fetchProducts() {
			let jsonData = [];
			try {
				const res = await fetch(`https://docs.google.com/uc?export=download&id=1Gt36oOwInVsa2VJXepZicTNQoQWJKT5A&t=${new Date().getTime()}`);
				if (res.ok) {
					const raw = await res.json();
					jsonData = raw.map(item => {
						const newItem = {};
						Object.keys(item).forEach(k => {
							const normK = k.replace(/\s+/g, '').toLowerCase();
							newItem[normK] = item[k];
						});
						// Map internal naming
						if (newItem.id_san_pham === undefined && newItem.idsanpham) newItem.id_san_pham = newItem.idsanpham;
						if (newItem.ten_san_pham === undefined && newItem.tensanpham) newItem.ten_san_pham = newItem.tensanpham;
						if (newItem.gia_san_pham === undefined && newItem.giasanpham) newItem.gia_san_pham = newItem.giasanpham;
						if (newItem.ten_nghanh_hang === undefined && newItem.tennghanhhang) newItem.ten_nghanh_hang = newItem.tennghanhhang;

						return newItem;
					}).filter(item => item.ten_dang_nhap === userData.email);
				}
			} catch (e) { console.warn("No local product JSON or error", e); }

			try {
				const res = await fetch(`${PRODUCT_SCRIPT_URL}?action=read&username=${encodeURIComponent(userData.email)}`);
				const json = await res.json();
				if (json.success) {
					const sheetData = json.data;
					const merged = [...sheetData];
					const sheetIds = new Set(sheetData.map(s => s.id_san_pham));

					jsonData.forEach(j => {
						if (!sheetIds.has(j.id_san_pham)) merged.push(j);
					});
					availableProducts = merged;
				} else {
					availableProducts = jsonData;
				}
			} catch (e) { availableProducts = jsonData; }
		}

		// --- TAB SWITCH --
		function switchTab(tab) {
			document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
			document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

			if (tab === 'orders') {
				document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
				document.getElementById('ordersTab').classList.add('active');
			} else {
				document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
				document.getElementById('customersTab').classList.add('active');
			}
		}

		// --- CUSTOMER LOGIC ---
		function renderCustomers() {
			const body = document.getElementById('customersBody');
			body.innerHTML = currentCustomers.map(c => `
				<tr>
					<td style="font-weight:700; color:var(--primary);">${c.idkh√°chh√†ng}</td>
					<td style="font-weight:600;">${c.t√™nkh√°chh√†ng}</td>
					<td>${c.phone || '-'}</td>
					<td style="color:var(--text-gray); font-size:0.85rem;">${c.ghich√∫ || '-'}</td>
					<td>
						<div style="display:flex; gap:10px;">
							<button class="btn-glass" style="padding:5px 10px;" onclick="openCustomerModal('edit', '${c.idkh√°chh√†ng}')">S·ª≠a</button>
							<button class="btn-glass" style="padding:5px 10px; color:var(--danger);" onclick="deleteCustomer('${c.idkh√°chh√†ng}')">X√≥a</button>
						</div>
					</td>
				</tr>
			`).join('');

			// C·∫≠p nh·∫≠t select kh√°ch h√†ng trong form l√™n ƒë∆°n
			const select = document.getElementById('orderCustSelect');
			select.innerHTML = '<option value="">-- Ch·ªçn kh√°ch h√†ng --</option>' +
				currentCustomers.map(c => `<option value="${c.idkh√°chh√†ng}">${c.t√™nkh√°chh√†ng} (${c.idkh√°chh√†ng})</option>`).join('');
		}

		function filterCustomers() {
			// Redundant since tab removed
		}

		// --- ORDER LOGIC ---
		function openChoiceModal() { document.getElementById('choiceModal').classList.add('active'); }
		function closeChoiceModal() { document.getElementById('choiceModal').classList.remove('active'); }

		function startNewCustomerOrder() {
			window.location.href = 'khach-hang-form';
		}

		function startOldCustomerOrder() {
			closeChoiceModal();
			openOrderModal('create');
		}

		function renderDetailedOrders() {
			const body = document.getElementById('ordersBody');
			// Nh√≥m c√°c d√≤ng theo id ƒë∆°n h√†ng
			const ordersMap = {};
			currentOrders.forEach(row => {
				const id = row.idƒë∆°nh√†ng;
				if (!ordersMap[id]) {
					ordersMap[id] = {
						id: id,
						customer: row.t√™nkh√°chh√†ng,
						total: row.t·ªïngti·ªÅntrongƒë∆°n,
						date: row.ng√†yt·∫°o,
						rows: []
					};
				}
				ordersMap[id].rows.push(row);
			});

			const orderList = Object.values(ordersMap).reverse();
			body.innerHTML = orderList.map(o => `
				<tr>
					<td style="font-weight:700; color:var(--primary);">${o.id}</td>
					<td style="font-weight:600;">${o.customer}</td>
					<td style="color:var(--accent); font-weight:700;">${formatCurrency(o.total)}</td>
					<td style="font-size:0.85rem; color:var(--text-gray);">${o.date || '-'}</td>
					<td>
						<div style="display:flex; gap:10px;">
							<button class="btn-glass" style="padding:5px 10px; color:var(--primary);" onclick="viewInvoice('${o.id}')">Xem</button>
							<button class="btn-glass" style="padding:5px 10px;" onclick="openOrderModal('edit', '${o.id}')">S·ª≠a</button>
							<button class="btn-glass" style="padding:5px 10px; color:var(--danger);" onclick="deleteOrder('${o.id}')">X√≥a</button>
						</div>
					</td>
				</tr>
			`).join('');
		}

		function openOrderModal(mode, preselectedCustId = null) {
			const modal = document.getElementById('orderModal');
			document.getElementById('orderItemsBody').innerHTML = '';
			document.getElementById('orderExtraService').value = '0';
			document.getElementById('orderGlobalNote').value = '';
			document.getElementById('extraServiceType').value = 'v·∫≠n chuy·ªÉn';
			document.getElementById('minusSign').style.display = 'none';

			if (mode === 'create') {
				editOrderId = null;
				document.getElementById('orderModalTitle').innerText = 'L√™n ƒê∆°n H√†ng M·ªõi';
				if (preselectedCustId) document.getElementById('orderCustSelect').value = preselectedCustId;
				else {
					document.getElementById('orderCustSelect').value = '';
					window.isNewCustomerFlow = false; // Reset if opened normally
				}
				addOrderRow();
			} else {
				// Mode EDIT: id ·ªü ƒë√¢y ch√≠nh l√† m√£ ƒë∆°n h√†ng
				editOrderId = preselectedCustId;
				window.isNewCustomerFlow = false;
				const orderRows = currentOrders.filter(r => r.idƒë∆°nh√†ng === editOrderId);
				if (orderRows.length > 0) {
					document.getElementById('orderModalTitle').innerText = 'Ch·ªânh S·ª≠a ƒê∆°n: ' + editOrderId;
					document.getElementById('orderCustSelect').value = orderRows[0].idkh√°chh√†ng;
					document.getElementById('orderGlobalNote').value = orderRows[0].ghich√∫;

					const extraVal = orderRows[0].d·ªãchv·ª•th√™mtrongƒë∆°n || 0;
					if (extraVal < 0) {
						document.getElementById('extraServiceType').value = 'chi·∫øt kh·∫•u';
						document.getElementById('orderExtraService').value = formatCurrencyNoSign(Math.abs(extraVal));
					} else {
						document.getElementById('extraServiceType').value = 'v·∫≠n chuy·ªÉn';
						document.getElementById('orderExtraService').value = formatCurrencyNoSign(extraVal);
					}

					orderRows.forEach(row => addOrderRow(row));
				}
			}

			calculateOrderTotal();
			modal.classList.add('active');
		}

		function closeOrderModal() { document.getElementById('orderModal').classList.remove('active'); }

		function viewInvoice(id) {
			const rows = currentOrders.filter(r => r.idƒë∆°nh√†ng === id);
			if (rows.length === 0) return;

			const main = rows[0];
			const content = document.getElementById('invoiceContent');

			let itemsHtml = rows.map((r, i) => `
				<tr>
					<td style="text-align:center;">${i + 1}</td>
					<td>
						<div style="font-weight:700;">${r.t√™ns·∫£nph·∫©m}</div>
						<div style="font-size:0.75rem; color:#888;">${r.t√™nng√†nhh√†ng}</div>
					</td>
					<td style="text-align:right;">${formatCurrencyNoSign(r.gi√°s·∫£nph·∫©m)}</td>
					<td style="text-align:center;">${r.s·ªël∆∞·ª£ng}</td>
					<td style="text-align:right; font-weight:700;">${formatCurrencyNoSign(r.th√†nhti·ªÅn)}</td>
				</tr>
			`).join('');

			content.innerHTML = `
				<div class="invoice-header">
					<div>
						<div class="invoice-title">H√ìA ƒê∆†N B√ÅN H√ÄNG</div>
						<p style="color:#d35400; font-weight:800; margin-top:5px;">M√£ ƒë∆°n: ${main.idƒë∆°nh√†ng}</p>
					</div>
					<div style="text-align:right;">
						<p style="font-size:0.85rem; color:#666;">Nh√¢n vi√™n: <strong style="color:#333;">${userData.name}</strong></p>
						<p style="font-size:0.85rem; color:#666;">Ng√†y l·∫≠p: ${main.ng√†yt·∫°o || '-'}</p>
					</div>
				</div>

				<div class="invoice-info-grid">
					<div class="info-item">
						<label>Kh√°ch h√†ng</label>
						<p style="font-size:1.1rem;">${main.t√™nkh√°chh√†ng}</p>
						<p style="font-size:0.85rem; font-weight:400; color:#666;">M√£ KH: ${main.idkh√°chh√†ng}</p>
					</div>
					<div class="info-item" style="text-align:right;">
						<label>Ghi ch√∫ ƒë∆°n h√†ng</label>
						<p style="font-weight:400; color:#555;">${main.ghich√∫ || 'Kh√¥ng c√≥ ghi ch√∫'}</p>
					</div>
				</div>

				<table class="invoice-table">
					<thead>
						<tr>
							<th style="width:40px;">STT</th>
							<th>S·∫£n ph·∫©m / Ng√†nh h√†ng</th>
							<th style="width:120px; text-align:right;">ƒê∆°n gi√°</th>
							<th style="width:60px; text-align:center;">SL</th>
							<th style="width:120px; text-align:right;">Th√†nh ti·ªÅn</th>
						</tr>
					</thead>
					<tbody>
						${itemsHtml}
					</tbody>
				</table>

				<div class="invoice-summary">
					<div class="summary-row">
						<span>Ti·ªÅn h√†ng:</span>
						<span style="font-weight:600;">${formatCurrency(main.t·ªïngti·ªÅnh√†ng)}</span>
					</div>
					<div class="summary-row">
						<span>${main.d·ªãchv·ª•th√™mtrongƒë∆°n < 0 ? 'Chi·∫øt kh·∫•u:' : 'D·ªãch v·ª•/VC:'}</span>
						<span style="font-weight:600;">${formatCurrency(main.d·ªãchv·ª•th√™mtrongƒë∆°n)}</span>
					</div>
					<div class="summary-row grand-total">
						<span>T·ªîNG C·ªòNG:</span>
						<span>${formatCurrency(main.t·ªïngti·ªÅntrongƒë∆°n)}</span>
					</div>
				</div>

				<div style="margin-top:50px; display:flex; justify-content:space-between; padding:0 40px;">
					<div style="text-align:center;">
						<p style="font-size:0.85rem; font-weight:700;">NG∆Ø·ªúI MUA H√ÄNG</p>
						<p style="font-size:0.75rem; color:#888; margin-top:40px;">(K√Ω v√† ghi r√µ h·ªç t√™n)</p>
					</div>
					<div style="text-align:center;">
						<p style="font-size:0.85rem; font-weight:700;">NG∆Ø·ªúI L·∫¨P ƒê∆†N</p>
						<p style="font-size:0.9rem; margin-top:5px; color:#1976d2;">${userData.name}</p>
						<p style="font-size:0.75rem; color:#888; margin-top:20px;">(K√Ω v√† ghi r√µ h·ªç t√™n)</p>
					</div>
				</div>
			`;

			document.getElementById('invoiceModal').classList.add('active');
		}

		function closeInvoiceModal() { document.getElementById('invoiceModal').classList.remove('active'); }

		function addOrderRow(data = null) {
			const tbody = document.getElementById('orderItemsBody');
			const row = document.createElement('tr');

			// L·∫•y danh s√°ch ng√†nh h√†ng duy nh·∫•t
			const categories = [...new Set(availableProducts.map(p => p.ten_nghanh_hang))].filter(Boolean);
			const catOptions = categories.map(cat => `<option value="${cat}" ${data && data.t√™nng√†nhh√†ng === cat ? 'selected' : ''}>${cat}</option>`).join('');

			row.innerHTML = `
				<td>
					<select class="item-category" style="width:100%; padding:8px;" onchange="filterProductsByCategory(this)">
						<option value="">-- Ch·ªçn ng√†nh h√†ng --</option>
						${catOptions}
					</select>
				</td>
				<td>
					<select class="item-product" style="width:100%; padding:8px;" onchange="updateRowPrice(this)">
						<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
					</select>
				</td>
				<td><input type="text" class="item-price" value="0" style="width:100%; text-align:right;" readonly></td>
				<td><input type="text" inputmode="decimal" class="item-qty" value="${data ? data.s·ªël∆∞·ª£ng : '1'}" style="width:100%;" oninput="calculateOrderTotal()" onkeyup="calculateOrderTotal()"></td>
				<td><span class="item-total" style="font-weight:600;">0 ƒë</span></td>
				<td><button class="btn-glass" style="padding:5px; color:var(--danger);" onclick="this.closest('tr').remove(); calculateOrderTotal();">X</button></td>
			`;
			tbody.appendChild(row);

			// N·∫øu c√≥ d·ªØ li·ªáu (S·ª≠a ƒë∆°n), ta c·∫ßn fill s·∫£n ph·∫©m theo ng√†nh h√†ng ƒë√£ ch·ªçn
			if (data) {
				const catSelect = row.querySelector('.item-category');
				filterProductsByCategory(catSelect, data.ids·∫£nph·∫©m);
				row.querySelector('.item-price').value = formatCurrencyNoSign(data.gi√°s·∫£nph·∫©m);
			}

			calculateOrderTotal();
		}

		function filterProductsByCategory(catSelect, selectedProdId = null) {
			const row = catSelect.closest('tr');
			const prodSelect = row.querySelector('.item-product');
			const category = catSelect.value;

			const filtered = availableProducts.filter(p => p.ten_nghanh_hang === category);
			prodSelect.innerHTML = '<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>' +
				filtered.map(p => `<option value="${p.id_san_pham}" data-price="${p.gia_san_pham}" data-cat="${p.ten_nghanh_hang}" ${selectedProdId === p.id_san_pham ? 'selected' : ''}>${p.ten_san_pham}</option>`).join('');

			if (!selectedProdId) {
				row.querySelector('.item-price').value = '0';
				calculateOrderTotal();
			}
		}

		function updateRowPrice(select) {
			const row = select.closest('tr');
			const option = select.options[select.selectedIndex];
			const price = option.getAttribute('data-price') || 0;
			row.querySelector('.item-price').value = formatCurrencyNoSign(price);
			calculateOrderTotal();
		}

		function calculateOrderTotal() {
			let productTotal = 0;
			document.querySelectorAll('#orderItemsBody tr').forEach(row => {
				const select = row.querySelector('.item-product');
				const option = select.options[select.selectedIndex];
				const priceText = row.querySelector('.item-price').value;
				const price = parseFlexibleNumber(priceText);
				const qtyText = row.querySelector('.item-qty').value;
				const qty = parseFlexibleNumber(qtyText);
				const rowTotal = price * qty;
				row.querySelector('.item-total').innerText = formatCurrency(rowTotal);
				productTotal += rowTotal;
			});

			const type = document.getElementById('extraServiceType').value;
			let extra = parseFlexibleNumber(document.getElementById('orderExtraService').value);
			if (type === 'chi·∫øt kh·∫•u') {
				document.getElementById('minusSign').style.display = 'inline';
				extra = -Math.abs(extra);
			} else {
				document.getElementById('minusSign').style.display = 'none';
				extra = Math.abs(extra);
			}

			document.getElementById('totalProductMoney').innerText = formatCurrency(productTotal);
			document.getElementById('orderFinalTotal').innerText = formatCurrency(productTotal + extra);
		}

		async function saveOrder() {
			const custId = document.getElementById('orderCustSelect').value;
			if (!custId) return alert("Vui l√≤ng ch·ªçn kh√°ch h√†ng");

			const customer = currentCustomers.find(c => c.idkh√°chh√†ng === custId);
			const rows = [];
			const type = document.getElementById('extraServiceType').value;
			let extra = parseInt(document.getElementById('orderExtraService').value.replace(/\./g, '')) || 0;
			if (type === 'chi·∫øt kh·∫•u') extra = -Math.abs(extra);
			const globalNote = document.getElementById('orderGlobalNote').value;

			let productTotal = 0;
			const inventoryRecords = []; // Collect products for inventory recording
			document.querySelectorAll('#orderItemsBody tr').forEach(tr => {
				const select = tr.querySelector('.item-product');
				const option = select.options[select.selectedIndex];
				if (!option.value) return;

				const qty = parseFlexibleNumber(tr.querySelector('.item-qty').value);
				const price = parseFlexibleNumber(tr.querySelector('.item-price').value);
				const subTotal = price * qty;
				productTotal += subTotal;

				rows.push({
					'ph√¢n lo·∫°i kh√°ch h√†ng': window.isNewCustomerFlow ? 'Kh√°ch m·ªõi' : 'Kh√°ch c≈©',
					't√™n kh√°ch h√†ng': customer.t√™nkh√°chh√†ng,
					'id kh√°ch h√†ng': customer.idkh√°chh√†ng,
					't√™n ng√†nh h√†ng': option.getAttribute('data-cat'),
					't√™n s·∫£n ph·∫©m': option.text,
					'id s·∫£n ph·∫©m': option.value,
					'gi√° s·∫£n ph·∫©m': price,
					's·ªë l∆∞·ª£ng': qty,
					'tr·∫°ng th√°i l√™n ƒë∆°n': window.orderStatus || '',
					'th√†nh ti·ªÅn': subTotal,
					't·ªïng ti·ªÅn h√†ng': 0, // S·∫Ω t√≠nh sau ho·∫∑c fill cho d√≤ng ƒë·∫ßu
					'd·ªãch v·ª• th√™m trong ƒë∆°n': extra,
					't·ªïng ti·ªÅn trong ƒë∆°n': 0, // S·∫Ω t√≠nh sau
					'ghi ch√∫': globalNote,
					'mail ƒëƒÉng nh·∫≠p': userData.email,
					'tr·∫°ng th√°i x√≥a': 'ACTIVE',
					'ng√†y t·∫°o': new Date().toLocaleString('vi-VN')
				});

				// N·∫øu ƒë∆°n l√† "ƒê∆°n Ch·ªët", th√™m v√†o inventory records (xu·∫•t h√†ng)
				if (window.orderStatus === 'ƒê∆°n Ch·ªët') {
					inventoryRecords.push({
						date: new Date().toISOString().split('T')[0],
						ten_san_pham: option.text,
						id_san_pham: option.value,
						so_luong_nhap: 0,
						so_luong_xuat: qty,
						con_lai: 0,
						ghi_chu: `Xu·∫•t t·ª´ ƒë∆°n h√†ng - ${customer.t√™nkh√°chh√†ng}`,
						ten_dang_nhap: userData.email,
						trang_thai: 'xu·∫•t'
					});
				}
			});

			if (rows.length === 0) return alert("H√†ng h√≥a tr·ªëng!");

			const finalTotal = productTotal + extra;
			rows.forEach(r => {
				r['t·ªïng ti·ªÅn h√†ng'] = productTotal;
				r['t·ªïng ti·ªÅn trong ƒë∆°n'] = finalTotal;
				r['tr·∫°ng th√°i l√™n ƒë∆°n'] = window.orderStatus || '';
			});

			showLoader(true);
			try {
				const res = await fetch(ORDER_SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: editOrderId ? 'update_order' : 'create_order',
						id: editOrderId,
						data: rows
					})
				});
				if ((await res.json()).success) {
					// N·∫øu ƒë∆°n l√† "ƒê∆°n Ch·ªët", ghi inventory (xu·∫•t h√†ng)
					if (window.orderStatus === 'ƒê∆°n Ch·ªët' && inventoryRecords.length > 0) {
						for (const invRecord of inventoryRecords) {
							try {
								const invRes = await fetch(PRODUCT_SCRIPT_URL, {
									method: 'POST',
									body: new URLSearchParams({
										payload: JSON.stringify({
											action: 'createInventory',
											data: invRecord
										})
									})
								});
								const invResult = await invRes.json();
								console.log('Inventory record saved:', invResult);
							} catch (err) {
								console.error('Failed to save inventory record:', err);
							}
						}
					}
					await fetchOrders();
					renderDetailedOrders();
					closeOrderModal();
					alert("ƒê√£ l∆∞u ƒë∆°n h√†ng!");
				}
			} finally { showLoader(false); }
		}

		async function deleteOrder(orderId) {
			if (!confirm("X√≥a to√†n b·ªô ƒë∆°n h√†ng n√†y?")) return;
			showLoader(true);
			try {
				const res = await fetch(ORDER_SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({ action: 'delete_order', id: orderId })
				});
				if ((await res.json()).success) {
					await fetchOrders();
					renderDetailedOrders();
				}
			} finally { showLoader(false); }
		}

		// --- HELPERS ---
		function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
		function formatCurrency(num) { return new Intl.NumberFormat('vi-VN').format(num) + ' ƒë'; }
		function formatCurrencyNoSign(num) { return new Intl.NumberFormat('vi-VN').format(num); }
		function formatCurrencyInput(input) {
			let val = input.value.replace(/\D/g, "");
			if (val === "") return;
			input.value = new Intl.NumberFormat('vi-VN').format(val);
		}

		// Parse flexible number formats: supports "1.234,56", "1234.56", "1 234,56", or plain digits
		function parseFlexibleNumber(s) {
			if (s === undefined || s === null) return 0;
			s = String(s).trim();
			if (!s) return 0;
			// remove spaces
			s = s.replace(/\s/g, '');
			// If contains both dot and comma, assume dot thousands, comma decimal
			if (s.indexOf('.') !== -1 && s.indexOf(',') !== -1) {
				// e.g. 1.234,56 -> 1234.56
				s = s.replace(/\./g, '').replace(',', '.');
			} else if (s.indexOf(',') !== -1) {
				// comma as decimal separator e.g. 1.5 -> 1.5 or "1,5" -> 1.5
				s = s.replace(',', '.');
			} else if (s.indexOf('.') !== -1) {
				// Only dots present. Could be thousand separators (e.g. 340.000) or decimal (e.g. 1234.56)
				// Heuristic: if last group after dot has exactly 3 digits, treat dots as thousand separators
				const parts = s.split('.');
				if (parts.length > 1 && parts[parts.length - 1].length === 3 && parts.every(p => /^\d+$/.test(p))) {
					// remove dots
					s = parts.join('');
				} else {
					// keep dot as decimal point, remove other non-digit chars
					s = s.replace(/[^0-9.\-]/g, '');
				}
			} else {
				// no separators, remove any non-digit
				s = s.replace(/[^0-9\-]/g, '');
			}
			const n = parseFloat(s);
			return isNaN(n) ? 0 : n;
		}

		function filterOrders() {
			const q = document.getElementById('orderSearch').value.toLowerCase();
			const rows = document.querySelectorAll('#ordersBody tr');
			rows.forEach(r => {
				r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
			});
		}

		function filterCustomers() {
			const q = document.getElementById('customerSearch').value.toLowerCase();
			const rows = document.querySelectorAll('#customersBody tr');
			rows.forEach(r => {
				r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
			});
		}

		// --- TR·∫†NG TH√ÅI ƒê∆†N H√ÄNG ---
		// No default selection: user must explicitly choose before saving (or leave blank)
		window.orderStatus = null;
		document.getElementById('addRowButton').addEventListener('click', function () { addOrderRow(); });

		// Visual toggle helper
		function setOrderStatus(status) {
			window.orderStatus = status;
			const draftBtn = document.getElementById('draftButton');
			const finalBtn = document.getElementById('finalizedButton');
			draftBtn.classList.toggle('btn-primary', status === 'ƒê∆°n Nh√°p');
			draftBtn.classList.toggle('btn', status !== 'ƒê∆°n Nh√°p');
			finalBtn.classList.toggle('btn-primary', status === 'ƒê∆°n Ch·ªët');
			finalBtn.classList.toggle('btn', status !== 'ƒê∆°n Ch·ªët');
		}

		document.getElementById('draftButton').addEventListener('click', function () {
			setOrderStatus('ƒê∆°n Nh√°p');
			// do NOT auto-save; user must press X√ÅC NH·∫¨N L∆ØU ƒê∆†N
		});

		document.getElementById('finalizedButton').addEventListener('click', function () {
			setOrderStatus('ƒê∆°n Ch·ªët');
			// do NOT auto-save; user must press X√ÅC NH·∫¨N L∆ØU ƒê∆†N
		});
	</script>
</body>

</html>