<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Qu·∫£n L√Ω ƒê∆°n H√†ng - Kh√°ch H√†ng</title>
	<link rel="icon"
		href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgC6ibu0IT2Ihhik57NmlGYZgx57h3XvSk5dLipgo7cZTS0pEV7dmPGQZhwXAxTFqFH9l2C74l14MamphdzEWaRBZbeWSUsyIh2Wd-wKuPv274PMjrAgMtirxbfrK-eUcFp5Rx0cFL7uPMA93RBiWrnp5sghMDD78oBCEk3FA_QbZUY4eG3jTZK_nt65vM/s1600/logo12.png"
		type="image/png">
	<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
		rel="stylesheet">
	<style>
		:root {
			--primary: #FFD700;
			--primary-dark: #FFC000;
			--accent: #FDB931;
			--dark: #121212;
			--dark-card: #1e1e1e;
			--text-light: #ffffff;
			--text-gray: #a0a0a0;
			--success: #00c853;
			--danger: #ff3d00;
			--glass: rgba(255, 255, 255, 0.05);
			--glass-border: rgba(255, 255, 255, 0.1);
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Plus Jakarta Sans', sans-serif;
		}

		body {
			background-color: var(--dark);
			color: var(--text-light);
			min-height: 100vh;
			overflow-x: hidden;
		}

		.bg-gradient {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: radial-gradient(circle at 50% 50%, #1e1e1e 0%, #121212 100%);
			z-index: -1;
		}

		.container {
			max-width: 1300px;
			margin: 0 auto;
			padding: 40px 20px;
		}

		header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 40px;
		}

		.header-left h1 {
			font-size: 2.2rem;
			font-weight: 800;
			background: linear-gradient(to right, var(--primary), #fff);
			-webkit-background-clip: text;
			background-clip: text;
			-webkit-text-fill-color: transparent;
		}

		/* Tabs */
		.tab-container {
			display: flex;
			gap: 15px;
			margin-bottom: 30px;
			border-bottom: 1px solid var(--glass-border);
			padding-bottom: 10px;
		}

		.tab-btn {
			padding: 12px 25px;
			background: none;
			border: none;
			color: var(--text-gray);
			cursor: pointer;
			font-weight: 600;
			font-size: 1rem;
			transition: all 0.3s;
			position: relative;
		}

		.tab-btn.active {
			color: var(--primary);
		}

		.tab-btn.active::after {
			content: '';
			position: absolute;
			bottom: -11px;
			left: 0;
			width: 100%;
			height: 2px;
			background: var(--primary);
			box-shadow: 0 0 10px var(--primary);
		}

		.tab-content {
			display: none;
			animation: fadeIn 0.4s ease-out;
		}

		.tab-content.active {
			display: block;
		}

		/* Actions Bar */
		.actions-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 25px;
			gap: 20px;
		}

		.search-box {
			flex: 1;
			position: relative;
			max-width: 400px;
		}

		.search-box input {
			width: 100%;
			padding: 12px 20px 12px 45px;
			background: var(--glass);
			border: 1px solid var(--glass-border);
			border-radius: 12px;
			color: white;
			outline: none;
		}

		/* Buttons */
		.btn {
			display: inline-flex;
			align-items: center;
			gap: 8px;
			padding: 12px 24px;
			border-radius: 12px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.3s;
			border: none;
			font-size: 0.95rem;
		}

		.btn-primary {
			background: var(--primary);
			color: var(--dark);
		}

		.btn-glass {
			background: var(--glass);
			border: 1px solid var(--glass-border);
			color: white;
		}

		/* Table */
		.table-wrapper {
			background: var(--glass);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			overflow-x: auto;
			backdrop-filter: blur(10px);
		}

		table {
			width: 100%;
			border-collapse: collapse;
			text-align: left;
		}

		th {
			padding: 20px;
			color: var(--text-gray);
			font-weight: 600;
			border-bottom: 1px solid var(--glass-border);
			font-size: 0.85rem;
			text-transform: uppercase;
			letter-spacing: 1px;
		}

		td {
			padding: 18px 20px;
			border-bottom: 1px solid var(--glass-border);
			font-size: 0.95rem;
		}

		tr:hover {
			background: rgba(255, 255, 255, 0.02);
		}

		.status-badge {
			padding: 5px 12px;
			border-radius: 20px;
			font-size: 0.8rem;
			font-weight: 600;
			background: rgba(0, 200, 83, 0.1);
			color: var(--success);
		}

		/* Modal */
		.modal {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.85);
			backdrop-filter: blur(10px);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 1000;
		}

		.modal.active {
			display: flex;
		}

		.modal-content {
			background: var(--dark-card);
			width: 95%;
			max-width: 900px;
			max-height: 90vh;
			border-radius: 24px;
			border: 1px solid var(--glass-border);
			padding: 40px;
			overflow-y: auto;
			position: relative;
		}

		.modal-header {
			margin-bottom: 30px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		/* Form */
		.form-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
			margin-bottom: 25px;
		}

		.form-group {
			display: flex;
			flex-direction: column;
			gap: 8px;
		}

		.form-group label {
			font-size: 0.9rem;
			color: var(--text-gray);
			font-weight: 500;
		}

		.form-group input,
		.form-group select,
		.form-group textarea {
			padding: 12px 16px;
			background: var(--glass);
			border: 1px solid var(--glass-border);
			border-radius: 12px;
			color: white;
			outline: none;
		}

		/* Choice Modal */
		.choice-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
			margin-top: 20px;
		}

		.choice-card {
			padding: 30px;
			background: var(--glass);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			text-align: center;
			cursor: pointer;
			transition: all 0.3s;
		}

		.choice-card:hover {
			border-color: var(--primary);
			transform: translateY(-5px);
			background: rgba(255, 215, 0, 0.05);
		}

		.choice-card svg {
			color: var(--primary);
			margin-bottom: 15px;
		}

		/* Order Rows (Dynamic Products) */
		.order-items-table {
			margin-top: 20px;
			width: 100%;
		}

		.order-items-table th {
			padding: 10px;
		}

		.order-items-table td {
			padding: 8px;
		}

		.total-section {
			margin-top: 30px;
			padding-top: 20px;
			border-top: 1px solid var(--glass-border);
			display: flex;
			flex-direction: column;
			align-items: flex-end;
			gap: 15px;
		}

		.total-row {
			display: flex;
			gap: 20px;
			font-size: 1.1rem;
		}

		.total-val {
			font-weight: 800;
			color: var(--primary);
			min-width: 150px;
			text-align: right;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* Loader */
		#loader {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			display: none;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			z-index: 2000;
			backdrop-filter: blur(5px);
		}

		.spinner {
			width: 50px;
			height: 50px;
			border: 4px solid var(--glass);
			border-top: 4px solid var(--primary);
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			100% {
				transform: rotate(360deg);
			}
		}
	</style>
</head>

<body>
	<div class="bg-gradient"></div>
	<div id="loader">
		<div class="spinner"></div>
		<p style="margin-top: 20px; font-weight: 600;">Vui l√≤ng ƒë·ª£i...</p>
	</div>

	<div class="container">
		<header>
			<div class="header-left">
				<h1>H·ªá Th·ªëng L√™n ƒê∆°n Kh√°ch H√†ng</h1>
				<p style="color: var(--text-gray); margin-top: 5px;">Qu·∫£n l√Ω d·ªØ li·ªáu chuy√™n nghi·ªáp v√† tinh g·ªçn</p>
			</div>
			<div class="header-right" style="display: flex; gap: 15px;">
				<button class="btn btn-glass" onclick="location.href='index.html'">Trang ch·ªß</button>
				<div id="userChip"
					style="background: var(--glass); border: 1px solid var(--glass-border); padding: 5px 20px; border-radius: 30px; display: flex; align-items: center; gap: 10px;">
					<span id="userName" style="font-weight: 600;">User</span>
				</div>
			</div>
		</header>

		<div class="tab-container">
			<button class="tab-btn active" onclick="switchTab('orders')">üì¶ L·ªäCH S·ª¨ ƒê∆†N H√ÄNG</button>
			<button class="tab-btn" onclick="switchTab('customers')">üë• DANH S√ÅCH KH√ÅCH H√ÄNG</button>
		</div>

		<!-- Tab ƒê∆°n H√†ng -->
		<div id="ordersTab" class="tab-content active">
			<div class="actions-bar">
				<div class="search-box">
					<svg style="position: absolute; left: 15px; top: 12px; color: var(--text-gray);" width="20"
						height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<circle cx="11" cy="11" r="8"></circle>
						<line x1="21" y1="21" x2="16.65" y2="16.65"></line>
					</svg>
					<input type="text" id="orderSearch" placeholder="T√¨m ki·∫øm ƒë∆°n h√†ng, kh√°ch h√†ng..."
						onkeyup="filterOrders()">
				</div>
				<button class="btn btn-primary" onclick="openChoiceModal()">
					<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
						stroke-width="2.5">
						<line x1="12" y1="5" x2="12" y2="19"></line>
						<line x1="5" y1="12" x2="19" y2="12"></line>
					</svg>
					L√äN ƒê∆†N M·ªöI
				</button>
			</div>
			<div class="table-wrapper">
				<table id="ordersTable">
					<thead>
						<tr>
							<th>ID ƒê∆°n</th>
							<th>T√™n Kh√°ch H√†ng</th>
							<th>T·ªïng Ti·ªÅn</th>
							<th>Ng√†y T·∫°o</th>
							<th>Thao T√°c</th>
						</tr>
					</thead>
					<tbody id="ordersBody"></tbody>
				</table>
			</div>
		</div>

		<!-- Tab Kh√°ch H√†ng -->
		<div id="customersTab" class="tab-content">
			<div class="actions-bar">
				<div class="search-box">
					<svg style="position: absolute; left: 15px; top: 12px; color: var(--text-gray);" width="20"
						height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<circle cx="11" cy="11" r="8"></circle>
						<line x1="21" y1="21" x2="16.65" y2="16.65"></line>
					</svg>
					<input type="text" id="customerSearch" placeholder="T√¨m t√™n kh√°ch, s·ªë ƒëi·ªán tho·∫°i..."
						onkeyup="filterCustomers()">
				</div>
				<button class="btn btn-primary" onclick="openCustomerModal('create')">+ TH√äM KH√ÅCH H√ÄNG</button>
			</div>
			<div class="table-wrapper">
				<table>
					<thead>
						<tr>
							<th>M√£ KH</th>
							<th>T√™n Kh√°ch H√†ng</th>
							<th>Phone</th>
							<th>Ghi Ch√∫</th>
							<th>Thao T√°c</th>
						</tr>
					</thead>
					<tbody id="customersBody"></tbody>
				</table>
			</div>
		</div>
	</div>

	<!-- Modal Ch·ªçn lo·∫°i kh√°ch -->
	<div id="choiceModal" class="modal">
		<div class="modal-content" style="max-width: 500px;">
			<h2 style="text-align: center; margin-bottom: 30px;">B·∫°n mu·ªën l√™n ƒë∆°n cho ai?</h2>
			<div class="choice-grid">
				<div class="choice-card" onclick="startNewCustomerOrder()">
					<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
						<circle cx="8.5" cy="7" r="4"></circle>
						<line x1="20" y1="8" x2="20" y2="14"></line>
						<line x1="17" y1="11" x2="23" y2="11"></line>
					</svg>
					<h3>KH√ÅCH H√ÄNG M·ªöI</h3>
					<p style="font-size: 0.8rem; color: var(--text-gray); margin-top: 5px;">T·∫°o h·ªì s∆° v√† l√™n ƒë∆°n</p>
				</div>
				<div class="choice-card" onclick="startOldCustomerOrder()">
					<svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
						<circle cx="8.5" cy="7" r="4"></circle>
						<polyline points="17 11 19 13 23 9"></polyline>
					</svg>
					<h3>KH√ÅCH H√ÄNG C≈®</h3>
					<p style="font-size: 0.8rem; color: var(--text-gray); margin-top: 5px;">Ch·ªçn kh√°ch t·ª´ danh s√°ch</p>
				</div>
			</div>
			<button class="btn btn-glass" style="width: 100%; margin-top: 25px; justify-content: center;"
				onclick="closeChoiceModal()">ƒê√≥ng</button>
		</div>
	</div>

	<!-- Modal Form Kh√°ch H√†ng -->
	<div id="customerModal" class="modal">
		<div class="modal-content" style="max-width: 500px;">
			<div class="modal-header">
				<h2 id="customerModalTitle">Th√™m Kh√°ch H√†ng M·ªõi</h2>
				<button class="btn-glass" style="padding: 5px; border-radius: 5px;"
					onclick="closeCustomerModal()">X</button>
			</div>
			<form id="customerForm">
				<input type="hidden" id="custId">
				<div class="form-group" style="margin-bottom: 20px;">
					<label>T√™n kh√°ch h√†ng *</label>
					<input type="text" id="custName" required placeholder="Nh·∫≠p t√™n kh√°ch h√†ng...">
				</div>
				<div class="form-group" style="margin-bottom: 20px;">
					<label>S·ªë ƒëi·ªán tho·∫°i</label>
					<input type="text" id="custPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i...">
				</div>
				<div class="form-group" style="margin-bottom: 25px;">
					<label>Ghi ch√∫</label>
					<textarea id="custNote" rows="3" placeholder="Ghi ch√∫ th√™m..."></textarea>
				</div>
				<button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center;">L∆ØU TH√îNG
					TIN</button>
			</form>
		</div>
	</div>

	<!-- Modal L√™n ƒê∆°n H√†ng -->
	<div id="orderModal" class="modal">
		<div class="modal-content" style="max-width: 1100px;">
			<div class="modal-header">
				<h2 id="orderModalTitle">L√™n ƒê∆°n H√†ng M·ªõi</h2>
				<button class="btn-glass" style="padding: 5px; border-radius: 5px;"
					onclick="closeOrderModal()">X</button>
			</div>
			<div class="form-grid">
				<div class="form-group">
					<label>Kh√°ch h√†ng *</label>
					<select id="orderCustSelect" required>
						<option value="">-- Ch·ªçn kh√°ch h√†ng --</option>
					</select>
				</div>
				<div class="form-group">
					<label>Ghi ch√∫ ƒë∆°n h√†ng</label>
					<input type="text" id="orderGlobalNote" placeholder="V√≠ d·ª•: Giao g·∫•p bu·ªïi chi·ªÅu...">
				</div>
			</div>

			<div style="margin: 20px 0; display: flex; justify-content: space-between; align-items: center;">
				<h3 style="font-size: 1rem; color: var(--primary);">DANH S√ÅCH S·∫¢N PH·∫®M TRONG ƒê∆†N</h3>
				<button class="btn btn-glass" style="padding: 8px 15px; font-size: 0.85rem;" onclick="addOrderRow()">+
					Th√™m d√≤ng</button>
			</div>

			<div class="table-wrapper" style="border-radius: 12px; max-height: 400px;">
				<table class="order-items-table">
					<thead>
						<tr>
							<th style="width: 300px;">S·∫£n ph·∫©m</th>
							<th>ƒê∆°n gi√°</th>
							<th style="width: 80px;">S·ªë l∆∞·ª£ng</th>
							<th>Th√†nh ti·ªÅn</th>
							<th style="width: 50px;"></th>
						</tr>
					</thead>
					<tbody id="orderItemsBody"></tbody>
				</table>
			</div>

			<div class="total-section">
				<div class="total-row">
					<span>Ti·ªÅn h√†ng:</span>
					<span id="totalProductMoney" class="total-val">0 ƒë</span>
				</div>
				<div class="total-row" style="align-items: center;">
					<span>D·ªãch v·ª• th√™m (S·ª≠a/VC...):</span>
					<input type="text" id="orderExtraService" value="0"
						style="width: 150px; text-align: right; background: var(--glass); border: 1px solid var(--glass-border); color: white; border-radius: 8px; padding: 5px 10px;"
						onkeyup="formatCurrencyInput(this); calculateOrderTotal();">
				</div>
				<div class="total-row"
					style="font-size: 1.4rem; margin-top: 10px; border-top: 1px dashed var(--glass-border); padding-top: 15px;">
					<span>T·ªîNG C·ªòNG ƒê∆†N:</span>
					<span id="orderFinalTotal" class="total-val" style="color: var(--primary);">0 ƒë</span>
				</div>
			</div>

			<div style="margin-top: 30px; display: flex; justify-content: flex-end; gap: 15px;">
				<button class="btn btn-glass" onclick="closeOrderModal()">H·ª¶Y</button>
				<button class="btn btn-primary" onclick="saveOrder()">X√ÅC NH·∫¨N L∆ØU ƒê∆†N</button>
			</div>
		</div>
	</div>

	<script>
		// --- CONFIG & DATA ---
		const ORDER_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxOQTGo9JGfVthBQ33DMpTEwkZArvWT-7hF9abPSh7LHT3zYQYa8hErzcBarYtCg65WWA/exec';
		const PRODUCT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzM8tzbdJJvXE0r6NcP8cJGO2RHsgYUR6Jy73U4NDLkSQRjT3fus_i4lugwVQZIKI8zhw/exec'; // URL l·∫•y s·∫£n ph·∫©m kh√°ch ƒë√£ t·∫°o

		let userData = {};
		let currentCustomers = [];
		let currentOrders = [];
		let availableProducts = [];
		let editOrderId = null;

		// --- INITIALIZATION ---
		document.addEventListener('DOMContentLoaded', () => {
			const userStr = localStorage.getItem('userLoggedIn');
			if (!userStr) {
				location.href = 'index.html';
				return;
			}
			userData = JSON.parse(userStr);
			document.getElementById('userName').innerText = userData.name;

			loadAllData();
		});

		async function loadAllData() {
			showLoader(true);
			try {
				await Promise.all([
					fetchCustomers(),
					fetchOrders(),
					fetchProducts()
				]);
				renderCustomers();
				renderDetailedOrders();
			} catch (err) {
				console.error("Load failed", err);
			} finally {
				showLoader(false);
			}
		}

		async function fetchCustomers() {
			if (ORDER_SCRIPT_URL.includes('AKfyc')) {
				const res = await fetch(`${ORDER_SCRIPT_URL}?action=read_customers&email=${encodeURIComponent(userData.email)}`);
				const json = await res.json();
				if (json.success) currentCustomers = json.data;
			}
		}

		async function fetchOrders() {
			if (ORDER_SCRIPT_URL.includes('AKfyc')) {
				const res = await fetch(`${ORDER_SCRIPT_URL}?action=read_orders&email=${encodeURIComponent(userData.email)}`);
				const json = await res.json();
				if (json.success) currentOrders = json.data;
			}
		}

		async function fetchProducts() {
			const res = await fetch(`${PRODUCT_SCRIPT_URL}?action=read&username=${encodeURIComponent(userData.email)}`);
			const json = await res.json();
			if (json.success) availableProducts = json.data;
		}

		// --- TAB SWITCH --
		function switchTab(tab) {
			document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
			document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

			if (tab === 'orders') {
				document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
				document.getElementById('ordersTab').classList.add('active');
			} else {
				document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
				document.getElementById('customersTab').classList.add('active');
			}
		}

		// --- CUSTOMER LOGIC ---
		function renderCustomers() {
			const body = document.getElementById('customersBody');
			body.innerHTML = currentCustomers.map(c => `
				<tr>
					<td style="font-weight:700; color:var(--primary);">${c.idkh√°chh√†ng}</td>
					<td style="font-weight:600;">${c.t√™nkh√°chh√†ng}</td>
					<td>${c.phone || '-'}</td>
					<td style="color:var(--text-gray); font-size:0.85rem;">${c.ghich√∫ || '-'}</td>
					<td>
						<div style="display:flex; gap:10px;">
							<button class="btn-glass" style="padding:5px 10px;" onclick="openCustomerModal('edit', '${c.idkh√°chh√†ng}')">S·ª≠a</button>
							<button class="btn-glass" style="padding:5px 10px; color:var(--danger);" onclick="deleteCustomer('${c.idkh√°chh√†ng}')">X√≥a</button>
						</div>
					</td>
				</tr>
			`).join('');

			// C·∫≠p nh·∫≠t select kh√°ch h√†ng trong form l√™n ƒë∆°n
			const select = document.getElementById('orderCustSelect');
			select.innerHTML = '<option value="">-- Ch·ªçn kh√°ch h√†ng --</option>' +
				currentCustomers.map(c => `<option value="${c.idkh√°chh√†ng}">${c.t√™nkh√°chh√†ng} (${c.idkh√°chh√†ng})</option>`).join('');
		}

		function openCustomerModal(mode, id = null) {
			const modal = document.getElementById('customerModal');
			document.getElementById('customerForm').reset();
			if (mode === 'create') {
				document.getElementById('customerModalTitle').innerText = 'Th√™m Kh√°ch H√†ng M·ªõi';
				document.getElementById('custId').value = '';
			} else {
				const c = currentCustomers.find(item => item.idkh√°chh√†ng === id);
				if (c) {
					document.getElementById('customerModalTitle').innerText = 'Ch·ªânh S·ª≠a Kh√°ch H√†ng';
					document.getElementById('custId').value = c.idkh√°chh√†ng;
					document.getElementById('custName').value = c.t√™nkh√°chh√†ng;
					document.getElementById('custPhone').value = c.phone;
					document.getElementById('custNote').value = c.ghich√∫;
				}
			}
			modal.classList.add('active');
		}

		function closeCustomerModal() { document.getElementById('customerModal').classList.remove('active'); }

		document.getElementById('customerForm').onsubmit = async (e) => {
			e.preventDefault();
			const id = document.getElementById('custId').value;
			const data = {
				't√™n kh√°ch h√†ng': document.getElementById('custName').value,
				'phone': document.getElementById('custPhone').value,
				'ghi ch√∫': document.getElementById('custNote').value,
				'mail ƒëƒÉng nh·∫≠p': userData.email,
				'tr·∫°ng th√°i x√≥a': 'ACTIVE'
			};
			if (id) data['id kh√°ch h√†ng'] = id;

			showLoader(true);
			try {
				const res = await fetch(ORDER_SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({ action: 'upsert_customer', data })
				});
				const json = await res.json();
				if (json.success) {
					await fetchCustomers();
					renderCustomers();
					closeCustomerModal();
					// N·∫øu ƒëang trong lu·ªìng "Kh√°ch m·ªõi" c·ªßa L√™n ƒë∆°n th√¨ ti·∫øp t·ª•c
					if (window.pendingOrderFlow) {
						window.pendingOrderFlow = false;
						openOrderModal('create', json.id);
					}
				}
			} catch (e) { alert("L·ªói khi l∆∞u kh√°ch h√†ng"); }
			finally { showLoader(false); }
		};

		async function deleteCustomer(id) {
			if (!confirm("X√≥a kh√°ch h√†ng n√†y?")) return;
			showLoader(true);
			try {
				const res = await fetch(ORDER_SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({ action: 'delete_customer', id })
				});
				if ((await res.json()).success) {
					await fetchCustomers();
					renderCustomers();
				}
			} finally { showLoader(false); }
		}

		// --- ORDER LOGIC ---
		function openChoiceModal() { document.getElementById('choiceModal').classList.add('active'); }
		function closeChoiceModal() { document.getElementById('choiceModal').classList.remove('active'); }

		function startNewCustomerOrder() {
			closeChoiceModal();
			window.pendingOrderFlow = true; // C·ªù hi·ªáu ƒë·ªÉ sau khi l∆∞u kh√°ch s·∫Ω m·ªü form ƒë∆°n
			openCustomerModal('create');
		}

		function startOldCustomerOrder() {
			closeChoiceModal();
			openOrderModal('create');
		}

		function renderDetailedOrders() {
			const body = document.getElementById('ordersBody');
			// Nh√≥m c√°c d√≤ng theo id ƒë∆°n h√†ng
			const ordersMap = {};
			currentOrders.forEach(row => {
				const id = row.idƒë∆°nh√†ng;
				if (!ordersMap[id]) {
					ordersMap[id] = {
						id: id,
						customer: row.t√™nkh√°chh√†ng,
						total: row.t·ªïngti·ªÅntrongƒë∆°n,
						rows: []
					};
				}
				ordersMap[id].rows.push(row);
			});

			const orderList = Object.values(ordersMap).reverse();
			body.innerHTML = orderList.map(o => `
				<tr>
					<td style="font-weight:700; color:var(--primary);">${o.id}</td>
					<td style="font-weight:600;">${o.customer}</td>
					<td style="color:var(--accent); font-weight:700;">${formatCurrency(o.total)}</td>
					<td>-</td>
					<td>
						<div style="display:flex; gap:10px;">
							<button class="btn-glass" style="padding:5px 10px;" onclick="openOrderModal('edit', '${o.id}')">S·ª≠a</button>
							<button class="btn-glass" style="padding:5px 10px; color:var(--danger);" onclick="deleteOrder('${o.id}')">X√≥a</button>
						</div>
					</td>
				</tr>
			`).join('');
		}

		function openOrderModal(mode, preselectedCustId = null) {
			const modal = document.getElementById('orderModal');
			document.getElementById('orderItemsBody').innerHTML = '';
			document.getElementById('orderExtraService').value = '0';
			document.getElementById('orderGlobalNote').value = '';

			if (mode === 'create') {
				editOrderId = null;
				document.getElementById('orderModalTitle').innerText = 'L√™n ƒê∆°n H√†ng M·ªõi';
				if (preselectedCustId) document.getElementById('orderCustSelect').value = preselectedCustId;
				else document.getElementById('orderCustSelect').value = '';
				addOrderRow();
			} else {
				// Mode EDIT: id ·ªü ƒë√¢y ch√≠nh l√† m√£ ƒë∆°n h√†ng
				editOrderId = preselectedCustId;
				const orderRows = currentOrders.filter(r => r.idƒë∆°nh√†ng === editOrderId);
				if (orderRows.length > 0) {
					document.getElementById('orderModalTitle').innerText = 'Ch·ªânh S·ª≠a ƒê∆°n: ' + editOrderId;
					document.getElementById('orderCustSelect').value = orderRows[0].idkh√°chh√†ng;
					document.getElementById('orderGlobalNote').value = orderRows[0].ghich√∫;
					document.getElementById('orderExtraService').value = formatCurrencyNoSign(orderRows[0].d·ªãchv·ª•th√™mtrongƒë∆°n);

					orderRows.forEach(row => addOrderRow(row));
				}
			}

			calculateOrderTotal();
			modal.classList.add('active');
		}

		function closeOrderModal() { document.getElementById('orderModal').classList.remove('active'); }

		function addOrderRow(data = null) {
			const tbody = document.getElementById('orderItemsBody');
			const row = document.createElement('tr');

			const productOptions = availableProducts.map(p =>
				`<option value="${p.id_san_pham}" data-price="${p.gia_san_pham}" data-cat="${p.ten_nghanh_hang}" ${data && data.ids·∫£nph·∫©m === p.id_san_pham ? 'selected' : ''}>${p.ten_san_pham}</option>`
			).join('');

			row.innerHTML = `
				<td>
					<select class="item-product" style="width:100%; padding:8px;" onchange="updateRowPrice(this)">
						<option value="">-- Ch·ªçn s·∫£n ph·∫©m --</option>
						${productOptions}
					</select>
				</td>
				<td><input type="text" class="item-price" value="${data ? formatCurrencyNoSign(data.gi√°s·∫£nph·∫©m) : '0'}" style="width:100px; text-align:right;" readonly></td>
				<td><input type="number" class="item-qty" value="${data ? data.s·ªël∆∞·ª£ng : '1'}" style="width:100%;" onchange="calculateOrderTotal()" onkeyup="calculateOrderTotal()"></td>
				<td><span class="item-total" style="font-weight:600;">0 ƒë</span></td>
				<td><button class="btn-glass" style="padding:5px; color:var(--danger);" onclick="this.closest('tr').remove(); calculateOrderTotal();">X</button></td>
			`;
			tbody.appendChild(row);
			calculateOrderTotal();
		}

		function updateRowPrice(select) {
			const row = select.closest('tr');
			const option = select.options[select.selectedIndex];
			const price = option.getAttribute('data-price') || 0;
			row.querySelector('.item-price').value = formatCurrencyNoSign(price);
			calculateOrderTotal();
		}

		function calculateOrderTotal() {
			let productTotal = 0;
			document.querySelectorAll('#orderItemsBody tr').forEach(row => {
				const select = row.querySelector('.item-product');
				const option = select.options[select.selectedIndex];
				const priceText = row.querySelector('.item-price').value.replace(/\./g, '');
				const price = parseInt(priceText) || 0;
				const qty = parseInt(row.querySelector('.item-qty').value) || 0;
				const rowTotal = price * qty;
				row.querySelector('.item-total').innerText = formatCurrency(rowTotal);
				productTotal += rowTotal;
			});

			const extra = parseInt(document.getElementById('orderExtraService').value.replace(/\./g, '')) || 0;
			document.getElementById('totalProductMoney').innerText = formatCurrency(productTotal);
			document.getElementById('orderFinalTotal').innerText = formatCurrency(productTotal + extra);
		}

		async function saveOrder() {
			const custId = document.getElementById('orderCustSelect').value;
			if (!custId) return alert("Vui l√≤ng ch·ªçn kh√°ch h√†ng");

			const customer = currentCustomers.find(c => c.idkh√°chh√†ng === custId);
			const rows = [];
			const extra = parseInt(document.getElementById('orderExtraService').value.replace(/\./g, '')) || 0;
			const globalNote = document.getElementById('orderGlobalNote').value;

			let productTotal = 0;
			document.querySelectorAll('#orderItemsBody tr').forEach(tr => {
				const select = tr.querySelector('.item-product');
				const option = select.options[select.selectedIndex];
				if (!option.value) return;

				const qty = parseInt(tr.querySelector('.item-qty').value) || 0;
				const price = parseInt(tr.querySelector('.item-price').value.replace(/\./g, '')) || 0;
				const subTotal = price * qty;
				productTotal += subTotal;

				rows.push({
					'ph√¢n lo·∫°i kh√°ch h√†ng': window.pendingOrderFlow ? 'Kh√°ch m·ªõi' : 'Kh√°ch c≈©',
					't√™n kh√°ch h√†ng': customer.t√™nkh√°chh√†ng,
					'id kh√°ch h√†ng': customer.idkh√°chh√†ng,
					't√™n ng√†nh h√†ng': option.getAttribute('data-cat'),
					't√™n s·∫£n ph·∫©m': option.text,
					'id s·∫£n ph·∫©m': option.value,
					'gi√° s·∫£n ph·∫©m': price,
					's·ªë l∆∞·ª£ng': qty,
					'th√†nh ti·ªÅn': subTotal,
					't·ªïng ti·ªÅn h√†ng': 0, // S·∫Ω t√≠nh sau ho·∫∑c fill cho d√≤ng ƒë·∫ßu
					'd·ªãch v·ª• th√™m trong ƒë∆°n': extra,
					't·ªïng ti·ªÅn trong ƒë∆°n': 0, // S·∫Ω t√≠nh sau
					'ghi ch√∫': globalNote,
					'mail ƒëƒÉng nh·∫≠p': userData.email,
					'tr·∫°ng th√°i x√≥a': 'ACTIVE'
				});
			});

			if (rows.length === 0) return alert("H√†ng h√≥a tr·ªëng!");

			const finalTotal = productTotal + extra;
			rows.forEach(r => {
				r['t·ªïng ti·ªÅn h√†ng'] = productTotal;
				r['t·ªïng ti·ªÅn trong ƒë∆°n'] = finalTotal;
			});

			showLoader(true);
			try {
				const res = await fetch(ORDER_SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({
						action: editOrderId ? 'update_order' : 'create_order',
						id: editOrderId,
						data: rows
					})
				});
				if ((await res.json()).success) {
					await fetchOrders();
					renderDetailedOrders();
					closeOrderModal();
					alert("ƒê√£ l∆∞u ƒë∆°n h√†ng!");
				}
			} finally { showLoader(false); }
		}

		async function deleteOrder(orderId) {
			if (!confirm("X√≥a to√†n b·ªô ƒë∆°n h√†ng n√†y?")) return;
			showLoader(true);
			try {
				const res = await fetch(ORDER_SCRIPT_URL, {
					method: 'POST',
					body: JSON.stringify({ action: 'delete_order', id: orderId })
				});
				if ((await res.json()).success) {
					await fetchOrders();
					renderDetailedOrders();
				}
			} finally { showLoader(false); }
		}

		// --- HELPERS ---
		function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
		function formatCurrency(num) { return new Intl.NumberFormat('vi-VN').format(num) + ' ƒë'; }
		function formatCurrencyNoSign(num) { return new Intl.NumberFormat('vi-VN').format(num); }
		function formatCurrencyInput(input) {
			let val = input.value.replace(/\D/g, "");
			if (val === "") return;
			input.value = new Intl.NumberFormat('vi-VN').format(val);
		}

		function filterOrders() {
			const q = document.getElementById('orderSearch').value.toLowerCase();
			const rows = document.querySelectorAll('#ordersBody tr');
			rows.forEach(r => {
				r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
			});
		}

		function filterCustomers() {
			const q = document.getElementById('customerSearch').value.toLowerCase();
			const rows = document.querySelectorAll('#customersBody tr');
			rows.forEach(r => {
				r.style.display = r.innerText.toLowerCase().includes(q) ? '' : 'none';
			});
		}
	</script>
</body>

</html>