/**
 * Google Apps Script - Quản lý Tồn Kho Nano Data
 * Spreadsheet ID: 14fUCqVn-5sZ1xwPY0D5dXs-guz7phl5R9gguSajMnSs
 * Sheet: ton_kho
 */

const SPREADSHEET_ID = '14fUCqVn-5sZ1xwPY0D5dXs-guz7phl5R9gguSajMnSs';
const SHEET_NAME = 'ton_kho';

function doPost(e) {
  try {
    const params = JSON.parse(e.postData.contents);
    const action = params.action;
    
    if (action === 'create_entry') return createEntry(params);
    if (action === 'delete_entry') return deleteEntry(params);
    if (action === 'update_stock_out') return updateStockOut(params); // Dùng cho bên Đơn Hàng gọi sang
    
    return jsonResponse({ success: false, message: 'Hành động không hợp lệ: ' + action });
  } catch (err) {
    return jsonResponse({ success: false, message: err.toString() });
  }
}

function doGet(e) {
  const action = e.parameter.action;
  if (action === 'read') return readInventory(e.parameter);
  return jsonResponse({ success: false, message: 'Invalid action' });
}

function createEntry(params) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME) || ss.insertSheet(SHEET_NAME);
  
  // Kiểm tra Header
  if (sheet.getLastRow() === 0) {
    sheet.appendRow(['date', 'id_don_nhap_xuat', 'id_san_pham', 'ten_san_pham', 'so_luong_nhap', 'so_luong_xuat', 'so_luong_con_lai', 'mail_dang_nhap', 'trang_thai_xoa']);
  }
  
  const data = params.data;
  sheet.appendRow([
    data.date || new Date().toLocaleString('vi-VN'),
    data.id_don_nhap_xuat,
    data.id_san_pham,
    data.ten_san_pham,
    data.so_luong_nhap || 0,
    data.so_luong_xuat || 0,
    0, // Cột so_luong_con_lai tạm để 0, sẽ do hàm tính toán
    data.mail_dang_nhap,
    'ACTIVE'
  ]);
  
  return jsonResponse({ success: true, message: 'Đã tạo bản ghi tồn kho' });
}

function readInventory(params) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) return jsonResponse({ success: true, data: [] });
  
  const values = sheet.getDataRange().getValues();
  const headers = values[0];
  const items = [];
  
  // Tính tồn kho hiện tại cho từng ID sản phẩm
  const stockBalance = {};
  
  for (let i = 1; i < values.length; i++) {
    const row = values[i];
    const idSP = row[2];
    const status = row[8];
    
    if (status !== 'DELETE' && status !== 'DELETED') {
      const nhap = parseFloat(row[4]) || 0;
      const xuat = parseFloat(row[5]) || 0;
      
      if (!stockBalance[idSP]) stockBalance[idSP] = 0;
      stockBalance[idSP] += (nhap - xuat);
      
      let obj = {};
      headers.forEach((h, idx) => obj[h] = row[idx]);
      obj.stockBalanceNow = stockBalance[idSP]; // Tồn kho tại thời điểm đó (tùy chọn)
      items.push(obj);
    }
  }
  
  // Trả về cả list log và bảng tổng hợp tồn kho hiện tại
  return jsonResponse({ 
    success: true, 
    data: items,
    summary: stockBalance 
  });
}

function deleteEntry(params) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  const idDon = params.id_don_nhap_xuat;
  const idSP = params.id_san_pham;
  
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][1]).trim() === String(idDon).trim() && String(data[i][2]).trim() === String(idSP).trim()) {
      sheet.getRange(i + 1, 9).setValue('DELETE');
    }
  }
  return jsonResponse({ success: true });
}

// Hàm này dùng để đồng bộ từ bên Quản Lý Đơn Hàng (Xuat Kho)
function updateStockOut(params) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME) || ss.insertSheet(SHEET_NAME);
  
  const orderId = params.orderId;
  const actionType = params.actionType; // 'add', 'remove' (khi xóa đơn)
  
  if (actionType === 'remove') {
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][1]).trim() === String(orderId).trim()) {
        sheet.getRange(i + 1, 9).setValue('DELETE');
      }
    }
    return jsonResponse({ success: true });
  }
  
  // Thêm các dòng xuất kho dựa trên items của đơn hàng
  const items = params.items || [];
  const mail = params.mail || '';
  const date = params.date || new Date().toLocaleString('vi-VN');
  
  items.forEach(item => {
    sheet.appendRow([
      date,
      orderId,
      item.id_san_pham,
      item.ten_san_pham,
      0, // Nhập
      item.so_luong || 0, // Xuất
      0, // Còn lại
      mail,
      'ACTIVE'
    ]);
  });
  
  return jsonResponse({ success: true });
}

function jsonResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}
