<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Chỉnh Sửa Khách Hàng - Premium</title>
	<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
		rel="stylesheet">
	<style>
		:root {
			--primary: #FFD700;
			--dark: #0f0f0f;
			--dark-card: #1a1a1a;
			--text-light: #ffffff;
			--text-gray: #a0a0a0;
			--glass: rgba(255, 255, 255, 0.03);
			--glass-border: rgba(255, 255, 255, 0.1);
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Plus Jakarta Sans', sans-serif;
		}

		body {
			background-color: var(--dark);
			color: var(--text-light);
			min-height: 100vh;
			display: flex;
			justify-content: center;
			align-items: center;
			padding: 20px;
		}

		.form-card {
			background: var(--dark-card);
			width: 100%;
			max-width: 600px;
			padding: 40px;
			border-radius: 30px;
			border: 1px solid var(--glass-border);
			box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
			animation: fadeIn 0.5s ease-out;
			position: relative;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(20px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.edit-badge {
			position: absolute;
			top: 20px;
			right: 40px;
			background: var(--primary);
			color: var(--dark);
			padding: 4px 12px;
			border-radius: 8px;
			font-size: 0.75rem;
			font-weight: 800;
			text-transform: uppercase;
		}

		h2 {
			font-size: 1.8rem;
			margin-bottom: 30px;
			color: var(--primary);
			font-weight: 800;
			text-align: center;
		}

		.form-group {
			margin-bottom: 20px;
		}

		label {
			display: block;
			margin-bottom: 8px;
			font-size: 0.9rem;
			color: var(--text-gray);
			font-weight: 600;
		}

		input,
		textarea {
			width: 100%;
			padding: 15px 20px;
			background: var(--glass);
			border: 1px solid var(--glass-border);
			border-radius: 16px;
			color: white;
			font-size: 1rem;
			outline: none;
			transition: all 0.3s;
		}

		input:focus {
			border-color: var(--primary);
			background: rgba(255, 215, 0, 0.05);
		}

		input[readonly] {
			background: rgba(255, 255, 255, 0.05);
			color: #888;
			cursor: not-allowed;
			border-style: dashed;
		}

		.location-container {
			display: grid;
			grid-template-columns: 1fr auto;
			gap: 10px;
		}

		.btn-location {
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid var(--glass-border);
			color: white;
			padding: 0 15px;
			border-radius: 16px;
			cursor: pointer;
			display: flex;
			align-items: center;
			gap: 8px;
			font-size: 0.8rem;
			transition: all 0.3s;
		}

		.btn-location:hover {
			background: white;
			color: var(--dark);
		}

		.btn-submit {
			width: 100%;
			padding: 18px;
			background: var(--primary);
			color: var(--dark);
			border: none;
			border-radius: 16px;
			font-size: 1.1rem;
			font-weight: 800;
			cursor: pointer;
			margin-top: 20px;
			transition: all 0.3s;
		}

		.btn-submit:hover {
			transform: translateY(-3px);
			box-shadow: 0 10px 20px rgba(255, 215, 0, 0.3);
		}

		.btn-back {
			display: block;
			text-align: center;
			margin-top: 20px;
			color: var(--text-gray);
			text-decoration: none;
			font-size: 0.9rem;
		}

		#loader {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 1000;
			backdrop-filter: blur(5px);
		}

		/* Floating Menu Styles */
		.floating-menu {
			position: fixed;
			bottom: 30px;
			right: 30px;
			z-index: 1000;
			display: flex;
			flex-direction: column;
			align-items: flex-end;
			gap: 15px;
		}

		.fab-btn {
			width: 60px;
			height: 60px;
			background: var(--primary);
			border: none;
			border-radius: 50%;
			color: var(--dark);
			cursor: pointer;
			box-shadow: 0 10px 25px rgba(255, 215, 0, 0.4);
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			z-index: 1001;
		}

		.fab-btn svg {
			width: 28px;
			height: 28px;
			transition: transform 0.4s;
		}

		.fab-btn.active svg {
			transform: rotate(135deg);
		}

		.fab-menu-list {
			position: absolute;
			bottom: 80px;
			right: 0;
			background: #1a1a1a;
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			padding: 10px;
			width: 240px;
			display: none;
			flex-direction: column;
			gap: 5px;
			backdrop-filter: blur(20px);
			box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
			animation: slideUp 0.3s ease-out;
		}

		.fab-menu-list.active {
			display: flex;
		}

		.menu-item {
			display: flex;
			align-items: center;
			gap: 12px;
			padding: 12px 15px;
			color: var(--text-light);
			text-decoration: none;
			border-radius: 12px;
			font-weight: 600;
			font-size: 0.9rem;
			transition: all 0.2s;
		}

		.menu-item:hover {
			background: rgba(255, 215, 0, 0.1);
			color: var(--primary);
		}

		.menu-item svg {
			width: 20px;
			height: 20px;
		}

		@keyframes slideUp {
			from {
				opacity: 0;
				transform: translateY(20px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}
	</style>
</head>

<body>
	<div id="loader">
		<div style="text-align: center;">
			<div
				style="width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;">
			</div>
			<p id="loaderText">Đang tải dữ liệu cũ...</p>
		</div>
	</div>

	<style>
		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}
	</style>

	<div class="form-card">
		<div class="edit-badge">Mode: Edit</div>
		<h2>Sửa Thông Tin</h2>
		<form id="editForm">
			<div class="form-group">
				<label>Mã khách hàng (Cố định)</label>
				<input type="text" id="idDisplay" readonly>
			</div>

			<div class="form-group">
				<label>Tên khách hàng / Cửa hàng *</label>
				<input type="text" id="tenKhach" required placeholder="Nhập tên khách hàng">
			</div>

			<div class="form-group">
				<label>Số điện thoại *</label>
				<input type="text" id="phone" required placeholder="Nhập số điện thoại">
			</div>

			<div class="form-group">
				<label>Địa chỉ</label>
				<input type="text" id="diaChi" placeholder="Nhập địa chỉ">
			</div>

			<div class="form-group">
				<label>Vị trí (Lat, Long)</label>
				<div class="location-container">
					<input type="text" id="viTri" placeholder="Tự động lấy GPS hoặc nhập Lat, Long">
					<button type="button" class="btn-location" onclick="getLocation()">
						<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
							stroke-width="2">
							<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
							<circle cx="12" cy="10" r="3"></circle>
						</svg>
						Lấy GPS
					</button>
				</div>
			</div>

			<div class="form-group">
				<label>Ghi chú</label>
				<textarea id="ghiChu" rows="3" placeholder="Nhập thêm ghi chú (nếu có)"></textarea>
			</div>

			<button type="submit" class="btn-submit" id="btnSubmit">CẬP NHẬT THAY ĐỔI</button>
			<a href="danh-sach-khach-hang.html" class="btn-back">Hủy bỏ và quay lại</a>
		</form>
	</div>

	<!-- Floating Menu -->
	<div class="floating-menu">
		<div class="fab-menu-list" id="fabMenu">
			<a href="len-don.html" class="menu-item" style="color: var(--primary);">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M12 5v14M5 12h14" />
				</svg>
				<span>Lên đơn hàng mới</span>
			</a>
			<a href="quan-ly-don-khach.html" class="menu-item">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
					<line x1="3" y1="10" x2="21" y2="10" />
					<line x1="9" y1="21" x2="9" y2="10" />
					<line x1="15" y1="21" x2="15" y2="10" />
				</svg>
				<span>Danh sách đơn hàng</span>
			</a>
			<a href="san-pham-khach.html" class="menu-item">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<rect x="3" y="3" width="7" height="7" />
					<rect x="14" y="3" width="7" height="7" />
					<rect x="14" y="14" width="7" height="7" />
					<rect x="3" y="14" width="7" height="7" />
				</svg>
				<span>Quản lý sản phẩm</span>
			</a>
			<a href="danh-sach-khach-hang.html" class="menu-item">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
					<circle cx="9" cy="7" r="4" />
					<path d="M23 21v-2a4 4 0 0 0-3-3.87" />
					<path d="M16 3.13a4 4 0 0 1 0 7.75" />
				</svg>
				<span>Danh sách khách hàng</span>
			</a>
		</div>
		<button class="fab-btn" onclick="toggleFabMenu(event)">
			<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
				<line x1="3" y1="12" x2="21" y2="12" />
				<line x1="3" y1="6" x2="21" y2="6" />
				<line x1="3" y1="18" x2="21" y2="18" />
			</svg>
		</button>
	</div>

	<script>
		const KHACH_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxJ_SMcR1BOrVrZ9Ym0pmhuAa4XbP0ASvYPM5LhQxZLenCLvWy-Nc0jBiv3finAByac/exec';
		let userData = null;
		let customerId = null;

		document.addEventListener('DOMContentLoaded', async () => {
			const userStr = localStorage.getItem('userLoggedIn');
			if (!userStr) {
				window.location.href = 'index.html';
				return;
			}
			userData = JSON.parse(userStr);

			const params = new URLSearchParams(window.location.search);
			customerId = params.get('id');

			if (!customerId) {
				alert("Lỗi: Không tìm thấy tham số ID khách hàng trên URL. Hãy chắc chắn bạn mở trang này từ nút Chỉnh sửa trong danh sách!");
				window.location.href = 'danh-sach-khach-hang.html';
				return;
			}

			document.getElementById('idDisplay').value = customerId;
			loadCustomerDetail(customerId);
		});

		async function loadCustomerDetail(id) {
			showLoader(true, "Đang truy xuất dữ liệu cũ...");
			try {
				const url = `${KHACH_SCRIPT_URL}?action=read&username=${encodeURIComponent(userData.email)}`;
				const res = await fetch(url);
				const result = await res.json();

				if (result.success) {
					// Tìm khách hàng theo ID (kiểm tra linh hoạt các biến thể key)
					const customer = result.data.find(c => {
						const cid = c.id_khach_hang || c.idkhachhang || c.id_khachhang;
						return String(cid).trim() === String(id).trim();
					});

					if (customer) {
						document.getElementById('tenKhach').value = customer.ten_khach_hang || customer.tenkhachhang || '';
						document.getElementById('phone').value = customer.phone || customer.so_dien_thoai || '';
						document.getElementById('diaChi').value = customer.dia_chi || customer.diachi || '';
						document.getElementById('viTri').value = customer.vi_tri || customer.vitri || '';
						document.getElementById('ghiChu').value = customer.ghi_chu || customer.ghichu || '';
					} else {
						alert("Không tìm thấy dữ liệu khách hàng này trên hệ thống!");
						window.location.href = 'danh-sach-khach-hang.html';
					}
				}
			} catch (err) {
				console.error("Lỗi:", err);
				alert("Lỗi khi kết nối với máy chủ!");
			}
			showLoader(false);
		}

		function getLocation() {
			if (navigator.geolocation) {
				showLoader(true, "Đang lấy vị trí GPS...");
				navigator.geolocation.getCurrentPosition(
					(position) => {
						document.getElementById('viTri').value = `${position.coords.latitude}, ${position.coords.longitude}`;
						showLoader(false);
					},
					(error) => {
						alert("Không thể lấy tọa độ. Hãy kiểm tra quyền truy cập vị trí.");
						showLoader(false);
					}
				);
			}
		}

		function toggleFabMenu(e) {
			e.stopPropagation();
			document.getElementById('fabMenu').classList.toggle('active');
			document.querySelector('.fab-btn').classList.toggle('active');
		}

		document.getElementById('editForm').addEventListener('submit', async (e) => {
			e.preventDefault();

			const data = {
				ten_khach_hang: document.getElementById('tenKhach').value,
				phone: document.getElementById('phone').value,
				dia_chi: document.getElementById('diaChi').value,
				vi_tri: document.getElementById('viTri').value,
				ghi_chu: document.getElementById('ghiChu').value,
				ten_dang_nhap: userData.email
			};

			showLoader(true, "Đang gửi yêu cầu cập nhật lên Sheet...");
			try {
				const payload = {
					action: 'update',
					idValue: customerId,
					data: data
				};

				const fd = new URLSearchParams();
				fd.append('payload', JSON.stringify(payload));

				const res = await fetch(KHACH_SCRIPT_URL, {
					method: 'POST',
					body: fd
				});
				const result = await res.json();
				if (result.success) {
					window.location.href = 'danh-sach-khach-hang.html';
				} else {
					alert("Cập nhật thất bại: " + result.message);
				}
			} catch (err) {
				alert("Lỗi mạng: " + err.toString());
			} finally {
				showLoader(false);
			}
		});

		function showLoader(show, text = "") {
			const loader = document.getElementById('loader');
			if (text) document.getElementById('loaderText').innerText = text;
			loader.style.display = show ? 'flex' : 'none';
		}

		// Close menu
		document.addEventListener('click', (e) => {
			const fabMenu = document.getElementById('fabMenu');
			const fabBtn = document.querySelector('.fab-btn');
			if (fabMenu && !fabMenu.contains(e.target) && !fabBtn.contains(e.target)) {
				fabMenu.classList.remove('active');
				fabBtn.classList.remove('active');
			}
		});
	</script>
</body>

</html>