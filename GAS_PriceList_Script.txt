/**
 * GAS SCRIPT CHO QUẢN LÝ BẢNG GIÁ (DURAFLEX, WEBER, PIMA)
 * Hỗ trợ: Read, Create, Update, Delete (Xóa hẳn dòng), Upload Image
 */

function doGet(e) {
  const params = e.parameter;
  const action = params.action;
  
  if (action === 'read') {
    return readData(params.sheetId, params.sheetName);
  }
  
  return jsonResponse({success: false, message: 'Invalid GET action'});
}

function doPost(e) {
  let data;
  try {
    data = JSON.parse(e.postData.contents);
  } catch (err) {
    return jsonResponse({success: false, message: 'Invalid JSON'});
  }
  
  const action = data.action;
  
  if (action === 'upload') {
    return uploadFile(data);
  } else if (action === 'create') {
    return createData(data);
  } else if (action === 'update') {
    return updateData(data);
  } else if (action === 'delete') {
    return deleteData(data);
  }
  
  return jsonResponse({success: false, message: 'Invalid POST action'});
}

function readData(sheetId, sheetName) {
  try {
    const ss = SpreadsheetApp.openById(sheetId);
    const sheet = ss.getSheetByName(sheetName);
    if (!sheet) return jsonResponse({success: false, message: 'Sheet not found'});
    
    const values = sheet.getDataRange().getValues();
    if (values.length < 1) return jsonResponse({success: true, data: []});
    
    const headers = values[0];
    const data = [];
    
    for (let i = 1; i < values.length; i++) {
        // Bỏ qua dòng trống
        if (!values[i].join('').trim()) continue;
        
        let obj = {};
        headers.forEach((header, index) => {
            if (header) { // Chỉ lấy các cột có tiêu đề
                obj[header] = values[i][index];
            }
        });
        data.push(obj);
    }
    
    return jsonResponse({success: true, data: data});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function createData(payload) {
  try {
    const ss = SpreadsheetApp.openById(payload.sheetId);
    const sheet = ss.getSheetByName(payload.sheetName);
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const newRow = headers.map(h => payload.data[h] !== undefined ? payload.data[h] : '');
    
    sheet.appendRow(newRow);
    return jsonResponse({success: true});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function updateData(payload) {
  try {
    const ss = SpreadsheetApp.openById(payload.sheetId);
    const sheet = ss.getSheetByName(payload.sheetName);
    const idField = payload.idField;
    const idValue = payload.idValue;
    
    const values = sheet.getDataRange().getValues();
    const headers = values[0];
    const idColIndex = headers.indexOf(idField);
    
    if (idColIndex === -1) return jsonResponse({success: false, message: 'ID Field not found: ' + idField});
    
    for (let i = 1; i < values.length; i++) {
      if (String(values[i][idColIndex]).trim() === String(idValue).trim()) {
        const rowNum = i + 1;
        headers.forEach((header, index) => {
          if (header && payload.data[header] !== undefined) {
             sheet.getRange(rowNum, index + 1).setValue(payload.data[header]);
          }
        });
        return jsonResponse({success: true});
      }
    }
    
    return jsonResponse({success: false, message: 'Item not found for update'});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function deleteData(payload) {
  try {
    const ss = SpreadsheetApp.openById(payload.sheetId);
    const sheet = ss.getSheetByName(payload.sheetName);
    const idField = payload.idField;
    const idValue = payload.idValue;
    
    // Đọc dữ liệu và tiêu đề
    const range = sheet.getDataRange();
    const values = range.getValues();
    const headers = values[0];
    
    // Tìm vị trí cột ID
    const idColIndex = headers.indexOf(idField);
    if (idColIndex === -1) return jsonResponse({success: false, message: 'ID Field not found: ' + idField});
    
    // Tìm vị trí cột "trạng thái xóa" (không phân biệt hoa thường, khoảng trắng)
    let deleteColIndex = headers.findIndex(h => String(h).trim().toLowerCase() === 'trạng thái xóa');
    
    // Nếu chưa có cột "trạng thái xóa", tự động thêm vào cột cuối cùng
    if (deleteColIndex === -1) {
        deleteColIndex = headers.length; // Cột mới sẽ ở vị trí này
        sheet.getRange(1, deleteColIndex + 1).setValue('trạng thái xóa'); // Ghi tiêu đề mới
    }
    
    let actionTaken = '';
    let updated = false;

    // Duyệt qua các dòng để tìm ID
    for (let i = 1; i < values.length; i++) {
        if (String(values[i][idColIndex]).trim() === String(idValue).trim()) {
            // Ghi đè chữ DELETED vào cột trạng thái xóa
            sheet.getRange(i + 1, deleteColIndex + 1).setValue('DELETED');
            updated = true;
            actionTaken = 'Updated existing row to DELETED';
        }
    }
    
    // Nếu không tìm thấy dòng nào khớp ID, ta tạo dòng mới với trạng thái DELETED
    if (!updated && payload.data) {
        const newRow = [];
        // Map dữ liệu vào đúng cột
        headers.forEach((h, index) => {
             // Nếu là cột trạng thái xóa, ghi DELETED
             if (index === deleteColIndex) {
                 newRow.push('DELETED');
             } else if (payload.data[h] !== undefined) {
                 newRow.push(payload.data[h]);
             } else {
                 newRow.push('');
             }
        });
        
        // Nếu cột trạng thái xóa nằm ngoài số lượng cột cũ (do mới thêm), xử lý thêm
        if (deleteColIndex >= headers.length) {
             newRow[deleteColIndex] = 'DELETED';
        }
        
        // Nếu dữ liệu mới có nhiều cột hơn header hiện tại? 
        // Đảm bảo không lỗi. Thêm row an toàn.
        sheet.appendRow(newRow);
        actionTaken = 'Created new row with DELETED status';
        updated = true;
    }
    
    if (updated) return jsonResponse({success: true, message: actionTaken});
    return jsonResponse({success: false, message: 'Item not found and no data provided to create'});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function uploadFile(payload) {
  try {
    const folder = DriveApp.getFolderById(payload.folderId);
    const blob = Utilities.newBlob(Utilities.base64Decode(payload.file), payload.mimeType, payload.filename);
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    const url = 'https://drive.google.com/uc?export=view&id=' + file.getId();
    return jsonResponse({success: true, url: url});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function jsonResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
