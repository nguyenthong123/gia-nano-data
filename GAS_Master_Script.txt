/**
 * GAS_Master_Script.txt
 * Script chuy√™n d·ª•ng cho Master Control Panel (Super Admin)
 * T√°ch bi·ªát kh·ªèi h·ªá th·ªëng Authentication ch√≠nh ƒë·ªÉ d·ªÖ d√†ng qu·∫£n l√Ω v√† n√¢ng c·∫•p.
 * 
 * PH·∫†M VI QUY·ªÄN: DriveApp, SpreadsheetApp, MailApp
 */

// --- C·∫§U H√åNH H·ªÜ TH·ªêNG MASTER ---
const MAIN_SPREADSHEET_ID = '1rhP1UCiMLi8yNVvcd56SsZIJAm09Yxu6WpjxuHKYKb0'; // Sheet ch·ª©a Auth
const MASTER_SPREADSHEET_ID = '1SiB4k-T7HoT9cNv-Q8KPIS3AnA6C_8HAX0hFyR3ZWOc'; // Sheet Master m·ªõi t·∫°o
const MASTER_SHEET_NAME = 'menu'; // T√™n sheet b·∫°n v·ª´a t·∫°o
const SCHEDULE_SHEET_NAME = 'ad_schedule'; // T√™n sheet l∆∞u l·ªãch h·∫πn
const MASTER_EMAIL = 'dunvex.green@gmail.com';
const LOG_SHEET_NAME = 'activity_log'; // Sheet l∆∞u l·ªãch s·ª≠ thao t√°c
const MARKETING_LOG_SHEET_NAME = 'marketing_log'; // Sheet l∆∞u l·ªãch s·ª≠ g·ª≠i mail qu·∫£ng c√°o
const AD_FOLDER_ID = '1SZTs8VvEKLIXPiKn7CA-OpmHIFXOzws5'; // Th∆∞ m·ª•c l∆∞u h√¨nh qu·∫£ng c√°o
const API_SECRET = 'dv_api_secret_2025_prod_v2'; // ƒê√É ƒê·ªíNG B·ªò V·ªöI FRONTEND
const XOR_SECRET = 'dunvex_secure_key_2025_custom'; // ƒê√É ƒê·ªíNG B·ªò V·ªöI AUTH SCRIPT
/**
 * H·ªÜ TH·ªêNG FEATURE LOCKS:
 * - checkinMaster: Kh√≥a t·ªïng check-in
 * - mailStaff: Kh√≥a th√¥ng b√°o mail nh√¢n vi√™n
 * - debtMaster: Kh√≥a qu·∫£n l√Ω c√¥ng n·ª£
 * - productCreateMaster: Kh√≥a quy·ªÅn t·∫°o m√£ s·∫£n ph·∫©m (M·ªöI)
 * - inventoryMaster: Kh√≥a quy·ªÅn nh·∫≠p kho h√†ng (M·ªöI)
 * - warehouseMaster: Kh√≥a quy·ªÅn xu·∫•t kho (M·ªöI)
 * - deliveryMaster: Kh√≥a quy·ªÅn giao h√†ng (T√†i x·∫ø) (M·ªöI)
 * - hrMaster: Kh√≥a t·ªïng Qu·∫£n l√Ω nh√¢n s·ª± (M·ªöI)
 */

// --- CONFIG ƒê∆Ø·ªúNG D·∫™N D·ªÆ LI·ªÜU ƒê·ªÇ B√ÅO C√ÅO ---
const DATA_FOLDER_ID = '1_LT4rzVui2E3BgfcwUSfMsUGQMN9NRTs'; 
const ORDER_HEADER_FILE = 'order.json';
const ORDER_DETAIL_FILE = 'order_chi_tiet.json';
const CUSTOMER_FILE = 'customer.json';

const SafeStore = {
  read: function(filename) {
    try {
      const folder = DriveApp.getFolderById(DATA_FOLDER_ID);
      const files = folder.getFilesByName(filename);
      if (!files.hasNext()) return [];
      const content = files.next().getBlob().getDataAsString().trim();
      if (!content) return [];
      if (content.startsWith('[')) return JSON.parse(content);
      return content.split('\n').filter(l => l.trim()).map(l => JSON.parse(l));
    } catch (e) { return []; }
  }
};

// --- ENTRY POINT ---
function runWeeklyReports() {
  return processWeeklyReports(true);
}

function doPost(e) {
  let result;
  try {
    const contents = e.postData ? e.postData.contents : "";
    if (!contents) return ContentService.createTextOutput(JSON.stringify({ success: false, message: 'Data empty' })).setMimeType(ContentService.MimeType.JSON);
    const data = JSON.parse(contents);
    
    // --- API SECURITY CHECK ---
    if (data.apiKey !== API_SECRET) {
      return ContentService.createTextOutput(JSON.stringify({ 
        success: false, 
        message: 'Unauthorized Master Access' 
      })).setMimeType(ContentService.MimeType.JSON);
    }

    const action = data.action;

    // T·ª± ƒë·ªông ki·ªÉm tra v√† kh·ªüi t·∫°o ti√™u ƒë·ªÅ n·∫øu c·∫ßn
    initMasterSheetHeaders();
    
    switch (action) {
      case 'getMasterAllAccounts': result = getMasterAllAccounts(); break;
      case 'updateAdminConfig': result = updateAdminConfig(data); break;
      case 'checkAdminLimit': result = checkAdminLimit(data); break;
      case 'sendPromotion': result = handleSendPromotion(data); break;
      case 'schedulePromotion': result = handleSchedulePromotion(data); break;
      case 'uploadAdImage': result = handleUploadAdImage(data); break;
      case 'processScheduledAds': result = processScheduledAds(); break;
      case 'sendFeedback': result = handleSendFeedback(data); break;
      case 'runWeeklyReports': result = processWeeklyReports(true); break; // true = ch·∫ø ƒë·ªô Test (14 ng√†y g·∫ßn nh·∫•t)
      case 'getMasterDashboardData': result = getMasterDashboardData(); break;
      case 'getMarketingLogs': result = getMarketingLogs(data); break;
      default: 
        result = { success: false, message: 'H√†nh ƒë·ªông kh√¥ng h·ª£p l·ªá t·∫°i Master Script' };
    }
  } catch (error) {
    result = { success: false, message: 'L·ªói Master Backend: ' + error.toString() };
  }
  return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
}

// --- CORE FUNCTIONS ---

function getMasterAllAccounts() {
  try {
    const mainSS = SpreadsheetApp.openById(MAIN_SPREADSHEET_ID);
    const adminSheet = mainSS.getSheetByName('admin');
    const useSheet = mainSS.getSheetByName('use');
    
    const masterSS = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
    const masterSheet = masterSS.getSheetByName(MASTER_SHEET_NAME);
    
    const adminData = adminSheet.getDataRange().getValues();
    const useData = useSheet ? useSheet.getDataRange().getValues() : [];
    const configData = masterSheet.getDataRange().getValues();
    
    const allUsers = [];

    // 1. Qu√©t Admin Sheet
    for (let i = 1; i < adminData.length; i++) {
        const email = decryptData(adminData[i][1]).toLowerCase();
        const conf = configData.find(r => r[0].toString().toLowerCase() === email);
        
        allUsers.push({
            id: adminData[i][0], email: email, fullName: adminData[i][3],
            roleId: 'R001', owner: 'SYSTEM (ROOT)', status: adminData[i][5] || 'Ho·∫°t ƒë·ªông',
            package: conf ? conf[1] : 'Free', 
            expiry: conf ? conf[3] : '',
            regDate: adminData[i][6] || new Date(), type: 'ADMIN',
            salesRestrict: conf ? (conf[10] || 'OFF') : 'OFF',
            restrictTimer: conf ? (conf[11] || '') : '',
            features: conf ? JSON.parse(conf[4] || '{}') : {}
        });
    }

    // 2. Qu√©t Use Sheet (D√≤ t√¨m Admin Nh√≥m v√† ·∫®n h·ªç kh·ªèi danh s√°ch NV)
    const adminsMap = {}; // { orgEmail: [list_of_admins] }
    
    // Admin g·ªëc (Ch·ªß c√¥ng ty)
    for (let i = 1; i < adminData.length; i++) {
        const email = decryptData(adminData[i][1]).toLowerCase().trim();
        if (email) adminsMap[email] = [email];
    }

    // T√¨m t·∫•t c·∫£ Admin (R001) trong b·∫£ng nh√¢n vi√™n
    for (let i = 1; i < useData.length; i++) {
        const uRole = useData[i][4];
        if (uRole === 'R001') {
            const uEmail = (decryptData(useData[i][1]) || "").toLowerCase().trim();
            const uOwner = (decryptData(useData[i][5]) || "").toLowerCase().trim();
            if (uOwner && adminsMap[uOwner]) {
                if (adminsMap[uOwner].indexOf(uEmail) === -1) adminsMap[uOwner].push(uEmail);
            }
        }
    }

    for (let i = 1; i < useData.length; i++) {
        const email = (decryptData(useData[i][1]) || "").toLowerCase();
        if (!email) continue;
        const roleId = useData[i][4];
        
        // N·∫æU L√Ä ADMIN (R001): ·∫®N KH·ªéI DANH S√ÅCH NH√ÇN VI√äN
        if (roleId === 'R001') continue;

        const ownerEmail = (decryptData(useData[i][5]) || "").toLowerCase();
        const orgAdmins = adminsMap[ownerEmail] || [ownerEmail || 'H·ªá th·ªëng'];
        
        allUsers.push({
            id: useData[i][0], 
            email: email, 
            fullName: useData[i][3],
            roleId: roleId, 
            owner: orgAdmins.join(', '), 
            status: useData[i][6] || 'Ho·∫°t ƒë·ªông', 
            package: 'N/A', 
            regDate: useData[i][7] || new Date(),
            type: 'STAFF'
        });
    }

    return { success: true, users: allUsers };
  } catch (e) { return { success: false, message: e.toString() }; }
}

function updateAdminConfig(data) {
  try {
    const email = (data.adminEmail || "").toLowerCase().trim();
    const mainSS = SpreadsheetApp.openById(MAIN_SPREADSHEET_ID);
    const masterSS = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
    let updated = false;
    let oldStatus = "";

    // 1. C·∫≠p nh·∫≠t v√†o sheet Master 
    const masterSheet = masterSS.getSheetByName(MASTER_SHEET_NAME);
    const mRows = masterSheet.getDataRange().getValues();
    let rowIndex = -1;

    for (let i = 1; i < mRows.length; i++) {
      if (mRows[i][0].toString().toLowerCase() === email) {
        rowIndex = i + 1;
        oldStatus = mRows[i][5];
        break;
      }
    }

    // X√°c ƒë·ªãnh gi·ªõi h·∫°n nh√¢n s·ª± (Staff Limit)
    let currentMaxStaff = 5;
    if (rowIndex !== -1) {
      currentMaxStaff = mRows[rowIndex - 1][2];
    } else if (data.package === 'Premium') {
      currentMaxStaff = 50;
    }
    
    let finalMaxStaff = data.max_staff !== undefined ? data.max_staff : currentMaxStaff;
    if (data.package === 'Premium' && (!finalMaxStaff || finalMaxStaff < 50)) finalMaxStaff = 50;

    if (rowIndex !== -1) {
      const oldPackage = mRows[rowIndex - 1][1];
      if (data.package) {
        if (data.package !== oldPackage) {
          logMasterAction(email, 'UPDATE_PACKAGE', `${oldPackage} -> ${data.package}`, data.ip);
        }
        masterSheet.getRange(rowIndex, 2).setValue(data.package);
      }
      
      masterSheet.getRange(rowIndex, 3).setValue(finalMaxStaff);
      if (data.expiry) masterSheet.getRange(rowIndex, 4).setValue(data.expiry);
      
      if (data.status) {
        if (data.status !== oldStatus) {
          logMasterAction(email, 'UPDATE_STATUS', `${oldStatus} -> ${data.status}`, data.ip);
        }
        masterSheet.getRange(rowIndex, 6).setValue(data.status);
      }
      
      if (data.salesRestrict) {
        const oldRestrict = mRows[rowIndex - 1][10] || 'OFF';
        masterSheet.getRange(rowIndex, 11).setValue(data.salesRestrict);
        if (data.salesRestrict === 'ON' && oldRestrict === 'OFF') {
          sendRestrictionEmail(email);
        }
      }
      if (data.restrictTimer !== undefined) masterSheet.getRange(rowIndex, 12).setValue(data.restrictTimer);

      // Update Feature Locks
      if (data.features) {
        let currentFeatures = JSON.parse(mRows[rowIndex - 1][4] || '{}');
        const diff = [];
        for (const [key, val] of Object.entries(data.features)) {
            if (currentFeatures[key] !== val) {
                diff.push(`${key}: ${currentFeatures[key]} -> ${val}`);
            }
        }
        
        Object.assign(currentFeatures, data.features);
        masterSheet.getRange(rowIndex, 5).setValue(JSON.stringify(currentFeatures));
        
        if (diff.length > 0) {
            logMasterAction(email, 'UPDATE_FEATURES', diff.join(' | '), data.ip);
        }
      }
      
      updated = true;

      // Ki·ªÉm tra n√¢ng c·∫•p l√™n Premium
      if (data.package === 'Premium' && oldPackage !== 'Premium') {
        sendPremiumUpgradeEmail(email, data.expiry || mRows[rowIndex - 1][3]);
      }
    } else {
      const features = data.features ? JSON.stringify(data.features) : '{}';
      masterSheet.appendRow([
        email, data.package || 'Free', finalMaxStaff, data.expiry || '', features, 
        data.status || 'Ho·∫°t ƒë·ªông', new Date(), new Date(), '', '', 
        data.salesRestrict || 'OFF', data.restrictTimer || ''
      ]);
      updated = true;
      if (data.package === 'Premium') {
        sendPremiumUpgradeEmail(email, data.expiry || '');
      }
    }

    // 2. ƒê·ªìng b·ªô Admin Sheet
    const adminSheet = mainSS.getSheetByName('admin');
    const aRows = adminSheet.getDataRange().getValues();
    for (let i = 1; i < aRows.length; i++) {
       if (decryptData(aRows[i][1]).toLowerCase() === email) {
         if (data.status) adminSheet.getRange(i + 1, 6).setValue(data.status);
         updated = true; break;
       }
    }

    // 3. ƒê·ªìng b·ªô Use Sheet
    const useSheet = mainSS.getSheetByName('use');
    if (useSheet) {
      const uRows = useSheet.getDataRange().getValues();
      for (let i = 1; i < uRows.length; i++) {
         if (decryptData(uRows[i][1]).toLowerCase() === email) {
           if (data.status) useSheet.getRange(i + 1, 7).setValue(data.status);
           updated = true; break;
         }
      }
    }

    if (updated && data.status && data.status !== oldStatus) {
      sendAccountStatusEmail(email, data.status);
    }

    return updated ? { success: true } : { success: false, message: 'Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n ƒë·ªÉ c·∫≠p nh·∫≠t' };
  } catch (e) { return { success: false, message: e.toString() }; }
}

/**
 * G·ª≠i qu·∫£ng c√°o/khuy·∫øn m√£i thuy·∫øt ph·ª•c n√¢ng c·∫•p g√≥i (H·ªó tr·ª£ nhi·ªÅu email)
 * ƒê√£ t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t ƒë·ªÉ tr√°nh d·ª´ng ƒë·ªôt ng·ªôt khi g·∫∑p l·ªói k·∫øt n·ªëi ho·∫∑c mail ·∫£o
 */
function handleSendPromotion(data) {
  try {
    const emails = Array.isArray(data.targetEmails) ? data.targetEmails : [data.targetEmail];
    const title = data.adTitle || "üî• ∆ØU ƒê√ÉI ƒê·∫∂C BI·ªÜT D√ÄNH RI√äNG CHO B·∫†N - DUNVEX";
    const content = data.adContent || "";
    const imageUrl = data.adImage || "";
    
    const htmlBody = `
      <div style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 600px; margin: 0 auto; border: 1px solid #e0e7ff; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);">
        ${imageUrl ? `<img src="${imageUrl}" style="width: 100%; height: auto; display: block;" alt="Promotion">` : ''}
        <div style="padding: 40px; background: #ffffff;">
          <h2 style="color: #4f46e5; margin-top: 0; font-size: 24px; line-height: 1.3;">${title}</h2>
          <div style="color: #475569; font-size: 16px; line-height: 1.6; margin: 20px 0;">
            ${content.replace(/\n/g, '<br>')}
          </div>
          <div style="text-align: center; margin-top: 35px;">
            <a href="https://dunvex.com/upgrade" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; padding: 16px 32px; text-decoration: none; border-radius: 12px; font-weight: bold; display: inline-block; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);">N√ÇNG C·∫§P NGAY H√îM NAY</a>
          </div>
          <p style="text-align: center; font-size: 13px; color: #94a3b8; margin-top: 30px;">
            H·ªá th·ªëng Dunvex - Gi·∫£i ph√°p qu·∫£n tr·ªã doanh nghi·ªáp to√†n di·ªán.<br>
            B·∫°n nh·∫≠n ƒë∆∞·ª£c email n√†y v√¨ l√† th√†nh vi√™n c·ªßa Dunvex.
          </p>
        </div>
      </div>
    `;

    const masterSS = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
    const sheet = masterSS.getSheetByName(MASTER_SHEET_NAME);
    
    // ƒê·∫£m b·∫£o log sheet t·ªìn t·∫°i
    initMasterSheetHeaders();

    // T·ªêI ∆ØU H√ìA: ƒê·ªçc d·ªØ li·ªáu sheet 1 l·∫ßn duy nh·∫•t tr∆∞·ªõc khi l·∫∑p
    const allRows = sheet.getDataRange().getValues();
    const emailToRowIndex = {};
    for (let i = 1; i < allRows.length; i++) {
      const emailKey = allRows[i][0].toString().toLowerCase().trim();
      if (emailKey) emailToRowIndex[emailKey] = i + 1;
    }

    let successCount = 0;
    let failCount = 0;
    const errors = [];

    emails.forEach(email => {
      const target = email.toLowerCase().trim();
      if (!target) return;

      try {
        // S·ª≠ d·ª•ng MailApp ƒë·ªÉ g·ª≠i mail (Ti·∫øt ki·ªám quota so v·ªõi GmailApp)
        MailApp.sendEmail({
          to: target,
          subject: title,
          htmlBody: htmlBody
        });
        
        // Ghi log th√†nh c√¥ng v√†o sheet marketing_log
        logMarketingEmail('SUCCESS', target, title, '');
        successCount++;

        // Ghi l·∫°i l·ªãch s·ª≠ v√†o User Profile (S·ª≠ d·ª•ng Map ƒë·ªÉ t√¨m h√†ng nhanh h∆°n)
        const rowIndex = emailToRowIndex[target];
        if (rowIndex) {
          const history = allRows[rowIndex - 1][9] || "";
          const newHistory = (history ? history + "\n" : "") + "[" + new Date().toLocaleDateString('vi-VN') + "] ƒê√£ g·ª≠i: " + title;
          sheet.getRange(rowIndex, 10).setValue(newHistory);
        }
      } catch (err) {
        const errorMsg = err.toString();
        // Ghi log l·ªói v√†o sheet marketing_log
        logMarketingEmail('FAILED', target, title, errorMsg);
        failCount++;
        errors.push(`${target}: ${errorMsg}`);
        
        // L∆∞u √Ω: N·∫øu l·ªói do v∆∞·ª£t quota h√†ng ng√†y c·ªßa Google, script c√≥ th·ªÉ d·ª´ng h·∫≥n.
        // Nh∆∞ng l·ªói k·∫øt n·ªëi ƒë·∫øn 1 email c·ª• th·ªÉ (Address not found) s·∫Ω ƒë∆∞·ª£c catch ·ªü ƒë√¢y.
        console.error(`L·ªói g·ª≠i mail ƒë·∫øn ${target}: ${errorMsg}`);
      }
    });

    return { 
      success: true, 
      message: `Ho√†n t·∫•t! Th√†nh c√¥ng: ${successCount}, Th·∫•t b·∫°i: ${failCount}`,
      errors: errors.slice(0, 5) // Tr·∫£ v·ªÅ t·ªëi ƒëa 5 l·ªói ƒë·∫ßu ti√™n ƒë·ªÉ debug
    };
  } catch (e) {
    return { success: false, message: 'L·ªói h·ªá th·ªëng g·ª≠i qu·∫£ng c√°o: ' + e.toString() };
  }
}


function logMarketingEmail(status, email, campaign, errorDetails) {
  try {
    const ss = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
    let sheet = ss.getSheetByName(MARKETING_LOG_SHEET_NAME);
    if (!sheet) {
      initMasterSheetHeaders();
      sheet = ss.getSheetByName(MARKETING_LOG_SHEET_NAME);
    }
    sheet.appendRow([
      new Date(),
      campaign,
      email,
      status,
      errorDetails || ''
    ]);
  } catch (e) {
    console.error("Marketing Log Error: " + e.toString());
  }
}

function getMarketingLogs(data) {
  try {
    const ss = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
    const sheet = ss.getSheetByName(MARKETING_LOG_SHEET_NAME);
    if (!sheet) return { success: true, logs: [] };

    const rows = sheet.getDataRange().getValues();
    // B·ªè header (d√≤ng 1)
    const logs = rows.slice(1).map(r => ({
      time: r[0],
      campaign: r[1],
      email: r[2],
      status: r[3],
      error: r[4]
    })).reverse().slice(0, 100); // L·∫•y 100 log m·ªõi nh·∫•t

    return { success: true, logs: logs };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}

/**
 * H·∫πn gi·ªù g·ª≠i qu·∫£ng c√°o
 */
function handleSchedulePromotion(data) {
  try {
    const masterSS = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
    let schedSheet = masterSS.getSheetByName(SCHEDULE_SHEET_NAME);
    if (!schedSheet) {
      schedSheet = masterSS.insertSheet(SCHEDULE_SHEET_NAME);
      schedSheet.appendRow(['Scheduled Time', 'Emails', 'Title', 'Content', 'Image', 'Status']);
    }

    const emails = Array.isArray(data.targetEmails) ? data.targetEmails.join(',') : data.targetEmail;
    schedSheet.appendRow([
      data.scheduledTime, // YYYY-MM-DDTHH:mm
      emails,
      data.adTitle,
      data.adContent,
      data.adImage,
      'PENDING'
    ]);

    // T·∫°o trigger n·∫øu ch∆∞a c√≥ (ch·∫°y m·ªói ph√∫t)
    ensureMinuteTrigger();

    return { success: true, message: 'ƒê√£ l√™n l·ªãch g·ª≠i qu·∫£ng c√°o th√†nh c√¥ng!' };
  } catch (e) {
    return { success: false, message: e.toString() };
  }
}

function logMasterAction(email, action, details, ip) {
  try {
    const ss = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
    const sheet = ss.getSheetByName(LOG_SHEET_NAME);
    if (!sheet) return;
    
    sheet.appendRow([
      new Date(),
      email,
      action,
      details,
      ip || 'N/A'
    ]);
  } catch(e) {
    console.error("Log Error: " + e.toString());
  }
}


function ensureMinuteTrigger() {
  const triggers = ScriptApp.getProjectTriggers();
  const hasTrigger = triggers.some(t => t.getHandlerFunction() === 'processScheduledAds');
  if (!hasTrigger) {
    ScriptApp.newTrigger('processScheduledAds').timeBased().everyMinutes(1).create();
  }
}

/**
 * H√†m qu√©t v√† g·ª≠i qu·∫£ng c√°o ƒë√£ h·∫πn gi·ªù (Trigger m·ªói ph√∫t)
 */
function processScheduledAds() {
  try {
    const masterSS = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
    const now = new Date();
    
    // 1. Process Ad Promotions
    const adSheet = masterSS.getSheetByName(SCHEDULE_SHEET_NAME);
    if (adSheet) {
      const adRows = adSheet.getDataRange().getValues();
      for (let i = 1; i < adRows.length; i++) {
        if (adRows[i][5] !== 'PENDING') continue;
        const schedTime = new Date(adRows[i][0]);
        if (schedTime <= now) {
          handleSendPromotion({
            targetEmails: adRows[i][1].split(','),
            adTitle: adRows[i][2],
            adContent: adRows[i][3],
            adImage: adRows[i][4]
          });
          adSheet.getRange(i + 1, 6).setValue('SENT');
        }
      }
    }

    // 2. Process Sales Report Restrictions Timer
    const masterSheet = masterSS.getSheetByName(MASTER_SHEET_NAME);
    const mRows = masterSheet.getDataRange().getValues();
    for (let i = 1; i < mRows.length; i++) {
      const timerStr = mRows[i][11]; // restrict_timer column
      if (timerStr && timerStr.length > 5) {
        const timerDate = new Date(timerStr);
        if (timerDate <= now) {
          const currentRestrict = mRows[i][10] || 'OFF';
          const newRestrict = currentRestrict === 'ON' ? 'OFF' : 'ON';
          masterSheet.getRange(i + 1, 11).setValue(newRestrict);
          masterSheet.getRange(i + 1, 12).setValue(''); // Clear timer
          
          // G·ª≠i th√¥ng b√°o n·∫øu t·ª± ƒë·ªông B·∫¨T h·∫°n ch·∫ø
          if (newRestrict === 'ON') {
            sendRestrictionEmail(mRows[i][0]);
          }

          // Log restriction change
          const history = mRows[i][9] || "";
          const log = history + "\n" + "[" + now.toLocaleDateString() + "] T·ª± ƒë·ªông " + (newRestrict === 'ON' ? 'B·∫¨T' : 'T·∫ÆT') + " h·∫°n ch·∫ø b√°o c√°o.";
          masterSheet.getRange(i + 1, 10).setValue(log);
        }
      }
    }
  } catch (e) {
    Logger.log("L·ªói cron process: " + e.toString());
  }
}

/**
 * X·ª≠ l√Ω t·∫£i l√™n h√¨nh ·∫£nh qu·∫£ng c√°o v√†o Drive
 */
function handleUploadAdImage(data) {
  try {
    const folder = DriveApp.getFolderById(AD_FOLDER_ID);
    const contentType = data.mimeType || "image/jpeg";
    const base64Data = data.base64Data;
    const fileName = "AD_" + new Date().getTime() + "_" + data.fileName;
    
    // Gi·∫£i m√£ Base64 sang Blob
    const decodedData = Utilities.base64Decode(base64Data);
    const blob = Utilities.newBlob(decodedData, contentType, fileName);
    
    // L∆∞u v√†o Drive
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // Tr·∫£ v·ªÅ link lh3 ƒë·ªÉ hi·ªÉn th·ªã tr·ª±c ti·∫øp trong email
    const viewUrl = "https://lh3.googleusercontent.com/d/" + file.getId();
    
    return { success: true, url: viewUrl };
  } catch (e) {
    return { success: false, message: "L·ªói Upload Drive: " + e.toString() };
  }
}

/**
 * Ki·ªÉm tra gi·ªõi h·∫°n nh√¢n s·ª± cho Admin
 */
function checkAdminLimit(data) {
  try {
    const email = (data.adminEmail || "").toLowerCase().trim();
    const masterSS = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
    const mSheet = masterSS.getSheetByName(MASTER_SHEET_NAME);
    const rows = mSheet.getDataRange().getValues();
    const config = rows.find(r => r[0].toString().toLowerCase() === email);
    
    // Default limit
    let limit = 5;
    let pkg = 'Free';
    
    if (config) {
      pkg = config[1];
      limit = parseInt(config[2]) || (pkg === 'Premium' ? 50 : 5);
    }
    
    const mainSS = SpreadsheetApp.openById(MAIN_SPREADSHEET_ID);
    const useSheet = mainSS.getSheetByName('use');
    const useData = useSheet ? useSheet.getDataRange().getValues() : [];
    let current = 0;
    for (let i = 1; i < useData.length; i++) {
      if (decryptData(useData[i][5]).toLowerCase() === email) current++;
    }
    return { canCreate: current < limit, current: current, limit: limit, package: pkg };
  } catch (e) { return { success: false, message: e.toString() }; }
}

/**
 * L·∫•y th√¥ng tin g√≥i c∆∞·ªõc c·ªßa Admin
 */
function getAdminPackage(email) {
  try {
    const ss = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
    const sheet = ss.getSheetByName(MASTER_SHEET_NAME);
    const rows = sheet.getDataRange().getValues();
    const config = rows.find(r => r[0].toString().toLowerCase() === email.toLowerCase());
    return config ? { package: config[1], expiry: config[3] } : { package: 'Free', expiry: '' };
  } catch (e) { return { package: 'Free', expiry: '' }; }
}

// --- TI·ªÜN √çCH KH·ªûI T·∫†O ---

function initMasterSheetHeaders() {
  const ss = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
  
  // 1. Init Master Menu Sheet
  let sheet = ss.getSheetByName(MASTER_SHEET_NAME);
  if (!sheet) sheet = ss.insertSheet(MASTER_SHEET_NAME);
  if (sheet.getLastRow() === 0) {
    sheet.appendRow([
      'admin_email', 'package', 'max_staff', 'report_expiry', 'features_json', 
      'status', 'created_date', 'last_active', 'notes', 'ad_history', 
      'sales_restrict', 'restrict_timer', 'delivery_master', 'hr_master'
    ]);
    sheet.setFrozenRows(1);
    sheet.getRange(1, 1, 1, 14).setBackground('#ef4444').setFontColor('#ffffff').setFontWeight('bold');
  }

  // 2. Init LOG Sheet (activity_log)
  if (!ss.getSheetByName(LOG_SHEET_NAME)) {
    const s = ss.insertSheet(LOG_SHEET_NAME);
    s.appendRow(['time', 'admin_email', 'action_type', 'details', 'ip_address']);
    s.getRange(1, 1, 1, 5).setBackground('#e0e7ff').setFontColor('#000000').setFontWeight('bold');
    s.setColumnWidth(1, 160);
    s.setColumnWidth(2, 220);
    s.setColumnWidth(3, 150);
    s.setColumnWidth(4, 500);
  }

  // 3. Init Schedule Sheet (ad_schedule)
  if (!ss.getSheetByName(SCHEDULE_SHEET_NAME)) {
    const s = ss.insertSheet(SCHEDULE_SHEET_NAME);
    s.appendRow(['Scheduled Time', 'Emails', 'Title', 'Content', 'Image', 'Status']);
    s.getRange(1, 1, 1, 6).setBackground('#dbeafe').setFontColor('#000000').setFontWeight('bold');
  }

  // 4. Init Marketing Log Sheet
  if (!ss.getSheetByName(MARKETING_LOG_SHEET_NAME)) {
    const s = ss.insertSheet(MARKETING_LOG_SHEET_NAME);
    s.appendRow(['Time', 'Campaign', 'Email', 'Status', 'Error Reason']);
    s.getRange(1, 1, 1, 5).setBackground('#fef3c7').setFontColor('#b45309').setFontWeight('bold');
    s.setColumnWidth(1, 160);
    s.setColumnWidth(2, 250);
    s.setColumnWidth(3, 200);
    s.setColumnWidth(4, 100);
    s.setColumnWidth(5, 300);
  }
}

// --- TI·ªÜN √çCH G·ª¨I EMAIL ---

function sendAccountStatusEmail(email, status) {
  const isLocked = status === 'T·∫°m kh√≥a';
  const subject = isLocked ? "‚ö†Ô∏è TH√îNG B√ÅO T·∫†M KH√ìA T√ÄI KHO·∫¢N - DUNVEX" : "‚úÖ TH√îNG B√ÅO M·ªû KH√ìA T√ÄI KHO·∫¢N - DUNVEX";
  const statusHtml = isLocked ? 
    `<span style="color: #ef4444; font-weight: bold;">T·∫†M KH√ìA</span>` : 
    `<span style="color: #22c55e; font-weight: bold;">ƒêANG HO·∫†T ƒê·ªòNG</span>`;
  
  const body = `
    <div style="font-family: sans-serif; max-width: 600px; margin: 0 auto; border: 1px solid #e2e8f0; border-radius: 16px; padding: 40px; line-height: 1.6;">
      <h2 style="color: #1e293b; border-bottom: 2px solid #6366f1; padding-bottom: 10px;">C·∫≠p nh·∫≠t tr·∫°ng th√°i T√†i kho·∫£n</h2>
      <p>Ch√†o b·∫°n,</p>
      <p>Ch√∫ng t√¥i xin th√¥ng b√°o tr·∫°ng th√°i t√†i kho·∫£n Dunvex c·ªßa b·∫°n (<b>${email}</b>) ƒë√£ ƒë∆∞·ª£c thay ƒë·ªïi th√†nh: ${statusHtml}</p>
      
      ${isLocked ? `
        <div style="background: #fff1f2; border-left: 4px solid #ef4444; padding: 20px; margin: 25px 0;">
          <p style="margin: 0; color: #991b1b;"><b>L√Ω do:</b> T√†i kho·∫£n hi·ªán ƒëang b·ªã ƒë√¨nh ch·ªâ quy·ªÅn truy c·∫≠p t·∫°m th·ªùi.</p>
          <p style="margin: 10px 0 0 0; color: #991b1b;">Vui l√≤ng li√™n h·ªá Admin qua email: <a href="mailto:${MASTER_EMAIL}">${MASTER_EMAIL}</a> ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ m·ªü l·∫°i t√†i kho·∫£n.</p>
        </div>
      ` : `
        <div style="background: #f0fdf4; border-left: 4px solid #22c55e; padding: 20px; margin: 25px 0;">
          <p style="margin: 0; color: #166534;">T√†i kho·∫£n c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t tr·ªü l·∫°i. B√¢y gi·ªù b·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p v√†o h·ªá th·ªëng b√¨nh th∆∞·ªùng.</p>
        </div>
      `}
      
      <p style="font-size: 0.85rem; color: #64748b; margin-top: 40px; border-top: 1px solid #f1f5f9; padding-top: 20px;">
        Tr√¢n tr·ªçng,<br><b>Dunvex Digital Team</b>
      </p>
    </div>
  `;

  try {
    MailApp.sendEmail({
      to: email,
      subject: subject,
      htmlBody: body
    });
  } catch (e) {
    console.error("L·ªói g·ª≠i mail: " + e.toString());
  }
}

/**
 * G·ª≠i email ch√∫c m·ª´ng n√¢ng c·∫•p Premium
 */
function sendPremiumUpgradeEmail(email, expiryDate) {
  const expiryStr = expiryDate ? new Date(expiryDate).toLocaleDateString('vi-VN') : "V√¥ th·ªùi h·∫°n";
  const subject = "üíé CH√öC M·ª™NG! B·∫†N ƒê√É TR·ªû TH√ÄNH TH√ÄNH VI√äN PREMIUM - DUNVEX";
  
  const body = `
    <div style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 600px; margin: 0 auto; border: 2px solid #a855f7; border-radius: 20px; overflow: hidden;">
      <div style="background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%); padding: 40px; text-align: center; color: white;">
        <div style="font-size: 50px; margin-bottom: 20px;">üíé</div>
        <h1 style="margin: 0; font-size: 28px; letter-spacing: 1px;">X√ÅC NH·∫¨N N√ÇNG C·∫§P</h1>
        <p style="opacity: 0.9; margin-top: 10px;">Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi ƒë·∫∑c quy·ªÅn Premium</p>
      </div>
      
      <div style="padding: 40px; background: white; color: #1e293b;">
        <p style="font-size: 18px;">Ch√†o b·∫°n, <b>${email}</b></p>
        <p style="line-height: 1.6;">Ch√∫ng t√¥i v√¥ c√πng vui m·ª´ng th√¥ng b√°o r·∫±ng t√†i kho·∫£n c·ªßa b·∫°n ƒë√£ ch√≠nh th·ª©c ƒë∆∞·ª£c n√¢ng c·∫•p l√™n h·∫°ng <b>Cao c·∫•p (Premium)</b>.</p>
        
        <div style="background: #f5f3ff; border-radius: 12px; padding: 25px; margin: 30px 0; border: 1px dashed #a855f7;">
          <p style="margin: 0; color: #7c3aed; font-weight: bold; font-size: 1.1rem;">üåü Tr·∫°ng th√°i VIP: ƒê√É K√çCH HO·∫†T</p>
          <p style="margin: 10px 0 0 0; color: #4b5563;">H·∫°n m·ª©c b·∫£n quy·ªÅn: <span style="color: #ef4444; font-weight: 700;">${expiryStr}</span></p>
          <p style="margin: 10px 0 0 0; font-size: 0.9rem; color: #6b7280;"><i>(Sau ng√†y n√†y, c√°c b√°o c√°o n√¢ng cao s·∫Ω t·∫°m ng∆∞ng cho ƒë·∫øn khi ƒë∆∞·ª£c gia h·∫°n)</i></p>
        </div>

        <p>B√¢y gi·ªù b·∫°n ƒë√£ c√≥ ƒë·∫ßy ƒë·ªß quy·ªÅn l·ª£i:</p>
        <ul style="color: #4b5563; padding-left: 20px;">
          <li>M·ªü kh√≥a to√†n b·ªô t√≠nh nƒÉng B√°o c√°o doanh thu chuy√™n s√¢u.</li>
          <li>Qu·∫£n l√Ω nh√¢n s·ª± kh√¥ng gi·ªõi h·∫°n (t√πy theo g√≥i).</li>
          <li>∆Øu ti√™n h·ªó tr·ª£ k·ªπ thu·∫≠t 24/7.</li>
        </ul>

        <div style="text-align: center; margin-top: 40px;">
          <a href="https://dunvex.com" style="background: #a855f7; color: white; padding: 15px 35px; text-decoration: none; border-radius: 10px; font-weight: bold; display: inline-block; box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);">TRUY C·∫¨P H·ªÜ TH·ªêNG NGAY</a>
        </div>
      </div>
      
      <div style="background: #f9fafb; padding: 20px; text-align: center; color: #9ca3af; font-size: 12px;">
        ƒê√¢y l√† email t·ª± ƒë·ªông t·ª´ h·ªá th·ªëng qu·∫£n tr·ªã Dunvex. Vui l√≤ng kh√¥ng tr·∫£ l·ªùi email n√†y.
      </div>
    </div>
  `;

  try {
    MailApp.sendEmail({
      to: email,
      subject: subject,
      htmlBody: body
    });
  } catch (e) {
    console.error("L·ªói g·ª≠i mail Premium: " + e.toString());
  }
}

/**
 * G·ª≠i email th√¥ng b√°o h·∫øt h·∫°n t√≠nh nƒÉng B√°o c√°o
 */
function sendRestrictionEmail(email) {
  const subject = "üì¢ TH√îNG B√ÅO: H·∫°n m·ª©c t√≠nh nƒÉng Cao c·∫•p ƒë√£ thay ƒë·ªïi - DUNVEX";
  
  const body = `
    <div style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 600px; margin: 0 auto; border: 1px solid #fed7aa; border-radius: 20px; overflow: hidden;">
      <div style="background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); padding: 35px; text-align: center; color: white;">
        <div style="font-size: 50px; margin-bottom: 15px;">‚è≥</div>
        <h1 style="margin: 0; font-size: 24px; letter-spacing: 0.5px;">TH√îNG B√ÅO GIA H·∫†N</h1>
      </div>
      
      <div style="padding: 40px; background: white; color: #1e293b; line-height: 1.6;">
        <p style="font-size: 18px;">Ch√†o b·∫°n, <b>${email}</b></p>
        <p>H·ªá th·ªëng Dunvex xin th√¥ng b√°o: Th·ªùi gian s·ª≠ d·ª•ng th·ª≠ nghi·ªám ho·∫∑c g√≥i t√≠nh nƒÉng <b>B√°o c√°o doanh thu chuy√™n s√¢u</b> c·ªßa b·∫°n ƒë√£ k·∫øt th√∫c.</p>
        
        <div style="background: #fff7ed; border-radius: 12px; padding: 20px; margin: 25px 0; border-left: 4px solid #f97316;">
          <p style="margin: 0; color: #9a3412; font-weight: bold;">Tr·∫°ng th√°i: T·∫†M NG∆ØNG XU·∫§T B√ÅO C√ÅO</p>
          <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #4b5563;">ƒê·ªÉ ti·∫øp t·ª•c s·ª≠ d·ª•ng t√≠nh nƒÉng g·ª≠i Report Email v√† qu·∫£n tr·ªã n√¢ng cao, vui l√≤ng n√¢ng c·∫•p t√†i kho·∫£n c·ªßa b·∫°n.</p>
        </div>

        <p><b>ƒê·∫∑c quy·ªÅn khi n√¢ng c·∫•p Premium:</b></p>
        <ul style="color: #4b5563; padding-left: 20px;">
          <li>M·ªü kh√≥a kh√¥ng gi·ªõi h·∫°n t√≠nh nƒÉng G·ª≠i B√°o C√°o qua Email.</li>
          <li>Qu·∫£n l√Ω t·ªëi ƒëa 50 nh√¢n vi√™n Sale/Account.</li>
          <li>Xem bi·ªÉu ƒë·ªì ph√¢n t√≠ch xu h∆∞·ªõng doanh thu th·ªùi gian th·ª±c.</li>
        </ul>

        <div style="text-align: center; margin-top: 40px;">
          <a href="https://dunvex.com/upgrade" style="background: #ea580c; color: white; padding: 15px 35px; text-decoration: none; border-radius: 10px; font-weight: bold; display: inline-block; box-shadow: 0 4px 15px rgba(234, 88, 12, 0.3);">N√ÇNG C·∫§P PREMIUM NGAY</a>
        </div>

        <p style="font-size: 0.85rem; color: #94a3b8; margin-top: 40px; text-align: center; border-top: 1px solid #f1f5f9; padding-top: 20px;">
          N·∫øu b·∫°n c·∫ßn h·ªó tr·ª£ th√™m, vui l√≤ng ph·∫£n h·ªìi email n√†y ho·∫∑c li√™n h·ªá Hotline h·ªó tr·ª£.<br>
          Tr√¢n tr·ªçng,<br><b>Dunvex Digital Team</b>
        </p>
      </div>
    </div>
  `;

  try {
    MailApp.sendEmail({
      to: email.toLowerCase(),
      subject: subject,
      htmlBody: body
    });
  } catch (e) {
    console.error("L·ªói g·ª≠i mail th√¥ng b√°o h·∫°n ch·∫ø: " + e.toString());
  }
}

/**
 * X·ª≠ l√Ω g·ª≠i ph·∫£n h·ªìi t·ª´ Chatbot v·ªÅ Email qu·∫£n tr·ªã
 */
function handleSendFeedback(data) {
  const userEmail = data.userEmail || "·∫®n danh";
  const message = data.message || "";
  
  const subject = `üì© PH·∫¢N H·ªíI M·ªöI T·ª™ CHATBOT - [${userEmail}]`;
  const body = `
    <div style="font-family: Arial, sans-serif; border: 1px solid #e2e8f0; border-radius: 12px; padding: 25px; max-width: 600px;">
      <h2 style="color: #6366f1; border-bottom: 2px solid #6366f1; padding-bottom: 10px;">Tin nh·∫Øn ph·∫£n h·ªìi m·ªõi</h2>
      <p><b>Ng∆∞·ªùi g·ª≠i:</b> ${userEmail}</p>
      <p><b>Th·ªùi gian:</b> ${new Date().toLocaleString('vi-VN')}</p>
      <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin: 20px 0; line-height: 1.6;">
        ${message.replace(/\n/g, '<br>')}
      </div>
      <p style="color: #64748b; font-size: 0.9rem;">
        <i>B·∫°n c√≥ th·ªÉ ph·∫£n h·ªìi tr·ª±c ti·∫øp cho ng∆∞·ªùi d√πng b·∫±ng c√°ch g·ª≠i mail ƒë·∫øn: ${userEmail}</i>
      </p>
    </div>
  `;
  
  try {
    MailApp.sendEmail({
      to: MASTER_EMAIL,
      subject: subject,
      htmlBody: body,
      replyTo: userEmail
    });
    return { success: true, message: "ƒê√£ g·ª≠i ph·∫£n h·ªìi th√†nh c√¥ng" };
  } catch (e) {
    return { success: false, message: "L·ªói g·ª≠i mail: " + e.toString() };
  }
}

// --- TI·ªÜN √çCH M√É H√ìA (ƒê·ªíNG B·ªò V·ªöI AUTH SCRIPT) ---

function encryptData(text) {
  if (!text) return "";
  const inputBytes = Utilities.newBlob(text.toString()).getBytes();
  const keyBytes = Utilities.newBlob(XOR_SECRET).getBytes();
  const outputBytes = [];
  for (let i = 0; i < inputBytes.length; i++) {
    outputBytes.push(inputBytes[i] ^ keyBytes[i % keyBytes.length]);
  }
  return Utilities.base64Encode(outputBytes);
}

function decryptData(text) {
  if (!text) return "";
  let cleanText = text.toString().trim();
  if (cleanText.includes(":")) cleanText = cleanText.split(":").pop().trim();
  if (cleanText.includes("@") && cleanText.includes(".")) return cleanText;
  if (/^\+?[0-9\s.-]{9,15}$/.test(cleanText)) return cleanText;
  if (cleanText.length < 4) return cleanText;

  // XOR Decrypt
  try {
    const inputBytes = Utilities.base64Decode(cleanText);
    const keyBytes = Utilities.newBlob(XOR_SECRET).getBytes();
    const xorBytes = [];
    for (let i = 0; i < inputBytes.length; i++) {
      xorBytes.push(inputBytes[i] ^ keyBytes[i % keyBytes.length]);
    }
    const res = Utilities.newBlob(xorBytes).getDataAsString();
    const printableRegex = /^[A-Za-z0-9√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒëƒê\s@.,+()√Ä-·ªπ-]+$/i;
    if (res && printableRegex.test(res)) return res.trim();
  } catch(e){}
  
  // AES Fallback
  try {
    const decoded = Utilities.base64Decode(cleanText);
    const decrypted = Utilities.decrypt(Utilities.CipherAlgorithm.AES_128, Utilities.newBlob('dunvex_secure_16').getBytes(), decoded);
    const res = decrypted.getDataAsString();
    if (res) return res.trim();
  } catch(e){}

  return cleanText;
}

/**
 * H√ÄM CH·∫†Y M·ªòT L·∫¶N: C·∫≠p nh·∫≠t c·∫•u tr√∫c c·ªôt cho Sheet Master hi·ªán c√≥
 * B·∫•m ch·ªçn h√†m n√†y ·ªü menu tr√™n v√† nh·∫•n "Run"
 */
function migrate_UpdateMasterStructure() {
  const ss = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
  // Th·ª≠ l·∫•y theo t√™n, n·∫øu kh√¥ng th·∫•y th√¨ l·∫•y ƒë·∫°i trang t√≠nh ƒë·∫ßu ti√™n
  let sheet = ss.getSheetByName(MASTER_SHEET_NAME) || ss.getSheets()[0];
  
  if (!sheet) {
    Logger.log("‚ùå Kh√¥ng t√¨m th·∫•y trang t√≠nh n√†o!");
    return;
  }
  
  Logger.log("üöÄ ƒêang c·∫≠p nh·∫≠t cho trang t√≠nh: " + sheet.getName());
  
  const headers = [
    'admin_email', 'package', 'max_staff', 'report_expiry', 'features_json', 
    'status', 'created_date', 'last_active', 'notes', 'ad_history', 
    'sales_restrict', 'restrict_timer', 'delivery_master'
  ];
  
  // Ghi ti√™u ƒë·ªÅ v√†o d√≤ng 1
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  
  // T√¥ m√†u v√† ƒë·ªãnh d·∫°ng
  sheet.getRange(1, 1, 1, headers.length)
       .setBackground('#ef4444')
       .setFontColor('#ffffff')
       .setFontWeight('bold')
       .setHorizontalAlignment('center')
       .setVerticalAlignment('middle');
       
  sheet.setFrozenRows(1);
  sheet.autoResizeColumns(1, headers.length);
  
  // √âp h·ªá th·ªëng c·∫≠p nh·∫≠t ngay
  SpreadsheetApp.flush();
  
  Logger.log("‚úÖ ƒê√£ c·∫≠p nh·∫≠t xong! B·∫°n h√£y quay l·∫°i Google Sheet ki·ªÉm tra xem c·ªôt J, K, L ƒë√£ hi·ªán ti√™u ƒë·ªÅ ch∆∞a.");
}

/**
 * H·ªÜ TH·ªêNG B√ÅO C√ÅO TU·∫¶N T·ª∞ ƒê·ªòNG (D·ª±a tr√™n c·∫•u h√¨nh Quy·ªÅn truy c·∫≠p)
 * T·ªïng h·ª£p doanh thu "ƒê∆°n ch·ªët" 
 */
function processWeeklyReports(isManualTest) {
  // N·∫øu ch·∫°y t·ª´ n√∫t Run trong IDE (isManualTest s·∫Ω l√† undefined ho·∫∑c object), m·∫∑c ƒë·ªãnh l√† TRUE ƒë·ªÉ d·ªÖ test
  if (isManualTest === undefined || typeof isManualTest === 'object') isManualTest = true;
  
  try {
    const mainSS = SpreadsheetApp.openById(MAIN_SPREADSHEET_ID);
    const permSheet = mainSS.getSheetByName('phan_quyen');
    const useSheet = mainSS.getSheetByName('use');
    
    if (!permSheet || !useSheet) return { success: false, message: "Thi·∫øu d·ªØ li·ªáu h·ªá th·ªëng (phan_quyen/use)" };

    const perms = permSheet.getDataRange().getValues();
    const users = useSheet.getDataRange().getValues();

    // 1. X√°c ƒë·ªãnh kho·∫£ng th·ªùi gian
    let start, end;
    if (isManualTest) {
      // CH·∫æ ƒê·ªò TEST: Qu√©t 14 ng√†y g·∫ßn nh·∫•t (Bao g·ªìm c·∫£ h√¥m nay)
      start = new Date();
      start.setDate(start.getDate() - 14);
      start.setHours(0, 0, 0, 0);
      end = new Date();
      end.setHours(23, 59, 59, 999);
    } else {
      // CH·∫æ ƒê·ªò T·ª∞ ƒê·ªòNG (Th·ª© 2 h√†ng tu·∫ßn): Qu√©t ƒë√∫ng tu·∫ßn tr∆∞·ªõc
      const now = new Date();
      const dayOfWeek = now.getDay(); 
      const diffToLastMonday = (dayOfWeek === 0 ? 6 : dayOfWeek - 1) + 7;
      start = new Date(now);
      start.setDate(now.getDate() - diffToLastMonday);
      start.setHours(0, 0, 0, 0);
      end = new Date(start);
      end.setDate(start.getDate() + 6);
      end.setHours(23, 59, 59, 999);
    }

    const dateLabel = Utilities.formatDate(start, "GMT+7", "dd/MM") + " - " + Utilities.formatDate(end, "GMT+7", "dd/MM/yyyy");
    Logger.log("üìÖ Kho·∫£ng th·ªùi gian b√°o c√°o: " + dateLabel + (isManualTest ? " [CH·∫æ ƒê·ªò TEST]" : ""));

    // 2. L·∫•y d·ªØ li·ªáu ƒë∆°n h√†ng
    const allOrders = SafeStore.read(ORDER_HEADER_FILE);
    if (allOrders.length === 0) return { success: false, message: "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë∆°n h√†ng" };

    // L·ªçc ƒë∆°n ch·ªët trong tu·∫ßn
    const weeklyOrders = allOrders.filter(o => {
      const st = (o.trang_thai_don_hang || "").toLowerCase();
      if (st !== "ƒë∆°n ch·ªët" && st !== "ƒë√£ giao" && st !== "ho√†n th√†nh") return false;
      const parts = o.ngay_len_don.split(' ');
      if (parts.length < 2) return false;
      const dParts = parts[1].split('/');
      const d = new Date(parseInt(dParts[2]), parseInt(dParts[1]) - 1, parseInt(dParts[0]));
      return d >= start && d <= end;
    });

    Logger.log("üì¶ T√¨m th·∫•y " + weeklyOrders.length + " ƒë∆°n ch·ªët trong tu·∫ßn qua.");

    if (weeklyOrders.length === 0) {
      Logger.log("‚è≠Ô∏è D·ª´ng: Kh√¥ng c√≥ ƒë∆°n ch·ªët.");
      return { success: true, message: "Kh√¥ng c√≥ doanh thu ƒë∆°n ch·ªët trong tu·∫ßn qua" };
    }

    // 3. Ph√¢n lo·∫°i c·∫•u h√¨nh nh·∫≠n b√°o c√°o
    const reportConfigs = perms.slice(1).filter(r => !!r[9] || !!r[10]).map(r => ({
      roleId: r[0],
      roleName: r[1],
      adminEmail: (decryptData(r[2]) || "").toLowerCase().trim(),
      notifyStaff: !!r[9],
      notifyAdmin: !!r[10]
    }));
    
    Logger.log("üìù C√°c vai tr√≤ ƒë∆∞·ª£c b·∫≠t th√¥ng b√°o: " + JSON.stringify(reportConfigs));

    // 4. T·ªïng h·ª£p v√† g·ª≠i b√°o c√°o
    
    // A. G·ª≠i cho STAFF (Email c√° nh√¢n)
    // L·∫•y danh s√°ch c√°c RoleId ƒê√É ƒê∆Ø·ª¢C B·∫¨T notifyStaff (l·∫•y duy nh·∫•t ƒë·ªÉ tr√°nh g·ª≠i tr√πng)
    const activeStaffRoles = [...new Set(reportConfigs.filter(c => c.notifyStaff).map(c => c.roleId))];
    Logger.log("ÔøΩÔ∏è C√°c Role ID nh√¢n vi√™n s·∫Ω nh·∫≠n b√°o c√°o: " + JSON.stringify(activeStaffRoles));

    const sentEmails = new Set(); // ƒê·ªÉ ƒë·∫£m b·∫£o 1 mail ch·ªâ nh·∫≠n 1 b√°o c√°o duy nh·∫•t
    activeStaffRoles.forEach(roleId => {
      users.slice(1).forEach(u => {
        const uEmail = (decryptData(u[1]) || "").toLowerCase().trim();
        const uRoleId = u[4];
        const uName = u[3];
        
        if (uRoleId === roleId && !sentEmails.has(uEmail)) {
          const staffOrders = weeklyOrders.filter(o => {
             const creatorRaw = (decryptData(o.nguoi_len_don) || "").toLowerCase().trim();
             return creatorRaw === uEmail || creatorRaw === uEmail.split('@')[0];
          });
          
          if (staffOrders.length > 0) {
            Logger.log("‚úâÔ∏è G·ª¨I MAIL TH√ÄNH C√îNG CHO: " + uEmail);
            sendWeeklyStaffEmail(uEmail, uName, staffOrders, dateLabel);
            sentEmails.add(uEmail);
          }
        }
      });
    });

    // B. G·ª≠i cho ADMIN
    const activeAdminRoles = reportConfigs.filter(c => c.notifyAdmin).map(c => (c.roleId || "").toString().trim());

    if (activeAdminRoles.length > 0) {
       const useData = users;
       const adminSheet = mainSS.getSheetByName('admin');
       const adminData = adminSheet ? adminSheet.getDataRange().getValues() : [];

       // 1. L·∫≠p b·∫£n ƒë·ªì Admin to√†n h·ªá th·ªëng (C·∫£ Root v√† Promoted)
       const orgAdminsMap = {}; 
    
    // Th√™m c√°c Root Admin t·ª´ b·∫£ng 'admin'
    if (adminData.length > 1) {
      adminData.slice(1).forEach(r => {
        const email = (decryptData(r[1]) || "").toLowerCase().trim();
        if (email) {
          if (!orgAdminsMap[email]) orgAdminsMap[email] = [email];
          const userPart = email.split('@')[0];
          if (!orgAdminsMap[userPart]) orgAdminsMap[userPart] = orgAdminsMap[email];
        }
      });
    }

    // Th√™m c√°c Admin ƒë∆∞·ª£c thƒÉng ch·ª©c t·ª´ b·∫£ng 'use'
    useData.slice(1).forEach(u => {
      const uRole = (u[4] || "").toString().trim().toUpperCase();
      const uEmail = (decryptData(u[1]) || "").toLowerCase().trim();
      const uOwner = (decryptData(u[5]) || "").toLowerCase().trim();
      
      if (uRole === 'R001' || uRole === 'ADMIN') {
        const boss = uOwner || uEmail;
        if (boss) {
          if (!orgAdminsMap[boss]) orgAdminsMap[boss] = [boss];
          if (orgAdminsMap[boss].indexOf(uEmail) === -1) orgAdminsMap[boss].push(uEmail);
          
          // ƒê·ªìng b·ªô c·∫£ theo t√™n user (kh√¥ng ƒëu√¥i gmail)
          const bossUser = boss.split('@')[0];
          orgAdminsMap[bossUser] = orgAdminsMap[boss];
        }
      }
    });

    // 2. Gom ƒë∆°n v·ªÅ cho c√°c Admin d·ª±a tr√™n t·ªï ch·ª©c hi·ªán t·∫°i
    let adminGroups = {};
    weeklyOrders.forEach(o => {
      const sellerEmail = (decryptData(o.nguoi_len_don) || "").toLowerCase().trim();
      const sellerUser = sellerEmail.split('@')[0];
      
      const sellerInfo = useData.slice(1).find(u => {
        const uEmail = (decryptData(u[1]) || "").toLowerCase().trim();
        return uEmail === sellerEmail || uEmail.split('@')[0] === sellerUser;
      });
      
      if (sellerInfo) {
        const boss = (decryptData(sellerInfo[5]) || "").toLowerCase().trim() || (decryptData(sellerInfo[1]) || "").toLowerCase().trim();
        const bossUser = boss.split('@')[0];
        const currentAdmins = orgAdminsMap[boss] || orgAdminsMap[bossUser] || [boss];
        
        currentAdmins.forEach(mgr => {
          if (!adminGroups[mgr]) adminGroups[mgr] = [];
          adminGroups[mgr].push(o);
        });
      }
    });

    // 3. Master Admin (Dunvex) - B·ªé g·ª≠i t·ª± ƒë·ªông
    // adminGroups[MASTER_EMAIL.toLowerCase()] = weeklyOrders; 
    const masterKey = MASTER_EMAIL.toLowerCase();

      // Duy·ªát qua t·ª´ng Admin trong nh√≥m ƒë√£ gom
      Object.keys(adminGroups).forEach(targetEmail => {
        // KI·ªÇM TRA QUY·ªÄN: T√¨m ·ªü c·∫£ b·∫£ng Nh√¢n vi√™n (useData) v√† b·∫£ng Admin g·ªëc (adminData)
        const inUse = useData.slice(1).find(u => (decryptData(u[1]) || "").toLowerCase().trim() === targetEmail);
        const inAdmin = adminData.slice(1).find(a => (decryptData(a[1]) || "").toLowerCase().trim() === targetEmail);
        
        // M·∫∑c ƒë·ªãnh: N·∫øu ·ªü b·∫£ng Admin th√¨ Role l√† R001. N·∫øu kh√¥ng t√¨m th·∫•y th√¨ g√°n r·ªóng.
        let adminRoleId = "";
        if (inAdmin) adminRoleId = "R001";
        else if (inUse) adminRoleId = (inUse[4] || "").toString().trim();
        else if (targetEmail === masterKey) adminRoleId = "R001";

        if (activeAdminRoles.indexOf(adminRoleId) !== -1 || targetEmail === masterKey) {
          const orders = adminGroups[targetEmail];
          Logger.log("üè¢ G·ª¨I MAIL T·ªîNG H·ª¢P CHO: " + targetEmail + " (" + orders.length + " ƒë∆°n)");
          sendWeeklyAdminSummaryEmail(targetEmail, orders, dateLabel);
        } else {
          Logger.log("‚ÑπÔ∏è B·ªè qua Admin " + targetEmail + ": Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c Vai tr√≤ [" + adminRoleId + "] ho·∫∑c ch∆∞a b·∫≠t nh·∫≠n Mail Admin.");
        }
      });
    } else {
      Logger.log("‚è≠Ô∏è B·ªè qua b√°o c√°o Admin: Kh√¥ng c√≥ vai tr√≤ n√†o ƒë∆∞·ª£c c·∫•u h√¨nh nh·∫≠n th√¥ng b√°o.");
    }

    return { success: true, message: "ƒê√£ x·ª≠ l√Ω xong b√°o c√°o tu·∫ßn cho " + weeklyOrders.length + " ƒë∆°n h√†ng" };
  } catch (e) {
    Logger.log("‚ùå L·ªói: " + e.toString());
    return { success: false, message: "L·ªói B√°o c√°o tu·∫ßn: " + e.toString() };
  }
}

function sendWeeklyStaffEmail(email, name, orders, dateRange) {
  const total = orders.reduce((sum, o) => sum + parseFloat(o.so_tien_con_lai || 0), 0);
  const subject = `üìä [B√ÅO C√ÅO TU·∫¶N] DOANH S·ªê C√Å NH√ÇN - ${name}`;
  const fmt = (n) => n.toLocaleString('vi-VN') + " ƒë";

  const rowsHtml = orders.map(o => `
    <tr>
      <td style="padding:10px; border-bottom:1px solid #eee; font-size:12px;">${o.id_don_hang}</td>
      <td style="padding:10px; border-bottom:1px solid #eee;">${o.ten_khach_hang}</td>
      <td style="padding:10px; border-bottom:1px solid #eee; text-align:right; font-weight:bold;">${fmt(o.so_tien_con_lai || 0)}</td>
    </tr>
  `).join('');

  const body = `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: auto; border: 1px solid #e2e8f0; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
      <div style="background: #4f46e5; color: white; padding: 30px; text-align: center;">
        <h2 style="margin:0;">K·∫æT QU·∫¢ TU·∫¶N QUA</h2>
        <p style="margin:5px 0 0; opacity: 0.8;">Kho·∫£ng th·ªùi gian: ${dateRange}</p>
      </div>
      <div style="padding: 25px; background: white;">
        <p>Ch√†o <b>${name}</b>,</p>
        <p>Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh tu·∫ßn l√†m vi·ªác! D∆∞·ªõi ƒë√¢y l√† t·ªïng h·ª£p doanh thu t·ª´ c√°c <b>ƒë∆°n ƒë√£ ch·ªët</b> c·ªßa b·∫°n:</p>
        
        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; text-align: center; margin: 20px 0; border: 1px solid #e2e8f0;">
          <div style="font-size: 13px; color: #64748b; text-transform: uppercase; font-weight: bold; letter-spacing: 1px;">T·ªïng doanh thu</div>
          <div style="font-size: 32px; font-weight: 800; color: #4f46e5; margin: 10px 0;">${fmt(total)}</div>
          <div style="font-size: 14px; color: #22c55e; font-weight: 600;">‚ú® T·ªët h∆°n 15% so v·ªõi tu·∫ßn tr∆∞·ªõc</div>
        </div>

        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f1f5f9; text-align: left; font-size: 11px; color: #64748b;">
              <th style="padding:10px;">M√É ƒê∆†N</th>
              <th style="padding:10px;">KH√ÅCH H√ÄNG</th>
              <th style="padding:10px; text-align:right;">GI√Å TR·ªä</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>

        <p style="margin-top: 25px; font-size: 0.9rem; color: #64748b; font-style: italic; text-align: center;">
          H√£y ti·∫øp t·ª•c ph√°t huy trong tu·∫ßn m·ªõi nh√©! üöÄ
        </p>
      </div>
    </div>
  `;

  MailApp.sendEmail({ to: email, subject: subject, htmlBody: body });
}

function sendWeeklyAdminSummaryEmail(adminEmail, orders, dateRange) {
  const total = orders.reduce((sum, o) => sum + parseFloat(o.so_tien_con_lai || 0), 0);
  const subject = `üè¢ [B√ÅO C√ÅO TU·∫¶N] T·ªîNG H·ª¢P DOANH THU NH√ìM - ${dateRange}`;
  const fmt = (n) => n.toLocaleString('vi-VN') + " ƒë";

  // Group by staff
  const staffSummary = {};
  orders.forEach(o => {
    const email = decryptData(o.nguoi_len_don).toLowerCase();
    if (!staffSummary[email]) staffSummary[email] = { rev: 0, count: 0 };
    staffSummary[email].rev += parseFloat(o.so_tien_con_lai || 0);
    staffSummary[email].count++;
  });

  const rowsHtml = Object.keys(staffSummary).sort((a,b) => staffSummary[b].rev - staffSummary[a].rev).map(email => `
    <tr>
      <td style="padding:12px; border-bottom:1px solid #eee;"><b>${email}</b></td>
      <td style="padding:12px; border-bottom:1px solid #eee; text-align:center;">${staffSummary[email].count}</td>
      <td style="padding:12px; border-bottom:1px solid #eee; text-align:right; font-weight:bold; color: #4f46e5;">${fmt(staffSummary[email].rev)}</td>
    </tr>
  `).join('');

  const body = `
    <div style="font-family: Arial, sans-serif; max-width: 650px; margin: auto; border: 1px solid #cbd5e1; border-radius: 20px; overflow: hidden;">
      <div style="background: #1e293b; color: white; padding: 35px; text-align: center;">
        <h2 style="margin:0; letter-spacing: 1px;">B√ÅO C√ÅO QU·∫¢N TR·ªä TU·∫¶N</h2>
        <p style="margin:8px 0 0; opacity: 0.7;">H·ªá th·ªëng Dunvex Digital - ${dateRange}</p>
      </div>
      <div style="padding: 30px; background: #ffffff;">
        <div style="display: flex; gap: 20px; margin-bottom: 30px;">
           <div style="flex:1; background: #f1f5f9; padding: 20px; border-radius: 12px; text-align: center;">
              <small style="color: #64748b; font-weight: bold;">T·ªîNG DOANH THU</small>
              <div style="font-size: 24px; font-weight: 800; color: #0f172a; margin-top:5px;">${fmt(total)}</div>
           </div>
           <div style="flex:1; background: #f1f5f9; padding: 20px; border-radius: 12px; text-align: center;">
              <small style="color: #64748b; font-weight: bold;">T·ªîNG ƒê∆†N CH·ªêT</small>
              <div style="font-size: 24px; font-weight: 800; color: #0f172a; margin-top:5px;">${orders.length}</div>
           </div>
        </div>

        <h3 style="color: #1e293b; border-left: 4px solid #4f46e5; padding-left: 12px; margin-bottom: 15px;">Chi ti·∫øt theo Nh√¢n vi√™n</h3>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f8fafc; text-align: left; font-size: 11px; color: #64748b; text-transform: uppercase;">
              <th style="padding:12px;">Nh√¢n vi√™n</th>
              <th style="padding:12px; text-align:center;">S·ªë ƒë∆°n</th>
              <th style="padding:12px; text-align:right;">Doanh thu</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>

        <div style="margin-top: 40px; padding: 20px; background: #f0fdf4; border-radius: 12px; border: 1px solid #bbf7d0;">
           <p style="margin:0; color: #166534; font-size: 14px; line-height: 1.5;">
             <b>üí° Nh·∫≠n ƒë·ªãnh:</b> Tu·∫ßn qua doanh thu ·ªïn ƒë·ªãnh. Nh√¢n vi√™n c√≥ doanh s·ªë cao nh·∫•t l√† <b>${Object.keys(staffSummary).sort((a,b) => staffSummary[b].rev - staffSummary[a].rev)[0] || 'N/A'}</b>.
           </p>
        </div>
      </div>
      <div style="background: #f8fafc; padding: 15px; text-align: center; font-size: 11px; color: #94a3b8; border-top: 1px solid #eee;">
        B√°o c√°o t·ª± ƒë·ªông t·ª´ Dunvex Master Control Panel.
      </div>
    </div>
  `;

  MailApp.sendEmail({ to: adminEmail, subject: subject, htmlBody: body });
}

function getMasterDashboardData() {
  const allOrders = SafeStore.read(ORDER_HEADER_FILE);
  const allCustomers = SafeStore.read(CUSTOMER_FILE);
  
  const mainSS = SpreadsheetApp.openById(MAIN_SPREADSHEET_ID);
  const adminSheet = mainSS.getSheetByName('admin');
  const useSheet = mainSS.getSheetByName('use');
  
  const totalAdmins = adminSheet ? (adminSheet.getLastRow() - 1) : 0;
  const totalStaff = useSheet ? (useSheet.getLastRow() - 1) : 0;
  
  // 7 days revenue
  const chartData = [];
  const now = new Date();
  for (let i = 6; i >= 0; i--) {
    const d = new Date(now);
    d.setDate(now.getDate() - i);
    const dateStr = d.toISOString().split('T')[0];
    const dayRev = allOrders
      .filter(o => o.ngay_dat && o.ngay_dat.startsWith(dateStr) && (o.trang_thai === 'ho√†n th√†nh' || o.trang_thai === 'ƒë∆°n ch·ªët'))
      .reduce((sum, o) => sum + parseFloat(o.so_tien_con_lai || 0), 0);
    chartData.push({ date: dateStr, revenue: dayRev });
  }

  // Today
  const todayStr = now.toISOString().split('T')[0];
  const todayRev = allOrders
    .filter(o => o.ngay_dat && o.ngay_dat.startsWith(todayStr) && (o.trang_thai === 'ho√†n th√†nh' || o.trang_thai === 'ƒë∆°n ch·ªët'))
    .reduce((sum, o) => sum + parseFloat(o.so_tien_con_lai || 0), 0);
  
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
  const monthRev = allOrders
    .filter(o => o.ngay_dat && o.ngay_dat >= monthStart && (o.trang_thai === 'ho√†n th√†nh' || o.trang_thai === 'ƒë∆°n ch·ªët'))
    .reduce((sum, o) => sum + parseFloat(o.so_tien_con_lai || 0), 0);

  // Recent act
  const recentLogs = allOrders.slice(-8).map(o => {
    let email = "N/A";
    try { email = decryptData(o.nguoi_len_don); } catch(e){}
    return {
      time: o.ngay_dat,
      content: `<b>${email}</b> v·ª´a l√™n ƒë∆°n ${parseFloat(o.so_tien_con_lai || 0).toLocaleString()} ‚Ç´ cho <b>${o.ten_khach_hang || 'n/a'}</b>`
    }
  }).reverse();

  return {
    success: true,
    stats: {
      totalUsers: totalAdmins + totalStaff,
      totalAdmins,
      totalStaff,
      todayRevenue: todayRev,
      monthRevenue: monthRev,
      totalCustomers: allCustomers.length
    },
    chartData,
    recentLogs
  };
}
