<!DOCTYPE html>
<html lang="vi">

<head>
	<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-QFQ2HMYTDH"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push(arguments); }
		gtag('js', new Date());

		gtag('config', 'G-QFQ2HMYTDH');
	</script>

	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Master Dashboard | Dunvex Digital</title>
	<link rel="icon" type="image/svg+xml"
		href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23FACC15'/><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' fill='white' font-size='60' font-family='sans-serif' font-weight='800'>DV</text></svg>">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@600;800&display=swap"
		rel="stylesheet">
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="security-utils.js"></script>
	<script>
		// Special access validation for Master Dashboard
		const session = SecurityProvider.validateAccess();
		const currentUser = session ? session.user : null;
		if (currentUser && currentUser.email !== 'dunvex.green@gmail.com') {
			window.location.href = 'index.html';
		}
	</script>
	<link rel="stylesheet" href="assets/theme.css">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
			text-rendering: optimizeLegibility;
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
		}

		body {
			background-color: var(--bg-body);
			color: var(--text-main);
			min-height: 100vh;
			overflow-x: hidden;
			background-image: var(--bg-gradient-1), var(--bg-gradient-2);
			background-attachment: fixed;
			padding: 20px;
		}

		.container {
			max-width: 1400px;
			margin: 0 auto;
		}

		/* Standardized Header */
		.header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
			padding: 24px 30px;
			background: white;
			border: 1px solid var(--glass-border);
			border-radius: 24px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
		}

		.logo-area h1 {
			font-size: 2.2rem;
			font-weight: 800;
			color: #0f172a;
			letter-spacing: -1px;
			font-family: 'Outfit', sans-serif;
		}

		.logo-area p {
			color: var(--text-muted);
			font-size: 0.9rem;
		}

		.header-actions {
			display: flex;
			gap: 12px;
			align-items: center;
		}

		.user-pill {
			display: flex;
			align-items: center;
			gap: 12px;
			background: #f8fafc;
			padding: 6px 16px 6px 6px;
			border-radius: 50px;
			border: 1px solid #e2e8f0;
		}

		.avatar {
			width: 36px;
			height: 36px;
			background: var(--primary);
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 800;
			color: #0f172a;
			font-size: 0.9rem;
			box-shadow: 0 2px 8px rgba(250, 204, 21, 0.3);
		}

		.btn {
			padding: 12px 24px;
			border-radius: 12px;
			border: none;
			font-weight: 800;
			cursor: pointer;
			transition: all 0.3s;
			display: flex;
			align-items: center;
			gap: 8px;
			text-decoration: none;
			font-size: 0.95rem;
		}

		.btn-glass {
			background: white;
			color: #0f172a;
			border: 2px solid var(--primary);
		}

		.btn-glass:hover {
			background: #fefce8;
			transform: translateY(-2px);
		}

		.btn-logout {
			background: rgba(239, 68, 68, 0.1);
			color: #ef4444;
			width: 36px;
			height: 36px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			border: none;
			cursor: pointer;
			transition: all 0.2s;
		}

		.btn-logout:hover {
			background: #ef4444;
			color: white;
			transform: scale(1.1);
		}

		/* Stats Grid */
		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}

		.stat-card {
			background: white;
			border: 1px solid var(--glass-border);
			padding: 24px;
			border-radius: 24px;
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			position: relative;
			overflow: hidden;
		}

		.stat-card:hover {
			transform: translateY(-5px);
			border-color: var(--primary);
			box-shadow: 0 12px 25px -5px rgba(0, 0, 0, 0.1);
		}

		.stat-card i {
			font-size: 1.5rem;
			margin-bottom: 15px;
			display: block;
			color: var(--primary);
		}

		.stat-card .label {
			color: var(--text-muted);
			font-size: 0.8rem;
			font-weight: 700;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			margin-bottom: 5px;
		}

		.stat-card .value {
			font-size: 1.8rem;
			font-weight: 800;
			color: #0f172a;
		}

		/* Dashboard Main Layout */
		.main-layout {
			display: grid;
			grid-template-columns: 2fr 1fr;
			gap: 25px;
		}

		.card {
			background: white;
			border: 1px solid var(--glass-border);
			border-radius: 30px;
			padding: 30px;
			box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
		}

		.card-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 25px;
		}

		.card-title {
			font-size: 1.2rem;
			font-weight: 800;
			color: #0f172a;
			font-family: 'Outfit', sans-serif;
		}

		.chart-container {
			height: 350px;
		}

		/* Activity Logs */
		.log-list {
			list-style: none;
		}

		.log-item {
			display: flex;
			gap: 15px;
			padding: 15px 0;
			border-bottom: 1px solid #f1f5f9;
		}

		.log-item:last-child {
			border-bottom: none;
		}

		.log-icon {
			width: 40px;
			height: 40px;
			border-radius: 12px;
			background: #fefce8;
			display: flex;
			align-items: center;
			justify-content: center;
			color: var(--primary);
			flex-shrink: 0;
			font-size: 1.2rem;
		}

		.log-content {
			font-size: 0.95rem;
			color: #334155;
			font-weight: 500;
		}

		.log-time {
			font-size: 0.8rem;
			color: #94a3b8;
			margin-top: 4px;
		}

		/* Quick Actions */
		.quick-actions {
			display: flex;
			flex-direction: column;
			gap: 12px;
			margin-top: 25px;
		}

		.action-btn {
			display: flex;
			align-items: center;
			justify-content: space-between;
			background: #f8fafc;
			border: 1.5px solid #e2e8f0;
			padding: 16px 20px;
			border-radius: 16px;
			text-decoration: none;
			color: #334155;
			font-weight: 700;
			transition: all 0.3s;
		}

		.action-btn:hover {
			background: white;
			border-color: var(--primary);
			color: #0f172a;
			transform: translateX(5px);
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
		}

		.action-btn i.fa-chevron-right {
			font-size: 0.8rem;
			color: #94a3b8;
			transition: transform 0.3s;
		}

		.action-btn:hover i.fa-chevron-right {
			transform: translateX(3px);
			color: var(--primary);
		}

		/* Standard Loader */
		#loader {
			position: fixed;
			inset: 0;
			background: white;
			z-index: 9999;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.spinner {
			width: 50px;
			height: 50px;
			border: 5px solid #f3f3f3;
			border-top: 5px solid var(--primary);
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		@media (max-width: 1024px) {
			.main-layout {
				grid-template-columns: 1fr;
			}
		}

		@media (max-width: 768px) {
			.header {
				flex-direction: column;
				gap: 20px;
				padding: 20px;
				text-align: center;
			}

			.logo-area h1 {
				font-size: 1.8rem;
			}

			.stats-grid {
				grid-template-columns: 1fr 1fr;
				gap: 12px;
			}

			.stat-card {
				padding: 16px;
			}

			.stat-card .value {
				font-size: 1.4rem;
			}
		}
	</style>
</head>

<body>
	<div id="loader">
		<div class="spinner"></div>
	</div>

	<div class="container">
		<div class="header">
			<div class="logo-area">
				<h1>MASTER HUB</h1>
				<p>Ch√†o m·ª´ng tr·ªü l·∫°i, Super Admin</p>
			</div>
			<div class="header-actions">
				<a href="index.html" class="btn btn-glass">
					<i class="fa-solid fa-house"></i> Trang ch·ªß
				</a>
				<div class="user-pill">
					<div class="avatar" id="avatarLetter">D</div>
					<div style="font-size: 0.95rem; font-weight: 700; color: #1e293b;" id="adminName">Super Admin</div>
					<button onclick="logout()" class="btn-logout" title="ƒêƒÉng xu·∫•t">
						<i class="fas fa-sign-out-alt"></i>
					</button>
				</div>
			</div>
		</div>

		<div class="stats-grid">
			<div class="stat-card">
				<i class="fas fa-users-gear" style="color: var(--primary);"></i>
				<div class="label">T·ªïng Users H·ªá Th·ªëng</div>
				<div class="value" id="stat-users">0</div>
				<div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 5px;" id="stat-sub-users">Admin: 0
					| Staff: 0</div>
			</div>
			<div class="stat-card">
				<i class="fas fa-chart-line" style="color: var(--success);"></i>
				<div class="label">Doanh Thu H√¥m Nay</div>
				<div class="value" id="stat-revenue-today">0 ‚Ç´</div>
			</div>
			<div class="stat-card">
				<i class="fas fa-wallet" style="color: var(--secondary);"></i>
				<div class="label">Doanh Thu Th√°ng N√†y</div>
				<div class="value" id="stat-revenue-month">0 ‚Ç´</div>
			</div>
			<div class="stat-card">
				<i class="fas fa-briefcase" style="color: var(--warning);"></i>
				<div class="label">Kh√°ch H√†ng To√†n H·ªá Th·ªëng</div>
				<div class="value" id="stat-customers">0</div>
			</div>
		</div>

		<div class="main-layout">
			<div class="card">
				<div class="card-header">
					<div class="card-title">TƒÉng Tr∆∞·ªüng Doanh Thu (7 ng√†y g·∫ßn nh·∫•t)</div>
					<i class="fas fa-ellipsis-h" style="color: var(--text-muted); cursor: pointer;"></i>
				</div>
				<div class="chart-container">
					<canvas id="revenueChart"></canvas>
				</div>
			</div>

			<div class="card">
				<div class="card-header">
					<div class="card-title">Ho·∫°t ƒê·ªông H·ªá Th·ªëng</div>
				</div>
				<ul class="log-list" id="activityList">
					<!-- Logs injection -->
				</ul>
				<div class="quick-actions">
					<a href="super-admin.html" class="action-btn">
						<span>üõ°Ô∏è V√†o Master Control</span>
						<i class="fas fa-chevron-right"></i>
					</a>
					<a href="admin-checkin-summary.html" class="action-btn">
						<span>üìç Theo d√µi Check-in</span>
						<i class="fas fa-chevron-right"></i>
					</a>
				</div>
			</div>
		</div>
	</div>

	<!-- Floating Menu script handle separately if needed -->
	<script src="floating-menu.js"></script>

	<script>
		const MASTER_API = 'https://script.google.com/macros/s/AKfycbz2FpV9hWeZKzBJyS636Hlf7JrM8bfA03YbH9xF3KYqdHJXcpgvCLoD2xjOGCDKzpfj/exec';
		let chart = null;

		window.onload = async () => {
			document.getElementById('adminName').innerText = currentUser ? currentUser.fullName : 'Super Admin';
			document.getElementById('avatarLetter').innerText = currentUser ? currentUser.fullName.charAt(0).toUpperCase() : 'D';

			await loadDashboardData();
			document.getElementById('loader').style.display = 'none';
		};

		async function loadDashboardData() {
			try {
				const res = await fetch(MASTER_API, {
					method: 'POST',
					body: SecurityProvider.prepareRequest('getMasterDashboardData', {})
				});
				const data = await res.json();
				if (data.success) {
					updateUI(data);
				}
			} catch (e) {
				console.error("Master Load error", e);
			}
		}

		function updateUI(data) {
			const { stats, chartData, recentLogs } = data;

			// Update Stats
			document.getElementById('stat-users').innerText = stats.totalUsers;
			document.getElementById('stat-sub-users').innerText = `Admin: ${stats.totalAdmins} | Staff: ${stats.totalStaff}`;
			document.getElementById('stat-revenue-today').innerText = stats.todayRevenue.toLocaleString() + ' ‚Ç´';
			document.getElementById('stat-revenue-month').innerText = stats.monthRevenue.toLocaleString() + ' ‚Ç´';
			document.getElementById('stat-customers').innerText = stats.totalCustomers;

			// Update Logs
			const logTbody = document.getElementById('activityList');
			if (recentLogs && recentLogs.length > 0) {
				logTbody.innerHTML = recentLogs.map(l => `
                    <li class="log-item">
                        <div class="log-icon"><i class="fas fa-receipt"></i></div>
                        <div class="log-content">
                            <div>${l.content}</div>
                            <div class="log-time">${new Date(l.time).toLocaleTimeString('vi-VN')} - ${new Date(l.time).toLocaleDateString('vi-VN')}</div>
                        </div>
                    </li>
                `).join('');
			} else {
				logTbody.innerHTML = '<li style="color:var(--text-muted); text-align:center; padding:20px;">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o h√¥m nay.</li>';
			}

			// Render Chart
			renderChart(chartData);
		}

		function renderChart(chartData) {
			const ctx = document.getElementById('revenueChart').getContext('2d');
			const labels = chartData.map(d => {
				const parts = d.date.split('-');
				return `${parts[2]}/${parts[1]}`;
			});
			const values = chartData.map(d => d.revenue);

			if (chart) chart.destroy();

			chart = new Chart(ctx, {
				type: 'line',
				data: {
					labels: labels,
					datasets: [{
						label: 'Doanh Thu (‚Ç´)',
						data: values,
						borderColor: '#FACC15',
						backgroundColor: (context) => {
							const chart = context.chart;
							const { ctx, chartArea } = chart;
							if (!chartArea) return null;
							const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
							gradient.addColorStop(0, 'rgba(250, 204, 21, 0)');
							gradient.addColorStop(1, 'rgba(250, 204, 21, 0.2)');
							return gradient;
						},
						fill: true,
						tension: 0.4,
						borderWidth: 4,
						pointBackgroundColor: '#fff',
						pointBorderColor: '#FACC15',
						pointBorderWidth: 2,
						pointHoverRadius: 7,
						pointHoverBackgroundColor: '#FACC15',
						pointHoverBorderColor: '#fff',
						pointHoverBorderWidth: 2,
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						legend: { display: false }
					},
					scales: {
						y: {
							beginAtZero: true,
							grid: { color: 'rgba(255,255,255,0.05)' },
							ticks: { color: '#94a3b8', font: { size: 10 } }
						},
						x: {
							grid: { display: false },
							ticks: { color: '#94a3b8', font: { size: 10 } }
						}
					}
				}
			});
		}

		function logout() {
			if (confirm("X√°c nh·∫≠n ƒëƒÉng xu·∫•t?")) {
				SecurityProvider.logout();
			}
		}
	</script>
</body>

</html>