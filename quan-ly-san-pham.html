<!DOCTYPE html>
<html lang="vi">

<head>
	<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-QFQ2HMYTDH"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push(arguments); }
		gtag('js', new Date());

		gtag('config', 'G-QFQ2HMYTDH');
	</script>

	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Qu·∫£n l√Ω S·∫£n ph·∫©m | Dunvex Digital</title>
	<link rel="icon" type="image/svg+xml"
		href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23FACC15'/><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' fill='white' font-size='60' font-family='sans-serif' font-weight='800'>DV</text></svg>">
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@600;800&display=swap"
		rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script src="security-utils.js"></script>
	<script src="assets/theme-toggle.js"></script>
	<script>
		const session = SecurityProvider.validateAccess();
		const currentUser = session ? session.user : null;
	</script>
	<link rel="stylesheet" href="assets/theme.css">

	<style>
		/* Variables handled in theme.css */


		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
			text-rendering: optimizeLegibility;
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
			font-weight: 500;
		}

		body {
			background-color: var(--bg-body);
			color: var(--text-main);
			min-height: 100vh;
			padding: 20px;
			-webkit-text-size-adjust: 100%;
			background-image: var(--bg-gradient-1), var(--bg-gradient-2);
			background-attachment: fixed;
		}

		.container {
			max-width: 1100px;
			margin: 0 auto;
		}

		/* Top Bar */
		.top-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
			padding: 20px 0;
		}

		.top-bar h1 {
			font-size: 2.2rem;
			font-family: 'Outfit', sans-serif;
			font-weight: 800;
			color: #0f172a;
			letter-spacing: -0.5px;
		}

		.actions {
			display: flex;
			gap: 15px;
		}

		/* Buttons */
		.btn {
			padding: 12px 24px;
			border-radius: 12px;
			font-weight: 700;
			cursor: pointer;
			transition: 0.3s;
			border: 1px solid var(--glass-border);
			display: flex;
			align-items: center;
			gap: 8px;
			text-decoration: none;
			font-size: 0.95rem;
		}

		.btn-primary {
			background: var(--primary);
			color: #0f172a;
			border: none;
			box-shadow: 0 4px 12px rgba(250, 204, 21, 0.3);
		}

		.btn-primary:hover {
			background: #facc15;
			transform: translateY(-2px);
			box-shadow: 0 8px 20px rgba(250, 204, 21, 0.4);
		}

		.btn-glass {
			background: white;
			color: #0f172a;
			border: 2px solid var(--primary);
		}

		.btn-glass:hover {
			background: #fefce8;
			transform: translateY(-2px);
		}

		/* Tab Header */
		.main-tabs {
			display: flex;
			gap: 15px;
			margin-bottom: 25px;
			border-bottom: 2px solid var(--glass-border);
			padding-bottom: 10px;
		}

		.main-tab {
			padding: 12px 30px;
			cursor: pointer;
			font-weight: 800;
			color: #64748b;
			transition: 0.3s;
			position: relative;
			background: transparent;
			border: none;
			outline: none;
			font-size: 1.05rem;
		}

		.main-tab.active {
			color: #0f172a;
		}

		.main-tab.active::after {
			content: '';
			position: absolute;
			bottom: -12px;
			left: 0;
			width: 100%;
			height: 4px;
			background: var(--primary);
			border-radius: 4px;
		}

		/* Search Box */
		.search-box {
			position: relative;
			flex: 1;
			max-width: 400px;
		}

		.search-box input {
			width: 100%;
			padding: 14px 15px 14px 45px;
			background: white !important;
			border: 2px solid #cbd5e1;
			border-radius: 12px;
			color: #0f172a;
			outline: none;
			font-weight: 600;
		}

		.search-box input:focus {
			border-color: var(--primary);
			box-shadow: 0 0 0 4px rgba(250, 204, 21, 0.15);
		}

		/* Product Grid */
		.product-grid {
			display: grid;
			grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
			gap: 30px;
		}

		.product-card {
			background: white;
			border: 1px solid var(--glass-border);
			border-radius: 24px;
			overflow: hidden;
			transition: 0.3s;
			position: relative;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
		}

		.product-card:hover {
			transform: translateY(-8px);
			border-color: var(--primary);
			box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
		}

		.image-container {
			width: 100%;
			height: 220px;
			background: #f8fafc;
			display: flex;
			align-items: center;
			justify-content: center;
			overflow: hidden;
			border-bottom: 2px solid #f1f5f9;
		}

		.image-container img {
			width: 100%;
			height: 100%;
			object-fit: contain;
			/* Better for product photos */
			padding: 10px;
		}

		.product-info {
			padding: 24px;
		}

		.product-category {
			font-size: 0.8rem;
			color: #854d0e;
			text-transform: uppercase;
			font-weight: 800;
			margin-bottom: 8px;
			background: rgba(250, 204, 21, 0.15);
			padding: 4px 10px;
			border-radius: 6px;
			width: fit-content;
		}

		.product-title {
			font-size: 1.2rem;
			font-weight: 800;
			margin-bottom: 15px;
			color: #0f172a;
		}

		.product-meta {
			display: grid;
			grid-template-columns: 1fr;
			gap: 8px;
			font-size: 0.95rem;
			color: #334155;
			margin-bottom: 24px;
			font-weight: 600;
		}

		.product-price {
			font-size: 1.4rem;
			font-weight: 900;
			color: #1e293b;
			letter-spacing: -0.5px;
		}

		.card-actions {
			display: flex;
			gap: 10px;
		}

		.card-actions button {
			flex: 1;
			padding: 10px;
			font-size: 0.85rem;
			font-weight: 700;
		}

		/* Modal */
		.modal {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			backdrop-filter: blur(5px);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 1000;
			padding: 20px;
		}

		.modal.active {
			display: flex;
		}

		.modal-content {
			background: white;
			width: 100%;
			max-width: 650px;
			border-radius: 28px;
			padding: 40px;
			position: relative;
			max-height: 90vh;
			overflow-y: auto;
			border: 1px solid var(--glass-border);
			box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
		}

		.form-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 15px;
		}

		.full-width {
			grid-column: span 2;
		}

		.form-group {
			margin-bottom: 20px;
		}

		label {
			display: block;
			font-size: 0.85rem;
			color: #475569;
			margin-bottom: 8px;
			text-transform: uppercase;
			font-weight: 800;
		}

		input,
		select {
			width: 100%;
			padding: 14px;
			background: white !important;
			border: 2px solid #cbd5e1 !important;
			border-radius: 12px;
			color: #0f172a !important;
			outline: none;
			font-weight: 600;
		}

		.image-upload-preview {
			width: 100px;
			height: 100px;
			background: #f8fafc;
			border-radius: 10px;
			margin-bottom: 10px;
			display: flex;
			align-items: center;
			justify-content: center;
			overflow: hidden;
			border: 2px dashed #e2e8f0;
		}

		.image-upload-preview img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		/* Toast */
		#toast {
			position: fixed;
			bottom: 30px;
			right: 30px;
			padding: 15px 25px;
			border-radius: 12px;
			background: var(--success);
			color: white;
			font-weight: 600;
			transform: translateY(150%);
			transition: 0.4s;
			z-index: 2000;
		}

		#toast.active {
			transform: translateY(0);
		}

		.loader {
			display: none;
			text-align: center;
			padding: 50px;
			font-size: 1.2rem;
			color: var(--text-muted);
		}

		/* Detail Modal (Iframe) */
		#viewModal .modal-content {
			max-width: 900px;
			padding: 0;
			overflow: hidden;
			background: transparent;
			height: 80vh;
		}

		#viewModal iframe {
			width: 100%;
			height: 100%;
			border: none;
			border-radius: 24px;
		}

		.close-view {
			position: absolute;
			top: 15px;
			right: 15px;
			background: rgba(0, 0, 0, 0.5);
			color: white;
			border: 1px solid var(--glass-border);
			width: 36px;
			height: 36px;
			border-radius: 50%;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 1010;
		}

		/* Custom Select Searchable Style */
		.searchable-select-container {
			position: relative;
		}

		.search-results {
			position: absolute;
			top: 100%;
			left: 0;
			width: 100%;
			background: var(--card-bg);
			border: 1px solid var(--glass-border);
			border-top: none;
			border-radius: 0 0 10px 10px;
			max-height: 200px;
			overflow-y: auto;
			z-index: 10;
			display: none;
		}

		.search-results div {
			padding: 10px;
			cursor: pointer;
			border-bottom: 1px solid var(--glass-border);
			color: var(--text-main);
		}

		.search-results div:hover {
			background: rgba(var(--primary), 0.1);
		}

		.search-results.active {
			display: block;
		}
	</style>
</head>

<body>

	<div id="toast">Th√¥ng b√°o!</div>

	<div class="container">
		<div class="top-bar">
			<div>
				<h1>üì¶ Shop Manager</h1>
				<p id="userStatus" style="color: var(--text-muted); font-size: 0.9rem;">ƒêang ƒëƒÉng nh·∫≠p: ...</p>
			</div>
			<div class="actions">
				<button class="btn btn-primary" onclick="openModal()">+ Th√™m S·∫£n Ph·∫©m</button>
				<a href="index.html" class="btn btn-glass">
					<i class="fa-solid fa-house"></i> Trang ch·ªß
				</a>
			</div>
		</div>

		<!-- Main Tabs -->
		<div class="main-tabs">
			<button class="main-tab active" onclick="switchTab('sales')">S·∫£n ph·∫©m b√°n ra</button>
			<button class="main-tab" onclick="switchTab('purchase')">S·∫£n ph·∫©m mua v√†o</button>
		</div>

		<div style="margin-bottom: 30px;">
			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
				<div class="search-box">
					<input type="text" id="searchInput" placeholder="T√¨m ki·∫øm trong danh m·ª•c c·ªßa b·∫°n..."
						oninput="applyFilters()">
				</div>
				<p id="stats" style="color: var(--text-muted); font-size: 0.9rem;">ƒêang t·∫£i...</p>
			</div>
		</div>

		<div id="loading" class="loader">üöÄ ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Drive...</div>
		<div id="productGrid" class="product-grid"></div>
	</div>

	<!-- VIEW DETAIL MODAL -->
	<div id="viewModal" class="modal">
		<div class="modal-content">
			<button class="close-view" onclick="closeViewModal()">&times;</button>
			<iframe src="" id="viewIframe"></iframe>
		</div>
	</div>

	<!-- MODAL FORM -->
	<div id="productModal" class="modal">
		<div class="modal-content">
			<h2 id="modalTitle" style="margin-bottom: 25px;">Th√™m S·∫£n Ph·∫©m M·ªõi</h2>
			<form id="productForm">
				<input type="hidden" id="edit_id">
				<div class="form-group">
					<label>·∫¢nh s·∫£n ph·∫©m</label>
					<div class="image-upload-preview" id="previewContainer">
						<img src="" id="imgPreview" style="display:none;">
						<span id="previewLabel">Ch∆∞a c√≥ ·∫£nh</span>
					</div>
					<input type="file" id="file_loader_anh" accept="image/*" onchange="previewImage(this)">
				</div>

				<div class="form-grid">
					<!-- Special Searchable Input for Purchase Type -->
					<div class="form-group full-width" id="nameInputGroup">
						<label id="nameLabel">T√™n S·∫£n Ph·∫©m *</label>
						<div class="searchable-select-container">
							<input type="text" id="ten_san_pham" required placeholder="T√™n s·∫£n ph·∫©m..."
								autocomplete="off">
							<div id="selectSearchResults" class="search-results"></div>
						</div>
					</div>

					<div class="form-group">
						<label>ID s·∫£n ph·∫©m (Auto)</label>
						<input type="text" id="id_san_pham_display" readonly placeholder="S000">
					</div>

					<div class="form-group">
						<label>Ng√†nh H√†ng</label>
						<input type="text" id="ten_nghanh_hang" list="categoryList" placeholder="Pima, Duraflex...">
						<datalist id="categoryList"></datalist>
					</div>
					<div class="form-group">
						<label id="priceLabel">Gi√° (VNƒê) *</label>
						<input type="number" id="gia_san_pham" required placeholder="0">
					</div>
					<div class="form-group">
						<label>Quy c√°ch</label>
						<input type="text" id="quy_cach" placeholder="1220x2440...">
					</div>
					<div class="form-group">
						<label>ƒê√≥ng ki·ªán</label>
						<input type="text" id="dong_kien" placeholder="V√≠ d·ª•: 20">
					</div>
					<div class="form-group">
						<label>Tr·ªçng l∆∞·ª£ng ri√™ng (kg)</label>
						<input type="text" id="trong_luong_rieng" placeholder="V√≠ d·ª•: 2.2 ho·∫∑c 2,2">
					</div>
				</div>

				<div style="display: flex; gap: 15px; margin-top: 20px;">
					<button type="submit" class="btn btn-primary" style="flex:2" id="btnSave">L∆ØU S·∫¢N PH·∫®M</button>
					<button type="button" class="btn btn-glass" style="flex:1" onclick="closeModal()">H·ª¶Y</button>
				</div>
			</form>
		</div>
	</div>

	<script>
		// C·∫§U H√åNH URL SCRIPT
		const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw-iU2IYU1yHpybQ308SsY8QWJfp-zxJ9oZSfFJniREfctsbhCLy_7Rc-Ns0CFM8xDehg/exec';

		let allProducts = [];
		let allPurchaseProducts = [];
		let currentTab = 'sales'; // 'sales' or 'purchase'
		// currentUser is already defined in the head script

		// 1. T·∫£i d·ªØ li·ªáu
		async function loadData() {
			document.getElementById('loading').style.display = 'block';
			try {
				const [salesRes, purchaseRes] = await Promise.all([
					fetch(SCRIPT_URL, {
						method: 'POST',
						body: SecurityProvider.prepareRequest('get_products', {
							userEmail: currentUser.email,
							isAdmin: currentUser.roleId === 'R001',
							adminEmail: currentUser.adminEmail
						})
					}),
					fetch(SCRIPT_URL, {
						method: 'POST',
						body: SecurityProvider.prepareRequest('get_purchase_products', {
							userEmail: currentUser.email,
							isAdmin: currentUser.roleId === 'R001',
							adminEmail: currentUser.adminEmail
						})
					})
				]);

				const salesData = await salesRes.json();
				const purchaseData = await purchaseRes.json();

				if (salesData.success) {
					allProducts = salesData.products;
				}
				if (purchaseData.success) {
					allPurchaseProducts = purchaseData.products;
				}

				// FIX: Save ALL products to local storage for Detail View lookup
				const combinedForCache = [...allProducts, ...allPurchaseProducts];
				localStorage.setItem('last_loaded_products', JSON.stringify(combinedForCache));

				// C·∫≠p nh·∫≠t datalist ng√†nh h√†ng
				const cats = [...new Set(combinedForCache.map(p => p.ten_nghanh_hang || ''))].filter(c => c).sort();
				const dl = document.getElementById('categoryList');
				if (dl) {
					dl.innerHTML = cats.map(c => `<option value="${c}">`).join('');
				}

				applyFilters();
			} catch (e) {
				console.error(e);
				showToast("Kh√¥ng th·ªÉ k·∫øt n·ªëi Backend", true);
			}
			document.getElementById('loading').style.display = 'none';

			const roleName = currentUser.roleId === 'R001' ? 'Qu·∫£n tr·ªã vi√™n' : 'Nh√¢n vi√™n';
			document.getElementById('userStatus').innerText = `${roleName}: ${currentUser.email}`;
		}

		function switchTab(tab) {
			currentTab = tab;
			document.querySelectorAll('.main-tab').forEach(t => {
				t.classList.toggle('active', t.innerText.toLowerCase().includes(tab === 'sales' ? 'b√°n' : 'mua'));
			});
			applyFilters();
		}

		// 2. Hi·ªÉn th·ªã danh s√°ch
		function renderProducts(products) {
			const grid = document.getElementById('productGrid');
			grid.innerHTML = products.map(p => `
                <div class="product-card">
                    <div class="image-container">
                        <img src="${convertDriveLink(p.image_san_pham) || 'https://placehold.co/300x200/1e293b/white?text=No+Image'}" 
                             onerror="this.src='https://placehold.co/300x200/1e293b/white?text=Error'">
                    </div>
                    <div class="product-info">
                        <div class="product-category">${p.ten_nghanh_hang || 'S·∫¢N PH·∫®M'}</div>
                        <div class="product-title" title="${p.ten_san_pham}">${p.ten_san_pham}</div>
                        <div class="product-meta">
                            <span>Quy c√°ch: ${p.quy_cach || '-'}</span>
                            <span>ƒê√≥ng ki·ªán: ${p.dong_kien || '-'}</span>
                            <span>Tr·ªçng l∆∞·ª£ng: ${p.trong_luong_rieng || '-'} kg</span>
                            <span class="full-width" style="grid-column: span 1; color: var(--accent-purple); font-size: 0.75rem;">üë§ Ng∆∞·ªùi t·∫°o: ${p.ten_dang_nhap ? p.ten_dang_nhap.split('@')[0] : 'H·ªá th·ªëng'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:15px;">
                            <div class="product-price">${formatPrice(p.gia_san_pham)} ƒë</div>
                            <span style="font-size: 0.7rem; color: var(--text-muted)">ID: ${p.id_san_pham}</span>
                        </div>
                        <div class="card-actions">
                            <button class="btn btn-primary" onclick="viewProductDetail('${p.id_san_pham}')">XEM</button>
                            <button class="btn btn-glass" onclick="editProduct('${p.id_san_pham}')">S·ª¨A</button>
                            <button class="btn btn-glass" style="color: var(--danger)" onclick="deleteProduct('${p.id_san_pham}')">X√ìA</button>
                        </div>
                    </div>
                </div>
            `).join('');
		}

		function convertDriveLink(url) {
			if (!url) return '';
			if (url.includes('drive.google.com')) {
				const id = url.split('/d/')[1]?.split('/')[0] || url.split('id=')[1]?.split('&')[0];
				return id ? `https://lh3.googleusercontent.com/d/${id}` : url;
			}
			return url;
		}

		// Searchable Logic for Purchase Modal
		const nameInput = document.getElementById('ten_san_pham');
		const searchResults = document.getElementById('selectSearchResults');

		nameInput.addEventListener('input', () => {
			if (currentTab !== 'purchase') return;
			const query = nameInput.value.toLowerCase();
			if (!query) {
				searchResults.classList.remove('active');
				return;
			}
			const matches = allProducts.filter(p => p.ten_san_pham.toLowerCase().includes(query));
			if (matches.length > 0) {
				searchResults.innerHTML = matches.map(p => `
					<div onclick="selectPurchaseProduct('${p.ten_san_pham}', '${p.id_san_pham}')">
						<b>${p.ten_san_pham}</b> <span style="font-size:0.75rem">(${p.id_san_pham})</span>
					</div>
				`).join('');
				searchResults.classList.add('active');
			} else {
				searchResults.classList.remove('active');
			}
		});

		function selectPurchaseProduct(name, id) {
			const p = allProducts.find(x => x.id_san_pham === id);
			if (!p) return;

			nameInput.value = p.ten_san_pham;
			document.getElementById('id_san_pham_display').value = p.id_san_pham;
			document.getElementById('edit_id').value = p.id_san_pham;

			// Auto fill based on sales product data
			document.getElementById('ten_nghanh_hang').value = p.ten_nghanh_hang || '';
			document.getElementById('quy_cach').value = p.quy_cach || '';
			document.getElementById('dong_kien').value = p.dong_kien || '';
			document.getElementById('trong_luong_rieng').value = p.trong_luong_rieng || '';

			// Show image preview
			if (p.image_san_pham) {
				const imgUrl = convertDriveLink(p.image_san_pham);
				document.getElementById('imgPreview').src = imgUrl;
				document.getElementById('imgPreview').style.display = 'block';
				document.getElementById('previewLabel').style.display = 'none';
				// Store the image URL to preserve it if not changed
				nameInput.dataset.autoImage = p.image_san_pham;
			}

			searchResults.classList.remove('active');
		}

		// Hide search results when clicking outside
		document.addEventListener('click', (e) => {
			if (!e.target.closest('.searchable-select-container')) {
				searchResults.classList.remove('active');
			}
		});

		// 3. X·ª≠ l√Ω Form L∆∞u
		document.getElementById('productForm').onsubmit = async (e) => {
			e.preventDefault();
			const btn = document.getElementById('btnSave');
			btn.disabled = true;
			btn.innerText = "ƒêANG X·ª¨ L√ù...";

			const id = document.getElementById('edit_id').value;
			const fileInput = document.getElementById('file_loader_anh');

			let imageData = null;
			if (fileInput.files[0]) {
				imageData = {
					filename: fileInput.files[0].name,
					mimetype: fileInput.files[0].type,
					base64: await fileToBase64(fileInput.files[0])
				};
			}

			const product = {
				id_san_pham: id,
				ten_san_pham: nameInput.value,
				ten_nghanh_hang: document.getElementById('ten_nghanh_hang').value,
				gia_san_pham: document.getElementById('gia_san_pham').value,
				quy_cach: document.getElementById('quy_cach').value,
				dong_kien: document.getElementById('dong_kien').value,
				trong_luong_rieng: document.getElementById('trong_luong_rieng').value.replace(',', '.'),
				ten_dang_nhap: currentUser.email,
				adminEmail: currentUser.adminEmail,
				image_san_pham: (function () {
					const existing = id ? (currentTab === 'sales' ? allProducts : allPurchaseProducts).find(p => p.id_san_pham === id) : null;
					if (existing) return existing.image_san_pham;
					return nameInput.dataset.autoImage || "";
				})()
			};

			const action = currentTab === 'sales' ? 'save_product' : 'save_purchase_product';

			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest(action, {
						product: product,
						image_data: imageData
					})
				});
				const data = await response.json();
				if (data.success) {
					showToast("ƒê√£ l∆∞u s·∫£n ph·∫©m th√†nh c√¥ng!");
					closeModal();
					loadData();
				} else {
					showToast("L·ªói l∆∞u: " + data.message, true);
				}
			} catch (e) {
				showToast("L·ªói k·∫øt n·ªëi", true);
			}
			btn.disabled = false;
			btn.innerText = "L∆ØU S·∫¢N PH·∫®M";
		};

		// 4. X√≥a
		async function deleteProduct(id) {
			if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m " + id + "?")) return;
			const action = currentTab === 'sales' ? 'delete_product' : 'delete_purchase_product';
			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest(action, { id_san_pham: id })
				});
				const data = await response.json();
				if (data.success) {
					showToast("ƒê√£ x√≥a s·∫£n ph·∫©m");
					loadData();
				}
			} catch (e) { showToast("L·ªói x√≥a", true); }
		}

		// 5. Xem chi ti·∫øt (Modal Iframe)
		// 5. Xem chi ti·∫øt (Modal Iframe)
		function viewProductDetail(id) {
			// Find specific product based on current tab to avoid ID collisions
			const sourceList = currentTab === 'sales' ? allProducts : allPurchaseProducts;
			const p = sourceList.find(x => String(x.id_san_pham) === String(id));

			if (p) {
				// Pass the specific object directly to avoid lookup errors
				localStorage.setItem('direct_product_detail', JSON.stringify(p));
				const iframe = document.getElementById('viewIframe');
				// Use a special flag so the popup knows to load from direct storage, add timestamp to force reload
				iframe.src = `chi-tiet-san-pham.html?mode=direct&timestamp=${Date.now()}`;
				document.getElementById('viewModal').classList.add('active');
			} else {
				showToast("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu s·∫£n ph·∫©m", true);
			}
		}

		function closeViewModal() {
			document.getElementById('viewModal').classList.remove('active');
			document.getElementById('viewIframe').src = "";
			localStorage.removeItem('direct_product_detail');
		}

		function editProduct(id) {
			const list = currentTab === 'sales' ? allProducts : allPurchaseProducts;
			// Strict comparison might fail if types differ, assume string/number tolerance
			const p = list.find(x => String(x.id_san_pham) === String(id));
			if (!p) return;

			document.getElementById('edit_id').value = p.id_san_pham;
			document.getElementById('id_san_pham_display').value = p.id_san_pham;
			nameInput.value = p.ten_san_pham;
			document.getElementById('ten_nghanh_hang').value = p.ten_nghanh_hang;
			document.getElementById('gia_san_pham').value = p.gia_san_pham;
			document.getElementById('quy_cach').value = p.quy_cach;
			document.getElementById('dong_kien').value = p.dong_kien;
			document.getElementById('trong_luong_rieng').value = p.trong_luong_rieng || '';

			if (p.image_san_pham) {
				document.getElementById('imgPreview').src = convertDriveLink(p.image_san_pham);
				document.getElementById('imgPreview').style.display = 'block';
				document.getElementById('previewLabel').style.display = 'none';
				nameInput.dataset.autoImage = p.image_san_pham;
			} else {
				document.getElementById('imgPreview').style.display = 'none';
				document.getElementById('previewLabel').style.display = 'block';
			}

			document.getElementById('modalTitle').innerText = (currentTab === 'sales' ? "S·ª≠a S·∫£n Ph·∫©m B√°n: " : "S·ª≠a S·∫£n Ph·∫©m Mua: ") + id;
			openModal();
		}

		function previewImage(input) {
			if (input.files && input.files[0]) {
				const reader = new FileReader();
				reader.onload = function (e) {
					document.getElementById('imgPreview').src = e.target.result;
					document.getElementById('imgPreview').style.display = 'block';
					document.getElementById('previewLabel').style.display = 'none';
				}
				reader.readAsDataURL(input.files[0]);
			}
		}

		function fileToBase64(file) {
			return new Promise((resolve, reject) => {
				const reader = new FileReader();
				reader.readAsDataURL(file);
				reader.onload = () => resolve(reader.result.split(',')[1]);
				reader.onerror = error => reject(error);
			});
		}

		function applyFilters() {
			const q = document.getElementById('searchInput').value.toLowerCase();
			const list = currentTab === 'sales' ? allProducts : allPurchaseProducts;
			const filtered = list.filter(p => {
				return p.ten_san_pham.toLowerCase().includes(q) ||
					(p.ten_nghanh_hang && p.ten_nghanh_hang.toLowerCase().includes(q)) ||
					p.id_san_pham.toLowerCase().includes(q);
			});

			renderProducts(filtered);
			const label = currentTab === 'sales' ? "b√°n ra" : "mua v√†o";
			document.getElementById('stats').innerText = `T·ªïng c·ªông: ${filtered.length} s·∫£n ph·∫©m ${label}`;
		}

		function formatPrice(num) {
			return Number(num).toLocaleString('vi-VN');
		}

		function openModal() {
			if (currentTab === 'purchase') {
				document.getElementById('modalTitle').innerText = "Th√™m S·∫£n Ph·∫©m Mua V√†o";
				document.getElementById('nameLabel').innerText = "Ch·ªçn S·∫£n Ph·∫©m B√°n T∆∞∆°ng ·ª®ng *";
				document.getElementById('priceLabel').innerText = "Gi√° Mua S·ªâ (VNƒê) *";
			} else {
				document.getElementById('modalTitle').innerText = "Th√™m S·∫£n Ph·∫©m B√°n M·ªõi";
				document.getElementById('nameLabel').innerText = "T√™n S·∫£n Ph·∫©m *";
				document.getElementById('priceLabel').innerText = "Gi√° Ni√™m Y·∫øt (VNƒê) *";
			}
			document.getElementById('productModal').classList.add('active');
		}

		function closeModal() {
			document.getElementById('productModal').classList.remove('active');
			document.getElementById('productForm').reset();
			document.getElementById('edit_id').value = "";
			document.getElementById('id_san_pham_display').value = "";
			document.getElementById('imgPreview').style.display = 'none';
			document.getElementById('previewLabel').style.display = 'block';
			searchResults.classList.remove('active');
			delete nameInput.dataset.autoImage;
		}

		function showToast(msg, isError = false) {
			const t = document.getElementById('toast');
			t.innerText = msg;
			t.style.background = isError ? 'var(--danger)' : 'var(--success)';
			t.classList.add('active');
			setTimeout(() => t.classList.remove('active'), 3000);
		}

		window.onload = loadData;
	</script>
	<script src="floating-menu.js"></script>
</body>

</html>