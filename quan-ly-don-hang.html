<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Qu·∫£n L√Ω ƒê∆°n H√†ng - Premium</title>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
	<style>
		:root {
			--primary: #2d3436;
			--accent: #f1c40f;
			--success: #27ae60;
			--danger: #e74c3c;
			--bg: #f8f9fa;
			--card-bg: #ffffff;
			--border: #e9ecef;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Inter', sans-serif;
		}

		body {
			background: var(--bg);
			padding: 20px;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
		}

		header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
			border-bottom: 2px solid var(--accent);
			padding-bottom: 15px;
		}

		.btn {
			padding: 10px 20px;
			border-radius: 10px;
			cursor: pointer;
			font-weight: 600;
			border: none;
			transition: 0.3s;
			text-decoration: none;
			display: inline-flex;
			align-items: center;
			gap: 8px;
		}

		.btn-primary {
			background: var(--primary);
			color: var(--accent);
		}

		.btn-success {
			background: var(--success);
			color: white;
		}

		.form-card {
			background: white;
			padding: 25px;
			border-radius: 20px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
			margin-bottom: 25px;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 20px;
		}

		th {
			background: #f8f9fa;
			padding: 15px;
			text-align: left;
			font-size: 0.85rem;
			text-transform: uppercase;
			color: #666;
			border-bottom: 2px solid var(--border);
		}

		td {
			padding: 15px;
			border-bottom: 1px solid var(--border);
			vertical-align: middle;
		}

		tr:hover {
			background: #fafafa;
		}

		.order-id {
			font-weight: 800;
			color: #2980b9;
		}

		.status-badge {
			padding: 4px 10px;
			border-radius: 6px;
			font-size: 0.75rem;
			font-weight: 700;
			background: #e3f2fd;
			color: #1976d2;
		}

		.loading {
			text-align: center;
			padding: 50px;
			font-weight: 700;
			color: #999;
		}

		.actions {
			display: flex;
			gap: 10px;
		}

		.modal {
			display: none;
			position: fixed;
			z-index: 100;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			align-items: center;
			justify-content: center;
			overflow-y: auto;
			padding: 20px;
		}

		.modal-content {
			background: white;
			width: 95%;
			max-width: 1000px;
			max-height: 95vh;
			overflow-y: auto;
			border-radius: 20px;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
			position: relative;
			animation: modalSlideIn 0.3s ease-out;
		}

		@keyframes modalSlideIn {
			from {
				opacity: 0;
				transform: translateY(-30px) scale(0.95);
			}

			to {
				opacity: 1;
				transform: translateY(0) scale(1);
			}
		}

		.modal-close {
			position: absolute;
			top: 20px;
			right: 20px;
			width: 40px;
			height: 40px;
			background: rgba(0, 0, 0, 0.6);
			color: white;
			border: none;
			border-radius: 50%;
			font-size: 1.5rem;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: 0.3s;
			z-index: 101;
		}

		.modal-close:hover {
			background: rgba(0, 0, 0, 0.9);
			transform: rotate(90deg);
		}

		.cat-weber {
			border-left: 5px solid #000;
		}

		.cat-pima {
			border-left: 5px solid #f1c40f;
		}

		.cat-duraflex {
			border-left: 5px solid #27ae60;
		}

		/* Invoice Styles in Modal */
		.invoice-container {
			background: white;
		}

		.invoice-header {
			background: linear-gradient(135deg, #f1c40f, #f39c12);
			color: #000;
			padding: 40px;
			text-align: center;
			border-radius: 20px 20px 0 0;
		}

		.invoice-header h1 {
			font-size: 2rem;
			font-weight: 800;
			margin-bottom: 10px;
		}

		.invoice-header .order-id {
			font-size: 1.1rem;
			font-weight: 600;
			opacity: 0.9;
		}

		.invoice-header div {
			margin-top: 10px;
			font-size: 0.95rem;
			opacity: 0.9;
		}

		.invoice-body {
			padding: 30px;
		}

		.section {
			margin-bottom: 25px;
		}

		.section-title {
			font-size: 1.1rem;
			font-weight: 700;
			color: #2d3436;
			margin-bottom: 15px;
			padding-bottom: 8px;
			border-bottom: 3px solid #f1c40f;
		}

		.info-grid {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			gap: 15px;
			margin-bottom: 20px;
		}

		.info-item {
			display: flex;
			gap: 10px;
		}

		.info-label {
			font-weight: 700;
			color: #666;
			min-width: 140px;
		}

		.info-value {
			color: #2d3436;
			font-weight: 500;
		}

		.products-table {
			width: 100%;
			border-collapse: collapse;
			margin: 20px 0;
		}

		.products-table thead {
			background: #2d3436;
			color: white;
		}

		.products-table th {
			padding: 12px 10px;
			text-align: left;
			font-size: 0.85rem;
			font-weight: 700;
		}

		.products-table td {
			padding: 12px 10px;
			border-bottom: 1px solid #e9ecef;
			font-size: 0.9rem;
		}

		.products-table tbody tr:hover {
			background: #f8f9fa;
		}

		.delivery-badge {
			display: inline-block;
			padding: 4px 10px;
			background: #fff3cd;
			color: #856404;
			border-radius: 6px;
			font-weight: 600;
			font-size: 0.75rem;
		}

		.summary-box {
			background: #f8f9fa;
			padding: 25px;
			border-radius: 12px;
			margin-top: 25px;
		}

		.summary-row {
			display: flex;
			justify-content: space-between;
			padding: 10px 0;
			font-size: 1rem;
		}

		.summary-row.highlight {
			color: #e67e22;
			font-weight: 600;
		}

		.summary-row.total {
			font-size: 1.5rem;
			font-weight: 800;
			color: #2d3436;
			border-top: 3px solid #f1c40f;
			padding-top: 15px;
			margin-top: 10px;
		}

		.invoice-footer {
			padding: 25px;
			background: #2d3436;
			color: white;
			text-align: center;
			border-radius: 0 0 20px 20px;
		}

		.footer-actions {
			display: flex;
			justify-content: center;
			gap: 12px;
			margin-bottom: 15px;
		}

		.btn-print {
			background: #f1c40f;
			color: #000;
			padding: 10px 25px;
			border-radius: 8px;
			border: none;
			font-weight: 700;
			cursor: pointer;
			transition: 0.3s;
		}

		.btn-print:hover {
			background: #f39c12;
		}

		/* Responsive Design - Tablet */
		@media (max-width: 1024px) {
			.container {
				max-width: 95%;
			}

			header {
				flex-direction: column;
				align-items: flex-start;
				gap: 15px;
			}

			th, td {
				padding: 12px;
				font-size: 0.9rem;
			}

			.modal-content {
				max-width: 90%;
				padding: 0;
			}
		}

		/* Responsive Design - Mobile */
		@media (max-width: 768px) {
			body {
				padding: 10px;
			}

			.container {
				max-width: 100%;
			}

			header {
				flex-direction: column;
				align-items: flex-start;
				margin-bottom: 20px;
				padding-bottom: 10px;
			}

			.btn {
				padding: 8px 15px;
				font-size: 0.9rem;
			}

			table {
				font-size: 0.85rem;
			}

			th, td {
				padding: 10px 8px;
			}

			.status-badge {
				padding: 3px 8px;
				font-size: 0.7rem;
			}

			.actions {
				flex-direction: column;
				gap: 5px;
			}

			.actions .btn {
				width: 100%;
				justify-content: center;
				padding: 8px 10px;
				font-size: 0.8rem;
			}

			.modal-content {
				width: 98%;
				max-width: 100%;
				max-height: 90vh;
				border-radius: 12px;
			}

			.modal-close {
				width: 36px;
				height: 36px;
				font-size: 1.3rem;
				top: 10px;
				right: 10px;
			}

			.invoice-header {
				padding: 30px 20px;
			}

			.invoice-header h1 {
				font-size: 1.8rem;
			}

			.invoice-header .order-id {
				font-size: 0.95rem;
			}

			.invoice-body {
				padding: 20px;
			}

			.section-title {
				font-size: 1rem;
				margin-bottom: 15px;
			}

			.info-grid {
				gap: 10px;
				margin-bottom: 15px;
			}

			.info-label {
				min-width: 100px;
				font-size: 0.9rem;
			}

			.info-value {
				font-size: 0.9rem;
			}

			.products-table {
				margin: 15px 0;
				font-size: 0.8rem;
			}

			.products-table th,
			.products-table td {
				padding: 8px 6px;
			}

			.summary-box {
				padding: 15px;
				margin-top: 20px;
			}

			.summary-row {
				padding: 8px 0;
				font-size: 0.95rem;
			}

			.summary-row.total {
				font-size: 1.3rem;
				padding-top: 10px;
			}

			.invoice-footer {
				padding: 15px;
			}

			.footer-actions {
				flex-direction: column;
				gap: 10px;
				margin-bottom: 10px;
			}

			.btn-print {
				padding: 10px 20px;
				font-size: 0.9rem;
			}
		}

		/* Extra small screens */
		@media (max-width: 480px) {
			body {
				padding: 6px;
			}

			.container {
				max-width: 100%;
			}

			header {
				flex-direction: column;
				align-items: flex-start;
				gap: 10px;
				margin-bottom: 15px;
				padding-bottom: 10px;
			}

			header div:last-child {
				width: 100%;
				display: flex;
				gap: 8px;
			}

			.btn {
				padding: 6px 10px;
				font-size: 0.75rem;
				flex: 1;
			}

			header h1 {
				font-size: 1rem;
				margin-bottom: 2px;
			}

			header p {
				font-size: 0.75rem;
			}

			.form-card {
				padding: 10px;
				border-radius: 10px;
				margin-bottom: 15px;
			}

			table {
				font-size: 0.7rem;
				margin-top: 10px;
			}

			th {
				padding: 6px 4px;
				font-size: 0.65rem;
				text-transform: capitalize;
				word-break: break-word;
			}

			td {
				padding: 6px 4px;
				vertical-align: top;
			}

			.order-id {
				font-weight: 700;
				font-size: 0.75rem;
				word-break: break-all;
			}

			.status-badge {
				padding: 2px 4px;
				font-size: 0.6rem;
				border-radius: 4px;
			}

			.actions {
				display: flex;
				flex-direction: column;
				gap: 3px;
			}

			.actions .btn {
				width: 100%;
				padding: 4px 6px;
				font-size: 0.65rem;
				white-space: nowrap;
			}

			/* Hide non-essential columns on very small screens */
			table thead tr {
				display: grid;
				grid-template-columns: 0.8fr 1fr 1.2fr 0.8fr 1fr;
				gap: 2px;
			}

			table tbody tr {
				display: grid;
				grid-template-columns: 0.8fr 1fr 1.2fr 0.8fr 1fr;
				gap: 2px;
				border-bottom: 1px solid var(--border);
				padding: 6px 0;
			}

			table tbody tr td:nth-child(n+6) {
				display: none;
			}

			table thead tr th:nth-child(n+6) {
				display: none;
			}

			/* Show total and actions in a separate row */
			table tbody tr td:last-child {
				grid-column: 1 / -1;
				display: flex;
				gap: 4px;
			}

			.modal-content {
				width: 96%;
				max-height: 95vh;
				border-radius: 8px;
			}

			.invoice-header {
				padding: 20px 15px;
			}

			.invoice-header h1 {
				font-size: 1.3rem;
			}

			.invoice-header .order-id {
				font-size: 0.8rem;
			}

			.invoice-body {
				padding: 12px;
			}

			.section-title {
				font-size: 0.9rem;
				margin-bottom: 10px;
			}

			.info-grid {
				gap: 8px;
			}

			.info-label {
				min-width: 90px;
				font-size: 0.8rem;
			}

			.info-value {
				font-size: 0.8rem;
			}

			.products-table th,
			.products-table td {
				padding: 6px 4px;
				font-size: 0.7rem;
			}

			.summary-row {
				font-size: 0.8rem;
				padding: 6px 0;
			}

			.summary-row.total {
				font-size: 1rem;
				padding-top: 8px;
			}

			.invoice-footer {
				padding: 12px;
			}

			.btn-print {
				padding: 8px 16px;
				font-size: 0.8rem;
			}
		}
	</style>
</head>

<body>

	<div class="container">
		<header>
			<div>
				<h1 style="font-weight: 800; text-transform: uppercase;">Qu·∫£n L√Ω ƒê∆°n H√†ng</h1>
				<p style="color: #666;">Danh s√°ch ƒë∆°n h√†ng t·ª´ Google Sheet</p>
			</div>
			<div style="display: flex; gap: 15px;">
				<a href="len-don.html" class="btn btn-success">+ T·∫†O ƒê∆†N M·ªöI</a>
				<a href="index.html" class="btn btn-primary">TRANG CH·ª¶</a>
			</div>
		</header>

		<div class="form-card">
			<div id="orderList" class="loading">ƒêang t·∫£i danh s√°ch ƒë∆°n h√†ng...</div>
		</div>
	</div>

	<!-- Invoice Modal -->
	<div id="invoiceModal" class="modal">
		<div class="modal-content">
			<button class="modal-close" onclick="closeInvoiceModal()">‚úï</button>
			<div id="invoiceContent"></div>
		</div>
	</div>

	<script>
		const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIHfOV9rW_GQ8_Xv-WWA3KAqPMONiZQPDdOdNOcYmMSMlt93KG3zZJ7Z53OJ-d-LIJZg/exec';

		document.addEventListener('DOMContentLoaded', fetchOrders);

		async function fetchOrders() {
			const container = document.getElementById('orderList');
			try {
				const res = await fetch(SCRIPT_URL);
				const csvText = await res.text();
				const rows = csvToJson(csvText);

				if (rows.length === 0) {
					container.innerHTML = "Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.";
					return;
				}

				// G·ªôp c√°c d√≤ng c√πng OrderId v√† chu·∫©n h√≥a tr∆∞·ªùng
				const ordersMap = {};
				rows.forEach(r => {
					// Try common header variants for important fields
					const id = r["M√£ ƒê∆°n"] || r["M√£ ƒë∆°n"] || r["Ma Don"] || r["Ma don"] || 'UNKNOWN';
					const rawCategory = r["Lo·∫°i SP"] || r["Loai SP"] || r["Lo·∫°i s·∫£n ph·∫©m"] || r["Lo·∫°i"] || r["Loai san pham"] || '';
					const categoryNorm = (rawCategory || '').toString().toLowerCase().trim();
					const categoryDisplay = (rawCategory && rawCategory.toString().trim()) ? rawCategory.toString().trim() : (categoryNorm ? categoryNorm.toUpperCase() : 'PIMA');

					const time = r["Th·ªùi gian"] || r["Th·ªùi gian "] || r["Thoi gian"] || '';
					const customer = r["Kh√°ch H√†ng"] || r["Kh√°ch h√†ng"] || r["Khach Hang"] || '';
					const custType = r["Ph√¢n Lo·∫°i KH"] || r["Lo·∫°i KH"] || r["Phan loai"] || '';
					const total = r["T·ªïng ƒê∆°n"] || r["Tong Don"] || r["T·ªïng ti·ªÅn"] || 0;
					const notes = r["Ghi Ch√∫"] || r["Ghi ch√∫"] || r["Ghi chu"] || '';

					if (!ordersMap[id]) {
						ordersMap[id] = {
							id: id,
							time: time,
							category: categoryNorm, // normalized (lowercase) or empty
							category_display: categoryDisplay,
							customer: customer,
							customer_type: custType,
							total: total,
							items: [],
							notes: notes
						};
					}

					ordersMap[id].items.push({
						name: r["S·∫£n Ph·∫©m"] || r["San Pham"] || r["S·∫£n ph·∫©m"] || '',
						qty: r["S·ªë L∆∞·ª£ng"] || r["So Luong"] || r["S·ªë l∆∞·ª£ng"] || 0,
						price: r["ƒê∆°n Gi√°"] || r["Don Gia"] || 0,
						subtotal: r["Th√†nh Ti·ªÅn"] || r["Thanh Tien"] || 0,
						promo: r["Chi·∫øt Kh·∫•u/KM"] || r["Chi·∫øt Kh·∫•u"] || '',
						delivery_type: r["Giao h√†ng"] || r["Giao hang"] || '',
						surplus: r["Ph·∫ßn d∆∞"] || r["Phan du"] || 0
					});
				});

				// If any order missing category, try to infer from product names
				Object.values(ordersMap).forEach(o => {
					if (!o.category || o.category === '') {
						const names = o.items.map(it => (it.name || '').toString().toLowerCase());
						if (names.some(n => n.includes('duraflex'))) {
							o.category = 'duraflex';
							o.category_display = 'DURAFLEX';
						} else if (names.some(n => n.includes('weber'))) {
							o.category = 'weber';
							o.category_display = 'WEBER';
						} else if (names.some(n => n.includes('pima'))) {
							o.category = 'pima';
							o.category_display = 'PIMA';
						} else {
							// default to pima
							o.category = 'pima';
							o.category_display = 'PIMA';
						}
					} else {
						// ensure category normalized
						o.category = o.category.toString().toLowerCase().trim();
						o.category_display = o.category_display || o.category.toUpperCase();
					}
				});

				renderTable(Object.values(ordersMap).reverse());
			} catch (e) {
				container.innerHTML = `<span style="color:red">L·ªói t·∫£i d·ªØ li·ªáu: ${e.message}</span>`;
			}
		}

		function csvToJson(csv) {
			const lines = csv.trim().split(/\r?\n/);
			if (lines.length < 2) return [];
			
			// Parse header
			const headers = parseCSVLine(lines[0]);
			console.log('=== CSV PARSING ===');
			console.log('Total rows:', lines.length - 1);
			console.log('Headers:', headers);
			
			// Parse data rows
			const data = [];
			for (let i = 1; i < lines.length; i++) {
				if (lines[i].trim() === '') continue;
				const values = parseCSVLine(lines[i]);
				const obj = {};
				headers.forEach((h, idx) => {
					obj[h.trim()] = values[idx] ? values[idx].trim() : '';
				});
				data.push(obj);
				if (i <= 2) {
					console.log(`Row ${i}:`, obj);
				}
			}
			console.log('Total parsed rows:', data.length);
			return data;
		}

		function parseCSVLine(line) {
			// Parse CSV line properly handling quoted fields
			const result = [];
			let current = '';
			let inQuotes = false;
			
			for (let i = 0; i < line.length; i++) {
				const char = line[i];
				const nextChar = line[i + 1];
				
				if (char === '"') {
					if (inQuotes && nextChar === '"') {
						// Escaped quote
						current += '"';
						i++;
					} else {
						// Toggle quote state
						inQuotes = !inQuotes;
					}
				} else if (char === ',' && !inQuotes) {
					// Field separator
					result.push(current);
					current = '';
				} else {
					current += char;
				}
			}
			result.push(current);
			return result;
		}

		function renderTable(orders) {
			const container = document.getElementById('orderList');
			let html = `
            <table>
                <thead>
                    <tr>
                        <th>Th·ªùi gian</th>
                        <th>M√£ ƒê∆°n</th>
                        <th>Kh√°ch H√†ng</th>
                        <th>Lo·∫°i SP</th>
                        <th>S·∫£n ph·∫©m</th>
                        <th>T·ªïng c·ªông</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody>
        `;

			orders.forEach(order => {
				const catClass = `cat-${(order.category || 'pima')}`;
				const displayCat = order.category_display || (order.category ? order.category.toUpperCase() : 'PIMA');
				html += `
                <tr class="${catClass}">
					<td style="font-size: 0.8rem; color: #888;">${new Date(order.time).toLocaleString('vi-VN')}</td>
					<td class="order-id">${order.id}</td>
					<td><strong>${order.customer}</strong></td>
					<td><span class="status-badge">${displayCat}</span></td>
                    <td style="font-size: 0.9rem;">
                        ${order.items.slice(0, 2).map(i => i.name).join(', ')}
                        ${order.items.length > 2 ? '...' : ''}
                    </td>
                    <td style="font-weight: 800; color: #e67e22;">${formatCurrency(order.total || 0)}</td>
                    <td class="actions">
						<button class="btn btn-primary" style="padding: 5px 12px; font-size: 0.8rem;" onclick='viewInvoice(${JSON.stringify(order)})'>XEM CHI TI·∫æT</button>
                    </td>
                </tr>
            `;
			});

			html += `</tbody></table>`;
			container.innerHTML = html;
		}

		function formatCurrency(num) {
			return new Intl.NumberFormat('vi-VN').format(num) + ' ƒë';
		}

		async function viewInvoice(order) {
			// Display invoice in modal by loading the appropriate external template
			const modal = document.getElementById('invoiceModal');
			const content = document.getElementById('invoiceContent');
			console.log('Order object:', order);

			const category = ((order.category || '') + '').toLowerCase().trim();
			const catNorm = category || 'pima';
			console.log('Category normalized:', catNorm);

			// Map to template file
			const templateMap = {
				'duraflex': 'phieu-don-hang-duraflex.html',
				'weber': 'phieu-don-hang-weber.html',
				'pima': 'phieu-don-hang-pima.html'
			};

			const templateFile = templateMap[catNorm] || templateMap['pima'];

			try {
				const resp = await fetch(templateFile);
				if (!resp.ok) throw new Error('Kh√¥ng th·ªÉ load template: ' + templateFile);
				const html = await resp.text();

				// Parse template and extract the invoice container
				const parser = new DOMParser();
				const doc = parser.parseFromString(html, 'text/html');
				const invoiceNode = doc.querySelector('.invoice-container');

				if (!invoiceNode) {
					throw new Error('Template kh√¥ng ch·ª©a .invoice-container');
				}

				// Clone node into current document
				const clone = invoiceNode.cloneNode(true);

				// Populate fields inside clone
				const setText = (selector, text) => {
					const el = clone.querySelector(selector);
					if (el) el.textContent = text;
				};

				setText('#orderIdDisplay', `M√£ ƒë∆°n: ${order.id || 'N/A'}`);
				setText('#orderTimeDisplay', `Th·ªùi gian: ${order.time ? new Date(order.time).toLocaleString('vi-VN') : 'N/A'}`);
				setText('#customerName', order.customer || 'N/A');
				setText('#customerType', order.customer_type || order.phan_loai || 'N/A');

				// Products
				const tbody = clone.querySelector('#productsTableBody');
				if (tbody) {
					tbody.innerHTML = '';
					if (!order.items || order.items.length === 0) {
						tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 30px;">Kh√¥ng c√≥ s·∫£n ph·∫©m</td></tr>';
					} else {
						order.items.forEach((item, index) => {
							const subtotal = parseInt(item.subtotal || 0);
							const price = parseInt(item.price || item.unit_price || 0);
							const qty = parseInt(item.qty || item.quantity || 0);
							const discount = parseInt(item.promo || item.discount || 0);

							const tr = document.createElement('tr');
							tr.innerHTML = `
								<td>${index + 1}</td>
								<td><strong>${item.name || 'N/A'}</strong></td>
								<td>${qty}</td>
								<td>${formatCurrency(price)}</td>
								<td>${formatCurrency(discount)}</td>
								<td><strong>${formatCurrency(subtotal)}</strong></td>
							`;
							tbody.appendChild(tr);
						});
					}
				}

				// Summary
				const total = parseInt(order.total || 0);
				const summaryEl = clone.querySelector('#summaryTotal');
				if (summaryEl) summaryEl.textContent = formatCurrency(total);

				// Notes
				if (order.notes && order.notes.trim()) {
					const notesSection = clone.querySelector('#notesSection');
					const notesEl = clone.querySelector('#orderNotes');
					if (notesSection && notesEl) {
						notesSection.style.display = 'block';
						notesEl.textContent = order.notes;
					}
				}

				// Inject clone into modal content
				content.innerHTML = '';
				content.appendChild(clone);
				modal.style.display = 'flex';
				document.body.style.overflow = 'hidden';
			} catch (e) {
				console.error(e);
				// fallback to inline generation in case of error
				const invoiceHTML = generateInvoiceHTML(order, catNorm);
				content.innerHTML = invoiceHTML;
				modal.style.display = 'flex';
				document.body.style.overflow = 'hidden';
			}
		}

		function generateInvoiceHTML(order, category) {
			// Normalize category - ensure it's a clean string
			const catNorm = ((category || '') + '').toLowerCase().trim();
			console.log('generateInvoiceHTML: category input =', category, 'normalized =', catNorm);

			// Determine header color and class based on category
			let headerClass = 'pima';
			let headerGradient = 'linear-gradient(135deg, #f1c40f, #f39c12)';
			let headerTextColor = '#000';
			let footerText = 'C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ tin t∆∞·ªüng s·ª≠ d·ª•ng s·∫£n ph·∫©m Pima Nano';
			let btnColor = '#f1c40f';

			if (catNorm === 'duraflex') {
				headerClass = 'duraflex';
				headerGradient = 'linear-gradient(135deg, #2ecc71, #27ae60)';
				headerTextColor = '#fff';
				footerText = 'C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ tin t∆∞·ªüng s·ª≠ d·ª•ng s·∫£n ph·∫©m Duraflex';
				btnColor = '#2ecc71';
			} else if (catNorm === 'weber') {
				headerClass = 'weber';
				headerGradient = 'linear-gradient(135deg, #000, #222)';
				headerTextColor = '#fff';
				footerText = 'C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ tin t∆∞·ªüng s·ª≠ d·ª•ng s·∫£n ph·∫©m Weber';
				btnColor = '#000';
			}

			console.log('invoice visual: catNorm=', catNorm, 'headerGradient=', headerGradient, 'btnColor=', btnColor, 'headerTextColor=', headerTextColor);

			// Generate products table
			let productsHTML = '';
			let totalGross = 0;
			let totalSurplus = 0;

			if (!order.items || order.items.length === 0) {
				productsHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 30px;">Kh√¥ng c√≥ s·∫£n ph·∫©m</td></tr>';
			} else {
				order.items.forEach((item, index) => {
					const subtotal = parseInt(item.subtotal || 0);
					const price = parseInt(item.price || 0);
					const qty = parseInt(item.qty || 0);
					const surplus = parseInt(item.surplus || 0);

					if (surplus > 0) {
						totalSurplus += surplus;
						totalGross += subtotal + surplus;
					} else {
						totalGross += subtotal;
					}

					let tableCell = `
						<tr>
							<td>${index + 1}</td>
							<td><strong>${item.name || 'N/A'}</strong></td>
							<td>${qty}</td>
							<td>${formatCurrency(price)}</td>
					`;

					if (catNorm === 'duraflex') {
						tableCell += `<td>${formatCurrency(item.promo || 0)}</td>`;
					} else if (catNorm === 'weber') {
						tableCell += `<td><span style="background: #e9ecef; padding: 4px 10px; border-radius: 5px; font-size: 0.75rem; font-weight: 700;">${item.delivery_type || '-'}</span></td>`;
					} else {
						tableCell += `<td><span style="background: #fff3cd; padding: 4px 10px; border-radius: 5px; font-size: 0.75rem; font-weight: 700; color: #856404;">${item.delivery_type || '-'}</span></td>`;
					}

					tableCell += `<td><strong>${formatCurrency(subtotal)}</strong></td></tr>`;
					productsHTML += tableCell;
				});
			}

			// Generate summary
			const total = parseInt(order.total || 0);
			let summaryHTML = '';

			if (catNorm === 'duraflex') {
				summaryHTML = `
					<div class="summary-row total">
						<span>T·ªîNG C·ªòNG:</span>
						<span>${formatCurrency(total)}</span>
					</div>
				`;
			} else if (catNorm === 'weber') {
				summaryHTML = `
					<div class="summary-row total">
						<span>T·ªîNG C·ªòNG:</span>
						<span>${formatCurrency(total)}</span>
					</div>
				`;
			} else {
				summaryHTML = `
					<div class="summary-row">
						<span>T·ªïng gi√° tr·ªã:</span>
						<span>${formatCurrency(totalGross)}</span>
					</div>
					${totalSurplus > 0 ? `
					<div class="summary-row" style="color: #e67e22; font-weight: 700;">
						<span>H·ªó tr·ª£ v·∫≠n chuy·ªÉn:</span>
						<span>- ${formatCurrency(totalSurplus)}</span>
					</div>
					` : ''}
					<div class="summary-row total">
						<span>${totalSurplus > 0 ? 'S·ªê TI·ªÄN C√íN L·∫†I:' : 'T·ªîNG C·ªòNG:'}</span>
						<span>${formatCurrency(total)}</span>
					</div>
				`;
			}

			const invoiceHTML = `
				<div style="max-width: 900px; margin: 0 auto; background: white; border-radius: 10px; overflow: hidden;">
					<div style="background: ${headerGradient}; color: ${headerTextColor}; padding: 30px 28px; text-align: center;">
						<h1 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 6px;">PHI·∫æU ƒê∆†N H√ÄNG</h1>
						<div style="font-size: 0.95rem; font-weight: 600; opacity: 0.9;">M√£ ƒë∆°n: ${order.id || 'N/A'}</div>
						<div style="margin-top: 10px; font-size: 0.95rem; opacity: 0.9;">Th·ªùi gian: ${order.time ? new Date(order.time).toLocaleString('vi-VN') : 'N/A'}</div>
							<!-- DEBUG: hi·ªÉn th·ªã category ƒë∆∞·ª£c d√πng ƒë·ªÉ t·∫°o phi·∫øu -->
							<div style="margin-top:6px; font-size:0.85rem; opacity:0.95; font-weight:700; color: ${headerTextColor};">DEBUG category: ${catNorm}</div>
					</div>

					<div style="padding: 28px;">
						<!-- Customer Info -->
						<div style="margin-bottom: 22px;">
							<div style="font-size: 1rem; font-weight: 700; color: #2d3436; margin-bottom: 14px; padding-bottom: 6px; border-bottom: 2px solid ${catNorm === 'duraflex' ? '#2ecc71' : catNorm === 'weber' ? '#000' : '#f1c40f'};">TH√îNG TIN KH√ÅCH H√ÄNG</div>
							<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-bottom: 16px;">
								<div style="display: flex; gap: 8px;">
									<span style="font-weight: 700; color: #666; min-width: 120px; font-size: 0.9rem;">T√™n kh√°ch h√†ng:</span>
									<span style="color: #2d3436; font-weight: 500; font-size: 0.9rem;">${order.customer || 'N/A'}</span>
								</div>
								<div style="display: flex; gap: 8px;">
									<span style="font-weight: 700; color: #666; min-width: 120px; font-size: 0.9rem;">Ph√¢n lo·∫°i:</span>
									<span style="color: #2d3436; font-weight: 500; font-size: 0.9rem;">${order.customer_type || 'N/A'}</span>
								</div>
							</div>
						</div>

						<!-- Products -->
						<div style="margin-bottom: 22px;">
							<div style="font-size: 1rem; font-weight: 700; color: #2d3436; margin-bottom: 14px; padding-bottom: 6px; border-bottom: 2px solid ${catNorm === 'duraflex' ? '#2ecc71' : catNorm === 'weber' ? '#000' : '#f1c40f'};">CHI TI·∫æT S·∫¢N PH·∫®M</div>
							<table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
								<thead>
									<tr style="background: #2d3436; color: white;">
										<th style="padding: 10px; text-align: left; font-size: 0.85rem; font-weight: 700;">STT</th>
										<th style="padding: 10px; text-align: left; font-size: 0.85rem; font-weight: 700;">T√™n s·∫£n ph·∫©m</th>
										<th style="padding: 10px; text-align: left; font-size: 0.85rem; font-weight: 700;">S·ªë l∆∞·ª£ng</th>
										<th style="padding: 10px; text-align: left; font-size: 0.85rem; font-weight: 700;">ƒê∆°n gi√°</th>
										<th style="padding: 10px; text-align: left; font-size: 0.85rem; font-weight: 700;">${catNorm === 'duraflex' ? 'Chi·∫øt kh·∫•u' : catNorm === 'weber' ? 'T·∫°i kho' : 'Giao h√†ng'}</th>
										<th style="padding: 10px; text-align: left; font-size: 0.85rem; font-weight: 700;">Th√†nh ti·ªÅn</th>
									</tr>
								</thead>
								<tbody>
									${productsHTML}
								</tbody>
							</table>
						</div>

						<!-- Summary -->
						<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 18px;">
							${summaryHTML}
						</div>

						${order.notes ? `
						<div style="margin-bottom: 22px; margin-top: 22px;">
							<div style="font-size: 1rem; font-weight: 700; color: #2d3436; margin-bottom: 14px; padding-bottom: 6px; border-bottom: 2px solid ${catNorm === 'duraflex' ? '#2ecc71' : catNorm === 'weber' ? '#000' : '#f1c40f'};">GHI CH√ö</div>
							<p style="color: #666; line-height: 1.6;">${order.notes}</p>
						</div>
						` : ''}
					</div>

					<div style="padding: 20px 28px; background: #2d3436; color: white; text-align: center;">
						<div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 12px;">
							<button onclick="printInvoice()" style="padding: 9px 24px; border-radius: 7px; border: none; font-weight: 700; cursor: pointer; background: ${btnColor}; color: ${catNorm === 'pima' ? '#000' : '#fff'}; font-size: 0.9rem;">üìÑ IN PHI·∫æU</button>
							<button onclick="closeInvoiceModal()" style="padding: 9px 24px; border-radius: 7px; border: none; font-weight: 700; cursor: pointer; background: #95a5a6; color: white; font-size: 0.9rem;">‚úï ƒê√ìNG</button>
						</div>
						<p style="font-size: 0.9rem; opacity: 0.8;">${footerText}</p>
					</div>
				</div>
			`;

			return invoiceHTML;
		}

		function closeInvoiceModal() {
			const modal = document.getElementById('invoiceModal');
			modal.style.display = 'none';
			document.body.style.overflow = 'auto';
		}

		function printInvoice() {
			const content = document.getElementById('invoiceContent').innerHTML;
			const printWindow = window.open('', '', 'width=800,height=600');
			printWindow.document.write(`
			<html>
			<head>
				<title>Phi·∫øu ƒê∆°n H√†ng</title>
				<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
				<style>
					* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
					body { background: white; }
					.invoice-container { background: white; }
					.footer-actions { display: none !important; }
					table { width: 100%; border-collapse: collapse; }
					th, td { padding: 10px; border: 1px solid #e9ecef; text-align: left; }
					th { background: #2d3436; color: white; }
				</style>
			</head>
			<body>${content}</body>
			</html>
		`);
			printWindow.document.close();
			setTimeout(() => {
				printWindow.print();
				printWindow.close();
			}, 250);
		}

		function generateInvoiceHTML(order) {
			let totalGross = 0;
			let totalSurplus = 0;

			let productsHTML = '';
			if (!order.items || order.items.length === 0) {
				productsHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 30px;">Kh√¥ng c√≥ s·∫£n ph·∫©m</td></tr>';
			} else {
				order.items.forEach((item, index) => {
					const deliveryBadge = item.delivery_type ? `<span class="delivery-badge">${item.delivery_type}</span>` : '-';
					const surplus = parseInt(item.surplus || 0);
					const subtotal = parseInt(item.subtotal || 0);
					const price = parseInt(item.price || item.unit_price || 0);
					const qty = parseInt(item.qty || item.quantity || 0);

					if (surplus > 0) {
						totalSurplus += surplus;
						totalGross += subtotal + surplus;
					} else {
						totalGross += subtotal;
					}

					productsHTML += `
					<tr>
						<td>${index + 1}</td>
						<td><strong>${item.name || 'N/A'}</strong></td>
						<td>${qty}</td>
						<td>${formatCurrency(price)}</td>
						<td>${deliveryBadge}</td>
						<td><strong>${formatCurrency(subtotal)}</strong></td>
					</tr>
				`;
				});
			}

			const total = parseInt(order.total || 0);
			const surplusRowHTML = totalSurplus > 0 ? `
			<div class="summary-row highlight">
				<span>H·ªó tr·ª£ v·∫≠n chuy·ªÉn:</span>
				<span>- ${formatCurrency(totalSurplus)}</span>
			</div>
		` : '';

			const totalLabel = totalSurplus > 0 ? 'S·ªê TI·ªÄN C√íN L·∫†I:' : 'T·ªîNG C·ªòNG:';
			const notesHTML = order.notes && order.notes.trim() ? `
			<div class="section">
				<div class="section-title">GHI CH√ö</div>
				<p style="color: #666; line-height: 1.6;">${order.notes}</p>
			</div>
		` : '';

			return `
			<div class="invoice-container">
				<div class="invoice-header">
					<h1>PHI·∫æU ƒê∆†N H√ÄNG</h1>
					<div class="order-id">M√£ ƒë∆°n: ${order.id || 'N/A'}</div>
					<div style="margin-top: 10px; font-size: 0.95rem; opacity: 0.9;">Th·ªùi gian: ${order.time ? new Date(order.time).toLocaleString('vi-VN') : 'N/A'}</div>
				</div>

				<div class="invoice-body">
					<div class="section">
						<div class="section-title">TH√îNG TIN KH√ÅCH H√ÄNG</div>
						<div class="info-grid">
							<div class="info-item">
								<span class="info-label">T√™n kh√°ch h√†ng:</span>
								<span class="info-value">${order.customer || 'N/A'}</span>
							</div>
							<div class="info-item">
								<span class="info-label">Ph√¢n lo·∫°i:</span>
								<span class="info-value">${order.customer_type || 'N/A'}</span>
							</div>
							<div class="info-item">
								<span class="info-label">Lo·∫°i s·∫£n ph·∫©m:</span>
								<span class="info-value">${order.category || 'N/A'}</span>
							</div>
						</div>
					</div>

					<div class="section">
						<div class="section-title">CHI TI·∫æT S·∫¢N PH·∫®M</div>
						<table class="products-table">
							<thead>
								<tr>
									<th>STT</th>
									<th>T√™n s·∫£n ph·∫©m</th>
									<th>S·ªë l∆∞·ª£ng</th>
									<th>ƒê∆°n gi√°</th>
									<th>Giao h√†ng</th>
									<th>Th√†nh ti·ªÅn</th>
								</tr>
							</thead>
							<tbody>
								${productsHTML}
							</tbody>
						</table>
					</div>

					<div class="summary-box">
						<div class="summary-row">
							<span>T·ªïng gi√° tr·ªã (Gi√° ch√†nh):</span>
							<span>${formatCurrency(totalGross || total)}</span>
						</div>
						${surplusRowHTML}
						<div class="summary-row total">
							<span>${totalLabel}</span>
							<span>${formatCurrency(total)}</span>
						</div>
					</div>

					${notesHTML}
				</div>

				<div class="invoice-footer">
					<div class="footer-actions">
						<button class="btn btn-print" onclick="printInvoice()">üìÑ IN PHI·∫æU</button>
					</div>
					<p style="font-size: 0.9rem; opacity: 0.8;">C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ tin t∆∞·ªüng s·ª≠ d·ª•ng s·∫£n ph·∫©m Pima Nano</p>
				</div>
			</div>
		`;
		}

		function editOrder(order) {
			// L∆∞u data v√†o localStorage v√† chuy·ªÉn sang trang l√™n ƒë∆°n v·ªõi mode edit
			localStorage.setItem('editingOrder', JSON.stringify(order));
			window.location.href = 'len-don.html';
		}

		// Close modal on clicking outside
		document.addEventListener('click', function (e) {
			const modal = document.getElementById('invoiceModal');
			if (e.target === modal) {
				closeInvoiceModal();
			}
		});

		// Close modal on ESC key
		document.addEventListener('keydown', function (e) {
			if (e.key === 'Escape') {
				closeInvoiceModal();
			}
		});
	</script>

</body>

</html>