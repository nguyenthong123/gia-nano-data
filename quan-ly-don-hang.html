<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Quản Lý Đơn Hàng - Premium</title>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
	<style>
		:root {
			--primary: #2d3436;
			--accent: #f1c40f;
			--success: #27ae60;
			--danger: #e74c3c;
			--bg: #f8f9fa;
			--card-bg: #ffffff;
			--border: #e9ecef;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Inter', sans-serif;
		}

		body {
			background: var(--bg);
			padding: 20px;
		}

		.container {
			max-width: 1200px;
			margin: 0 auto;
		}

		header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
			border-bottom: 2px solid var(--accent);
			padding-bottom: 15px;
		}

		.btn {
			padding: 10px 20px;
			border-radius: 10px;
			cursor: pointer;
			font-weight: 600;
			border: none;
			transition: 0.3s;
			text-decoration: none;
			display: inline-flex;
			align-items: center;
			gap: 8px;
		}

		.btn-primary {
			background: var(--primary);
			color: var(--accent);
		}

		.btn-success {
			background: var(--success);
			color: white;
		}

		.form-card {
			background: white;
			padding: 25px;
			border-radius: 20px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
			margin-bottom: 25px;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 20px;
		}

		th {
			background: #f8f9fa;
			padding: 12px 10px;
			text-align: left;
			font-size: 0.8rem;
			text-transform: uppercase;
			color: #666;
			border-bottom: 2px solid var(--border);
			white-space: nowrap;
		}

		td {
			padding: 10px;
			border-bottom: 1px solid var(--border);
			vertical-align: middle;
			font-size: 0.85rem;
		}

		tr:hover {
			background: #fafafa;
		}

		.order-id {
			font-weight: 800;
			color: #2980b9;
		}

		.status-badge {
			padding: 4px 10px;
			border-radius: 6px;
			font-size: 0.75rem;
			font-weight: 700;
			background: #e3f2fd;
			color: #1976d2;
		}

		.loading {
			text-align: center;
			padding: 50px;
			font-weight: 700;
			color: #999;
		}

		.actions {
			display: flex;
			gap: 10px;
		}

		.modal {
			display: none;
			position: fixed;
			z-index: 100;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.8);
			align-items: center;
			justify-content: center;
			overflow-y: auto;
			padding: 20px;
		}

		.modal-content {
			background: white;
			width: 95%;
			max-width: 1000px;
			max-height: 95vh;
			overflow-y: auto;
			border-radius: 20px;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
			position: relative;
			animation: modalSlideIn 0.3s ease-out;
		}

		@keyframes modalSlideIn {
			from {
				opacity: 0;
				transform: translateY(-30px) scale(0.95);
			}

			to {
				opacity: 1;
				transform: translateY(0) scale(1);
			}
		}

		.modal-close {
			position: absolute;
			top: 20px;
			right: 20px;
			width: 40px;
			height: 40px;
			background: rgba(0, 0, 0, 0.6);
			color: white;
			border: none;
			border-radius: 50%;
			font-size: 1.5rem;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: 0.3s;
			z-index: 101;
		}

		.modal-close:hover {
			background: rgba(0, 0, 0, 0.9);
			transform: rotate(90deg);
		}

		.cat-weber {
			border-left: 5px solid #000;
		}

		.cat-pima {
			border-left: 5px solid #f1c40f;
		}

		.cat-duraflex {
			border-left: 5px solid #27ae60;
		}

		/* Invoice Styles in Modal */
		.invoice-container {
			background: white;
		}

		.invoice-header {
			background: linear-gradient(135deg, #f1c40f, #f39c12);
			color: #000;
			padding: 40px;
			text-align: center;
			border-radius: 20px 20px 0 0;
		}

		.invoice-container.duraflex .invoice-header {
			background: linear-gradient(135deg, #2ecc71, #27ae60);
			color: #fff;
		}

		.invoice-container.weber .invoice-header {
			background: linear-gradient(135deg, #f39c12, #e67e22);
			color: #fff;
		}

		.invoice-container.pima .invoice-header {
			background: linear-gradient(135deg, #f1c40f, #f39c12);
			color: #000;
		}

		.invoice-header h1 {
			font-size: 2rem;
			font-weight: 800;
			margin-bottom: 10px;
		}

		.invoice-header .order-id {
			font-size: 1.1rem;
			font-weight: 600;
			opacity: 0.9;
		}

		.invoice-header div {
			margin-top: 10px;
			font-size: 0.95rem;
			opacity: 0.9;
		}

		.invoice-body {
			padding: 30px;
		}

		.section {
			margin-bottom: 25px;
		}

		.section-title {
			font-size: 1.1rem;
			font-weight: 700;
			color: #2d3436;
			margin-bottom: 15px;
			padding-bottom: 8px;
			border-bottom: 3px solid #f1c40f;
		}

		.invoice-container.duraflex .section-title {
			border-bottom-color: #2ecc71;
		}

		.invoice-container.weber .section-title {
			border-bottom-color: #f39c12;
		}

		.invoice-container.pima .section-title {
			border-bottom-color: #f1c40f;
		}

		.info-grid {
			display: grid;
			grid-template-columns: repeat(2, 1fr);
			gap: 15px;
			margin-bottom: 20px;
		}

		.info-item {
			display: flex;
			gap: 10px;
		}

		.info-label {
			font-weight: 700;
			color: #666;
			min-width: 140px;
		}

		.info-value {
			color: #2d3436;
			font-weight: 500;
		}

		.products-table {
			width: 100%;
			border-collapse: collapse;
			margin: 20px 0;
		}

		.products-table thead {
			background: #2d3436;
			color: white;
		}

		.products-table th {
			padding: 12px 10px;
			text-align: left;
			font-size: 0.85rem;
			font-weight: 700;
		}

		.products-table td {
			padding: 12px 10px;
			border-bottom: 1px solid #e9ecef;
			font-size: 0.9rem;
		}

		.products-table tbody tr:hover {
			background: #f8f9fa;
		}

		.delivery-badge {
			display: inline-block;
			padding: 4px 10px;
			background: #fff3cd;
			color: #856404;
			border-radius: 6px;
			font-weight: 600;
			font-size: 0.75rem;
		}

		.summary-box {
			background: #f8f9fa;
			padding: 25px;
			border-radius: 12px;
			margin-top: 25px;
		}

		.summary-row {
			display: flex;
			justify-content: space-between;
			padding: 10px 0;
			font-size: 1rem;
		}

		.summary-row.highlight {
			color: #e67e22;
			font-weight: 600;
		}

		.summary-row.total {
			font-size: 1.5rem;
			font-weight: 800;
			color: #2d3436;
			border-top: 3px solid #f1c40f;
			padding-top: 15px;
			margin-top: 10px;
		}

		.invoice-footer {
			padding: 25px;
			background: #2d3436;
			color: white;
			text-align: center;
			border-radius: 0 0 20px 20px;
		}

		.footer-actions {
			display: flex;
			justify-content: center;
			gap: 12px;
			margin-bottom: 15px;
		}

		.btn-print {
			background: #f1c40f;
			color: #000;
			padding: 10px 25px;
			border-radius: 8px;
			border: none;
			font-weight: 700;
			cursor: pointer;
			transition: 0.3s;
		}

		.btn-print:hover {
			background: #f39c12;
		}

		/* Responsive Design - Tablet */
		@media (max-width: 1024px) {
			.container {
				max-width: 95%;
			}

			header {
				flex-direction: column;
				align-items: flex-start;
				gap: 15px;
			}

			th,
			td {
				padding: 12px;
				font-size: 0.9rem;
			}

			.modal-content {
				max-width: 90%;
				padding: 0;
			}
		}

		/* Responsive Design - Mobile */
		@media (max-width: 768px) {
			body {
				padding: 10px;
			}

			.container {
				max-width: 100%;
			}

			header {
				flex-direction: column;
				align-items: flex-start;
				margin-bottom: 20px;
				padding-bottom: 10px;
			}

			.btn {
				padding: 8px 15px;
				font-size: 0.9rem;
			}

			table {
				font-size: 0.85rem;
			}

			th,
			td {
				padding: 10px 8px;
			}

			.status-badge {
				padding: 3px 8px;
				font-size: 0.7rem;
			}

			.actions {
				flex-direction: column;
				gap: 5px;
			}

			.actions .btn {
				width: 100%;
				justify-content: center;
				padding: 8px 10px;
				font-size: 0.8rem;
			}

			.modal-content {
				width: 98%;
				max-width: 100%;
				max-height: 90vh;
				border-radius: 12px;
			}

			.modal-close {
				width: 36px;
				height: 36px;
				font-size: 1.3rem;
				top: 10px;
				right: 10px;
			}

			.invoice-header {
				padding: 30px 20px;
			}

			.invoice-header h1 {
				font-size: 1.8rem;
			}

			.invoice-header .order-id {
				font-size: 0.95rem;
			}

			.invoice-body {
				padding: 20px;
			}

			.section-title {
				font-size: 1rem;
				margin-bottom: 15px;
			}

			.info-grid {
				gap: 10px;
				margin-bottom: 15px;
			}

			.info-label {
				min-width: 100px;
				font-size: 0.9rem;
			}

			.info-value {
				font-size: 0.9rem;
			}

			.products-table {
				margin: 15px 0;
				font-size: 0.8rem;
			}

			.products-table th,
			.products-table td {
				padding: 8px 6px;
			}

			.summary-box {
				padding: 15px;
				margin-top: 20px;
			}

			.summary-row {
				padding: 8px 0;
				font-size: 0.95rem;
			}

			.summary-row.total {
				font-size: 1.3rem;
				padding-top: 10px;
			}

			.invoice-footer {
				padding: 15px;
			}

			.footer-actions {
				flex-direction: column;
				gap: 10px;
				margin-bottom: 10px;
			}

			.btn-print {
				padding: 10px 20px;
				font-size: 0.9rem;
			}
		}

		/* Extra small screens */
		@media (max-width: 480px) {
			body {
				padding: 6px;
			}

			.container {
				max-width: 100%;
			}

			header div:last-child {
				width: 100%;
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 8px;
			}

			#categoryButtons {
				grid-column: 1 / -1;
				display: flex;
				flex-wrap: wrap;
				gap: 5px;
			}

			#categoryButtons .btn {
				flex: 1 1 calc(50% - 5px);
				font-size: 0.65rem;
				padding: 8px 5px;
				justify-content: center;
			}

			.btn {
				padding: 8px 10px;
				font-size: 0.8rem;
			}

			header h1 {
				font-size: 1.2rem;
				margin-bottom: 4px;
			}

			header p {
				font-size: 0.8rem;
			}

			.form-card {
				border-radius: 12px;
				margin-bottom: 15px;
			}

			table,
			thead,
			tbody,
			th,
			td,
			tr {
				display: block !important;
				width: 100% !important;
				min-width: 0 !important;
				box-sizing: border-box;
			}

			.form-card div[style*="overflow-x: auto"] {
				overflow-x: visible !important;
			}

			thead {
				display: none !important;
			}

			tr {
				background: #fff;
				border: 1px solid var(--border);
				border-radius: 12px;
				padding: 15px;
				margin-bottom: 20px;
				box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
				position: relative;
				width: 100% !important;
				overflow: hidden;
			}

			td {
				display: flex !important;
				justify-content: space-between;
				align-items: flex-start;
				padding: 10px 0 !important;
				border-bottom: 1px dashed #eee !important;
				white-space: normal !important;
				text-align: right;
				gap: 15px;
			}

			td:last-child {
				border-bottom: none !important;
				padding-top: 15px !important;
				justify-content: center;
				text-align: center;
			}

			td::before {
				content: attr(data-label);
				font-weight: 700;
				color: #888;
				text-align: left;
				font-size: 0.7rem;
				text-transform: uppercase;
				flex: 0 0 40%;
				white-space: normal;
			}

			.order-id {
				position: static !important;
				box-shadow: none !important;
				font-size: 1.1rem !important;
				color: #2980b9 !important;
				word-break: break-all;
			}

			.actions {
				width: 100%;
			}

			.actions .btn {
				width: 100%;
				padding: 14px !important;
				font-size: 0.9rem !important;
				text-transform: uppercase;
				letter-spacing: 0.5px;
			}

			.modal-content {
				width: 96%;
				max-height: 95vh;
				border-radius: 8px;
			}

			.invoice-header {
				padding: 20px 15px;
			}

			.invoice-header h1 {
				font-size: 1.3rem;
			}

			.invoice-header .order-id {
				font-size: 0.8rem;
			}

			.invoice-body {
				padding: 12px;
			}

			.section-title {
				font-size: 0.9rem;
				margin-bottom: 10px;
			}

			.info-grid {
				gap: 8px;
			}

			.info-label {
				min-width: 90px;
				font-size: 0.8rem;
			}

			.info-value {
				font-size: 0.8rem;
			}

			.products-table th,
			.products-table td {
				padding: 6px 4px;
				font-size: 0.7rem;
			}

			.summary-row {
				font-size: 0.8rem;
				padding: 6px 0;
			}

			.summary-row.total {
				font-size: 1rem;
				padding-top: 8px;
			}

			.invoice-footer {
				padding: 12px;
			}

			.btn-print {
				padding: 8px 16px;
				font-size: 0.8rem;
			}
		}
	</style>
</head>

<body>

	<div class="container">
		<header>
			<div>
				<h1 style="font-weight: 800; text-transform: uppercase;">Quản Lý Đơn Hàng</h1>
				<p style="color: #666;">Danh sách đơn hàng từ Google Sheet</p>
			</div>
			<div id="userInfo" style="text-align: right; font-size: 0.9rem; margin-right: 20px;">
				<!-- Logged in user info will be injected here -->
			</div>
			<div style="display: flex; gap: 12px; align-items:center;">
				<a href="len-don.html" id="btnCreateOrder" class="btn btn-success" style="display: none;">+ TẠO ĐƠN
					MỚI</a>
				<a href="index.html" class="btn btn-primary">TRANG CHỦ</a>
				<div style="width:12px"></div>
				<div id="categoryButtons" style="display:flex;gap:8px;">
					<button class="btn" id="btnAll" style="background:#ffffff;border:1px solid var(--border);">TẤT
						CẢ</button>
					<button class="btn" id="btnDuraflex" style="background:#27ae60;color:#fff;">TẤM DURAFLEX</button>
					<button class="btn" id="btnWeber" style="background:#000;color:#fff;">SILICONE WEBER</button>
					<button class="btn" id="btnPima" style="background:#f1c40f;color:#000;">TRẦN NANO PIMA</button>
				</div>
			</div>
		</header>

		<div class="form-card">
			<div id="orderList" class="loading">Đang tải danh sách đơn hàng...</div>
		</div>
	</div>

	<!-- Invoice Modal -->
	<div id="invoiceModal" class="modal">
		<div class="modal-content">
			<button class="modal-close" onclick="closeInvoiceModal()">✕</button>
			<div id="invoiceContent"></div>
		</div>
	</div>

	<!-- Modal Xác Nhận Xóa -->
	<div id="confirmModal" class="modal" style="display: none;">
		<div class="modal-content"
			style="max-width: 400px; padding: 30px; text-align: center; border-radius: 20px; background: white; position: relative;">
			<div style="font-size: 3rem; color: #e74c3c; margin-bottom: 20px;">⚠️</div>
			<h2 id="confirmTitle" style="margin-bottom: 15px; color: #2d3436;">Xác nhận xóa?</h2>
			<p id="confirmMessage" style="color: #636e72; margin-bottom: 25px; line-height: 1.5;">Bạn có chắc chắn muốn
				xóa đơn hàng này không? Hành động này không thể hoàn tác.</p>
			<div style="display: flex; gap: 15px; justify-content: center;">
				<button id="btnCancelConfirm" class="btn"
					style="background: #dfe6e9; color: #2d3436; border: none; padding: 12px 25px; border-radius: 12px; cursor: pointer; font-weight: 700; flex: 1;">HỦY</button>
				<button id="btnOkConfirm" class="btn"
					style="background: #e74c3c; color: white; border: none; padding: 12px 25px; border-radius: 12px; cursor: pointer; font-weight: 700; flex: 1;">XÓA
					NGAY</button>
			</div>
		</div>
	</div>

	<style>
		#confirmModal .modal-content {
			animation: modalPop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
		}

		@keyframes modalPop {
			from {
				transform: scale(0.8);
				opacity: 0;
			}

			to {
				transform: scale(1);
				opacity: 1;
			}
		}
	</style>

	<script>
		const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzIHfOV9rW_GQ8_Xv-WWA3KAqPMONiZQPDdOdNOcYmMSMlt93KG3zZJ7Z53OJ-d-LIJZg/exec';

		document.addEventListener('DOMContentLoaded', () => {
			checkAuth();
			initCategoryButtons();
			fetchOrders(); // load all by default
		});

		function checkAuth() {
			const userData = JSON.parse(localStorage.getItem('userLoggedIn'));
			if (!userData) {
				window.location.href = 'index.html';
				return;
			}
			const userInfo = document.getElementById('userInfo');
			userInfo.innerHTML = `
				<div style="font-weight: 700; color: #2d3436;">${userData.name}</div>
				<div style="color: #d63031; cursor: pointer; text-decoration: underline;" onclick="logout()">Đăng xuất</div>
			`;

			// Show create order button only for ad mind
			const createBtn = document.getElementById('btnCreateOrder');
			if (userData.phan_loai === 'ad mind') {
				createBtn.style.display = 'inline-flex';
			} else {
				createBtn.style.display = 'none';
			}
		}

		function logout() {
			localStorage.removeItem('userLoggedIn');
			window.location.href = 'index.html';
		}

		const CATEGORY_TO_SHEET = {
			'duraflex': 'don_hang_duraflex',
			'weber': 'don_hang_weber',
			'pima': 'don_hang_pima'
		};

		function initCategoryButtons() {
			const btnAll = document.getElementById('btnAll');
			const btnDur = document.getElementById('btnDuraflex');
			const btnWeb = document.getElementById('btnWeber');
			const btnPima = document.getElementById('btnPima');

			btnAll.addEventListener('click', () => { setActiveButton(btnAll); fetchOrders(); });
			btnDur.addEventListener('click', () => { setActiveButton(btnDur); fetchOrders('duraflex'); });
			btnWeb.addEventListener('click', () => { setActiveButton(btnWeb); fetchOrders('weber'); });
			btnPima.addEventListener('click', () => { setActiveButton(btnPima); fetchOrders('pima'); });

			// initial active
			setActiveButton(document.getElementById('btnAll'));
		}

		function setActiveButton(activeBtn) {
			const btns = document.querySelectorAll('#categoryButtons .btn');
			btns.forEach(b => {
				b.style.opacity = '0.9';
				b.style.transform = 'none';
			});
			activeBtn.style.opacity = '1';
			activeBtn.style.transform = 'translateY(-1px)';
		}

		function parseCurrency(str) {
			if (!str) return 0;
			return parseInt(str.toString().replace(/[^0-9]/g, '')) || 0;
		}

		function removeAccents(str) {
			return str.normalize('NFD')
				.replace(/[\u0300-\u036f]/g, '')
				.replace(/đ/g, 'd').replace(/Đ/g, 'D');
		}

		// Helper to find value in row by trying multiple possible header names (case-insensitive & trimmed)
		function getRowValue(row, possibleLabels) {
			if (!row) return '';
			if (typeof possibleLabels === 'string') possibleLabels = [possibleLabels];

			const normalize = (s) => removeAccents((s || '').toString().toLowerCase().trim().replace(/\s+/g, ' '));

			const normLabels = possibleLabels.map(normalize);
			const rowKeys = Object.keys(row);

			// 1. Try exact or normalized match
			for (const key of rowKeys) {
				const nKey = normalize(key);
				if (normLabels.includes(nKey)) return row[key];
			}

			// 2. Try partial keyword match if no exact match (useful for long Vietnamese headers)
			for (const key of rowKeys) {
				const nKey = normalize(key);
				for (const label of normLabels) {
					if (nKey.length > 0 && nKey.includes(label)) {
						return row[key];
					}
				}
			}
			return '';
		}

		const CATEGORY_HEADERS = {
			'duraflex': ['Thời gian', 'Mã Đơn', 'Loại SP', 'Khách Hàng', 'Phân Loại KH', 'Sản Phẩm', 'Đơn Giá', 'Số Lượng', 'Thành Tiền', 'số kiện', 'số tiền chiết khấu kiện', 'số tiền còn lại trong đơn', 'Ghi Chú'],
			'weber': ['Thời gian', 'Mã Đơn', 'Loại SP', 'Khách Hàng', 'Phân Loại KH', 'Sản Phẩm', 'Đơn Giá', 'Số Lượng', 'Thành Tiền', 'số thùng', 'tổng thùng trong đơn', 'ghi chú đơn hàng'],
			'pima': ['Thời gian', 'Mã Đơn', 'Loại SP', 'Khách Hàng', 'Phân Loại KH', 'Sản Phẩm', 'Đơn Giá', 'Số Lượng', 'Thành Tiền', 'tiền hỗ trợ vận chuyển', 'tổng tiền trong đơn', 'tổng tiền hỗ trợ vận chuyển', 'số tiền còn lại trong đơn', 'ghi chú']
		};

		async function fetchOrders(category) {
			const container = document.getElementById('orderList');
			container.innerHTML = '<div class="loading">Đang tải dữ liệu...</div>';
			try {
				let rows = [];

				if (!category) {
					// fetch all and merge
					const cats = Object.keys(CATEGORY_TO_SHEET);
					// Fetch live data from Sheets
					const sheetFetches = cats.map(c => fetch(`${SCRIPT_URL}?category=${encodeURIComponent(c)}`).then(r => r.text()));
					// Fetch history data from JSON
					const historyFetches = cats.map(c => fetch(`data/history_don_hang_${c}.json`).then(r => r.ok ? r.json() : []).catch(() => []));

					const [sheetResults, historyResults] = await Promise.all([
						Promise.all(sheetFetches),
						Promise.all(historyFetches)
					]);

					const liveIds = new Set();
					sheetResults.forEach(txt => {
						const parsed = csvToJson(txt);
						parsed.forEach(r => {
							r._isHistory = false;
							const id = getRowValue(r, ["Mã Đơn", "Mã đơn", "Ma Don", "Ma don"]);
							if (id) liveIds.add(id);
						});
						rows = rows.concat(parsed);
					});

					historyResults.forEach(hData => {
						const filtered = hData.filter(r => {
							const id = getRowValue(r, ["Mã Đơn", "Mã đơn", "Ma Don", "Ma don"]);
							return !liveIds.has(id);
						});
						filtered.forEach(r => r._isHistory = true);
						rows = rows.concat(filtered);
					});

					// Filter by logged in user
					const userData = JSON.parse(localStorage.getItem('userLoggedIn'));
					if (userData && userData.phan_loai !== 'ad mind') {
						rows = rows.filter(r => {
							const customerName = getRowValue(r, ["Khách Hàng", "Khach Hang"]);
							return customerName === userData.name;
						});
					}

					if (rows.length === 0) {
						container.innerHTML = "Chưa có đơn hàng nào.";
						return;
					}

					// Gộp các dòng (Summary View)
					const ordersMap = {};
					rows.forEach(r => {
						const id = getRowValue(r, ["Mã Đơn", "Mã đơn", "Ma Don", "Ma don"]) || 'UNKNOWN';
						const rawCategory = getRowValue(r, ["Loại SP", "Loai SP", "Loại sản phẩm", "Loại"]);
						const categoryNorm = (rawCategory || '').toString().toLowerCase().trim();
						let categoryKey = 'pima';
						if (categoryNorm.includes('weber') || id.startsWith('W')) categoryKey = 'weber';
						else if (categoryNorm.includes('duraflex') || id.startsWith('D')) categoryKey = 'duraflex';

						const time = getRowValue(r, ["Thời gian", "Thoi gian"]);
						const customer = getRowValue(r, ["Khách Hàng", "Khach Hang"]);
						const custType = getRowValue(r, ["Phân Loại KH", "Loại KH", "Phan loai"]);
						const notes = getRowValue(r, ["Ghi Chú", "Ghi chú", "ghi chú", "ghi chú đơn hàng"]);

						let rowValue = 0;
						if (categoryKey === 'pima') {
							rowValue = parseCurrency(getRowValue(r, ["số tiền còn lại trong đơn", "số tiền còn lại", "Remaining Amount"]));
						} else if (categoryKey === 'duraflex') {
							rowValue = parseCurrency(getRowValue(r, ["số tiền còn lại trong đơn", "số tiền còn lại"]));
						} else {
							rowValue = parseCurrency(getRowValue(r, ["Thành Tiền", "Thanh Tien", "Thành tiền"]));
						}

						if (!ordersMap[id]) {
							ordersMap[id] = {
								id: id,
								time: time,
								category: categoryKey,
								category_display: rawCategory || (id.startsWith('P') ? 'PIMA' : id.startsWith('D') ? 'DURAFLEX' : 'WEBER'),
								customer: customer,
								customer_type: custType,
								total: rowValue,
								items: [],
								notes: notes,
								_isHistory: r._isHistory
							};
						} else {
							// Weber thì cộng dồn Thành Tiền, Pima/Duraflex thì lấy giá trị lặp lại (pick max)
							if (categoryKey === 'weber') {
								ordersMap[id].total += rowValue;
							} else {
								if (rowValue > ordersMap[id].total) ordersMap[id].total = rowValue;
							}
						}

						ordersMap[id].items.push({
							name: getRowValue(r, ["Sản Phẩm", "San Pham", "Sản phẩm"]),
							qty: getRowValue(r, ["Số Lượng", "So Luong", "Số lượng"]),
							price: getRowValue(r, ["Đơn Giá", "Don Gia", "Đơn giá"]),
							subtotal: getRowValue(r, ["Thành Tiền", "Thanh Tien", "Thành tiền"]),
							surplus: parseCurrency(getRowValue(r, ["hỗ trợ", "vận chuyển", "tiền hỗ trợ", "phần dư", "surplus"]))
						});
					});

					renderTable(Object.values(ordersMap).sort((a, b) => parseVNTime(b.time) - parseVNTime(a.time)));
				} else {
					// FULL TABLE VIEW for specific category
					const res = await fetch(`${SCRIPT_URL}?category=${encodeURIComponent(category)}`);
					const csvText = await res.text();
					const sheetRows = csvToJson(csvText);
					sheetRows.forEach(r => r._isHistory = false);
					const liveIds = new Set(sheetRows.map(r => getRowValue(r, ["Mã Đơn", "Mã đơn"])));

					let historyRows = [];
					try {
						const hRes = await fetch(`data/history_don_hang_${category}.json`);
						if (hRes.ok) {
							const hData = await hRes.json();
							historyRows = hData.filter(r => !liveIds.has(getRowValue(r, ["Mã Đơn", "Mã đơn"])));
							historyRows.forEach(r => r._isHistory = true);
						}
					} catch (e) {
						console.warn("No history for " + category);
					}

					rows = sheetRows.concat(historyRows);

					// Filter by logged in user
					const userData = JSON.parse(localStorage.getItem('userLoggedIn'));
					if (userData && userData.phan_loai !== 'ad mind') {
						rows = rows.filter(r => {
							const customerName = getRowValue(r, ["Khách Hàng", "Khach Hang"]);
							return customerName === userData.name;
						});
					}

					if (rows.length === 0) {
						container.innerHTML = "Chưa có đơn hàng nào trong mục này.";
						return;
					}

					renderCategoryFullTable(rows, category);
				}
			} catch (e) {
				console.error(e);
				container.innerHTML = `<span style="color:red">Lỗi tải dữ liệu: ${e.message}</span>`;
			}
		}

		function csvToJson(csv) {
			const lines = csv.trim().split(/\r?\n/);
			if (lines.length < 2) return [];

			// Parse header
			const headers = parseCSVLine(lines[0]);

			// Parse data rows
			const data = [];
			for (let i = 1; i < lines.length; i++) {
				if (lines[i].trim() === '') continue;
				const values = parseCSVLine(lines[i]);
				const obj = {};
				headers.forEach((h, idx) => {
					obj[h.trim()] = values[idx] ? values[idx].trim() : '';
				});
				data.push(obj);
			}
			return data;
		}

		function parseCSVLine(line) {
			const result = [];
			let current = '';
			let inQuotes = false;

			for (let i = 0; i < line.length; i++) {
				const char = line[i];
				const nextChar = line[i + 1];

				if (char === '"') {
					if (inQuotes && nextChar === '"') {
						current += '"';
						i++;
					} else {
						inQuotes = !inQuotes;
					}
				} else if (char === ',' && !inQuotes) {
					result.push(current);
					current = '';
				} else {
					current += char;
				}
			}
			result.push(current);
			return result;
		}

		function parseVNTime(str) {
			if (!str) return new Date(0);
			// Format: "23/12/2025 08:30:15" hoặc ISO
			const parts = str.split(/[ /:]/);
			if (parts.length >= 6) {
				return new Date(parts[2], parts[1] - 1, parts[0], parts[3], parts[4], parts[5]);
			}
			const d = new Date(str);
			return isNaN(d) ? new Date(0) : d;
		}

		function renderTable(orders) {
			const container = document.getElementById('orderList');
			let html = `
            <table style="min-width: 1000px;">
                <thead>
                    <tr>
                        <th style="width: 150px;">Thời gian</th>
                        <th style="width: 100px;">Mã Đơn</th>
                        <th>Khách Hàng</th>
                        <th style="width: 120px;">Loại SP</th>
                        <th>Sản phẩm</th>
                        <th style="width: 150px;">Tổng cộng</th>
                        <th style="width: 150px;">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
        `;

			const userData = JSON.parse(localStorage.getItem('userLoggedIn'));
			const isAdmin = userData && userData.phan_loai === 'ad mind';

			orders.forEach(order => {
				const catClass = `cat-${(order.category || 'pima')}`;
				const displayCat = order.category_display || (order.category ? order.category.toUpperCase() : 'PIMA');
				html += `
				<tr class="${catClass}">
					<td data-label="Thời gian" style="font-size: 0.8rem; color: #888;">${order.time}</td>
					<td data-label="Mã Đơn" class="order-id">${order.id}</td>
					<td data-label="Khách Hàng"><strong>${order.customer}</strong><br><small style="color:#999">${order.customer_type}</small></td>
					<td data-label="Loại SP"><span class="status-badge">${displayCat}</span></td>
                    <td data-label="Sản phẩm" style="font-size: 0.85rem;">
                        ${order.items.map(i => i.name).join(', ')}
                    </td>
                    <td data-label="Tổng cộng" style="font-weight: 800; color: #e67e22; font-size: 1.1rem;">${formatCurrency(order.total || 0)}</td>
                     <td class="actions">
						<button class="btn btn-primary" style="padding: 6px 14px; font-size: 0.8rem; ${order._isHistory || !isAdmin ? 'width:100%' : ''}" onclick='viewInvoice(${JSON.stringify(order).replace(/'/g, "&apos;")})'>XEM</button>
						${(!order._isHistory && isAdmin) ? `
						<button class="btn btn-warning" style="padding: 6px 14px; font-size: 0.8rem; background: #f39c12; color: white; border:none; border-radius:10px; cursor:pointer;" onclick='editOrder(${JSON.stringify(order).replace(/'/g, "&apos;")})'>SỬA</button>
						<button class="btn btn-danger" style="padding: 6px 14px; font-size: 0.8rem; background: #e74c3c; color: white; border:none; border-radius:10px; cursor:pointer;" onclick='deleteOrder(event, "${order.id}", "${order.category}")'>XÓA</button>
						` : ''}
                    </td>
                </tr>
            `;
			});

			html += `</tbody></table>`;
			container.innerHTML = `<div style="overflow-x: auto;">${html}</div>`;
		}

		function renderCategoryFullTable(rows, category) {
			const container = document.getElementById('orderList');
			const headers = CATEGORY_HEADERS[category] || Object.keys(rows[0]);

			let html = `
				<div style="overflow-x: auto;">
					<table style="min-width: 1500px;">
						<thead>
							<tr>
								${headers.map(h => `<th>${h}</th>`).join('')}
								<th>Thao tác</th>
							</tr>
						</thead>
						<tbody>
			`;

			rows.reverse().forEach(row => {
				html += `<tr>`;
				headers.forEach(h => {
					let val = getRowValue(row, h) || '';
					if (h.toLowerCase().includes('tiền') || h.toLowerCase().includes('giá') || h.toLowerCase().includes('tổng') || h.toLowerCase().includes('chiết khấu')) {
						val = formatCurrency(parseCurrency(val));
					}
					if (h === 'Mã Đơn') {
						html += `<td data-label="${h}" class="order-id">${val}</td>`;
					} else {
						html += `<td data-label="${h}">${val}</td>`;
					}
				});

				const userData = JSON.parse(localStorage.getItem('userLoggedIn'));
				const isAdmin = userData && userData.phan_loai === 'ad mind';

				// Add a simplified order object for the modal
				const orderObj = { id: row["Mã Đơn"] || row["Mã đơn"], time: row["Thời gian"], customer: row["Khách Hàng"], category: category };
				html += `
					<td class="actions">
						<button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.75rem; ${row._isHistory || !isAdmin ? 'width:100%' : ''}" onclick='viewInvoiceFromId("${row["Mã Đơn"] || row["Mã đơn"]}", "${category}")'>XEM</button>
						${(!row._isHistory && isAdmin) ? `
						<button class="btn btn-warning" style="padding: 5px 10px; font-size: 0.75rem; background: #f39c12; color: white; border:none; border-radius:10px; cursor:pointer;" onclick='editOrderFromRow(${JSON.stringify(row).replace(/'/g, "&apos;")}, "${category}")'>SỬA</button>
						<button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.75rem; background: #e74c3c; color: white; border:none; border-radius:10px; cursor:pointer;" onclick='deleteOrder(event, "${row["Mã Đơn"] || row["Mã đơn"]}", "${category}")'>XÓA</button>
						` : ''}
					</td>
				</tr>`;
			});

			html += `</tbody></table></div>`;
			container.innerHTML = html;
		}

		async function viewInvoiceFromId(orderId, category) {
			// This helper groups rows for the specific orderId to show the invoice
			const res = await fetch(`${SCRIPT_URL}?category=${encodeURIComponent(category)}`);
			const csvText = await res.text();
			const sheetRows = csvToJson(csvText);
			const liveIds = new Set(sheetRows.map(r => getRowValue(r, ["Mã Đơn", "Mã đơn"])));

			let historyRows = [];
			try {
				const hRes = await fetch(`data/history_don_hang_${category}.json`);
				if (hRes.ok) {
					const hData = await hRes.json();
					historyRows = hData.filter(r => !liveIds.has(getRowValue(r, ["Mã Đơn", "Mã đơn"])));
				}
			} catch (e) { }

			const allRows = sheetRows.concat(historyRows);

			const userData = JSON.parse(localStorage.getItem('userLoggedIn'));
			const orderRows = allRows.filter(r => {
				const isTargetOrder = (r["Mã Đơn"] || r["Mã đơn"]) === orderId;
				if (!isTargetOrder) return false;

				// Security check: only show if admin or if matches customer name
				if (userData && userData.phan_loai === 'ad mind') return true;
				const customerName = getRowValue(r, ["Khách Hàng", "Khach Hang"]);
				return customerName === (userData ? userData.name : '');
			});

			if (orderRows.length === 0) { alert("Không tìm thấy dữ liệu đơn hàng!"); return; }

			const first = orderRows[0];
			const order = {
				id: orderId,
				time: getRowValue(first, ["Thời gian", "Thoi gian"]),
				customer: getRowValue(first, ["Khách Hàng", "Khach Hang"]),
				customer_type: getRowValue(first, ["Phân Loại KH", "Loại KH", "Phan Loại KH", "Loai KH"]),
				category: category,
				notes: getRowValue(first, ["Ghi Chú", "Ghi chú", "ghi chú", "ghi chú đơn hàng"]),
				items: orderRows.map(r => ({
					name: getRowValue(r, ["Sản Phẩm", "San Pham", "Sản phẩm"]),
					qty: getRowValue(r, ["Số Lượng", "So Luong", "Số lượng"]),
					price: getRowValue(r, ["Đơn Giá", "Don Gia", "Đơn giá"]),
					subtotal: getRowValue(r, ["Thành Tiền", "Thanh Tien", "Thành tiền"]),
					promo: getRowValue(r, ["số tiền chiết khấu kiện", "chiết khấu kiện", "Chiết Khấu", "Chiet Khau", "discount_amount"]),
					delivery_type: getRowValue(r, ["Giao hàng", "Delivery"]),
					surplus: parseCurrency(getRowValue(r, ["hỗ trợ", "vận chuyển", "tiền hỗ trợ", "phần dư", "surplus"]))
				}))
			};

			// Calculate totals properly for the modal
			if (category === 'pima') {
				order.total = parseCurrency(getRowValue(first, ["số tiền còn lại trong đơn", "Tổng cộng", "Total"]));
			} else if (category === 'duraflex') {
				order.total = parseCurrency(getRowValue(first, ["số tiền còn lại trong đơn", "Tổng cộng", "Total"]));
				order.discount_total = parseCurrency(getRowValue(first, ["số tiền chiết khấu kiện", "chiết khấu kiện", "Chiết Khấu", "Chiet Khau"]));
			} else {
				order.total = orderRows.reduce((sum, r) => sum + parseCurrency(r["Thành Tiền"] || 0), 0);
			}

			viewInvoice(order);
		}

		function formatCurrency(num) {
			if (num === null || num === undefined || isNaN(num)) return "0 đ";
			return new Intl.NumberFormat('vi-VN').format(num) + ' đ';
		}

		async function viewInvoice(order) {
			// Display invoice in modal by loading the appropriate external template
			const modal = document.getElementById('invoiceModal');
			const content = document.getElementById('invoiceContent');
			console.log('Order object:', order);

			const category = ((order.category || '') + '').toLowerCase().trim();
			const catNorm = category;
			console.log('Category normalized:', catNorm);

			// Map to template file
			const templateMap = {
				'duraflex': 'phieu-don-hang-duraflex.html',
				'weber': 'phieu-don-hang-weber.html',
				'pima': 'phieu-don-hang-pima.html'
			};

			const templateFile = templateMap[catNorm] || templateMap['pima'];

			try {
				const resp = await fetch(templateFile);
				if (!resp.ok) throw new Error('Không thể load template: ' + templateFile);
				const html = await resp.text();

				// Parse template and extract the invoice container
				const parser = new DOMParser();
				const doc = parser.parseFromString(html, 'text/html');
				const invoiceNode = doc.querySelector('.invoice-container');

				if (!invoiceNode) {
					throw new Error('Template không chứa .invoice-container');
				}

				// Clone node into current document
				const clone = invoiceNode.cloneNode(true);
				clone.classList.add(catNorm); // dynamic styling by category (pima, duraflex, weber)

				// Populate fields inside clone
				const setText = (selector, text) => {
					const el = clone.querySelector(selector);
					if (el) el.textContent = text;
				};

				setText('#orderIdDisplay', `Mã đơn: ${order.id || 'N/A'}`);
				setText('#orderTimeDisplay', `Thời gian: ${order.time ? new Date(order.time).toLocaleString('vi-VN') : 'N/A'}`);
				setText('#customerName', order.customer || 'N/A');
				setText('#customerType', order.customer_type || order.phan_loai || 'N/A');

				// Products — compute category-specific pricing and promos
				const tbody = clone.querySelector('#productsTableBody');
				if (tbody) {
					tbody.innerHTML = '';
					if (!order.items || order.items.length === 0) {
						tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 30px;">Không có sản phẩm</td></tr>';
					} else {
						// Load pricing data depending on category
						let duraflexData = null;
						let chietKhauData = null;
						let weberData = null;
						let pimaData = null;
						try {
							if (catNorm === 'duraflex') {
								const [dResp, cResp] = await Promise.all([
									fetch('data/gia_duraflex.json'),
									fetch('data/chiet_khau_duraflex.json')
								]);
								duraflexData = dResp.ok ? await dResp.json() : null;
								chietKhauData = cResp.ok ? await cResp.json() : null;
							} else if (catNorm === 'weber') {
								const wResp = await fetch('data/gia_silicon_weber.json');
								weberData = wResp.ok ? await wResp.json() : null;
							} else if (catNorm === 'pima') {
								const pResp = await fetch('data/gia_web_nano.json');
								pimaData = pResp.ok ? await pResp.json() : null;
							}
						} catch (e) {
							console.warn('Không thể load pricing data:', e);
						}

						// Totals
						let computedGross = 0;
						let computedDiscount = 0;
						let computedSurplus = 0;
						let computedPackages = 0;
						let computedBoxes = 0;
						let computedDiff = 0;

						// Pre-check for Duraflex discount derivation
						if (catNorm === 'duraflex') {
							let estimatedGross = 0;
							order.items.forEach(item => {
								let up = parseCurrency(item.price || item.unit_price || 0);
								if (duraflexData) {
									const nameLower = (item.name || '').toString().toLowerCase();
									const found = duraflexData.find(p => (p["Tên sản phẩm"] || '').toString().toLowerCase().includes(nameLower) || nameLower.includes((p["Tên sản phẩm"] || '').toString().toLowerCase()));
									if (found) up = parseCurrency(found["giá niêm yết"] || up);
								}
								estimatedGross += up * (parseInt(item.qty || item.quantity || 0) || 0);
							});
							const currentTotal = parseInt(order.total || 0);
							const currentSavedCk = parseCurrency(order.discount_total || (order.items && order.items[0] ? order.items[0].promo : 0));

							if (currentSavedCk === 0 && currentTotal > 0 && currentTotal < estimatedGross) {
								order.discount_total = estimatedGross - currentTotal;
								console.log('Derived missing discount:', order.discount_total);
							}
						}

						order.items.forEach((item, index) => {
							const tr = document.createElement('tr');
							const qty = parseInt(item.qty || item.quantity || 0) || 0;
							let unitPrice = parseCurrency(item.price || item.unit_price || 0) || 0;
							let promoAmount = 0;
							let lineSubtotal = parseCurrency(item.subtotal || 0) || (unitPrice * qty);

							if (catNorm === 'duraflex') {
								// Trust the value already extracted into item.promo or order.discount_total
								let rawPromo = parseCurrency(item.promo || order.discount_total);

								if (index === 0) {
									promoAmount = rawPromo;
								} else {
									// If it's the same total repeated, don't double count
									promoAmount = 0;
								}

								if (duraflexData) {
									const nameLower = (item.name || '').toString().toLowerCase();
									const found = duraflexData.find(p => (p["Tên sản phẩm"] || '').toString().toLowerCase().includes(nameLower) || nameLower.includes((p["Tên sản phẩm"] || '').toString().toLowerCase()));
									if (found) {
										unitPrice = parseCurrency(found["giá niêm yết"] || unitPrice);
										const perPackage = parseCurrency(found["số tấm trong 1 kiện"] || 1);
										computedPackages += Math.floor(qty / perPackage);
									}
								}
								lineSubtotal = unitPrice * qty - promoAmount;
								computedDiscount += promoAmount;
							} else if (catNorm === 'weber' && weberData) {
								const nameLower = (item.name || '').toString().toLowerCase();
								const found = weberData.find(p => (p['tên sản phẩm'] || '').toString().toLowerCase().includes(nameLower) || nameLower.includes((p['tên sản phẩm'] || '').toString().toLowerCase()));
								if (found) {
									const bottlesPerBox = parseCurrency(found['số chai trong 1 thùng'] || 1);
									const listedUnit = parseCurrency(found['giá niêm yết theo chai'] || found['giá bán lẻ theo chai'] || unitPrice);
									unitPrice = listedUnit;
									const boxes = Math.floor(qty / bottlesPerBox);
									let promoText = '';
									if (boxes >= 3) {
										const freeBoxes = Math.floor(boxes / 3);
										promoText = `TẶNG ${freeBoxes} thùng`;
									} else if (boxes === 2) {
										promoText = (found['khuyến mãi 2 thùng'] || 'mua 2 thùng tặng 15 chai');
									} else if (boxes === 1) {
										promoText = (found['khuyến mãi 1 thùng'] || 'mua 1 thùng tặng 5 chai');
									}
									if (promoText) {
										item._promoNote = promoText;
									}
									lineSubtotal = unitPrice * qty;
									computedBoxes += boxes;
								}
							} else if (catNorm === 'pima' && pimaData) {
								const nameLower = (item.name || '').toString().toLowerCase();
								const found = pimaData.find(p => (p['tên sản phẩm'] || '').toString().toLowerCase().includes(nameLower) || nameLower.includes((p['tên sản phẩm'] || '').toString().toLowerCase()));
								if (found) {
									const priceKho = parseCurrency(found['giá tại kho'] || 0) || 0;
									const priceChanh = parseCurrency(found['giá ra chành'] || unitPrice);
									if ((item.delivery_type || '').toString().toLowerCase().includes('tại kho') || (item.delivery_type || '').toString().toLowerCase().includes('tai kho')) {
										unitPrice = priceKho || unitPrice;
										const diff = (priceChanh - unitPrice) * qty;
										computedDiff += diff > 0 ? diff : 0;
									} else {
										unitPrice = priceChanh || unitPrice;
									}
									lineSubtotal = unitPrice * qty;
								}
							}

							computedGross += lineSubtotal;
							computedSurplus += parseCurrency(item.surplus || 0);

							// Column 5 decision logic
							let column5Content = '-';
							if (catNorm === 'duraflex') {
								column5Content = formatCurrency(promoAmount);
							} else if (catNorm === 'weber') {
								column5Content = item._promoNote || '-';
							} else if (catNorm === 'pima') {
								const transportVal = parseInt(item.surplus || 0);
								const status = transportVal > 0 ? 'Tại kho' : 'Ra chành';
								column5Content = `<span class="delivery-badge">${status}</span>`;
							} else {
								column5Content = item.delivery_type ? `<span class="delivery-badge">${item.delivery_type}</span>` : '-';
							}

							tr.innerHTML = `
								<td>${index + 1}</td>
								<td><strong>${item.name || 'N/A'}</strong></td>
								<td>${qty}</td>
								<td>${formatCurrency(unitPrice)}</td>
								<td>${column5Content}</td>
								<td><strong>${formatCurrency(lineSubtotal)}</strong></td>
							`;
							tbody.appendChild(tr);
						});

						// After loop, handle category-specific summary population
						let finalDisplayTotal = parseCurrency(order.total || 0) || computedGross;

						if (catNorm === 'duraflex') {
							// Safety check: if discount is 0 but total is lower than gross, derive the discount
							if (computedDiscount === 0 && finalDisplayTotal < (computedGross + computedDiscount)) {
								computedDiscount = (computedGross + computedDiscount) - finalDisplayTotal;
							}

							setText('#summaryTotalPackages', computedPackages);
							setText('#summaryGross', formatCurrency(computedGross + computedDiscount));
							setText('#summaryDiscount', `- ${formatCurrency(computedDiscount)}`);
							setText('#summaryTotal', formatCurrency(finalDisplayTotal));
						} else if (catNorm === 'pima') {
							setText('#summarySurplus', formatCurrency(computedSurplus));
							setText('#summaryGross', formatCurrency(computedGross));
							setText('#summaryTotal', formatCurrency(finalDisplayTotal));

							const surplusRow = clone.querySelector('#surplusRow');
							if (surplusRow) {
								surplusRow.style.display = computedSurplus > 0 ? 'flex' : 'none';
							}
							const totalLabel = clone.querySelector('#totalLabel');
							if (totalLabel) {
								totalLabel.innerText = computedSurplus > 0 ? 'SỐ TIỀN CÒN LẠI:' : 'TỔNG CỘNG:';
							}
						} else if (catNorm === 'weber') {
							setText('#summaryTotalBoxes', computedBoxes);
							setText('#summaryTotal', formatCurrency(finalDisplayTotal));
						} else {
							setText('#summaryTotal', formatCurrency(finalDisplayTotal));
						}
					}
				}

				// Summary
				const total = parseCurrency(order.total || 0);
				const summaryEl = clone.querySelector('#summaryTotal');
				if (summaryEl) summaryEl.textContent = formatCurrency(total);

				// Notes
				if (order.notes && order.notes.trim()) {
					const notesSection = clone.querySelector('#notesSection');
					const notesEl = clone.querySelector('#orderNotes');
					if (notesSection && notesEl) {
						notesSection.style.display = 'block';
						notesEl.textContent = order.notes;
					}
				}

				// Inject clone into modal content
				content.innerHTML = '';
				content.appendChild(clone);
				modal.style.display = 'flex';
				document.body.style.overflow = 'hidden';
			} catch (e) {
				console.error(e);
				// No inline fallback — show a clear error to user
				content.innerHTML = `
					<div style="padding:24px; max-width:700px; color:#c0392b; background:#fff3f3; border-radius:8px;">
						<h3 style="margin-bottom:8px;">Lỗi tải mẫu phiếu</h3>
						<p>Không thể tải mẫu phiếu "${templateFile}". Vui lòng kiểm tra kết nối hoặc thử lại sau.</p>
					</div>
				`;
				modal.style.display = 'flex';
				document.body.style.overflow = 'hidden';
			}
		}

		function generateInvoiceHTML(order, category) {
			// Normalize category - ensure it's a clean string
			const catNorm = ((category || '') + '').toLowerCase().trim();
			console.log('generateInvoiceHTML: category input =', category, 'normalized =', catNorm);

			// Determine header color and class based on category
			let headerClass = 'pima';
			let headerGradient = 'linear-gradient(135deg, #f1c40f, #f39c12)';
			let headerTextColor = '#000';
			let footerText = 'Cảm ơn quý khách đã tin tưởng sử dụng sản phẩm Pima Nano';
			let btnColor = '#f1c40f';

			if (catNorm === 'duraflex') {
				headerClass = 'duraflex';
				headerGradient = 'linear-gradient(135deg, #2ecc71, #27ae60)';
				headerTextColor = '#fff';
				footerText = 'Cảm ơn quý khách đã tin tưởng sử dụng sản phẩm Duraflex';
				btnColor = '#2ecc71';
			} else if (catNorm === 'weber') {
				headerClass = 'weber';
				headerGradient = 'linear-gradient(135deg, #000, #222)';
				headerTextColor = '#fff';
				footerText = 'Cảm ơn quý khách đã tin tưởng sử dụng sản phẩm Weber';
				btnColor = '#000';
			}

			console.log('invoice visual: catNorm=', catNorm, 'headerGradient=', headerGradient, 'btnColor=', btnColor, 'headerTextColor=', headerTextColor);

			// Generate products table
			let productsHTML = '';
			let totalGross = 0;
			let totalSurplus = 0;

			if (!order.items || order.items.length === 0) {
				productsHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 30px;">Không có sản phẩm</td></tr>';
			} else {
				order.items.forEach((item, index) => {
					const subtotal = parseInt(item.subtotal || 0);
					const price = parseInt(item.price || 0);
					const qty = parseInt(item.qty || 0);
					const surplus = parseInt(item.surplus || 0);

					if (surplus > 0) {
						totalSurplus += surplus;
						totalGross += subtotal + surplus;
					} else {
						totalGross += subtotal;
					}

					let tableCell = `
						<tr>
							<td>${index + 1}</td>
							<td><strong>${item.name || 'N/A'}</strong></td>
							<td>${qty}</td>
							<td>${formatCurrency(price)}</td>
					`;

					if (catNorm === 'duraflex') {
						tableCell += `<td>${formatCurrency(item.promo || 0)}</td>`;
					} else if (catNorm === 'weber') {
						tableCell += `<td><span style="background: #e9ecef; padding: 4px 10px; border-radius: 5px; font-size: 0.75rem; font-weight: 700;">${item.delivery_type || '-'}</span></td>`;
					} else {
						tableCell += `<td><span style="background: #fff3cd; padding: 4px 10px; border-radius: 5px; font-size: 0.75rem; font-weight: 700; color: #856404;">${item.delivery_type || '-'}</span></td>`;
					}

					tableCell += `<td><strong>${formatCurrency(subtotal)}</strong></td></tr>`;
					productsHTML += tableCell;
				});
			}

			// Generate summary
			const total = parseInt(order.total || 0);
			let summaryHTML = '';

			if (catNorm === 'duraflex') {
				const discount = parseInt(order.discount_total || order.items.reduce((sum, i) => sum + parseInt(i.promo || 0), 0) || 0);
				const gross = total + discount;
				summaryHTML = `
					<div class="summary-row">
						<span>Tổng giá trị niêm yết:</span>
						<span>${formatCurrency(gross)}</span>
					</div>
					${discount > 0 ? `
					<div class="summary-row" style="color: #27ae60; font-weight: 700;">
						<span>Tổng chiết khấu:</span>
						<span>- ${formatCurrency(discount)}</span>
					</div>
					` : ''}
					<div class="summary-row total">
						<span>${discount > 0 ? 'SỐ TIỀN CÒN LẠI:' : 'TỔNG CỘNG:'}</span>
						<span>${formatCurrency(total)}</span>
					</div>
				`;
			} else if (catNorm === 'weber') {
				summaryHTML = `
					<div class="summary-row total">
						<span>TỔNG CỘNG:</span>
						<span>${formatCurrency(total)}</span>
					</div>
				`;
			} else {
				summaryHTML = `
					<div class="summary-row">
						<span>Tổng giá trị:</span>
						<span>${formatCurrency(totalGross)}</span>
					</div>
					${totalSurplus > 0 ? `
					<div class="summary-row" style="color: #e67e22; font-weight: 700;">
						<span>Hỗ trợ vận chuyển:</span>
						<span>- ${formatCurrency(totalSurplus)}</span>
					</div>
					` : ''}
					<div class="summary-row total">
						<span>${totalSurplus > 0 ? 'SỐ TIỀN CÒN LẠI:' : 'TỔNG CỘNG:'}</span>
						<span>${formatCurrency(total)}</span>
					</div>
				`;
			}

			const invoiceHTML = `
				<div style="max-width: 900px; margin: 0 auto; background: white; border-radius: 10px; overflow: hidden;">
					<div style="background: ${headerGradient}; color: ${headerTextColor}; padding: 30px 28px; text-align: center;">
						<h1 style="font-size: 1.8rem; font-weight: 800; margin-bottom: 6px;">PHIẾU ĐƠN HÀNG</h1>
						<div style="font-size: 0.95rem; font-weight: 600; opacity: 0.9;">Mã đơn: ${order.id || 'N/A'}</div>
						<div style="margin-top: 10px; font-size: 0.95rem; opacity: 0.9;">Thời gian: ${order.time ? new Date(order.time).toLocaleString('vi-VN') : 'N/A'}</div>
							<!-- DEBUG: hiển thị category được dùng để tạo phiếu -->
							<div style="margin-top:6px; font-size:0.85rem; opacity:0.95; font-weight:700; color: ${headerTextColor};">DEBUG category: ${catNorm}</div>
					</div>

					<div style="padding: 28px;">
						<!-- Customer Info -->
						<div style="margin-bottom: 22px;">
							<div style="font-size: 1rem; font-weight: 700; color: #2d3436; margin-bottom: 14px; padding-bottom: 6px; border-bottom: 2px solid ${catNorm === 'duraflex' ? '#2ecc71' : catNorm === 'weber' ? '#000' : '#f1c40f'};">THÔNG TIN KHÁCH HÀNG</div>
							<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-bottom: 16px;">
								<div style="display: flex; gap: 8px;">
									<span style="font-weight: 700; color: #666; min-width: 120px; font-size: 0.9rem;">Tên khách hàng:</span>
									<span style="color: #2d3436; font-weight: 500; font-size: 0.9rem;">${order.customer || 'N/A'}</span>
								</div>
								<div style="display: flex; gap: 8px;">
									<span style="font-weight: 700; color: #666; min-width: 120px; font-size: 0.9rem;">Phân loại:</span>
									<span style="color: #2d3436; font-weight: 500; font-size: 0.9rem;">${order.customer_type || 'N/A'}</span>
								</div>
							</div>
						</div>

						<!-- Products -->
						<div style="margin-bottom: 22px;">
							<div style="font-size: 1rem; font-weight: 700; color: #2d3436; margin-bottom: 14px; padding-bottom: 6px; border-bottom: 2px solid ${catNorm === 'duraflex' ? '#2ecc71' : catNorm === 'weber' ? '#000' : '#f1c40f'};">CHI TIẾT SẢN PHẨM</div>
							<table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
								<thead>
									<tr style="background: #2d3436; color: white;">
										<th style="padding: 10px; text-align: left; font-size: 0.85rem; font-weight: 700;">STT</th>
										<th style="padding: 10px; text-align: left; font-size: 0.85rem; font-weight: 700;">Tên sản phẩm</th>
										<th style="padding: 10px; text-align: left; font-size: 0.85rem; font-weight: 700;">Số lượng</th>
										<th style="padding: 10px; text-align: left; font-size: 0.85rem; font-weight: 700;">Đơn giá</th>
										<th style="padding: 10px; text-align: left; font-size: 0.85rem; font-weight: 700;">${catNorm === 'duraflex' ? 'Chiết khấu' : catNorm === 'weber' ? 'Tại kho' : 'Giao hàng'}</th>
										<th style="padding: 10px; text-align: left; font-size: 0.85rem; font-weight: 700;">Thành tiền</th>
									</tr>
								</thead>
								<tbody>
									${productsHTML}
								</tbody>
							</table>
						</div>

						<!-- Summary -->
						<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 18px;">
							${summaryHTML}
						</div>

						${order.notes ? `
						<div style="margin-bottom: 22px; margin-top: 22px;">
							<div style="font-size: 1rem; font-weight: 700; color: #2d3436; margin-bottom: 14px; padding-bottom: 6px; border-bottom: 2px solid ${catNorm === 'duraflex' ? '#2ecc71' : catNorm === 'weber' ? '#000' : '#f1c40f'};">GHI CHÚ</div>
							<p style="color: #666; line-height: 1.6;">${order.notes}</p>
						</div>
						` : ''}
					</div>

					<div style="padding: 20px 28px; background: #2d3436; color: white; text-align: center;">
						<div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 12px;">
							<button onclick="printInvoice()" style="padding: 9px 24px; border-radius: 7px; border: none; font-weight: 700; cursor: pointer; background: ${btnColor}; color: ${catNorm === 'pima' ? '#000' : '#fff'}; font-size: 0.9rem;">📄 IN PHIẾU</button>
							<button onclick="closeInvoiceModal()" style="padding: 9px 24px; border-radius: 7px; border: none; font-weight: 700; cursor: pointer; background: #95a5a6; color: white; font-size: 0.9rem;">✕ ĐÓNG</button>
						</div>
						<p style="font-size: 0.9rem; opacity: 0.8;">${footerText}</p>
					</div>
				</div>
			`;

			return invoiceHTML;
		}

		function closeInvoiceModal() {
			const modal = document.getElementById('invoiceModal');
			modal.style.display = 'none';
			document.body.style.overflow = 'auto';
		}

		function printInvoice() {
			const content = document.getElementById('invoiceContent').innerHTML;
			const printWindow = window.open('', '', 'width=800,height=600');
			printWindow.document.write(`
			<html>
			<head>
				<title>Phiếu Đơn Hàng</title>
				<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
				<style>
					* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
					body { background: white; }
					.invoice-container { background: white; }
					.footer-actions { display: none !important; }
					table { width: 100%; border-collapse: collapse; }
					th, td { padding: 10px; border: 1px solid #e9ecef; text-align: left; }
					th { background: #2d3436; color: white; }
				</style>
			</head>
			<body>${content}</body>
			</html>
		`);
			printWindow.document.close();
			setTimeout(() => {
				printWindow.print();
				printWindow.close();
			}, 250);
		}

		function generateInvoiceHTML(order) {
			let totalGross = 0;
			let totalSurplus = 0;

			let productsHTML = '';
			if (!order.items || order.items.length === 0) {
				productsHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 30px;">Không có sản phẩm</td></tr>';
			} else {
				order.items.forEach((item, index) => {
					const deliveryBadge = item.delivery_type ? `<span class="delivery-badge">${item.delivery_type}</span>` : '-';
					const surplus = parseInt(item.surplus || 0);
					const subtotal = parseInt(item.subtotal || 0);
					const price = parseInt(item.price || item.unit_price || 0);
					const qty = parseInt(item.qty || item.quantity || 0);

					if (surplus > 0) {
						totalSurplus += surplus;
						totalGross += subtotal + surplus;
					} else {
						totalGross += subtotal;
					}

					productsHTML += `
					<tr>
						<td>${index + 1}</td>
						<td><strong>${item.name || 'N/A'}</strong></td>
						<td>${qty}</td>
						<td>${formatCurrency(price)}</td>
						<td>${deliveryBadge}</td>
						<td><strong>${formatCurrency(subtotal)}</strong></td>
					</tr>
				`;
				});
			}

			const total = parseInt(order.total || 0);
			const surplusRowHTML = totalSurplus > 0 ? `
			<div class="summary-row highlight">
				<span>Hỗ trợ vận chuyển:</span>
				<span>- ${formatCurrency(totalSurplus)}</span>
			</div>
		` : '';

			const totalLabel = totalSurplus > 0 ? 'SỐ TIỀN CÒN LẠI:' : 'TỔNG CỘNG:';
			const notesHTML = order.notes && order.notes.trim() ? `
			<div class="section">
				<div class="section-title">GHI CHÚ</div>
				<p style="color: #666; line-height: 1.6;">${order.notes}</p>
			</div>
		` : '';

			return `
			<div class="invoice-container">
				<div class="invoice-header">
					<h1>PHIẾU ĐƠN HÀNG</h1>
					<div class="order-id">Mã đơn: ${order.id || 'N/A'}</div>
					<div style="margin-top: 10px; font-size: 0.95rem; opacity: 0.9;">Thời gian: ${order.time ? new Date(order.time).toLocaleString('vi-VN') : 'N/A'}</div>
				</div>

				<div class="invoice-body">
					<div class="section">
						<div class="section-title">THÔNG TIN KHÁCH HÀNG</div>
						<div class="info-grid">
							<div class="info-item">
								<span class="info-label">Tên khách hàng:</span>
								<span class="info-value">${order.customer || 'N/A'}</span>
							</div>
							<div class="info-item">
								<span class="info-label">Phân loại:</span>
								<span class="info-value">${order.customer_type || 'N/A'}</span>
							</div>
							<div class="info-item">
								<span class="info-label">Loại sản phẩm:</span>
								<span class="info-value">${order.category || 'N/A'}</span>
							</div>
						</div>
					</div>

					<div class="section">
						<div class="section-title">CHI TIẾT SẢN PHẨM</div>
						<table class="products-table">
							<thead>
								<tr>
									<th>STT</th>
									<th>Tên sản phẩm</th>
									<th>Số lượng</th>
									<th>Đơn giá</th>
									<th>Giao hàng</th>
									<th>Thành tiền</th>
								</tr>
							</thead>
							<tbody>
								${productsHTML}
							</tbody>
						</table>
					</div>

					<div class="summary-box">
						<div class="summary-row">
							<span>Tổng giá trị (Giá chành):</span>
							<span>${formatCurrency(totalGross || total)}</span>
						</div>
						${surplusRowHTML}
						<div class="summary-row total">
							<span>${totalLabel}</span>
							<span>${formatCurrency(total)}</span>
						</div>
					</div>

					${notesHTML}
				</div>

				<div class="invoice-footer">
					<div class="footer-actions">
						<button class="btn btn-print" onclick="printInvoice()">📄 IN PHIẾU</button>
					</div>
					<p style="font-size: 0.9rem; opacity: 0.8;">Cảm ơn quý khách đã tin tưởng sử dụng sản phẩm Pima Nano</p>
				</div>
			</div>
		`;
		}

		function editOrder(order) {
			// Ensure order is formatted correctly for len-don.html
			console.log('Editing order:', order);
			localStorage.setItem('editingOrder', JSON.stringify(order));
			window.location.href = 'len-don.html';
		}

		async function editOrderFromRow(row, category) {
			const orderId = row["Mã Đơn"] || row["Mã đơn"];
			// We need all rows for this order to edit
			const res = await fetch(`${SCRIPT_URL}?category=${encodeURIComponent(category)}`);
			const csvText = await res.text();
			const sheetRows = csvToJson(csvText);

			let historyRows = [];
			try {
				const hRes = await fetch(`data/history_don_hang_${category}.json`);
				if (hRes.ok) historyRows = await hRes.json();
			} catch (e) { }

			const allRows = sheetRows.concat(historyRows);
			const orderRows = allRows.filter(r => (r["Mã Đơn"] || r["Mã đơn"]) === orderId);

			if (orderRows.length === 0) { alert("Không tìm thấy dữ liệu!"); return; }

			const first = orderRows[0];
			const order = {
				id: orderId,
				time: getRowValue(first, ["Thời gian", "Thoi gian"]),
				customer: getRowValue(first, ["Khách Hàng", "Khach Hang"]),
				category: category,
				notes: getRowValue(first, ["Ghi Chú", "Ghi chú", "ghi chú", "ghi chú đơn hàng"]),
				items: orderRows.map(r => ({
					name: getRowValue(r, ["Sản Phẩm", "San Pham", "Sản phẩm"]),
					qty: getRowValue(r, ["Số Lượng", "So Luong", "Số lượng"]),
					subtotal: getRowValue(r, ["Thành Tiền", "Thanh Tien", "Thành tiền"]),
					promo: getRowValue(r, ["số tiền chiết khấu kiện", "chiết khấu kiện", "Chiết Khấu", "Chiet Khau", "discount_amount"]),
					surplus: getRowValue(r, ["tiền hỗ trợ vận chuyển", "hỗ trợ", "tiền hỗ trợ", "phần dư", "surplus"])
				})),
				discount_total: getRowValue(first, ["số tiền chiết khấu kiện", "chiết khấu kiện", "Chiết Khấu", "Chiet Khau", "tiền chiết khấu", "số tiền chiết khấu"])
			};
			editOrder(order);
		}

		// Hàm hiển thị Modal xác nhận tùy chỉnh (thay thế confirm)
		function showConfirm(title, message) {
			return new Promise((resolve) => {
				const modal = document.getElementById('confirmModal');
				const titleEl = document.getElementById('confirmTitle');
				const msgEl = document.getElementById('confirmMessage');
				const btnOk = document.getElementById('btnOkConfirm');
				const btnCancel = document.getElementById('btnCancelConfirm');

				titleEl.innerText = title;
				msgEl.innerText = message;
				modal.style.display = 'flex';

				const cleanup = (result) => {
					modal.style.display = 'none';
					btnOk.onclick = null;
					btnCancel.onclick = null;
					resolve(result);
				};

				btnOk.onclick = () => cleanup(true);
				btnCancel.onclick = () => cleanup(false);
			});
		}

		async function deleteOrder(event, orderId, category) {
			if (event) {
				event.preventDefault();
				event.stopPropagation();
			}
			console.log('--- Bắt đầu lệnh xóa ---');
			console.log('Mã đơn:', orderId);
			console.log('Loại sản phẩm (Ban đầu):', category);

			const confirmed = await showConfirm(
				"Xác nhận xóa?",
				`Bạn có chắc muốn xóa đơn hàng ${orderId}? Hành động này không thể hoàn tác.`
			);

			if (!confirmed) {
				console.log('Người dùng đã hủy xóa.');
				return;
			}

			// Xác định nút bấm để hiển thị trạng thái đang tải
			const btn = (event && event.currentTarget) ? event.currentTarget : null;
			const originalText = btn ? btn.innerText : 'XÓA';

			if (btn) {
				btn.innerText = 'Đang xóa...';
				btn.disabled = true;
			}

			// Tự động nhận diện category nếu bị thiếu hoặc là 'all'
			if (!category || category === 'all' || category === '') {
				const idPrefix = orderId.charAt(0).toUpperCase();
				category = idPrefix === 'W' ? 'weber' : (idPrefix === 'D' ? 'duraflex' : 'pima');
				console.log('Tự động nhận diện category:', category);
			}

			try {
				const payload = {
					action: 'delete_order',
					orderId: orderId,
					category: category
				};
				console.log('Gửi Payload đến Server:', payload);

				const form = new URLSearchParams();
				form.append('payload', JSON.stringify(payload));

				const res = await fetch(SCRIPT_URL, {
					method: 'POST',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
					body: form.toString()
				});

				console.log('Phản hồi HTTP Status:', res.status);

				const text = await res.text();
				console.log('Dữ liệu thô từ Server:', text);

				let json;
				try {
					json = JSON.parse(text);
				} catch (e) {
					throw new Error('Lỗi phản hồi từ server (không phải JSON)');
				}

				if (json.result === 'success') {
					console.log('Xóa thành công:', json);
					alert(`Đã xóa đơn hàng ${orderId} thành công!`);
					// Tải lại danh sách sau khi xóa
					fetchOrders();
				} else {
					throw new Error(json.message || 'Lỗi không xác định');
				}
			} catch (e) {
				console.error('LỖI KHI XÓA:', e);
				alert('Lỗi: ' + e.message);
			} finally {
				if (btn) {
					btn.innerText = originalText;
					btn.disabled = false;
				}
				console.log('--- Kết thúc quá trình xóa ---');
			}
		}

		// Close modal on clicking outside
		document.addEventListener('click', function (e) {
			const modal = document.getElementById('invoiceModal');
			if (e.target === modal) {
				closeInvoiceModal();
			}
		});

		// Close modal on ESC key
		document.addEventListener('keydown', function (e) {
			if (e.key === 'Escape') {
				closeInvoiceModal();
			}
		});
	</script>

</body>

</html>