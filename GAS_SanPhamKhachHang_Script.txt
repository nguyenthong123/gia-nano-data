/**
 * GAS SCRIPT QUẢN LÝ SẢN PHẨM KHÁCH HÀNG
 * Chức năng: Xem, Thêm, Sửa, Xóa Sản Phẩm và Upload Ảnh
 * Chỉ làm việc với sheet: tao_san_pham
 */

const SPREADSHEET_ID = '1x_DgdgVJVjkzZt8_e7Zg0gqDnG7oHmV0H7DgebVzD3E';
const SHEET_NAME = 'tao_san_pham';
const IMAGE_FOLDER_ID = '1iIG2DNVH7hYKG0z74oDGaY3ndGWLqu_S';

function doGet(e) {
  try {
    const action = e.parameter.action;
    const email = e.parameter.username || e.parameter.email; // Lọc theo email người tạo nếu cần

    if (action === 'read') return readData(email);
    
    return jsonResponse({success: false, message: 'Invalid GET action: ' + action});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function doPost(e) {
  let payload = null;
  try {
    if (e.postData && e.postData.contents) {
      payload = JSON.parse(e.postData.contents);
    }
  } catch (err) { payload = null; }

  if (!payload && e.parameter && e.parameter.payload) {
    try {
      payload = JSON.parse(e.parameter.payload);
    } catch (err) {
      return jsonResponse({success: false, message: 'Invalid payload: ' + err.toString()});
    }
  }

  if (!payload) return jsonResponse({success: false, message: 'No payload found'});

  try {
    const action = String(payload.action || '').trim().toLowerCase();

    if (action === 'upload') return uploadFile(payload);
    if (action === 'create' || action === 'update') return upsertProduct(payload.data, payload.idValue);
    if (action === 'delete') return deleteProduct(payload.idValue);

    return jsonResponse({success: false, message: 'Invalid POST action: ' + action});
  } catch (err) {
    return jsonResponse({success: false, message: 'System Error: ' + err.toString()});
  }
}

// --- CORE FUNCTIONS ---

function readData(email) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName(SHEET_NAME);
    
    // Tự tạo sheet nếu chưa có
    if (!sheet) {
      sheet = ss.insertSheet(SHEET_NAME);
      sheet.appendRow(['id_san_pham', 'image_san_pham', 'ten_nghanh_hang', 'ten_san_pham', 'gia_san_pham', 'ten_dang_nhap', 'trang_thai_xoa_sp']);
    }

    const values = sheet.getDataRange().getValues();
    if (values.length < 2) return jsonResponse({success: true, data: []});

    const rawHeaders = values[0];
    const headers = rawHeaders.map(normalizeHeader);
    
    // Tìm các cột quan trọng
    let emailIdx = getColIdx(headers, 'tendangnhap');
    if (emailIdx === -1) emailIdx = getColIdx(headers, 'maildangnhap');
    
    let deleteIdx = getColIdx(headers, 'trangthaixoasp');
    if (deleteIdx === -1) deleteIdx = getColIdx(headers, 'trangthaixoa');

    const data = [];
    for (let i = 1; i < values.length; i++) {
        const row = values[i];
        if (!row.join('').trim()) continue;

        // Xây dựng object dữ liệu
        let obj = {};
        rawHeaders.forEach((h, index) => {
           const val = row[index];
           const normH = normalizeHeader(h);
           obj[normH] = val;                          // Key chuẩn hóa (idsanpham)
           obj[h] = val;                              // Key gốc (id_san_pham)
           if (normH === 'idsanpham') obj['id_san_pham'] = val; // Đảm bảo key frontend cần
        });

        const itemEmail = emailIdx !== -1 ? String(row[emailIdx]).trim() : '';
        const isDeleted = deleteIdx !== -1 ? String(row[deleteIdx]) === 'DELETED' : false;

        if (!isDeleted) {
           // Nếu có truyền email lọc thì chỉ lấy đúng email đó, hoặc lấy tất cả nếu không truyền
           if (!email || emailIdx === -1 || itemEmail.toLowerCase() === email.toLowerCase()) {
             data.push(obj);
           }
        }
    }
    return jsonResponse({success: true, data: data});
  } catch (err) { 
    return jsonResponse({success: false, message: err.toString()}); 
  }
}

function upsertProduct(data, idValue) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName(SHEET_NAME);
    if (!sheet) {
      sheet = ss.insertSheet(SHEET_NAME);
      sheet.appendRow(['id_san_pham', 'image_san_pham', 'ten_nghanh_hang', 'ten_san_pham', 'gia_san_pham', 'ten_dang_nhap', 'trang_thai_xoa_sp']);
    }

    const values = sheet.getDataRange().getValues();
    const rawHeaders = values[0];
    const headers = rawHeaders.map(normalizeHeader);

    const idColName = 'id_san_pham';
    const normIdCol = 'idsanpham';
    let idIdx = headers.indexOf(normIdCol);
    if (idIdx === -1) idIdx = headers.indexOf(normalizeHeader(idColName));

    // Logic tạo ID tự động S001, S002...
    let currentId = idValue || data[idColName] || data[normIdCol] || '';
    if (!currentId && idIdx !== -1) {
       let maxNum = 0;
       if (values.length > 1) {
         values.slice(1).forEach(r => {
            const val = String(r[idIdx]);
            if (val.startsWith('S')) {
               const num = parseInt(val.substring(1));
               if (!isNaN(num) && num > maxNum) maxNum = num;
            }
         });
       }
       currentId = 'S' + String(maxNum + 1).padStart(3, '0');
       data[idColName] = currentId;
    }

    // Tìm dòng để update
    let rowIndex = -1;
    if (currentId && idIdx !== -1) {
      for (let i = 1; i < values.length; i++) {
         if (String(values[i][idIdx]) === String(currentId)) {
            rowIndex = i + 1;
            break;
         }
      }
    }

    // Map dữ liệu vào đúng cột
    const newRow = rawHeaders.map(h => {
       const normH = normalizeHeader(h);
       // Ưu tiên khớp chính xác key, sau đó khớp key chuẩn hóa
       let val = data[h];
       if (val === undefined) val = data[normH];
       // Tìm fallback nếu data dùng key khác nhưng chuẩn hóa giống nhau
       if (val === undefined) {
          const key = Object.keys(data).find(k => normalizeHeader(k) === normH);
          if (key) val = data[key];
       }
       return val !== undefined ? val : '';
    });

    if (rowIndex !== -1) {
       sheet.getRange(rowIndex, 1, 1, newRow.length).setValues([newRow]);
    } else {
       sheet.appendRow(newRow);
    }

    return jsonResponse({success: true, id: currentId});

  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function deleteProduct(idValue) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAME);
    if (!sheet) return jsonResponse({success: false, message: 'Sheet not found'});

    const values = sheet.getDataRange().getValues();
    const headers = values[0].map(normalizeHeader);
    
    let idIdx = headers.indexOf('idsanpham');
    let deleteIdx = headers.indexOf('trangthaixoasp');
    if (deleteIdx === -1) deleteIdx = headers.indexOf('trangthaixoa');

    if (idIdx === -1 || deleteIdx === -1) {
       return jsonResponse({success: false, message: 'Missing ID or Delete status column'});
    }

    let found = false;
    for (let i = 1; i < values.length; i++) {
       if (String(values[i][idIdx]) === String(idValue)) {
          sheet.getRange(i + 1, deleteIdx + 1).setValue('DELETED');
          found = true;
          break; // Xóa 1 dòng là đủ
       }
    }

    return jsonResponse({success: true, found: found});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

// --- HELPER FUNCTIONS ---

function uploadFile(payload) {
  try {
    const folder = DriveApp.getFolderById(IMAGE_FOLDER_ID);
    const blob = Utilities.newBlob(Utilities.base64Decode(payload.file), payload.mimeType, payload.filename);
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    return jsonResponse({success: true, url: 'https://lh3.googleusercontent.com/d/' + file.getId()});
  } catch (err) { return jsonResponse({success: false, message: err.toString()}); }
}

function normalizeHeader(h) {
  if (!h) return '';
  return String(h).trim()
    .replace(/đ/g, 'd').replace(/Đ/g, 'd')
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .replace(/[\s_]+/g, '').toLowerCase();
}

function getColIdx(headers, searchName) {
  return headers.indexOf(normalizeHeader(searchName));
}

function jsonResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}
