<!DOCTYPE html>
<html lang="vi">

<head>
	<!-- Google tag (gtag.js) -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=G-QFQ2HMYTDH"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag() { dataLayer.push(arguments); }
		gtag('js', new Date());

		gtag('config', 'G-QFQ2HMYTDH');
	</script>

	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Qu·∫£n L√Ω Nh√¢n Vi√™n | Dunvex Admin</title>
	<link rel="icon" type="image/svg+xml"
		href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23FACC15'/><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' fill='white' font-size='60' font-family='sans-serif' font-weight='800'>DV</text></svg>">
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@600;800&display=swap"
		rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script src="security-utils.js"></script>
	<script>
		const session = SecurityProvider.validateAccess();
		const currentUser = session ? session.user : null;
		const perms = session ? session.permissions : null;
	</script>
	<link rel="stylesheet" href="assets/theme.css">
	<script src="assets/theme-toggle.js"></script>
	<style>
		/* Variables handled in theme.css */

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
			text-rendering: optimizeLegibility;
			-webkit-font-smoothing: antialiased;
			-moz-osx-font-smoothing: grayscale;
		}

		body {
			/* Background handled by theme.css */
			min-height: 100vh;
			padding: 40px 20px;
			-webkit-text-size-adjust: 100%;
		}

		.container {
			max-width: 1000px;
			margin: 0 auto;
		}

		/* Top Bar */
		.top-bar {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 40px;
			gap: 20px;
		}

		.top-bar-actions {
			display: flex;
			align-items: center;
			gap: 12px;
		}

		.user-info {
			display: flex;
			align-items: center;
			gap: 8px;
			background: var(--card-bg);
			padding: 6px 12px;
			border-radius: 99px;
			border: 1px solid var(--glass-border);
			white-space: nowrap;
			overflow: hidden;
			max-width: 200px;
		}

		.user-info span {
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
			max-width: 100px;
		}

		.avatar {
			width: 32px;
			height: 32px;
			background: var(--primary);
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 800;
			font-size: 0.8rem;
			color: #0f172a;
		}

		.btn-logout {
			background: transparent;
			border: 1px solid var(--glass-border);
			color: var(--text-muted);
			padding: 8px 16px;
			border-radius: 12px;
			cursor: pointer;
			transition: all 0.3s ease;
		}

		.btn-logout:hover {
			background: rgba(239, 68, 68, 0.1);
			color: #ef4444;
			border-color: rgba(239, 68, 68, 0.2);
		}

		.admin-section {
			background: white;
			border: 1px solid #e2e8f0;
			border-radius: 24px;
			padding: 32px;
			margin-bottom: 32px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
		}

		.admin-grid {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 24px;
			margin-bottom: 32px;
		}

		@media (max-width: 900px) {
			.admin-grid {
				grid-template-columns: 1fr;
			}
		}

		h2 {
			font-size: 1.25rem;
			margin-bottom: 20px;
			display: flex;
			align-items: center;
			gap: 12px;
			color: #0f172a;
			font-weight: 800;
		}

		.role-form {
			display: flex;
			flex-direction: column;
			gap: 16px;
		}

		.form-row {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 12px;
		}

		@media (max-width: 600px) {
			.form-row {
				grid-template-columns: 1fr;
			}
		}

		.form-group label {
			display: block;
			font-size: 0.8rem;
			color: #475569;
			margin-bottom: 6px;
			font-weight: 700;
			text-transform: uppercase;
		}

		input,
		select {
			width: 100%;
			background: white !important;
			border: 1.5px solid #cbd5e1 !important;
			border-radius: 12px;
			padding: 12px 14px;
			color: #0f172a !important;
			outline: none;
			transition: all 0.3s ease;
			font-size: 0.9rem;
			font-weight: 600;
		}

		input:focus,
		select:focus {
			border-color: var(--primary) !important;
			box-shadow: 0 0 0 4px rgba(250, 204, 21, 0.15);
		}

		.btn-action {
			background: var(--primary);
			color: white;
			border: none;
			padding: 10px 20px;
			border-radius: 10px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.3s ease;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
		}

		.btn-action:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(99, 102, 241, 0.3);
		}

		.btn-secondary-action {
			background: rgba(192, 132, 252, 0.15);
			color: var(--accent-purple);
		}

		.btn-action:disabled {
			background: #334155 !important;
			color: #64748b !important;
			cursor: not-allowed !important;
			opacity: 0.7;
			transform: none !important;
			box-shadow: none !important;
		}

		.btn-edit {
			padding: 4px 10px;
			font-size: 0.75rem;
			border-radius: 4px;
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid var(--glass-border);
			color: var(--text-main);
			cursor: pointer;
		}

		.btn-edit:hover {
			background: var(--primary);
			color: white;
		}

		/* Sub-tabs for Report */
		.sub-tab-content {
			display: none;
		}

		.sub-tab-content.active {
			display: block;
			animation: fadeIn 0.3s ease-in-out;
		}

		.sub-tabs-nav {
			display: flex;
			gap: 12px;
			margin: 32px 0 16px;
			padding: 0 4px;
		}

		.sub-tab-btn {
			padding: 8px 16px;
			background: rgba(255, 255, 255, 0.03);
			border: 1px solid var(--glass-border);
			color: var(--text-muted);
			border-radius: 10px;
			cursor: pointer;
			font-size: 0.85rem;
			font-weight: 500;
			transition: all 0.3s ease;
		}

		.sub-tab-btn.active {
			background: var(--primary);
			color: #0f172a;
			border-color: var(--primary);
			box-shadow: 0 4px 12px rgba(250, 204, 21, 0.2);
		}

		/* Table Section */
		.user-list-container {
			width: 100%;
			overflow-x: auto;
			-webkit-overflow-scrolling: touch;
			margin-bottom: 20px;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 10px;
		}

		#permissionTable {
			min-width: 1800px;
		}

		#userTable {
			min-width: 800px;
		}

		th {
			text-align: left;
			padding: 16px;
			color: var(--text-muted);
			font-weight: 500;
			font-size: 0.8rem;
			text-transform: uppercase;
			letter-spacing: 0.05em;
			border-bottom: 1px solid var(--glass-border);
			white-space: normal;
			line-height: 1.2;
		}

		td {
			padding: 16px;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
			font-size: 0.95rem;
		}

		.role-badge {
			padding: 4px 10px;
			border-radius: 6px;
			font-size: 0.75rem;
			font-weight: 600;
		}

		.badge-admin {
			background: rgba(250, 204, 21, 0.15);
			color: #b45309;
			/* Darker Yellow/Amber for text readability */
		}

		.badge-user {
			background: rgba(34, 197, 94, 0.15);
			color: #4ade80;
		}

		.status-dot {
			display: inline-block;
			width: 8px;
			height: 8px;
			border-radius: 50%;
			margin-right: 6px;
		}

		.status-active {
			background: #22c55e;
		}

		.status-locked {
			background: #ef4444;
		}

		.loading-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(15, 23, 42, 0.8);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 1000;
		}

		.loader {
			width: 48px;
			height: 48px;
			border: 5px solid #FFF;
			border-bottom-color: var(--primary);
			border-radius: 50%;
			animation: rotation 1s linear infinite;
		}

		@keyframes rotation {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		#toast {
			position: fixed;
			bottom: 20px;
			right: 20px;
			padding: 16px 24px;
			border-radius: 12px;
			background: #1e293b;
			color: white;
			box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
			transform: translateY(100px);
			transition: transform 0.3s ease;
			z-index: 1001;
		}

		#toast.show {
			transform: translateY(0);
		}

		/* Tabs */
		.tabs-nav {
			display: flex;
			flex-wrap: wrap;
			gap: 12px;
			margin-bottom: 30px;
			padding-bottom: 20px;
			border-bottom: 1px solid var(--glass-border);
		}

		.tab-btn {
			padding: 12px 16px;
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid var(--glass-border);
			color: var(--text-muted);
			border-radius: 12px;
			cursor: pointer;
			font-weight: 600;
			font-size: 0.85rem;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			text-align: center;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
		}

		.tab-btn.active {
			background: rgba(99, 102, 241, 0.1);
			color: var(--primary);
			border-color: rgba(99, 102, 241, 0.2);
		}

		.tab-content {
			display: none;
		}

		.tab-content.active {
			display: block;
			animation: fadeIn 0.4s ease-out;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.filter-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
			gap: 16px;
			align-items: flex-end;
		}

		.report-summary {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 20px;
			margin-top: 30px;
		}

		.summary-card {
			background: rgba(255, 255, 255, 0.03);
			border: 1px solid var(--glass-border);
			padding: 20px;
			border-radius: 16px;
			text-align: center;
		}

		.summary-card h4 {
			font-size: 0.8rem;
			color: var(--text-muted);
			margin-bottom: 8px;
		}

		.summary-card .value {
			font-size: 1.5rem;
			font-weight: 800;
			color: var(--primary);
		}

		/* Custom Toggle Switch for Permissions */
		.perm-toggle {
			position: relative;
			display: inline-block;
			width: 44px;
			height: 24px;
			cursor: pointer;
		}

		.perm-toggle input {
			opacity: 0;
			width: 0;
			height: 0;
		}

		.perm-slider {
			position: absolute;
			cursor: pointer;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: rgba(255, 255, 255, 0.05);
			border: 1px solid var(--glass-border);
			transition: .3s;
			border-radius: 24px;
		}

		.perm-slider:before {
			position: absolute;
			content: "";
			height: 18px;
			width: 18px;
			left: 2px;
			bottom: 2px;
			background-color: var(--text-muted);
			transition: .3s;
			border-radius: 50%;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
		}

		input:checked+.perm-slider {
			background-color: var(--primary);
			border-color: var(--primary);
		}

		input:checked+.perm-slider:before {
			transform: translateX(20px);
			background-color: white;
		}

		input:focus+.perm-slider {
			box-shadow: 0 0 1px var(--primary);
		}

		input:disabled+.perm-slider {
			opacity: 0.3;
			cursor: not-allowed;
		}

		@media (max-width: 768px) {
			body {
				padding: 15px 10px;
			}

			.top-bar {
				flex-direction: row;
				gap: 10px;
				align-items: center;
				justify-content: center;
				margin-bottom: 25px;
			}

			.top-bar h1 {
				display: none;
				/* Hide title to save space as requested */
			}

			.top-bar-actions {
				display: flex;
				flex-wrap: wrap;
				gap: 6px;
				width: 100%;
				justify-content: center;
				order: 2;
			}

			.top-bar-actions .user-info {
				flex: 1 0 100%;
				/* Full width for profile pill on small screens */
				justify-content: center;
				margin-bottom: 5px;
				grid-column: auto;
				max-width: none;
			}

			.btn-logout {
				flex: 1 1 auto;
				padding: 8px 10px;
				font-size: 0.75rem;
				min-width: 80px;
				justify-content: center;
				background: rgba(255, 255, 255, 0.05);
			}

			.admin-section {
				padding: 20px 15px;
				border-radius: 16px;
			}

			.tabs-nav {
				grid-template-columns: 1fr 1fr;
			}

			#nav_checkin {
				grid-column: span 2;
			}

			.role-form {
				grid-template-columns: 1fr;
			}

			.btn-update {
				width: 100%;
			}

			input,
			select,
			.btn-action {
				min-height: 48px;
			}
		}
	</style>
</head>

<body>
	<div class="loading-overlay" id="loader">
		<div class="loader"></div>
	</div>

	<div class="container">
		<div class="top-bar">
			<h1>Dunvex Admin</h1>
			<div class="top-bar-actions">
				<a href="index.html" class="btn btn-glass" style="height: auto; padding: 10px 18px;">
					<i class="fa-solid fa-house"></i> Trang ch·ªß
				</a>
				<button class="btn-logout"
					style="background: rgba(34, 197, 94, 0.1); color: #22c55e; border-color: rgba(34, 197, 94, 0.2);"
					onclick="syncSystem()">‚öôÔ∏è ƒê·ªìng B·ªô</button>
				<div class="user-info">
					<div class="avatar" id="avatarLetter">A</div>
					<span id="adminName">Admin</span>
				</div>
				<button class="btn-logout" onclick="logout()">Tho√°t</button>
			</div>
		</div>

		<div class="tabs-nav">
			<button class="tab-btn active" onclick="switchTab('hr')">üë• Qu·∫£n L√Ω Nh√¢n S·ª±</button>
			<button class="tab-btn" onclick="switchTab('report')">üìä B√°o C√°o Doanh Thu</button>
			<button id="nav_checkin" class="tab-btn" onclick="window.location.href='admin-checkin-summary.html'">üìç T·ªïng
				H·ª£p
				Check-in</button>
		</div>

		<!-- HR MANAGEMENT TAB -->
		<div id="tab-hr" class="tab-content active">
			<div class="admin-grid">
				<!-- CREATE NEW USER -->
				<div class="admin-section">
					<h2>‚ûï T·∫°o Nh√¢n Vi√™n M·ªõi</h2>
					<form class="role-form" id="createUserForm">
						<div class="form-group">
							<label>H·ªç v√† T√™n</label>
							<input type="text" id="newFullName" placeholder="Nguy·ªÖn VƒÉn B" required>
						</div>
						<div class="form-row">
							<div class="form-group">
								<label>Email (ƒêƒÉng nh·∫≠p)</label>
								<input type="email" id="newEmail" placeholder="nv@gmail.com" required>
							</div>
							<div class="form-group">
								<label>Vai Tr√≤ Ban ƒê·∫ßu</label>
								<select class="role-select-list" id="newRoleSelect">
									<option value="">-- ƒêang t·∫£i vai tr√≤ --</option>
									<option value="R002">Sale</option>
									<option value="R003">Kho</option>
									<option value="R004">K·∫ø to√°n</option>
									<option value="R005">Kh√°ch h√†ng</option>
								</select>
							</div>
						</div>
						<p style="font-size: 0.7rem; color: var(--text-muted);">* M·∫≠t kh·∫©u m·∫∑c ƒë·ªãnh: <b>123456</b></p>
						<button type="submit" class="btn-action">T·∫°o T√†i Kho·∫£n</button>
					</form>
				</div>

				<!-- UPDATE EXISTING USER -->
				<div class="admin-section">
					<h2>‚ö° G√°n L·∫°i Vai Tr√≤</h2>
					<form class="role-form" id="updateRoleForm">
						<div class="form-group">
							<label>Email Nh√¢n Vi√™n</label>
							<input type="email" id="targetEmail" placeholder="Ch·ªçn t·ª´ b·∫£ng b√™n d∆∞·ªõi" required>
						</div>
						<div class="form-group">
							<label>Vai Tr√≤ M·ªõi</label>
							<select class="role-select-list" id="roleSelect">
								<option value="">-- ƒêang t·∫£i vai tr√≤ --</option>
								<option value="R001">Admin</option>
								<option value="R002">Sale</option>
								<option value="R003">Kho</option>
								<option value="R004">K·∫ø to√°n</option>
								<option value="R005">Kh√°ch h√†ng</option>
							</select>
						</div>
						<div style="height: 14px;"></div>
						<button type="submit" class="btn-action btn-secondary-action">C·∫≠p Nh·∫≠t Quy·ªÅn</button>
					</form>
				</div>
			</div>

			<div class="admin-section">
				<h2>üõ°Ô∏è C·∫•u H√¨nh Quy·ªÅn Truy C·∫≠p</h2>
				<p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 20px;">* Ch·ªânh s·ª≠a quy·ªÅn tr·ª±c ti·∫øp
					cho
					t·ª´ng Vai tr√≤. C√°c thay ƒë·ªïi s·∫Ω c√≥ hi·ªáu l·ª±c ngay khi ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p l·∫°i.</p>
				<div class="user-list-container">
					<table id="permissionTable">
						<thead>
							<tr>
								<th>Vai Tr√≤</th>
								<th style="min-width: 100px;">Qu·∫£n l√Ω b·ªüi</th>
								<th style="text-align:center">üìä CRM &<br>Sales <i class="fas fa-lock"
										style="font-size: 0.7rem; opacity: 0.5;"></i></th>
								<th style="text-align:center">Qu·∫£n l√Ω<br>S·∫£n ph·∫©m <i class="fas fa-lock"
										style="font-size: 0.7rem; opacity: 0.5;"></i></th>
								<th style="text-align:center">Danh s√°ch<br>ƒë∆°n h√†ng <i class="fas fa-lock"
										style="font-size: 0.7rem; opacity: 0.5;"></i></th>
								<th style="text-align:center">Qu·∫£n l√Ω<br>nh√¢n vi√™n <i class="fas fa-lock"
										style="font-size: 0.7rem; opacity: 0.5;"></i></th>
								<th style="text-align:center">Xem<br>B·∫£ng gi√° <i class="fas fa-lock"
										style="font-size: 0.7rem; opacity: 0.5;"></i></th>
								<th style="text-align:center" id="th_logi">Qu·∫£n l√Ω<br>Kho v·∫≠n <i class="fas fa-lock"
										style="font-size: 0.7rem; opacity: 0.5;"></i></th>
								<th style="text-align:center" id="th_inventory">‚ûï Nh·∫≠p/Xu·∫•t<br>kho <i
										class="fas fa-lock" style="font-size: 0.7rem; opacity: 0.5;"></i></th>
								<th style="text-align:center" id="th_warehouse">‚ûñ L·ªánh<br>Xu·∫•t kho <i
										class="fas fa-lock" style="font-size: 0.7rem; opacity: 0.5;"></i></th>
								<th style="text-align:center" id="th_delivery">üöö Giao<br>h√†ng <i class="fas fa-lock"
										style="font-size: 0.7rem; opacity: 0.5;"></i></th>
								<th style="text-align:center; color: #4ade80;" id="th_mail_staff">üì© Mail<br>Nh√¢n vi√™n
									<i class="fas fa-lock" id="lock_mail_staff"
										style="font-size: 0.7rem; opacity: 0.5;"></i>
								</th>
								<th style="text-align:center; color: #818cf8;" id="th_mail_admin">üì© Mail<br>Admin <i
										class="fas fa-lock" id="lock_mail_admin"
										style="font-size: 0.7rem; opacity: 0.5;"></i></th>
								<th style="text-align:center" id="th_checkin_summary">üìç T·ªïng h·ª£p<br>Check-in <span
										id="label_checkin_summary"
										style="font-size: 0.65rem; font-weight: 800; padding: 2px 6px; border-radius: 4px;"></span>
									<i class="fas fa-lock" id="lock_checkin_summary"
										style="font-size: 0.7rem; opacity: 0.5;"></i>
								</th>
								<th style="text-align:center; color: #fbbf24;" id="th_cong_no">üí∞ Qu·∫£n l√Ω<br>C√¥ng n·ª£
									<i class="fas fa-lock" id="lock_cong_no"
										style="font-size: 0.7rem; opacity: 0.5;"></i>
								</th>

								<th style="text-align:center; color: #10b981;" id="th_hr_new">üè¢ Qu·∫£n l√Ω<br>Nh√¢n s·ª± m·ªõi
									<span id="label_hr_new"
										style="font-size: 0.65rem; font-weight: 800; padding: 2px 6px; border-radius: 4px;"></span>
									<i class="fas fa-lock" id="lock_hr_new"
										style="font-size: 0.7rem; opacity: 0.5;"></i>
								</th>
								<th style="text-align:center; color: #a855f7;" id="th_price_analysis">üìà Ph√¢n
									t√≠ch<br>gi√°
									<i class="fas fa-lock" id="lock_price_analysis"
										style="font-size: 0.7rem; opacity: 0.5;"></i>
								</th>
								<th style="text-align:center; color: #22c55e;" id="th_profit_analysis">üìä B√°o c√°o<br>L·ª£i
									nhu·∫≠n
									<i class="fas fa-lock" id="lock_profit_analysis"
										style="font-size: 0.7rem; opacity: 0.5;"></i>
								</th>
								<th style="text-align:center; color: #f59e0b;">‚öôÔ∏è C·∫•u h√¨nh<br>HR</th>
								<th style="text-align:center; color: #38bdf8;">üîç Tra c·ª©u<br>S·∫£n ph·∫©m</th>
								<th style="text-align:center">Thao t√°c</th>
							</tr>
						</thead>
						<tbody id="permissionTableBody">
							<!-- Data will be loaded here -->
						</tbody>
					</table>
				</div>
			</div>

			<div class="admin-section">
				<h2>üë• Danh S√°ch T√†i Kho·∫£n</h2>
				<div class="user-list-container">
					<table id="userTable">
						<thead>
							<tr>
								<th>ID</th>
								<th>H·ªç v√† T√™n</th>
								<th>Email</th>
								<th>Thu·ªôc nh√≥m</th>
								<th>Tr·∫°ng th√°i</th>
								<th>H√†nh ƒê·ªông</th>
							</tr>
						</thead>
						<tbody id="userTableBody">
							<!-- Data will be loaded here -->
						</tbody>
					</table>
				</div>
			</div>
		</div> <!-- End tab-hr -->

		<!-- REPORT TAB -->
		<div id="tab-report" class="tab-content">
			<div class="admin-section">
				<h2>üìà L·ªçc D·ªØ Li·ªáu Doanh Thu</h2>
				<div class="filter-grid">
					<div class="form-group">
						<label>T·ª´ ng√†y</label>
						<input type="date" id="reportStart">
					</div>
					<div class="form-group">
						<label>ƒê·∫øn ng√†y</label>
						<input type="date" id="reportEnd">
					</div>
					<div class="form-group">
						<label>Nh√¢n vi√™n</label>
						<select id="reportStaffSelect">
							<option value="ALL">-- T·∫•t c·∫£ nh√¢n vi√™n --</option>
						</select>
					</div>
					<div class="form-group">
						<label>Tr·∫°ng th√°i</label>
						<select id="reportStatusSelect">
							<option value="ALL">-- T·∫•t c·∫£ tr·∫°ng th√°i --</option>
							<option value="ƒë∆°n ch·ªët" selected>ƒê∆°n ch·ªët</option>
							<option value="ƒëang x·ª≠ l√Ω">ƒêang x·ª≠ l√Ω</option>
							<option value="ƒë∆°n nh√°p">ƒê∆°n nh√°p</option>
							<option value="ƒë√£ h·ªßy">ƒê√£ h·ªßy</option>
						</select>
					</div>
					<button class="btn-action" id="btnFilterReport" onclick="fetchRevenueReport()">üîç L·ªçc D·ªØ
						Li·ªáu</button>
				</div>
			</div>

			<div class="report-summary" id="revenueSummary" style="display:none;">
				<div class="summary-card">
					<h4>T·ªïng S·ªë ƒê∆°n</h4>
					<div class="value" id="sumOrderCount">0</div>
				</div>
				<div class="summary-card">
					<h4>T·ªïng Doanh Thu</h4>
					<div class="value" id="sumTotalRevenue">0 ‚Ç´</div>
				</div>
				<div class="summary-card">
					<h4>Kh√°ch H√†ng M·ªõi</h4>
					<div class="value" id="sumNewCustomers">0</div>
				</div>
				<button class="btn-action btn-secondary-action" id="btnSendReport" style="grid-column: span 1;"
					onclick="sendReport()">üì§
					G·ª≠i Report Email</button>
				<button class="btn-action" id="btnWeeklyTest"
					style="grid-column: span 1; background: #1e1b4b; color: #818cf8; border: 1px solid #312e81; display: none;"
					onclick="runWeeklyReportTest()">üöÄ
					Test B√°o C√°o Tu·∫ßn</button>
			</div>

			<div class="admin-section" style="margin-top: 32px; padding-top: 20px;">
				<div class="sub-tabs-nav">
					<button class="sub-tab-btn active" id="btnSubOrders" onclick="switchSubTab('orders')">üìã ƒê∆°n
						H√†ng</button>
					<button class="sub-tab-btn" id="btnSubCustomers" onclick="switchSubTab('customers')">üë• Kh√°ch H√†ng
						M·ªõi</button>
				</div>

				<!-- SUB TAB: ORDERS -->
				<div id="sub-tab-orders" class="sub-tab-content active">
					<div class="user-list-container">
						<table id="reportTable">
							<thead>
								<tr>
									<th>Th·ªùi Gian</th>
									<th>Kh√°ch H√†ng</th>
									<th>Nh√¢n Vi√™n</th>
									<th>T·ªïng Ti·ªÅn</th>
									<th>Tr·∫°ng Th√°i</th>
								</tr>
							</thead>
							<tbody id="reportTableBody">
								<tr>
									<td colspan="5" style="text-align:center; padding: 40px; color: var(--text-muted);">
										Vui l√≤ng ch·ªçn th·ªùi gian v√† b·∫•m L·ªçc.</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>

				<!-- SUB TAB: CUSTOMERS -->
				<div id="sub-tab-customers" class="sub-tab-content">
					<div class="user-list-container">
						<table id="customerReportTable">
							<thead>
								<tr>
									<th>Ng√†y T·∫°o</th>
									<th>ID</th>
									<th>T√™n Kh√°ch H√†ng</th>
									<th>Khu V·ª±c</th>
									<th>Nh√¢n Vi√™n</th>
								</tr>
							</thead>
							<tbody id="customerReportTableBody">
								<tr>
									<td colspan="5" style="text-align:center; padding: 40px; color: var(--text-muted);">
										Vui l√≤ng ch·ªçn th·ªùi gian v√† b·∫•m L·ªçc.</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div id="toast"></div>

	<script>
		const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyaz_6xI3Nz0FHnNgr9qEcPuOUGf4OY53l8x1ofSoh_LIGozbKmpSJNAwpq8U6ygpPNHw/exec';
		const REPORT_URL = 'https://script.google.com/macros/s/AKfycbzUfmgFXDKg4TCwEvotTAmILCu7ZZJFSPtimQ7hHVzO5C9JZqfzxeGGSRSTzkSCPHGT4w/exec';
		const MASTER_URL = 'https://script.google.com/macros/s/AKfycbz2FpV9hWeZKzBJyS636Hlf7JrM8bfA03YbH9xF3KYqdHJXcpgvCLoD2xjOGCDKzpfj/exec';

		window.onload = async function () {
			if (!currentUser) {
				window.location.href = 'auth.html';
				return;
			}
			document.getElementById('adminName').innerText = currentUser.fullName;
			document.getElementById('avatarLetter').innerText = currentUser.fullName.charAt(0).toUpperCase();

			// Hi·ªÉn th·ªã huy hi·ªáu Premium n·∫øu c√≥
			if (currentUser.package === 'Premium') {
				const badge = document.createElement('span');
				badge.innerHTML = 'üíé PREMIUM';
				badge.style.cssText = 'background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%); color: white; font-size: 0.65rem; padding: 2px 8px; border-radius: 6px; font-weight: 800; margin-left: 8px; border: 1px solid rgba(255,255,255,0.2);';
				document.getElementById('adminName').parentElement.appendChild(badge);
			}

			async function syncAndLoad() {
				// 1. ƒê·ªìng b·ªô l·∫°i Features t·ª´ Server (Kh√≥a Master)
				try {
					const res = await fetch(SCRIPT_URL, {
						method: 'POST',
						body: SecurityProvider.prepareRequest('getUserConfig', { email: currentUser.email })
					});
					const data = await res.json();
					if (data.success && data.features) {
						currentUser.features = data.features;
						SecurityProvider.saveSession(currentUser, session.permissions);
					}
				} catch (e) { console.error("Sync failed", e); }

				// 2. Load d·ªØ li·ªáu ch√≠nh
				loadRoles();
				loadPermissions();
				loadUsers();
			}

			// Check if Super Admin
			if (currentUser.email === 'dunvex.green@gmail.com') {
				const hrBtn = document.querySelector('button[onclick="switchTab(\'hr\')"]');
				const chkBtn = document.getElementById('nav_checkin');
				const hrContent = document.getElementById('tab-hr');
				if (hrBtn) hrBtn.style.display = 'none';
				if (chkBtn) chkBtn.style.display = 'none';
				if (hrContent) hrContent.style.display = 'none';
				switchTab('report');
			}

			syncAndLoad();
		}; // End of window.onload

		function switchTab(tabId) {
			document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
			document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

			document.getElementById('tab-' + tabId).classList.add('active');
			// Find the button that triggered the switch, or the one corresponding to tabId
			const targetButton = document.querySelector(`.tab-btn[onclick="switchTab('${tabId}')"]`);
			if (targetButton) {
				targetButton.classList.add('active');
			}


			if (tabId === 'report') {
				// Default dates
				const now = new Date();
				const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
				const today = now.toISOString().split('T')[0];
				if (!document.getElementById('reportStart').value) document.getElementById('reportStart').value = firstDay;
				if (!document.getElementById('reportEnd').value) document.getElementById('reportEnd').value = today;

				// Populate staff select if empty
				populateReportStaff();

				// NEW: Check for Sales Report Restriction
				if (currentUser.salesRestrict === 'ON') {
					const btnSend = document.getElementById('btnSendReport');
					if (btnSend) {
						btnSend.disabled = true;
						btnSend.innerHTML = "üîí T√≠nh nƒÉng b·ªã kh√≥a b·ªüi Super Admin";
						btnSend.title = "Vui l√≤ng li√™n h·ªá Super Admin ƒë·ªÉ m·ªü quy·ªÅn g·ª≠i b√°o c√°o.";
					}
				}

				// Show Weekly Test Button only for Dunvex
				if (currentUser.email.toLowerCase().includes('dunvex')) {
					const weeklyBtn = document.getElementById('btnWeeklyTest');
					if (weeklyBtn) weeklyBtn.style.display = 'block';
				}
			}
		}

		function switchSubTab(subTabId) {
			document.querySelectorAll('.sub-tab-content').forEach(el => el.classList.remove('active'));
			document.querySelectorAll('.sub-tab-btn').forEach(el => el.classList.remove('active'));

			document.getElementById('sub-tab-' + subTabId).classList.add('active');
			// Find button by ID or text depending on call
			if (subTabId === 'orders') document.getElementById('btnSubOrders').classList.add('active');
			else document.getElementById('btnSubCustomers').classList.add('active');
		}

		let allUsersCache = [];
		function populateReportStaff() {
			const select = document.getElementById('reportStaffSelect');
			if (select.options.length > 1) return; // Already populated

			allUsersCache.forEach(u => {
				if (u.roleId === 'R002' || u.roleId === 'R001') {
					const opt = document.createElement('option');
					opt.value = u.email;
					opt.innerText = u.fullName + " (" + u.email + ")";
					select.appendChild(opt);
				}
			});
		}

		let cachedRawData = null;
		let cachedDateRange = { start: '', end: '' };

		async function fetchRevenueReport() {
			const start = document.getElementById('reportStart').value;
			const end = document.getElementById('reportEnd').value;
			const staff = document.getElementById('reportStaffSelect').value;
			const status = document.getElementById('reportStatusSelect').value;

			if (!start || !end) return showToast("Vui l√≤ng ch·ªçn ng√†y", "error");

			const btn = document.getElementById('btnFilterReport');
			btn.disabled = true;

			// 1. Check Cache
			if (cachedRawData && cachedDateRange.start === start && cachedDateRange.end === end) {
				console.log("Using cached data...");
				processAndRender(cachedRawData, staff, status);
				btn.disabled = false;
				return;
			}

			// 2. Fetch New Data
			btn.innerHTML = "‚åõ ƒêang t·∫£i t·ª´ server...";
			try {
				const res = await fetch(REPORT_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest('getRevenueData', {
						startDate: start,
						endDate: end,
						staffEmail: 'ALL', // Fetch ALL for client-side filtering
						status: 'ALL',     // Fetch ALL for client-side filtering
						requesterEmail: currentUser.email
					})
				});
				const data = await res.json();
				if (data.success) {
					// Store Cache
					cachedRawData = data;
					cachedDateRange = { start, end };
					processAndRender(data, staff, status);
				} else {
					showToast('‚ùå L·ªói: ' + data.message, 'error');
				}
			} catch (e) {
				showToast('‚ùå L·ªói k·∫øt n·ªëi!', 'error');
				console.error(e);
			} finally {
				btn.disabled = false;
				btn.innerHTML = "üîç L·ªçc D·ªØ Li·ªáu";
			}
		}

		function processAndRender(data, staffFilter, statusFilter) {
			// Local Filtering Logic to replace Server Logic
			let filteredOrders = data.orders || [];
			let filteredCustomers = data.customers || [];

			// 1. Filter Orders
			if (staffFilter !== 'ALL') {
				filteredOrders = filteredOrders.filter(o => o.staffEmail === staffFilter || o.staffName === staffFilter);
			}
			if (statusFilter !== 'ALL') {
				filteredOrders = filteredOrders.filter(o => (o.status || '').toLowerCase() === statusFilter.toLowerCase());
			}

			// 2. Filter Customers
			if (staffFilter !== 'ALL') {
				filteredCustomers = filteredCustomers.filter(c => c.staffEmail === staffFilter);
			}

			// 3. Calculate Summaries
			let totalRev = 0;
			filteredOrders.forEach(o => {
				// Only sum revenue for completed orders or whatever logic business requires - usually 'ƒê∆°n ch·ªët' or similar
				// Assuming 'ƒê∆°n ch·ªët' or 'Ho√†n th√†nh' implies revenue.
				// However, the report usually shows Total Value of the list filtered.
				// Let's sum the 'total' field of filtered orders.
				totalRev += (typeof o.total === 'number' ? o.total : 0);
			});

			const summary = {
				orderCount: filteredOrders.length,
				totalRevenue: totalRev,
				newCustomers: filteredCustomers.length
			};

			renderRevenueReport({
				summary: summary,
				orders: filteredOrders,
				customers: filteredCustomers
			});
		}

		function renderRevenueReport(result) {
			document.getElementById('revenueSummary').style.display = 'grid';
			// Animate numbers? For now just set them.
			document.getElementById('sumOrderCount').innerText = result.summary.orderCount;
			document.getElementById('sumTotalRevenue').innerText = result.summary.totalRevenue.toLocaleString() + " ‚Ç´";
			document.getElementById('sumNewCustomers').innerText = result.summary.newCustomers;

			const tbody = document.getElementById('reportTableBody');
			if (!result.orders || result.orders.length === 0) {
				tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px; color: var(--text-muted);">Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o ph√π h·ª£p.</td></tr>';
			} else {
				// Limit render to 500 rows to prevent freeze if huge data
				const displayOrders = result.orders.slice(0, 500);

				tbody.innerHTML = displayOrders.map(o => {
					const displayTotal = (typeof o.total === 'number') ? o.total.toLocaleString() : '0';
					const displayStatus = o.status || 'N/A';
					const statusColor = getStatusColor(displayStatus);

					return `
					<tr>
						<td style="font-size: 0.85rem; color: var(--text-muted);">${o.date || '-'}</td>
						<td style="font-weight: 600;">${o.customerName || 'N/A'}</td>
						<td>${o.staffName || '-'}</td>
						<td style="font-weight: 800; color: var(--primary);">${displayTotal} ‚Ç´</td>
						<td>
							<span class="status-dot" style="background: ${statusColor}"></span>
							${displayStatus}
						</td>
					</tr>
				`}).join('');

				if (result.orders.length > 500) {
					tbody.innerHTML += `<tr><td colspan="5" style="text-align:center; color: var(--text-muted);">...v√† ${result.orders.length - 500} ƒë∆°n kh√°c...</td></tr>`;
				}
			}

			// Render Customers Table
			const custTbody = document.getElementById('customerReportTableBody');
			if (!result.customers || result.customers.length === 0) {
				custTbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px; color: var(--text-muted);">Kh√¥ng c√≥ kh√°ch h√†ng m·ªõi n√†o.</td></tr>';
			} else {
				const displayCust = result.customers.slice(0, 500);
				custTbody.innerHTML = displayCust.map(c => `
					<tr>
						<td style="font-size: 0.85rem; color: var(--text-muted);">${c.dateStr || '-'}</td>
						<td style="color: var(--accent-purple); font-weight: bold; font-size: 0.8rem;">${c.id || '-'}</td>
						<td style="font-weight: 600;">${c.name || 'N/A'}</td>
						<td>${c.area || '-'}</td>
						<td>${c.staffName || '-'}</td>
					</tr>
				`).join('');
			}
		}

		function getStatusColor(status) {
			switch (status.toLowerCase()) {
				case 'ƒë∆°n ch·ªët': return '#6366f1';
				case 'ho√†n th√†nh': return '#22c55e';
				case 'ƒëang x·ª≠ l√Ω': return '#fbbf24';
				case 'ƒë√£ h·ªßy': return '#ef4444';
				default: return '#94a3b8';
			}
		}

		async function runWeeklyReportTest() {
			if (!confirm("H·ªá th·ªëng s·∫Ω qu√©t doanh thu 'ƒê∆°n ch·ªët' tu·∫ßn tr∆∞·ªõc v√† g·ª≠i mail cho nh·ªØng ng∆∞·ªùi ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh. Ti·∫øp t·ª•c?")) return;

			const btn = document.getElementById('btnWeeklyTest');
			btn.disabled = true;
			btn.innerHTML = "‚åõ ƒêang x·ª≠ l√Ω...";

			try {
				const res = await fetch(MASTER_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest('runWeeklyReports')
				});
				const data = await res.json();
				if (data.success) {
					showToast('‚úÖ ' + data.message, 'success');
				} else {
					showToast('‚ùå L·ªói: ' + data.message, 'error');
				}
			} catch (e) {
				showToast('‚ùå L·ªói k·∫øt n·ªëi Master!', 'error');
			} finally {
				btn.disabled = false;
				btn.innerHTML = "üöÄ Test B√°o C√°o Tu·∫ßn";
			}
		}

		async function sendReport() {
			const start = document.getElementById('reportStart').value;
			const end = document.getElementById('reportEnd').value;
			if (!start || !end) return showToast("Vui l√≤ng ch·ªçn ng√†y", "error");

			if (!confirm("H·ªá th·ªëng s·∫Ω t·ªïng h·ª£p b√°o c√°o chi ti·∫øt v√† g·ª≠i email cho b·∫°n. X√°c nh·∫≠n?")) return;

			const btn = document.getElementById('btnSendReport');
			const originalHTML = btn.innerHTML;
			btn.disabled = true;
			btn.innerHTML = "‚åõ ƒêang g·ª≠i...";

			try {
				const res = await fetch(REPORT_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest('sendReportByDate', {
						startDate: start,
						endDate: end,
						requesterEmail: currentUser.email
					})
				});
				const data = await res.json();
				if (data.success) {
					showToast('‚úÖ ' + data.message, 'success');
				} else {
					showToast('‚ùå L·ªói: ' + data.message, 'error');
				}
			} catch (e) {
				showToast('‚ùå L·ªói k·∫øt n·ªëi!', 'error');
			} finally {
				btn.disabled = false;
				btn.innerHTML = originalHTML;
			}
		}
		// ...

		let allPermsCache = [];
		let masterLogsCache = {}; // L∆∞u l·ªãch s·ª≠ kh√≥a t·ª´ Super Admin

		async function loadPermissions() {
			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest('get_phan_quyen', {
						adminEmail: currentUser.adminEmail || currentUser.email
					})
				});
				const data = await response.json();
				if (data.success) {
					allPermsCache = data.data;
					masterLogsCache = data.masterLogs || {};

					// UPDATE CURRENT USER FEATURES FROM SERVER
					if (data.features) {
						currentUser.features = data.features;
						SecurityProvider.saveSession(currentUser, session.permissions);
					}

					renderPermissions(allPermsCache);
				} else {
					showToast('L·ªói t·∫£i quy·ªÅn: ' + (data.message || 'Kh√¥ng c√≥ ph·∫£n h·ªìi'), 'error');
				}
			} catch (err) {
				console.error("Failed to load permissions", err);
				showToast('L·ªói k·∫øt n·ªëi t·∫£i quy·ªÅn', 'error');
			}
		}

		function renderPermissions(perms) {
			const tbody = document.getElementById('permissionTableBody');
			const f = currentUser.features || {};

			// Update Header Tooltips based on masterLogs
			const logMap = {
				'mailStaff': ['th_mail_staff', 'lock_mail_staff'],
				'mailAdmin': ['th_mail_admin', 'lock_mail_admin'],
				'checkinMaster': ['th_checkin_summary', 'lock_checkin_summary'],
				'debtMaster': ['th_cong_no', 'lock_cong_no'],
				'hrMaster': ['th_hr_new', 'lock_hr_new'],
				'priceAnalysisMaster': ['th_price_analysis', 'lock_price_analysis'],
				'inventoryMaster': ['th_inventory', ''],
				'warehouseMaster': ['th_warehouse', ''],
				'deliveryMaster': ['th_delivery', '']
			};

			Object.keys(logMap).forEach(key => {
				const [thId, lockId] = logMap[key];
				const th = document.getElementById(thId);
				const log = masterLogsCache[key];
				if (th && f[key] === false) {
					th.style.color = '#ef4444';
					const lockIcon = document.getElementById(lockId);
					if (lockIcon) lockIcon.className = 'fas fa-lock';
					th.title = log ? `[KH√ìA T·ªîNG] l√∫c ${log.time}\n${log.details}` : "ƒê√£ b·ªã Kh√≥a b·ªüi Super Admin";
				}
			});

			// Fix Special case for Check-in label colors
			const labelCheckin = document.getElementById('label_checkin_summary');
			if (labelCheckin) {
				if (f.checkinMaster === false) {
					labelCheckin.innerText = 'KH√ìA';
					labelCheckin.style.background = 'rgba(239, 68, 68, 0.2)';
					labelCheckin.style.color = '#ef4444';
				} else {
					labelCheckin.innerText = 'M·ªû';
					labelCheckin.style.background = 'rgba(34, 197, 94, 0.2)';
					labelCheckin.style.color = '#22c55e';
				}
			}

			// HR New indicator logic
			const labelHr = document.getElementById('label_hr_new');
			if (labelHr) {
				if (f.hrMaster === false) {
					labelHr.innerText = 'KH√ìA';
					labelHr.style.background = 'rgba(239, 68, 68, 0.2)';
					labelHr.style.color = '#ef4444';
					const lockIcon = document.getElementById('lock_hr_new');
					if (lockIcon) { lockIcon.style.opacity = '1'; lockIcon.style.color = '#ef4444'; }
				} else {
					labelHr.innerText = 'M·ªû';
					labelHr.style.background = 'rgba(34, 197, 94, 0.2)';
					labelHr.style.color = '#22c55e';
					const lockIcon = document.getElementById('lock_hr_new');
					if (lockIcon) { lockIcon.style.opacity = '0.3'; lockIcon.style.color = 'inherit'; }
				}
			}

			tbody.innerHTML = perms.map(p => {
				const getLockInfo = (key) => {
					const log = masterLogsCache[key];
					if (f[key] === false) {
						return log ? `[KH√ìA T·ªîNG] l√∫c ${log.time}\n${log.details}` : "B·ªã kh√≥a b·ªüi Super Admin";
					}
					return "";
				};
				const isLocked = (key) => f[key] === false;

				return `
				<tr>
					<td>
						<div style="font-weight: 600;">${p.ten_vai_tro}</div>
						<div style="font-size: 0.75rem; color: var(--accent-purple);">${p.id_vai_tro}</div>
					</td>
					<td style="font-size: 0.8rem; color: var(--text-muted);">${p.email_quan_ly === 'all' ? 'To√†n h·ªá th·ªëng' : p.email_quan_ly}</td>
					<td style="text-align:center">
						<label class="perm-toggle">
							<input type="checkbox" id="v_${p.id_vai_tro}_${p.email_quan_ly}" ${p.checkin_sales ? 'checked' : ''} ${isLocked('crm') ? 'disabled' : ''}>
							<span class="perm-slider" title="${getLockInfo('crm')}"></span>
						</label>
					</td>
					<td style="text-align:center">
						<label class="perm-toggle">
							<input type="checkbox" id="c_${p.id_vai_tro}_${p.email_quan_ly}" ${p.quan_ly_san_pham ? 'checked' : ''} ${isLocked('prod') ? 'disabled' : ''}>
							<span class="perm-slider" title="${getLockInfo('prod')}"></span>
						</label>
					</td>
					<td style="text-align:center">
						<label class="perm-toggle">
							<input type="checkbox" id="d_${p.id_vai_tro}_${p.email_quan_ly}" ${p.danh_sach_don_hang ? 'checked' : ''} ${isLocked('order') ? 'disabled' : ''}>
							<span class="perm-slider" title="${getLockInfo('order')}"></span>
						</label>
					</td>
					<td style="text-align:center">
						<label class="perm-toggle">
							<input type="checkbox" id="m_${p.id_vai_tro}_${p.email_quan_ly}" ${p.quan_ly_nhan_vien ? 'checked' : ''} ${isLocked('hr') ? 'disabled' : ''}>
							<span class="perm-slider" title="${getLockInfo('hr')}"></span>
						</label>
					</td>
					<td style="text-align:center">
						<label class="perm-toggle">
							<input type="checkbox" id="x_${p.id_vai_tro}_${p.email_quan_ly}" ${p.xem_bang_gia ? 'checked' : ''} ${isLocked('price') ? 'disabled' : ''}>
							<span class="perm-slider" title="${getLockInfo('price')}"></span>
						</label>
					</td>
					<td style="text-align:center">
						<label class="perm-toggle">
							<input type="checkbox" id="k_${p.id_vai_tro}_${p.email_quan_ly}" ${p.quan_ly_kho ? 'checked' : ''}>
							<span class="perm-slider"></span>
						</label>
					</td>
					<td style="text-align:center">
						<label class="perm-toggle">
							<input type="checkbox" id="inv_${p.id_vai_tro}_${p.email_quan_ly}" ${p.nhap_kho ? 'checked' : ''} ${isLocked('inventoryMaster') ? 'disabled' : ''}>
							<span class="perm-slider" title="${getLockInfo('inventoryMaster')}"></span>
						</label>
					</td>
					<td style="text-align:center">
						<label class="perm-toggle">
							<input type="checkbox" id="wh_${p.id_vai_tro}_${p.email_quan_ly}" ${p.kho_xuat_hang ? 'checked' : ''} ${isLocked('warehouseMaster') ? 'disabled' : ''}>
							<span class="perm-slider" title="${getLockInfo('warehouseMaster')}"></span>
						</label>
					</td>
					<td style="text-align:center">
						<label class="perm-toggle">
							<input type="checkbox" id="dl_${p.id_vai_tro}_${p.email_quan_ly}" ${p.giao_hang ? 'checked' : ''} ${isLocked('deliveryMaster') ? 'disabled' : ''}>
							<span class="perm-slider" title="${getLockInfo('deliveryMaster')}"></span>
						</label>
					</td>
					<td style="text-align:center">
						<label class="perm-toggle">
							<input type="checkbox" id="ns_${p.id_vai_tro}_${p.email_quan_ly}" ${p.notify_staff ? 'checked' : ''} ${isLocked('mailStaff') ? 'disabled' : ''}>
							<span class="perm-slider" title="${getLockInfo('mailStaff')}"></span>
						</label>
					</td>
					<td style="text-align:center">
						<label class="perm-toggle">
							<input type="checkbox" id="na_${p.id_vai_tro}_${p.email_quan_ly}" ${p.notify_admin ? 'checked' : ''} ${isLocked('mailAdmin') ? 'disabled' : ''}>
							<span class="perm-slider" title="${getLockInfo('mailAdmin')}"></span>
						</label>
					</td>
					<td style="text-align:center">
						<label class="perm-toggle">
							<input type="checkbox" id="cs_${p.id_vai_tro}_${p.email_quan_ly}" ${p.checkin_summary ? 'checked' : ''} ${isLocked('checkinMaster') ? 'disabled' : ''}>
							<span class="perm-slider" title="${getLockInfo('checkinMaster')}"></span>
						</label>
					</td>
					<td style="text-align:center">
						<label class="perm-toggle">
							<input type="checkbox" id="cn_${p.id_vai_tro}_${p.email_quan_ly}" ${p.quan_ly_cong_no ? 'checked' : ''} ${isLocked('debtMaster') ? 'disabled' : ''}>
							<span class="perm-slider" title="${getLockInfo('debtMaster')}"></span>
						</label>
					</td>

					<td style="text-align:center">
						<label class="perm-toggle">
							<input type="checkbox" id="hrn_${p.id_vai_tro}_${p.email_quan_ly}" ${p.quan_ly_nhan_su ? 'checked' : ''} ${isLocked('hrMaster') ? 'disabled' : ''}>
							<span class="perm-slider" title="${getLockInfo('hrMaster')}"></span>
						</label>
					</td>
					<td style="text-align:center">
						<label class="perm-toggle">
							<input type="checkbox" id="mu_${p.id_vai_tro}_${p.email_quan_ly}" ${p.price_analysis ? 'checked' : ''} ${isLocked('priceAnalysisMaster') ? 'disabled' : ''}>
							<span class="perm-slider" title="${getLockInfo('priceAnalysisMaster')}"></span>
						</label>
					</td>
					<td style="text-align:center">
						<label class="perm-toggle">
							<input type="checkbox" id="pf_${p.id_vai_tro}_${p.email_quan_ly}" ${p.profit_analysis ? 'checked' : ''} ${isLocked('profitMaster') ? 'disabled' : ''}>
							<span class="perm-slider" title="${getLockInfo('profitMaster')}"></span>
						</label>
					</td>
					<td style="text-align:center">
						<label class="perm-toggle">
							<input type="checkbox" id="hrs_${p.id_vai_tro}_${p.email_quan_ly}" ${p.hr_setup ? 'checked' : ''} ${isLocked('hrMaster') ? 'disabled' : ''}>
							<span class="perm-slider" title="${getLockInfo('hrMaster')}"></span>
						</label>
					</td>
					<td style="text-align:center">
						<label class="perm-toggle">
							<input type="checkbox" id="tsp_${p.id_vai_tro}_${p.email_quan_ly}" ${p.tra_cuu_san_pham ? 'checked' : ''}>
							<span class="perm-slider"></span>
						</label>
					</td>
					<td style="text-align:center">
						<button class="btn-edit" onclick="savePerm('${p.id_vai_tro}', '${p.ten_vai_tro}', '${p.email_quan_ly}', this)">L∆ØU</button>
					</td>
				</tr>
				`}).join('');

			updateCheckinMenuVisibility(perms);
		}

		function updateCheckinMenuVisibility(perms) {
			const f = currentUser.features || {};
			const adminPerm = perms.find(p => p.id_vai_tro === 'R001');
			const btn = document.getElementById('nav_checkin');
			if (!btn) return;

			// N√∫t b·ªã ·∫©n n·∫øu: Master Lock b·ªã ƒë√≥ng HO·∫∂C quy·ªÅn Admin b·ªã t·∫Øt
			if (f.checkinMaster === false || (adminPerm && adminPerm.checkin_summary === false)) {
				btn.style.display = 'none';
			} else {
				btn.style.display = 'inline-block';
			}
		}

		async function savePerm(roleId, name, emailAdmin, btn) {
			const payload = {
				action: 'save_phan_quyen',
				id_vai_tro: roleId,
				ten_vai_tro: name,
				email_quan_ly: emailAdmin,
				checkin_sales: document.getElementById(`v_${roleId}_${emailAdmin}`).checked,
				quan_ly_san_pham: document.getElementById(`c_${roleId}_${emailAdmin}`).checked,
				danh_sach_don_hang: document.getElementById(`d_${roleId}_${emailAdmin}`).checked,
				quan_ly_nhan_vien: document.getElementById(`m_${roleId}_${emailAdmin}`).checked,
				xem_bang_gia: document.getElementById(`x_${roleId}_${emailAdmin}`).checked,
				quan_ly_kho: document.getElementById(`k_${roleId}_${emailAdmin}`).checked,
				nhap_kho: document.getElementById(`inv_${roleId}_${emailAdmin}`).checked,
				kho_xuat_hang: document.getElementById(`wh_${roleId}_${emailAdmin}`).checked,
				giao_hang: document.getElementById(`dl_${roleId}_${emailAdmin}`).checked,
				notify_staff: document.getElementById(`ns_${roleId}_${emailAdmin}`).checked,
				notify_admin: document.getElementById(`na_${roleId}_${emailAdmin}`).checked,
				checkin_summary: document.getElementById(`cs_${roleId}_${emailAdmin}`).checked,
				quan_ly_cong_no: document.getElementById(`cn_${roleId}_${emailAdmin}`).checked,
				tao_san_pham: document.getElementById(`c_${roleId}_${emailAdmin}`).checked,

				quan_ly_nhan_su: document.getElementById(`hrn_${roleId}_${emailAdmin}`).checked,
				price_analysis: document.getElementById(`mu_${roleId}_${emailAdmin}`).checked,
				profit_analysis: document.getElementById(`pf_${roleId}_${emailAdmin}`).checked,
				hr_setup: document.getElementById(`hrs_${roleId}_${emailAdmin}`).checked,
				tra_cuu_san_pham: document.getElementById(`tsp_${roleId}_${emailAdmin}`).checked
			};

			const originalHtml = btn.innerHTML;
			btn.disabled = true;
			btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> L∆ØU...';
			showLoader(true);

			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest('save_phan_quyen', payload)
				});
				const data = await response.json();
				if (data.success) {
					showToast('ƒê√£ l∆∞u quy·ªÅn th√†nh c√¥ng!', 'success');
					// N·∫øu Admin ƒëang s·ª≠a cho ch√≠nh Role c·ªßa m√¨nh, h√£y c·∫≠p nh·∫≠t LocalStorage ngay ƒë·ªÉ th·∫•y thay ƒë·ªïi ·ªü Menu
					if (roleId === currentUser.roleId) {
						const updatedPerms = {
							checkinSales: payload.checkin_sales,
							quanLySanPham: payload.quan_ly_san_pham,
							danhSachDonHang: payload.danh_sach_don_hang,
							quanLyNhanVien: payload.quan_ly_nhan_vien,
							xemBangGia: payload.xem_bang_gia,
							quanLyKho: payload.quan_ly_kho,
							checkinSummary: payload.checkin_summary,
							quanLyCongNo: payload.quan_ly_cong_no,
							taoSanPham: payload.tao_san_pham,

							quanLyNhanSu: payload.quan_ly_nhan_su,
							priceAnalysis: payload.price_analysis,
							hrSetup: payload.hr_setup,
							traCuuSanPham: payload.tra_cuu_san_pham
						};
						localStorage.setItem('permissions', JSON.stringify(updatedPerms));
					}
					showToast('ƒê√£ l∆∞u quy·ªÅn th√†nh c√¥ng! H·ªá th·ªëng s·∫Ω t·∫£i l·∫°i...', 'success');
					setTimeout(() => {
						window.location.reload();
					}, 1000);
				} else {
					showToast(data.message, 'error');
				}
			} catch (err) {
				showToast('L·ªói k·∫øt n·ªëi', 'error');
			} finally {
				showLoader(false);
				btn.disabled = false;
				btn.innerHTML = originalHtml;
			}
		}

		async function loadRoles() {
			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest('getRoles')
				});
				const data = await response.json();
				if (data.success && data.roles && data.roles.length > 0) {
					const options = data.roles.map(r =>
						`<option value="${r.id}">${r.name}</option>`
					).join('');

					document.getElementById('roleSelect').innerHTML = options;
					document.getElementById('newRoleSelect').innerHTML = options;
				} else {
					console.warn("No roles found in sheet, using default list.", data.message);
					const defaults = [
						{ id: 'R001', name: 'Admin' }, // Added Admin to default list
						{ id: 'R002', name: 'Sale' },
						{ id: 'R003', name: 'Kho' },
						{ id: 'R004', name: 'K·∫ø to√°n' },
						{ id: 'R005', name: 'Kh√°ch' }
					];
					const options = defaults.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
					document.getElementById('roleSelect').innerHTML = options;
					document.getElementById('newRoleSelect').innerHTML = options;
				}
			} catch (err) {
				console.error("Failed to load roles from API", err);
				showToast('L·ªói t·∫£i danh s√°ch Vai tr√≤', 'error');
			}
		}

		async function syncSystem() {
			if (!confirm("B·∫°n c√≥ mu·ªën ƒë·ªìng b·ªô l·∫°i c·∫•u tr√∫c Sheet v√† c√°c vai tr√≤ m·∫∑c ƒë·ªãnh kh√¥ng?")) return;
			showLoader(true);
			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest('setup')
				});
				const data = await response.json();
				if (data.success) {
					showToast('ƒê√£ ƒë·ªìng b·ªô h·ªá th·ªëng th√†nh c√¥ng!', 'success');
					loadRoles(); // Reload list
				}
			} catch (err) {
				showToast('L·ªói ƒë·ªìng b·ªô', 'error');
			} finally {
				showLoader(false);
			}
		}

		async function loadUsers() {
			showLoader(true);
			try {
				const isDunvexMaster = currentUser.email.toLowerCase().includes('dunvex');
				const targetUrl = isDunvexMaster ? MASTER_URL : SCRIPT_URL;
				const action = isDunvexMaster ? 'getMasterAllAccounts' : 'getUsers';

				const response = await fetch(targetUrl, {
					method: 'POST',
					body: SecurityProvider.prepareRequest(action, {
						adminEmail: currentUser.email
					})
				});
				const data = await response.json();

				if (data.success) {
					allUsersCache = data.users; // Save for report filter
					renderUsers(data.users);
				} else {
					showToast('L·ªói t·∫£i danh s√°ch ng∆∞·ªùi d√πng', 'error');
				}
			} catch (err) {
				showToast('L·ªói k·∫øt n·ªëi m√°y ch·ªß', 'error');
			} finally {
				showLoader(false);
			}
		}

		function renderUsers(users) {
			const tbody = document.getElementById('userTableBody');

			if (!users || users.length === 0) {
				tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 40px; color: var(--text-muted);">Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n n√†o.</td></tr>`;
				return;
			}

			tbody.innerHTML = users.map(user => `
				<tr>
                    <td style="color: var(--accent-purple); font-weight: bold; font-size: 0.8rem;">${user.id || '...'}</td>
                    <td style="font-weight: 600;">${user.fullName}</td>
                    <td style="color: var(--text-muted); font-size: 0.85rem;">${user.email}</td>
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 4px;">
                            <span style="font-size: 0.85rem; color: var(--primary); font-weight: 600;">
                                ${(!user.owner || user.owner === 'all') ? 'To√†n h·ªá th·ªëng' : user.owner.split(',').map(m => m.split('@')[0]).join(', ')}
                            </span>
                            <small style="font-size: 0.7rem; color: var(--text-muted); font-style: italic;">(Nh√≥m nh·∫≠n b√°o c√°o)</small>
                        </div>
                    </td>
                    <td>
                        <span class="status-dot ${user.status === 'Ho·∫°t ƒë·ªông' ? 'status-active' : 'status-locked'}"></span>
                        ${user.status}
                    </td>
                    <td>
                        ${user.email !== currentUser.email ? `
                            <button class="btn-edit" onclick="quickEdit('${user.email}', '${user.roleId}')">S·ª≠a Quy·ªÅn</button>
                            <button class="btn-edit" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border-color: rgba(239, 68, 68, 0.2); margin-left: 5px;" onclick="deleteUser('${user.email}')">X√≥a</button>
                        ` : '<span style="color: var(--text-muted); font-size: 0.8rem; font-style: italic;">(T√†i kho·∫£n c·ªßa b·∫°n)</span>'}
                    </td>
                </tr>
				`).join('');
		}

		function getRoleDisplayName(roleId) {
			const names = {
				'R001': 'ADMIN',
				'R002': 'SALE',
				'R003': 'KHO',
				'R004': 'K·∫æ TO√ÅN',
				'R005': 'GUEST'
			};
			return names[roleId] || roleId;
		}

		function cleanOwner(ownerText) {
			// (H√†m n√†y ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông h√≥a b√™n trong renderUsers, gi·ªØ l·∫°i r·ªóng ƒë·ªÉ tr√°nh l·ªói n·∫øu c√≥ n∆°i n√†o g·ªçi t·∫°m)
			return ownerText;
		}

		function quickEdit(email, roleId) {
			document.getElementById('targetEmail').value = email;
			document.getElementById('roleSelect').value = roleId;
			// Scroll to the update form
			document.getElementById('updateRoleForm').scrollIntoView({ behavior: 'smooth' });
			// Highlight the input briefly
			const input = document.getElementById('targetEmail');
			input.style.borderColor = 'var(--primary)';
			setTimeout(() => input.style.borderColor = '', 1000);
		}

		document.getElementById('createUserForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			const fullName = document.getElementById('newFullName').value;
			const email = document.getElementById('newEmail').value;
			const roleId = document.getElementById('newRoleSelect').value;

			showLoader(true);
			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest('createUser', {
						fullName: fullName,
						email: email,
						roleId: roleId,
						adminEmail: currentUser.email
					})
				});
				const data = await response.json();

				if (data.success) {
					showToast('ƒê√£ t·∫°o nh√¢n vi√™n th√†nh c√¥ng!', 'success');
					loadUsers();
					document.getElementById('createUserForm').reset();
				} else {
					showToast(data.message, 'error');
				}
			} catch (err) {
				showToast('L·ªói k·∫øt n·ªëi m√°y ch·ªß', 'error');
			} finally {
				showLoader(false);
			}
		});

		document.getElementById('updateRoleForm').addEventListener('submit', async (e) => {
			e.preventDefault();
			const targetEmail = document.getElementById('targetEmail').value;
			const newRoleId = document.getElementById('roleSelect').value;

			showLoader(true);
			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest('updateRole', {
						userEmail: targetEmail,
						newRoleId: newRoleId,
						adminEmail: currentUser.email
					})
				});
				const data = await response.json();

				if (data.success) {
					showToast('ƒê√£ c·∫≠p nh·∫≠t vai tr√≤ th√†nh c√¥ng', 'success');
					loadUsers(); // Refresh list
					document.getElementById('updateRoleForm').reset();
				} else {
					showToast(data.message, 'error');
				}
			} catch (err) {
				showToast('L·ªói k·∫øt n·ªëi m√°y ch·ªß', 'error');
			} finally {
				showLoader(false);
			}
		});

		async function deleteUser(email) {
			if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA nh√¢n vi√™n ${email} kh·ªèi h·ªá th·ªëng ?\nD·ªØ li·ªáu n√†y kh√¥ng th·ªÉ kh√¥i ph·ª•c v√† t√†i kho·∫£n n√†y s·∫Ω m·∫•t quy·ªÅn truy c·∫≠p ngay l·∫≠p t·ª©c.`)) return;

			showLoader(true);
			try {
				const response = await fetch(SCRIPT_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest('deleteUser', {
						userEmail: email,
						adminEmail: currentUser.email
					})
				});
				const data = await response.json();
				if (data.success) {
					showToast('ƒê√£ x√≥a nh√¢n vi√™n th√†nh c√¥ng!', 'success');
					loadUsers();
				} else {
					showToast(data.message, 'error');
				}
			} catch (err) {
				showToast('L·ªói k·∫øt n·ªëi', 'error');
			} finally {
				showLoader(false);
			}
		}

		function showToast(msg, type) {
			const toast = document.getElementById('toast');
			toast.innerText = msg;
			toast.style.borderLeft = type === 'success' ? '4px solid #22c55e' : '4px solid #ef4444';
			toast.classList.add('show');
			setTimeout(() => toast.classList.remove('show'), 3000);
		}

		function showLoader(show) {
			document.getElementById('loader').style.display = show ? 'flex' : 'none';
		}

		function logout() {
			localStorage.clear();
			window.location.href = 'auth.html';
		}
	</script>
	<script src="chatbot.js"></script>
	<script src="floating-menu.js"></script>
</body>

</html>