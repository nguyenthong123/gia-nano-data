/**
 * GOOGLE APPS SCRIPT CHO PIMA
 * Chuyên dụng cho file: giá nano pima
 * Sheet ID: 1f5w7uPmiqwbrqARpdPvBJeAOh1LPhhOnAwO4JFIkCn4
 * Sheet Name: gia_web_nano
 */

// ============= CẤU HÌNH CỐ ĐỊNH =============
const SPREADSHEET_ID = '1f5w7uPmiqwbrqARpdPvBJeAOh1LPhhOnAwO4JFIkCn4';
const SHEET_NAME = 'gia_web_nano';

function doGet(e) {
  const params = e.parameter;
  const action = params.action;
  
  if (action === 'read') {
    return readData();
  }
  
  return jsonResponse({success: false, message: 'Invalid GET action'});
}

function doPost(e) {
  let data;
  try {
    data = JSON.parse(e.postData.contents);
  } catch (err) {
    return jsonResponse({success: false, message: 'Invalid JSON'});
  }
  
  const action = data.action;
  
  if (action === 'upload') {
    return uploadFile(data);
  } else if (action === 'create') {
    return createData(data);
  } else if (action === 'update') {
    return updateData(data);
  } else if (action === 'delete') {
    // Để thống nhất với logic Duraflex, ta coi delete 'product' là chủ yếu
    return deleteData(data);
  }
  
  return jsonResponse({success: false, message: 'Invalid POST action'});
}

function readData() {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAME);
    if (!sheet) return jsonResponse({success: false, message: 'Sheet not found: ' + SHEET_NAME});
    
    const values = sheet.getDataRange().getValues();
    if (values.length < 1) return jsonResponse({success: true, data: []});
    
    const headers = values[0];
    const data = [];
    
    for (let i = 1; i < values.length; i++) {
        // Bỏ qua dòng trống
        if (!values[i].join('').trim()) continue;
        
        let obj = {};
        headers.forEach((header, index) => {
            if (header) {
                obj[header] = values[i][index];
            }
        });
        data.push(obj);
    }
    
    return jsonResponse({success: true, data: data});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function createData(payload) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAME);
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    
    // Map dữ liệu vào row mới dựa trên header (không phân biệt hoa thường/khoảng trắng)
    const newRow = headers.map(h => {
        const headerClean = String(h).trim().toLowerCase();
        const dataKey = Object.keys(payload.data).find(k => k.toLowerCase().trim() === headerClean);
        return (dataKey && payload.data[dataKey] !== undefined) ? payload.data[dataKey] : '';
    });
    
    sheet.appendRow(newRow);
    return jsonResponse({success: true});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function updateData(payload) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAME);
    const idField = (payload.idField || 'id sản phẩm').toLowerCase().trim();
    const idValue = payload.idValue;
    
    const values = sheet.getDataRange().getValues();
    const headers = values[0];
    
    // 1. Tìm index cột ID
    let idColIndex = -1;
    for (let j = 0; j < headers.length; j++) {
      if (String(headers[j]).toLowerCase().trim() === idField) {
        idColIndex = j;
        break;
      }
    }
    
    if (idColIndex === -1) return jsonResponse({success: false, message: 'ID Field not found: ' + idField});
    
    // 2. Tìm dòng cần update
    let rowNum = -1;
    
    // Cách 1: Tìm theo ID chính xác
    for (let i = 1; i < values.length; i++) {
      if (String(values[i][idColIndex]).trim() === String(idValue).trim()) {
        rowNum = i + 1;
        break;
      }
    }
    
    // Cách 2: Nếu không tìm thấy ID, thử tìm theo Tên Sản Phẩm (nếu dòng đó chưa có ID)
    // Giúp sửa lỗi các dòng bị mất ID trên sheet
    if (rowNum === -1) {
        let nameColIndex = -1;
        for (let j = 0; j < headers.length; j++) {
            if (String(headers[j]).toLowerCase().trim() === 'tên sản phẩm') {
                nameColIndex = j;
                break;
            }
        }
        
        // Lấy tên từ payload (tìm key tên sản phẩm linh hoạt)
        const nameKey = Object.keys(payload.data).find(k => k.toLowerCase().trim() === 'tên sản phẩm');
        const nameValue = nameKey ? payload.data[nameKey] : null;
        
        if (nameColIndex !== -1 && nameValue) {
            for (let i = 1; i < values.length; i++) {
                const currentName = String(values[i][nameColIndex]).toLowerCase().trim();
                const currentId = String(values[i][idColIndex]).trim();
                
                // Nếu trùng tên VÀ chưa có ID -> Chính là dòng cần update/sửa lỗi
                if (currentName === String(nameValue).toLowerCase().trim() && currentId === "") {
                    rowNum = i + 1;
                    break;
                }
            }
        }
    }
    
    if (rowNum === -1) {
        return jsonResponse({success: false, message: 'Item not found for update: ' + idValue});
    }

    // 3. Thực hiện update data vào row tìm được
    headers.forEach((header, index) => {
        if (header) {
            const headerClean = String(header).trim();
            const colIndex = index + 1;
            
            // Logic bảo vệ ID nhưng cho phép điền nếu trống
            if (headerClean.toLowerCase() === idField) {
                 const currentVal = sheet.getRange(rowNum, colIndex).getValue(); // Check trực tiếp giá trị ô
                 if (String(currentVal).trim() !== "") return; // Nếu đã có ID, không cho sửa
            }

            const dataKey = Object.keys(payload.data).find(k => k.toLowerCase().trim() === headerClean.toLowerCase());
            if (dataKey !== undefined && payload.data[dataKey] !== undefined) {
               sheet.getRange(rowNum, colIndex).setValue(payload.data[dataKey]);
            }
        }
    });

    return jsonResponse({success: true, message: 'Updated successfully'});

  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function deleteData(payload) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAME);
    
    if (!payload.data) {
      return jsonResponse({success: false, message: 'No data provided for delete operation'});
    }
    
    // Đọc headers để map dữ liệu
    const range = sheet.getDataRange();
    const headers = range.getValues()[0];
    
    // Tìm hoặc tạo cột "trạng thái xóa" (Case-insensitive check)
    let deleteColIndex = headers.findIndex(h => String(h).trim().toLowerCase() === 'trạng thái xóa');
    
    // Nếu chưa có cột trạng thái xóa thì thêm vào
    if (deleteColIndex === -1) {
        deleteColIndex = headers.length; // Index mới sẽ là cuối cùng
        sheet.getRange(1, deleteColIndex + 1).setValue('trạng thái xóa'); // Thêm header vào sheet
    }
    
    // Tạo dòng mới để Append
    const newRow = [];
    
    // Duyệt qua từng header (kể cả cột mới thêm) để điền dữ liệu tương ứng từ payload
    // Sử dụng vòng lặp an toàn đến max(headers.length, deleteColIndex + 1)
    const maxCols = Math.max(headers.length, deleteColIndex + 1);
    
    for (let i = 0; i < maxCols; i++) {
        if (i === deleteColIndex) {
            newRow.push('DELETED'); // Cột trạng thái xóa
        } else {
            // Lấy tên header hiện tại (nếu có)
            const headerName = headers[i] ? String(headers[i]).trim().toLowerCase() : '';
            
            // Tìm trong payload xem có key tương ứng không
            const dataKey = Object.keys(payload.data).find(k => k.toLowerCase().trim() === headerName);
            
            if (headerName && dataKey && payload.data[dataKey] !== undefined) {
                 newRow.push(payload.data[dataKey]);
            } else {
                 newRow.push(''); // Không có dữ liệu thì để trống
            }
        }
    }
    
    sheet.appendRow(newRow);
    
    return jsonResponse({success: true, message: 'Created DELETED record in sheet'});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function uploadFile(payload) {
  try {
    const folder = DriveApp.getFolderById(payload.folderId);
    const blob = Utilities.newBlob(Utilities.base64Decode(payload.file), payload.mimeType, payload.filename);
    const file = folder.createFile(blob);
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    // Auto convert to direct link like Duraflex fix
    const url = 'https://lh3.googleusercontent.com/d/' + file.getId();
    return jsonResponse({success: true, url: url});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function jsonResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
