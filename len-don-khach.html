<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Lên Đơn Hàng Khách - Premium System</title>
	<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
		rel="stylesheet">
	<style>
		:root {
			--primary: #FFD700;
			--primary-dark: #ccac00;
			--primary-soft: rgba(255, 215, 0, 0.1);
			--dark: #0f0f0f;
			--dark-card: #1a1a1a;
			--text-light: #ffffff;
			--text-gray: #a0a0a0;
			--glass: rgba(255, 255, 255, 0.03);
			--glass-border: rgba(255, 255, 255, 0.1);
			--error: #ff5252;
			--success: #00e676;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Plus Jakarta Sans', sans-serif;
		}

		body {
			background-color: var(--dark);
			color: var(--text-light);
			min-height: 100vh;
			padding-bottom: 100px;
		}

		/* Header */
		.header {
			padding: 30px 5%;
			background: linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent);
			display: flex;
			justify-content: space-between;
			align-items: center;
			position: sticky;
			top: 0;
			z-index: 100;
			backdrop-filter: blur(10px);
		}

		.logo-area h1 {
			font-size: 1.5rem;
			font-weight: 800;
			color: var(--primary);
			letter-spacing: -0.5px;
		}

		.container {
			max-width: 1300px;
			margin: 0 auto;
			padding: 20px;
		}

		.main-content-grid {
			display: grid;
			grid-template-columns: 1fr 1.3fr;
			gap: 30px;
		}

		.card {
			background: var(--dark-card);
			border-radius: 24px;
			border: 1px solid var(--glass-border);
			padding: 30px;
			margin-bottom: 25px;
		}

		.section-title {
			font-size: 1.2rem;
			font-weight: 700;
			margin-bottom: 20px;
			display: flex;
			align-items: center;
			gap: 10px;
			color: var(--primary);
		}

		/* Form Elements */
		.form-group {
			margin-bottom: 20px;
		}

		label {
			display: block;
			font-size: 0.85rem;
			color: var(--text-gray);
			margin-bottom: 8px;
			font-weight: 600;
		}

		select,
		input {
			width: 100%;
			background: var(--glass);
			border: 1px solid var(--glass-border);
			padding: 14px 18px;
			border-radius: 14px;
			color: white;
			font-size: 1rem;
			outline: none;
			transition: 0.3s;
		}

		select:focus,
		input:focus {
			border-color: var(--primary);
			background: rgba(255, 255, 255, 0.06);
		}

		/* Product Selector */
		.product-grid {
			display: grid;
			gap: 15px;
			grid-template-columns: 1fr 1fr;
		}

		/* Cart Table */
		.cart-table {
			width: 100%;
			border-collapse: collapse;
			margin-top: 10px;
		}

		.cart-table th {
			text-align: left;
			font-size: 0.75rem;
			text-transform: uppercase;
			color: var(--text-gray);
			padding: 12px 10px;
			border-bottom: 1px solid var(--glass-border);
		}

		.cart-table td {
			padding: 12px 10px;
			border-bottom: 1px solid var(--glass-border);
			vertical-align: top;
		}

		.item-info .name {
			font-weight: 700;
			font-size: 0.95rem;
		}

		.item-info .sub {
			font-size: 0.75rem;
			color: var(--text-gray);
		}

		.qty-control {
			background: var(--glass);
			border-radius: 12px;
			padding: 8px 15px;
			width: fit-content;
			border: 1px solid var(--glass-border);
			display: flex;
			align-items: center;
		}

		.qty-input {
			width: 100px;
			background: transparent;
			border: none;
			color: var(--primary);
			text-align: center;
			font-weight: 800;
			font-size: 1.15rem;
			outline: none;
		}

		.qty-input::-webkit-inner-spin-button {
			display: none;
		}

		.qty-unit {
			font-size: 0.75rem;
			color: var(--text-gray);
			margin-left: 5px;
			font-weight: 600;
		}

		/* Summary */
		.summary-row {
			display: flex;
			justify-content: space-between;
			margin-bottom: 15px;
			font-weight: 500;
		}

		.total-row {
			font-size: 1.4rem;
			font-weight: 800;
			color: var(--primary);
			border-top: 1px solid var(--glass-border);
			padding-top: 20px;
			margin-top: 20px;
		}

		.btn-submit {
			width: 100%;
			padding: 20px;
			background: var(--primary);
			color: var(--dark);
			border: none;
			border-radius: 18px;
			font-size: 1.1rem;
			font-weight: 800;
			cursor: pointer;
			transition: 0.3s;
			margin-top: 20px;
			box-shadow: 0 15px 30px rgba(255, 215, 0, 0.2);
		}

		.btn-submit:hover {
			transform: translateY(-3px);
			box-shadow: 0 20px 40px rgba(255, 215, 0, 0.3);
		}

		.btn-submit:disabled {
			opacity: 0.5;
			cursor: not-allowed;
			transform: none;
		}

		/* Searchable Select Hack */
		.datalist-input {
			position: relative;
		}

		.empty-cart {
			text-align: center;
			padding: 40px;
			color: var(--text-gray);
			font-style: italic;
		}

		@media (max-width: 992px) {
			.main-content-grid {
				grid-template-columns: 1fr;
			}

			header {
				flex-direction: column;
				align-items: flex-start;
				gap: 20px;
			}

			.header-left h1 {
				font-size: 2rem;
			}
		}

		/* Header Styles */
		header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
		}

		.header-left h1 {
			font-size: 2.5rem;
			font-weight: 800;
			background: linear-gradient(to right, var(--primary), #fff);
			-webkit-background-clip: text;
			background-clip: text;
			-webkit-text-fill-color: transparent;
			letter-spacing: -1px;
			margin-bottom: 5px;
		}

		.header-left p {
			color: var(--text-gray);
			font-size: 1rem;
		}

		.header-right {
			display: flex;
			gap: 15px;
			align-items: center;
		}

		.user-chip {
			background: var(--glass);
			border: 1px solid var(--glass-border);
			padding: 8px 15px;
			border-radius: 30px;
			display: flex;
			align-items: center;
			gap: 10px;
			backdrop-filter: blur(10px);
		}

		.user-chip span {
			font-weight: 600;
			font-size: 0.9rem;
		}

		.user-chip .avatar {
			width: 30px;
			height: 30px;
			background: var(--primary);
			color: var(--dark);
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 800;
			font-size: 0.8rem;
		}

		.btn-glass {
			padding: 10px 20px;
			border-radius: 14px;
			text-decoration: none;
			font-weight: 700;
			background: var(--glass);
			color: var(--text-light);
			border: 1px solid var(--glass-border);
			backdrop-filter: blur(10px);
			transition: 0.3s;
		}

		.btn-glass:hover {
			background: rgba(255, 255, 255, 0.1);
			border-color: var(--primary);
		}

		/* Floating Menu Styles */
		.floating-menu {
			position: fixed;
			bottom: 40px;
			left: 40px;
			z-index: 1000;
		}

		.fab-btn {
			width: 65px;
			height: 65px;
			background: var(--primary);
			border-radius: 50%;
			box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			border: none;
		}

		.fab-btn:hover {
			transform: scale(1.1) rotate(90deg);
			background: #fff;
		}

		.fab-btn svg {
			width: 30px;
			height: 30px;
			color: var(--dark);
		}

		.fab-menu-list {
			position: absolute;
			bottom: 85px;
			left: 0;
			background: var(--dark-card);
			border: 1px solid var(--glass-border);
			border-radius: 20px;
			width: 260px;
			padding: 10px;
			display: none;
			backdrop-filter: blur(20px);
			box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
			animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
		}

		.fab-menu-list.active {
			display: block;
		}

		.menu-item {
			display: flex;
			align-items: center;
			gap: 15px;
			padding: 15px 20px;
			color: var(--text-light);
			text-decoration: none;
			border-radius: 12px;
			transition: 0.3s;
			font-weight: 600;
		}

		.menu-item:hover {
			background: var(--glass);
			color: var(--primary);
		}

		.menu-item svg {
			width: 22px;
			height: 22px;
		}

		@keyframes slideUp {
			from {
				opacity: 0;
				transform: translateY(30px) scale(0.9);
			}

			to {
				opacity: 1;
				transform: translateY(0) scale(1);
			}
		}

		/* Background blobs */
		.bg-gradient {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: radial-gradient(circle at 50% 50%, #1e1e1e 0%, #121212 100%);
			z-index: -1;
		}

		.bg-blob {
			position: fixed;
			width: 500px;
			height: 500px;
			background: var(--primary);
			filter: blur(150px);
			opacity: 0.05;
			z-index: -1;
			border-radius: 50%;
		}

		.blob-1 {
			top: -200px;
			right: -200px;
		}

		.blob-2 {
			bottom: -200px;
			left: -200px;
		}
	</style>
</head>

<body>
	<div class="bg-gradient"></div>
	<div class="bg-blob blob-1"></div>
	<div class="bg-blob blob-2"></div>

	<div class="container">
		<header>
			<div class="header-left">
				<h1>LÊN ĐƠN KHÁCH HÀNG</h1>
				<p>Hệ thống xử lý đơn hàng chuyên nghiệp cho doanh nghiệp</p>
			</div>
			<div class="header-right">
				<div class="user-chip" id="userChip">
					<div class="avatar" id="userAvatar">U</div>
					<span id="userName">User</span>
				</div>
				<a href="index.html" class="btn btn-glass">Trang chủ</a>
			</div>
		</header>

		<div class="main-content-grid">
			<!-- Left Column: Selection -->
			<div class="left-col">
				<div class="card">
					<div class="section-title">Step 1: Chọn Khách Hàng</div>
					<div class="form-group">
						<label>Tìm khách hàng</label>
						<input type="text" id="custSearch" list="custList" placeholder="Gõ tên hoặc SĐT khách hàng...">
						<datalist id="custList"></datalist>
					</div>
				</div>

				<div class="card">
					<div class="section-title">Step 2: Thêm Sản Phẩm</div>
					<div class="product-grid">
						<div class="form-group">
							<label>Nhóm ngành</label>
							<select id="selectCategory" onchange="updateProductList()">
								<option value="">-- Chọn nhóm ngành --</option>
							</select>
						</div>
						<div class="form-group">
							<label>Tên sản phẩm</label>
							<select id="selectProduct">
								<option value="">-- Chọn sản phẩm --</option>
							</select>
						</div>
					</div>
					<div class="form-group">
						<label>Trạng thái đơn hàng</label>
						<select id="orderStatus">
							<option value="Đơn chốt">Đơn chốt (Xác nhận)</option>
							<option value="Đơn nháp">Đơn nháp (Lưu tạm)</option>
						</select>
					</div>
					<button onclick="addToCart()" class="btn-submit"
						style="margin-top: 10px; font-size: 0.95rem; padding: 16px;">
						+ THÊM VÀO ĐƠN HÀNG
					</button>
				</div>
			</div>

			<!-- Right Column: Cart & Summary -->
			<div class="right-col">
				<div class="card" style="position: sticky; top: 100px;">
					<div class="section-title">Đơn Hàng Chi Tiết</div>
					<div id="cartContent">
						<div class="empty-cart">Giỏ hàng đang trống</div>
					</div>

					<div class="summary-area" id="summaryArea" style="display: none; margin-top: 30px;">
						<div class="summary-row">
							<span>Tiền hàng:</span>
							<span id="subtotal" style="font-weight: 700;">0 đ</span>
						</div>
						<div class="summary-row" style="align-items: center;">
							<select id="serviceType" style="width: 140px; padding: 10px; font-size: 0.9rem;"
								onchange="calcTotal()">
								<option value="ship">Phí vận chuyển (+)</option>
								<option value="discount">Chiết khấu (-)</option>
							</select>
							<input type="number" id="serviceFee" value="0" placeholder="0"
								style="width: 140px; text-align: right; color: var(--primary); font-weight: 700;"
								oninput="calcTotal()">
						</div>
						<div class="form-group" style="margin-top: 15px;">
							<label>Ghi chú đơn hàng (nếu có)</label>
							<textarea id="orderNote"
								style="width: 100%; background: var(--glass); border: 1px solid var(--glass-border); border-radius: 12px; color: white; padding: 10px; outline: none; height: 60px;"></textarea>
						</div>
						<div class="summary-row total-row">
							<span>TỔNG CỘNG:</span>
							<span id="grandTotal">0 đ</span>
						</div>

						<button id="btnFinalSubmit" onclick="submitOrder()" class="btn-submit">
							XÁC NHẬN LÊN ĐƠN
						</button>
					</div>
				</div>
			</div>
		</div>
	</div> <!-- End main-content-grid -->
	</div> <!-- End container -->

	<script>
		// Các URL Script chuẩn của bạn
		const KHACH_URL = 'https://script.google.com/macros/s/AKfycbxJ_SMcR1BOrVrZ9Ym0pmhuAa4XbP0ASvYPM5LhQxZLenCLvWy-Nc0jBiv3finAByac/exec';
		const PRODUCT_URL = 'https://script.google.com/macros/s/AKfycbzM8tzbdJJvXE0r6NcP8cJGO2RHsgYUR6Jy73U4NDLkSQRjT3fus_i4lugwVQZIKI8zhw/exec';
		const ORDER_URL = 'https://script.google.com/macros/s/AKfycby6Ys7SwFR4bwRwgqk1wiX17H6ZQzbOPt4UKLK-37OTomvTxZWiYvPSKcNTMyaOSVVH/exec';

		let allProducts = [];
		let allCustomers = [];
		let allExistingOrders = []; // Thêm để lưu đơn cũ phục vụ tạo ID không trùng
		let cart = [];
		let userData = JSON.parse(localStorage.getItem('userLoggedIn') || '{}');

		document.addEventListener('DOMContentLoaded', () => {
			if (!userData.email) window.location.href = 'index.html';
			// Cập nhật thông tin User trên header
			document.getElementById('userName').innerText = userData.email.split('@')[0];
			document.getElementById('userAvatar').innerText = userData.email.charAt(0).toUpperCase();
			loadData();
		});

		async function loadData() {
			try {
				// Tải khách hàng
				const resK = await fetch(`${KHACH_URL}?action=read&username=${encodeURIComponent(userData.email)}`);
				const dataK = await resK.json();
				if (dataK.success) {
					allCustomers = dataK.data;
					const datalist = document.getElementById('custList');
					datalist.innerHTML = allCustomers.map(c => `<option value="${c.tenkhachhang || c.ten_khach_hang}">SĐT: ${c.phone || c.sdt}</option>`).join('');
				}

				// Tải sản phẩm (Hợp nhất Sheet và Legacy JSON)
				const resP = await fetch(`${PRODUCT_URL}?action=read&username=${encodeURIComponent(userData.email)}&t=${new Date().getTime()}`);
				const dataP = await resP.json();

				if (dataP.success) {
					let sheetData = dataP.data || [];
					let legacyData = [];

					if (dataP.legacyData) {
						legacyData = dataP.legacyData.map(item => {
							let normalizedItem = {};
							for (let key in item) {
								let normKey = key.replace(/\s+/g, ''); // Xóa mọi khoảng trắng để chuẩn hóa
								normalizedItem[normKey] = item[key];
							}
							return normalizedItem;
						}).filter(item => {
							const email = item.tendangnhap || item.ten_dang_nhap;
							return email === userData.email;
						});
					}

					// Hợp nhất: Ưu tiên Sheet
					const sheetIds = new Set(sheetData.map(p => String(p.id_san_pham || p.idsanpham || '').trim().toUpperCase()));
					const filteredLegacy = legacyData.filter(p => !sheetIds.has(String(p.id_san_pham || p.idsanpham || '').trim().toUpperCase()));

					// Lọc sản phẩm bị xóa
					allProducts = [...sheetData, ...filteredLegacy].filter(p => {
						const status = String(p.trang_thai_xoa_sp || p.trangthaixoasp || p.trangthaixoa || p.trang_thai_xoa || '').trim().toUpperCase();
						return status !== 'DELETED';
					});

					// Lấy nhóm ngành duy nhất
					const categories = [...new Set(allProducts.map(p =>
						p.ten_nganh_hang || p.ten_nghanh_hang || p.nhom_nganh_hang || p.tennganhhang || p.nhomnganhhang
					).filter(Boolean))];

					const catSelect = document.getElementById('selectCategory');
					categories.forEach(cat => {
						catSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
					});

					// Tải đơn hàng hiện có để tạo ID (lấy cả đơn đã xóa để tránh trùng ID cũ)
					const resO = await fetch(`${ORDER_URL}?action=read_all&username=${encodeURIComponent(userData.email)}`);
					const dataO = await resO.json();
					if (dataO.success) {
						allExistingOrders = dataO.data;
					}
				}
			} catch (e) {
				console.error("Load data error:", e);
			}
		}

		// Tạo ID đơn hàng tự động (D + 3 số, không trùng)
		function generateOrderId() {
			let maxId = 0;
			allExistingOrders.forEach(o => {
				const match = String(o.id_don_hang || o.iddonhang || '').match(/D(\d+)/i);
				if (match) {
					const num = parseInt(match[1]);
					if (num > maxId) maxId = num;
				}
			});
			return 'D' + String(maxId + 1).padStart(3, '0');
		}

		function updateProductList() {
			const cat = document.getElementById('selectCategory').value;
			const prodSelect = document.getElementById('selectProduct');
			prodSelect.innerHTML = '<option value="">-- Chọn sản phẩm --</option>';

			const filtered = allProducts.filter(p => (p.ten_nganh_hang || p.ten_nghanh_hang || p.nhom_nganh_hang || p.tennganhhang || p.nhomnganhhang) === cat);
			filtered.forEach(p => {
				const name = p.ten_san_pham || p.tensanpham;
				const id = p.id_san_pham || p.idsanpham;
				const price = p.gia_san_pham || p.giasanpham || 0;
				prodSelect.innerHTML += `<option value="${id}">${name} (${formatMoney(price)})</option>`;
			});
		}

		function addToCart() {
			const id = document.getElementById('selectProduct').value;
			if (!id) return;

			const p = allProducts.find(x => (x.id_san_pham || x.idsanpham) === id);
			const existing = cart.find(i => i.id === id);

			// Lấy số lượng quy cách đóng gói (ví dụ: "10 tấm/kiện" -> lấy số 10)
			// Lấy số lượng quy cách đóng gói (ví dụ: "10 tấm/kiện" -> lấy số 10)
			const packingStr = String(p.dong_kien || p.dongkien || p.dong_goi || p.donggoi || p.quy_cach_dong_goi || p.quycachdonggoi || '');
			const packingQty = parseFloat(packingStr.match(/\d+/g)?.[0]) || 1;

			if (existing) {
				existing.qty++;
				existing.kients = parseFloat((existing.qty / packingQty).toFixed(2));
			} else {
				cart.push({
					id: id,
					name: p.ten_san_pham || p.tensanpham,
					price: parseFloat(p.gia_san_pham || p.giasanpham) || 0,
					qty: 1,
					category: p.ten_nganh_hang || p.ten_nghanh_hang || p.nhom_nganh_hang || p.tennganhhang || p.nhomnganhhang,
					unit: p.quy_cach || p.quycach || '-',
					packing: packingQty,
					kients: parseFloat((1 / packingQty).toFixed(2)),
					note: ''
				});
			}
			renderCart();
		}

		function renderCart() {
			const content = document.getElementById('cartContent');
			const summary = document.getElementById('summaryArea');

			if (cart.length === 0) {
				content.innerHTML = '<div class="empty-cart">Giỏ hàng đang trống</div>';
				summary.style.display = 'none';
				return;
			}

			summary.style.display = 'block';
			let html = `<table class="cart-table">
                <thead>
                    <tr>
                        <th>Sản phẩm</th>
                        <th style="padding-left: 20px;">Số lượng</th>
                        <th style="text-align: right;">Thành tiền</th>
                        <th style="width: 40px;"></th>
                    </tr>
                </thead>
                <tbody>`;

			cart.forEach((item, index) => {
				html += `
                <tr>
                    <td style="width: 35%;">
                        <div class="item-info">
                            <div class="name" style="color: var(--primary);">${item.name}</div>
                            <div class="sub">${formatMoney(item.price)} - ${item.unit}</div>
                        </div>
                    </td>
                    <td style="width: 30%;">
                        <div class="qty-control" style="padding: 5px 10px; width: 100%;">
                            <input type="number" class="qty-input" value="${item.qty}" step="0.01" 
                                style="width: 100%; font-size: 1.1rem; text-align:center;" onchange="manualQty(${index}, this.value)">
                        </div>
                        <div style="font-size: 0.75rem; color: var(--text-gray); margin-top: 6px; text-align:center;">=${item.kients} kiện</div>
                    </td>
                    <td style="width: 30%;">
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 5px;">
                            <span style="font-weight:800; font-size: 1.1rem; color: #fff;">${formatMoney(item.price * item.qty)}</span>
                            <input type="text" placeholder="Ghi chú kiện..." value="${item.note || ''}" 
                                onchange="updateItemNote(${index}, this.value)"
                                style="width: 100%; font-size: 0.75rem; padding: 6px; border-radius: 8px;">
                        </div>
                    </td>
                    <td style="width: 5%; vertical-align: middle; text-align: center;">
                        <button onclick="removeItem(${index})" 
                            style="background: rgba(255, 82, 82, 0.2); color: var(--error); border: 1px solid var(--error); width: 30px; height: 30px; border-radius: 8px; cursor: pointer; font-weight: 800;">
                            ✕
                        </button>
                    </td>
                </tr>`;
			});

			html += `</tbody></table>`;
			content.innerHTML = html;
			calcTotal();
		}

		function adjustQty(index, delta) {
			cart[index].qty = Math.max(0, parseFloat((cart[index].qty + delta).toFixed(2)));
			if (cart[index].qty === 0) cart.splice(index, 1);
			renderCart();
		}

		function manualQty(index, val) {
			const v = parseFloat(val) || 0;
			if (v <= 0) {
				cart.splice(index, 1);
			} else {
				cart[index].qty = v;
				// Tự động tính lại số kiện khi thay đổi số lượng
				cart[index].kients = parseFloat((v / cart[index].packing).toFixed(2));
			}
			renderCart();
		}

		function updateItemNote(index, val) {
			cart[index].note = val;
		}

		function removeItem(index) {
			cart.splice(index, 1);
			renderCart();
		}

		function calcTotal() {
			const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
			const feeVal = parseFloat(document.getElementById('serviceFee').value) || 0;
			const feeType = document.getElementById('serviceType').value;

			let finalServiceFee = 0;
			if (feeType === 'ship') finalServiceFee = feeVal;
			else finalServiceFee = -feeVal;

			const total = subtotal + finalServiceFee;

			document.getElementById('subtotal').innerText = formatMoney(subtotal);
			document.getElementById('grandTotal').innerText = formatMoney(total);

			return finalServiceFee;
		}

		async function submitOrder() {
			const custName = document.getElementById('custSearch').value;
			if (!custName) { alert("Vui lòng chọn khách hàng!"); return; }
			if (cart.length === 0) { alert("Đơn hàng chưa có sản phẩm!"); return; }

			const btn = document.getElementById('btnFinalSubmit');
			btn.disabled = true;
			btn.innerText = "ĐANG XỬ LÝ...";

			const orderId = generateOrderId();
			const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
			const service = calcTotal(); // Lấy giá trị đã tính toán (âm hoặc dương)
			const status = document.getElementById('orderStatus').value;
			const note = document.getElementById('orderNote').value;

			const payload = {
				action: 'create',
				order: {
					ngay_len_don: new Date().toLocaleString('vi-VN'), // Ngày giờ tự động
					id_don_hang: orderId,
					ten_khach_hang: custName,
					trang_thai_don_hang: status,
					tong_tien_trong_don: subtotal,
					tong_tien_dich_vu: service,
					so_tien_con_lai: subtotal + service, // Tự động cộng/trừ số tiền dịch vụ
					nguoi_len_don: userData.email,
					ghi_chu_don_hang: note,
					trang_thai_xoa: 'ACTIVE'
				},
				items: cart.map(i => ({
					id_don_hang: orderId,
					id_san_pham: i.id,
					ten_san_pham: i.name,
					quy_cach_san_pham: i.unit,
					gia_tien: i.price,
					so_luong: i.qty,
					thanh_tien: i.price * i.qty,
					tinh_kien_trong_don: i.kients, // Kết quả tính toán kiện tự động
					trang_thai_xoa: 'ACTIVE'
				}))
			};

			try {
				if (ORDER_URL.includes('PASTE_YOUR_NEW_ORDER_SCRIPT_URL_HERE')) {
					alert("Bạn chưa dán URL Script Đơn Hàng mới vào mã nguồn!");
					btn.disabled = false;
					btn.innerText = "XÁC NHẬN LÊN ĐƠN";
					return;
				}

				// Sử dụng fetch chuẩn với Content-Type text/plain để vượt qua CORS của GAS
				const response = await fetch(ORDER_URL, {
					method: 'POST',
					body: JSON.stringify(payload)
				});

				// GAS sẽ redirect hoặc trả về kết quả, chúng ta kiểm tra đơn giản
				if (response.ok) {
					alert("Lên đơn hàng thành công!");
					window.location.href = 'danh-sach-don-khach.html';
				} else {
					// Trong một số trường hợp GAS không trả về JSON chuẩn khi POST qua Web, 
					// nhưng nếu đơn đã ghi vào Sheet thì vẫn coi là thành công
					alert("Đã gửi đơn hàng. Vui lòng kiểm tra danh sách!");
					window.location.href = 'danh-sach-don-khach.html';
				}

			} catch (e) {
				console.error("Submit error", e);
				// Fallback nếu gặp lỗi CORS nhưng đơn vẫn có thể đã vào Sheet
				alert("Hệ thống đang xử lý đơn hàng. Vui lòng kiểm tra lại trong danh sách!");
				window.location.href = 'danh-sach-don-khach.html';
			} finally {
				btn.disabled = false;
				btn.innerText = "XÁC NHẬN LÊN ĐƠN";
			}
		}

		function formatMoney(v) { return new Intl.NumberFormat('vi-VN').format(v) + ' đ'; }
	</script>

	<div class="floating-menu">
		<div class="fab-menu-list" id="fabMenu">
			<a href="len-don-khach.html" class="menu-item" style="color: var(--primary);">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M12 5v14M5 12h14" />
				</svg>
				<span>Lên đơn khách hàng</span>
			</a>
			<a href="danh-sach-don-khach.html" class="menu-item">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
					<line x1="3" y1="10" x2="21" y2="10" />
				</svg>
				<span>Danh sách đơn hàng</span>
			</a>
			<a href="san-pham-khach.html" class="menu-item">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<rect x="3" y="3" width="7" height="7" />
					<rect x="14" y="3" width="7" height="7" />
					<rect x="14" y="14" width="7" height="7" />
					<rect x="3" y="14" width="7" height="7" />
				</svg>
				<span>Quản lý sản phẩm</span>
			</a>
			<a href="danh-sach-khach-hang.html" class="menu-item">
				<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
					<circle cx="9" cy="7" r="4" />
				</svg>
				<span>Danh sách khách hàng</span>
			</a>
		</div>
		<button class="fab-btn" onclick="toggleFabMenu()">
			<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
				stroke-linejoin="round">
				<line x1="3" y1="12" x2="21" y2="12"></line>
				<line x1="3" y1="6" x2="21" y2="6"></line>
				<line x1="3" y1="18" x2="21" y2="18"></line>
			</svg>
		</button>
	</div>

	<script>
		function toggleFabMenu() {
			document.getElementById('fabMenu').classList.toggle('active');
		}

		// Đóng menu khi click ra ngoài
		document.addEventListener('click', (e) => {
			const menu = document.getElementById('fabMenu');
			const btn = document.querySelector('.fab-btn');
			if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target) && menu.classList.contains('active')) {
				menu.classList.remove('active');
			}
		});
	</script>
</body>

</html>