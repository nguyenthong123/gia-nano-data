/**
 * GAS SCRIPT QUẢN LÝ KHÁCH HÀNG (BẢN CẬP NHẬT THEO SHEET THỰC TẾ)
 * Spreadsheet ID: 1DQHccnRA6iVlMy5saYN2zCnetU1pVvV91DkZPOHe9g4
 * Sheet: data_khach
 */

const SPREADSHEET_ID = '1DQHccnRA6iVlMy5saYN2zCnetU1pVvV91DkZPOHe9g4';
const SHEET_NAME = 'data_khach';

function doGet(e) {
  try {
    const action = e.parameter.action;
    const username = e.parameter.username;
    if (action === 'read') return readCustomers(username);
    return jsonResponse({success: false, message: 'Invalid action'});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function doPost(e) {
  try {
    const payload = JSON.parse(e.parameter.payload || e.postData.contents);
    const action = payload.action;
    
    if (action === 'create') return createCustomer(payload.data);
    if (action === 'update') return updateCustomer(payload.data, payload.idValue);
    if (action === 'delete') return deleteCustomer(payload.idValue);
    
    return jsonResponse({success: false, message: 'Invalid action'});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function readCustomers(username) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sheet = ss.getSheetByName(SHEET_NAME);
  if (!sheet) return jsonResponse({success: false, message: 'Sheet data_khach không tồn tại'});

  const values = sheet.getDataRange().getValues();
  if (values.length < 2) return jsonResponse({success: true, data: []});
  
  const headers = values[0].map(h => String(h).trim());
  const data = [];
  
  for (let i = 1; i < values.length; i++) {
    let obj = {};
    headers.forEach((h, idx) => {
      obj[h] = values[i][idx];
      // Tạo thêm key chuẩn hóa (không viết hoa, không dấu cách, không gạch dưới)
      const normKey = String(h).toLowerCase().replace(/[\s_]/g, '');
      obj[normKey] = values[i][idx];
    });
    
    // Lọc bỏ những khách hàng đã bị đánh dấu DELETED (hỗ trợ cả key chuẩn hóa)
    if (obj['trangthaixoakhachhang'] === 'DELETED') continue;

    if (!username || obj['tendangnhap'] === username) {
      data.push(obj);
    }
  }
  return jsonResponse({success: true, data: data});
}

function createCustomer(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  const values = sheet.getDataRange().getValues();
  const headers = values[0];
  
  // Tự tạo ID: KH001, KH002... dựa trên cột id_khach_hang (Cột B)
  let maxNum = 0;
  if (values.length > 1) {
    values.slice(1).forEach(r => {
      const match = String(r[1]).match(/KH(\d+)/);
      if (match) maxNum = Math.max(maxNum, parseInt(match[1]));
    });
  }
  const newId = 'KH' + String(maxNum + 1).padStart(3, '0');
  
  // Chuẩn bị data theo đúng thứ tự các cột A-I trong ảnh
  const now = new Date();
  const dateStr = Utilities.formatDate(now, "GMT+7", "HH:mm:ss dd/MM/yyyy");
  
  const mapping = {
    'ngay_tao': dateStr,
    'id_khach_hang': newId,
    'ten_khach_hang': data.ten_khach_hang,
    'phone': data.phone,
    'dia_chi': data.dia_chi,
    'vi_tri': data.vi_tri,
    'ghi_chu': data.ghi_chu,
    'ten_dang_nhap': data.ten_dang_nhap,
    'trang_thai_xoa_khach_hang': 'ACTIVE'
  };
  
  const newRow = headers.map(h => mapping[h] !== undefined ? mapping[h] : '');
  sheet.appendRow(newRow);
  return jsonResponse({success: true, id: newId});
}

function updateCustomer(data, idValue) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  const values = sheet.getDataRange().getValues();
  const headers = values[0];
  
  let rowIndex = -1;
  for (let i = 1; i < values.length; i++) {
    if (String(values[i][1]) === String(idValue)) { // Cột B là id_khach_hang
      rowIndex = i + 1;
      break;
    }
  }
  
  if (rowIndex === -1) return jsonResponse({success: false, message: 'Customer not found'});
  
  // Cập nhật từng cột dựa trên data mới hoặc giữ nguyên data cũ
  headers.forEach((h, idx) => {
    if (data[h] !== undefined) {
      sheet.getRange(rowIndex, idx + 1).setValue(data[h]);
    }
  });
  
  return jsonResponse({success: true});
}

function deleteCustomer(idValue) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  const values = sheet.getDataRange().getValues();
  
  // Tìm cột trang_thai_xoa_khach_hang (thường là cột 9)
  for (let i = 1; i < values.length; i++) {
    if (String(values[i][1]) === String(idValue)) {
      sheet.deleteRow(i + 1);
      return jsonResponse({success: true});
    }
  }
  return jsonResponse({success: false, message: 'Customer not found'});
}

function jsonResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}
