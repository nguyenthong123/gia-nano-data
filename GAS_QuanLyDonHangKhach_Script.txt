/**
 * GAS SCRIPT QUẢN LÝ ĐƠN HÀNG KHÁCH HÀNG
 * Phiên bản: 1.1.0 - Sửa lỗi Syntax và tối ưu đa luồng Dữ liệu
 */

const SPREADSHEET_ID = '1CmH89TjGd5OeSsJ7ioWp4oWyG-ig9fGJq9RFpLhW_5Y';
const LEGACY_ORDER_FILE_ID = '1Bjv-cE-VRxGmrbIX4GAmST2elbqatPPJ';
const LEGACY_DETAIL_FILE_ID = '1dQQJKXz9qHwuxaSS9uW2b2iqkO_nmd6K';
const TONKHO_URL = 'https://script.google.com/macros/s/AKfycbwugXwFGv-z0h8ZU2tTAVyZ7tKt34idUqu6DlxdOV_nXGJf3ES4YGuSn7t0RMa9KJZI/exec';

function doGet(e) {
  try {
    const action = e.parameter.action;
    const username = e.parameter.username;

    if (action === 'read') return readOrders(username, false);
    if (action === 'read_all') return readOrders(username, true);
    if (action === 'get_order_detail') return getOrderDetail(e.parameter.orderId);
    
    return jsonResponse({success: false, message: 'Invalid GET action'});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function doPost(e) {
  try {
    const payload = JSON.parse(e.postData.contents);
    const action = payload.action;

    if (action === 'create') return createOrder(payload);
    if (action === 'delete') return deleteOrder(payload.orderId);
    if (action === 'update') return updateOrder(payload);
    
    return jsonResponse({success: false, message: 'Invalid POST action'});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

/**
 * Tạo đơn hàng mới
 */
function createOrder(payload) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheetDon = ss.getSheetByName('don_hang');
    let sheetChiTiet = ss.getSheetByName('chi_tiet_don_hang');
    
    const order = payload.order;
    const items = payload.items;
    
    const headers = sheetDon.getRange(1, 1, 1, sheetDon.getLastColumn()).getValues()[0];
    const newRow = new Array(headers.length);
    headers.forEach((h, i) => {
      const field = String(h).trim();
      if (order[field] !== undefined) newRow[i] = order[field];
      else if (field === 'trang_thai_xoa') newRow[i] = 'ACTIVE';
      else newRow[i] = '';
    });
    sheetDon.appendRow(newRow);
    
    items.forEach(item => {
      sheetChiTiet.appendRow([
        order.id_don_hang,
        item.id_san_pham,
        item.ten_san_pham || '',
        item.quy_cach_san_pham || '',
        item.gia_tien || 0,
        item.so_luong || 0,
        item.thanh_tien || 0,
        item.tinh_kien_trong_don || 0,
        'ACTIVE'
      ]);
    });
    
    // ĐỒNG BỘ TỒN KHO: Ghi nhận xuất kho nếu đơn ở trạng thái xác nhận
    if (order.trang_thai_don_hang !== 'Đơn nháp' && order.trang_thai_don_hang !== 'Đã hủy') {
      try {
        recordStockOut(order.id_don_hang, items, order.nguoi_len_don, order.ngay_len_don);
      } catch (e) {}
    }

    return jsonResponse({success: true, orderId: order.id_don_hang});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

/**
 * Cập nhật đơn hàng (Bao gồm cả chi tiết sản phẩm)
 */
function updateOrder(payload) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheetDon = ss.getSheetByName('don_hang');
    const sheetChiTiet = ss.getSheetByName('chi_tiet_don_hang');
    
    const orderId = payload.orderId;
    const updateHeader = payload.data; // Object chứa thông tin header
    const updateItems = payload.items; // Array chứa thông tin sản phẩm mới

    // 1. Cập nhật Sheet đơn hàng (Header)
    const dataDon = sheetDon.getDataRange().getValues();
    const headersDon = dataDon[0];
    let rowDonIndex = -1;
    for (let i = 1; i < dataDon.length; i++) {
      if (String(dataDon[i][headersDon.indexOf('id_don_hang')]).trim() === String(orderId).trim()) {
        rowDonIndex = i + 1;
        break;
      }
    }

    if (rowDonIndex !== -1) {
      // Cập nhật dòng hiện có trên Sheet
      headersDon.forEach((h, i) => {
        const field = String(h).trim();
        if (updateHeader[field] !== undefined) {
          sheetDon.getRange(rowDonIndex, i + 1).setValue(updateHeader[field]);
        }
      });
    } else {
      // Chuyển từ JSON sang Sheet (Ghi mới đầy đủ thông tin)
      let legacyData = null;
      if (LEGACY_ORDER_FILE_ID) {
        try {
          const file = DriveApp.getFileById(LEGACY_ORDER_FILE_ID);
          const jsonData = JSON.parse(file.getBlob().getDataAsString());
          legacyData = jsonData.find(o => String(o.id_don_hang || o.ma_don_hang || o.id || '').trim() === String(orderId).trim());
        } catch (e) {}
      }

      const newRowDon = new Array(headersDon.length).fill('');
      headersDon.forEach((h, i) => {
        const field = String(h).trim();
        if (field === 'id_don_hang') {
          newRowDon[i] = orderId;
        } else if (updateHeader[field] !== undefined) {
          newRowDon[i] = updateHeader[field];
        } else if (legacyData && legacyData[field] !== undefined) {
          newRowDon[i] = legacyData[field];
        } else if (legacyData) {
          // Fallback map cho các trường JSON cũ có tên khác
          if (field === 'ngay_len_don') newRowDon[i] = legacyData.ngay_len_don || legacyData.date || '';
          else if (field === 'nguoi_len_don') newRowDon[i] = legacyData.nguoi_len_don || '';
        }
      });
      const idxXoa = headersDon.indexOf('trang_thai_xoa');
      if (idxXoa !== -1) newRowDon[idxXoa] = 'ACTIVE';
      sheetDon.appendRow(newRowDon);
    }

    // 2. Cập nhật Sheet chi tiết sản phẩm (Xóa cũ - Ghi mới)
    const dataCT = sheetChiTiet.getDataRange().getValues();
    for (let i = 1; i < dataCT.length; i++) {
      if (String(dataCT[i][0]).trim() === String(orderId).trim()) {
        sheetChiTiet.getRange(i + 1, 9).setValue('DELETED');
      }
    }

    if (updateItems && updateItems.length > 0) {
      updateItems.forEach(item => {
        sheetChiTiet.appendRow([
          orderId,
          item.id_san_pham || '',
          item.ten_san_pham || '',
          item.quy_cach_san_pham || '',
          item.gia_tien || 0,
          item.so_luong || 0,
          item.thanh_tien || 0,
          item.tinh_kien_trong_don || 0,
          'ACTIVE'
        ]);
      });
    }

    // ĐỒNG BỘ TỒN KHO: Cập nhật xuất kho
    try {
      if (updateHeader.trang_thai_don_hang === 'Đã hủy' || updateHeader.trang_thai_don_hang === 'Đơn nháp') {
        recordStockRemoval(orderId);
      } else {
        recordStockOut(orderId, updateItems, '', ''); // Sẽ ghi đè hoặc tạo mới trong sheet ton_kho
      }
    } catch (e) {}

    return jsonResponse({success: true, message: 'Updated successfully'});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

/**
 * Xóa đơn hàng (Thông minh: Nếu là đơn cũ, lấy đầy đủ dữ liệu từ JSON ghi vào Sheet với trạng thái DELETED)
 */
function deleteOrder(orderId) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheetDon = ss.getSheetByName('don_hang');
    const sheetChiTiet = ss.getSheetByName('chi_tiet_don_hang');
    
    const dataDon = sheetDon.getDataRange().getValues();
    const headersDon = dataDon[0];
    const idxID = headersDon.indexOf('id_don_hang');
    const idxXoa = headersDon.indexOf('trang_thai_xoa');
    
    let foundInSheet = false;
    for (let i = 1; i < dataDon.length; i++) {
       if (String(dataDon[i][idxID]).trim() === String(orderId).trim()) {
          sheetDon.getRange(i + 1, idxXoa + 1).setValue('DELETED');
          foundInSheet = true;
       }
    }
    
    // Nếu đơn cũ chưa có trên sheet, ta phải lấy từ JSON để ghi đầy đủ thông tin
    if (!foundInSheet && LEGACY_ORDER_FILE_ID) {
       try {
         const file = DriveApp.getFileById(LEGACY_ORDER_FILE_ID);
         const jsonData = JSON.parse(file.getBlob().getDataAsString());
         const legacyOrder = jsonData.find(o => String(o.id_don_hang || o.ma_don_hang || o.id || '').trim() === String(orderId).trim());
         
         if (legacyOrder) {
           const newRow = new Array(headersDon.length).fill('');
           headersDon.forEach((h, i) => {
             const field = String(h).trim();
             if (field === 'trang_thai_xoa') newRow[i] = 'DELETED';
             else if (field === 'id_don_hang') newRow[i] = orderId;
             else if (field === 'ten_khach_hang') newRow[i] = legacyOrder.ten_khach_hang || legacyOrder.customer || '';
             else if (field === 'ngay_len_don') newRow[i] = legacyOrder.ngay_len_don || legacyOrder.date || '';
             else if (field === 'trang_thai_don_hang') newRow[i] = 'Đã hủy';
             else if (field === 'tong_tien_trong_don') newRow[i] = legacyOrder.tong_tien_trong_don || 0;
             else if (field === 'tong_tien_dich_vu') newRow[i] = legacyOrder.tong_tien_dich_vu || 0;
             else if (field === 'so_tien_con_lai') newRow[i] = legacyOrder.so_tien_con_lai || 0;
             else if (field === 'nguoi_len_don') newRow[i] = legacyOrder.nguoi_len_don || '';
             else if (field === 'ghi_chu_don_hang') newRow[i] = legacyOrder.ghi_chu_don_hang || '';
           });
           sheetDon.appendRow(newRow);
         }
       } catch (e) {}
    }
    
    // Xử lý chi tiết sản phẩm
    let foundItemsInSheet = false;
    const dataCT = sheetChiTiet.getDataRange().getValues();
    for (let i = 1; i < dataCT.length; i++) {
       if (String(dataCT[i][0]).trim() === String(orderId).trim()) {
          sheetChiTiet.getRange(i + 1, 9).setValue('DELETED');
          foundItemsInSheet = true;
       }
    }
    
    // ĐỒNG BỘ TỒN KHO: Xóa các bản ghi xuất kho liên quan
    try {
      recordStockRemoval(orderId);
    } catch(e) {}

    // Nếu chi tiết đơn cũ chưa có trên sheet, lấy từ JSON ghi vào đầy đủ
    if (!foundItemsInSheet && LEGACY_DETAIL_FILE_ID) {
      try {
        const fileCT = DriveApp.getFileById(LEGACY_DETAIL_FILE_ID);
        const jsonDetail = JSON.parse(fileCT.getBlob().getDataAsString());
        const legacyItems = jsonDetail.filter(i => String(i.id_don_hang || i.ma_don_hang || i.order_id).trim() === String(orderId).trim());
        
        legacyItems.forEach(item => {
          sheetChiTiet.appendRow([
            orderId,
            item.id_san_pham || '',
            item.ten_san_pham || '',
            item.quy_cach_san_pham || '',
            item.gia_tien || 0,
            item.so_luong || 0,
            item.thanh_tien || 0,
            item.tinh_kien_trong_don || 0,
            'DELETED'
          ]);
        });
      } catch (e) {}
    }

    return jsonResponse({success: true, message: 'Deleted and Synced successfully'});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

/**
 * Đọc đơn hàng (Đa nguồn)
 */
function readOrders(username, includeDeleted) {
  try {
    let allOrders = [];
    let deletedIds = new Set();
    let sheetIdList = new Set();

    // 1. Sheet
    try {
      const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
      const sheetDon = ss.getSheetByName('don_hang');
      const data = sheetDon.getDataRange().getValues();
      if (data.length > 1) {
        const headers = data[0];
        const rows = data.slice(1);
        const idxID = headers.indexOf('id_don_hang');
        const idxXoa = headers.indexOf('trang_thai_xoa');
        const idxNguoi = headers.indexOf('nguoi_len_don');

        rows.forEach(r => {
          const oid = String(r[idxID]).trim();
          sheetIdList.add(oid);
          if (r[idxXoa] === 'DELETED') deletedIds.add(oid);
          
          if (includeDeleted || r[idxXoa] !== 'DELETED') {
            if (!username || r[idxNguoi] === username) {
              let obj = {};
              headers.forEach((h, i) => obj[String(h).trim()] = r[i]);
              obj['is_legacy'] = false;
              allOrders.push(obj);
            }
          }
        });
      }
    } catch (e) {}

    // 2. JSON
    if (LEGACY_ORDER_FILE_ID) {
      try {
        const file = DriveApp.getFileById(LEGACY_ORDER_FILE_ID);
        const jsonData = JSON.parse(file.getBlob().getDataAsString());
        jsonData.forEach(o => {
          const oid = String(o.id_don_hang || o.ma_don_hang || o.id || '').trim();
          if (deletedIds.has(oid) || sheetIdList.has(oid)) return;
          
          if (!username || (o.nguoi_len_don || '').includes(username.split('@')[0])) {
            allOrders.push({
              ngay_len_don: o.ngay_len_don || '',
              id_don_hang: oid,
              ten_khach_hang: o.ten_khach_hang || '',
              trang_thai_don_hang: o.trang_thai_don_hang || 'Hoàn thành',
              tong_tien_trong_don: parseFloat(o.tong_tien_trong_don || 0),
              tong_tien_dich_vu: parseFloat(o.tong_tien_dich_vu || 0),
              so_tien_con_lai: parseFloat(o.so_tien_con_lai || 0),
              nguoi_len_don: o.nguoi_len_don || '',
              ghi_chu_don_hang: o.ghi_chu_don_hang || '',
              is_legacy: true
            });
          }
        });
      } catch (e) {}
    }
    return jsonResponse({success: true, data: allOrders});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

/**
 * Chi tiết đơn hàng
 */
function getOrderDetail(orderId) {
  try {
    let items = [];
    let foundInSheet = false;
    try {
      const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
      const sheetCT = ss.getSheetByName('chi_tiet_don_hang');
      const data = sheetCT.getDataRange().getValues();
      const headers = data[0];
      for (let i = 1; i < data.length; i++) {
        if (String(data[i][0]).trim() === String(orderId).trim() && data[i][8] !== 'DELETED') {
          let obj = {};
          headers.forEach((h, idx) => obj[String(h).trim()] = data[i][idx]);
          items.push(obj);
          foundInSheet = true;
        }
      }
    } catch (e) {}

    if (!foundInSheet && LEGACY_DETAIL_FILE_ID) {
      try {
        const file = DriveApp.getFileById(LEGACY_DETAIL_FILE_ID);
        const jsonData = JSON.parse(file.getBlob().getDataAsString());
        items = jsonData.filter(i => String(i.id_don_hang || i.ma_don_hang || i.order_id).trim() === String(orderId).trim());
      } catch (e) {}
    }
    return jsonResponse({success: true, data: items});
  } catch (err) {
    return jsonResponse({success: false, message: err.toString()});
  }
}

function jsonResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj)).setMimeType(ContentService.MimeType.JSON);
}

/**
 * Các hàm hỗ trợ đồng bộ Tồn Kho
 */
function recordStockOut(orderId, items, mail, date) {
  // Vì GAS không thể fetch chính mình một cách dễ dàng qua URL nếu chưa deploy, 
  // ta nên mở trực tiếp Spreadsheet Tồn kho để ghi
  const TONKHO_SS_ID = '14fUCqVn-5sZ1xwPY0D5dXs-guz7phl5R9gguSajMnSs';
  const ss = SpreadsheetApp.openById(TONKHO_SS_ID);
  const sheet = ss.getSheetByName('ton_kho') || ss.insertSheet('ton_kho');
  
  // Xóa sạch các bản ghi xuất cũ của đơn này để ghi lại (tránh trùng khi update đơn)
  const data = sheet.getDataRange().getValues();
  for (let i = data.length - 1; i >= 1; i--) {
    if (String(data[i][1]).trim() === String(orderId).trim() && (parseFloat(data[i][5]) > 0)) {
      sheet.deleteRow(i + 1);
    }
  }
  
  // Ghi mới
  items.forEach(item => {
    sheet.appendRow([
      date || new Date().toLocaleString('vi-VN'),
      orderId,
      item.id_san_pham,
      item.ten_san_pham,
      0, // Nhập
      item.so_luong || 0, // Xuất
      0, // Còn lại (tính sau)
      mail || '',
      'ACTIVE'
    ]);
  });
}

function recordStockRemoval(orderId) {
  const TONKHO_SS_ID = '14fUCqVn-5sZ1xwPY0D5dXs-guz7phl5R9gguSajMnSs';
  const ss = SpreadsheetApp.openById(TONKHO_SS_ID);
  const sheet = ss.getSheetByName('ton_kho');
  if (!sheet) return;
  
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][1]).trim() === String(orderId).trim()) {
      sheet.getRange(i + 1, 9).setValue('DELETED');
    }
  }
}
