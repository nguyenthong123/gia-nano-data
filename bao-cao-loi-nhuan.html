<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>B√°o C√°o L·ª£i Nhu·∫≠n | Dunvex Digital</title>
	<link rel="icon" type="image/svg+xml"
		href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23FACC15'/><text x='50%' y='50%' dominant-baseline='central' text-anchor='middle' fill='white' font-size='60' font-family='sans-serif' font-weight='800'>DV</text></svg>">
	<link
		href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@600;800&display=swap"
		rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="security-utils.js"></script>
	<script src="assets/theme-toggle.js"></script>
	<script>
		const session = SecurityProvider.validateAccess();
		const currentUser = session ? session.user : null;
	</script>
	<link rel="stylesheet" href="assets/theme.css">
	<style>
		.price-missing {
			color: var(--warning) !important;
			text-decoration: underline dotted;
			cursor: help;
		}

		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			font-family: 'Inter', sans-serif;
		}

		body {
			min-height: 100vh;
			padding: 20px;
		}

		.container {
			max-width: 1400px;
			margin: 0 auto;
		}

		.header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
			padding: 20px;
			background: var(--card-bg);
			backdrop-filter: blur(20px);
			border: 1px solid var(--glass-border);
			border-radius: 24px;
		}

		.header h1 {
			font-family: 'Outfit', sans-serif;
			font-size: 1.8rem;
			font-weight: 800;
			color: #0f172a;
		}

		.tabs-container {
			display: flex;
			gap: 10px;
			margin-bottom: 25px;
			background: var(--card-bg);
			padding: 5px;
			border-radius: 16px;
			width: fit-content;
			border: 1px solid var(--glass-border);
		}

		.tab-btn {
			padding: 12px 24px;
			border: none;
			background: transparent;
			color: var(--text-muted);
			font-weight: 600;
			cursor: pointer;
			border-radius: 12px;
			transition: 0.3s;
		}

		.tab-btn.active {
			background: var(--primary);
			color: #0f172a;
			box-shadow: 0 4px 12px rgba(250, 204, 21, 0.3);
		}

		.filter-section {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
			margin-bottom: 25px;
		}

		.filter-group {
			background: var(--card-bg);
			border: 1px solid var(--glass-border);
			padding: 15px;
			border-radius: 16px;
		}

		.filter-group label {
			display: block;
			font-size: 0.75rem;
			color: #475569;
			text-transform: uppercase;
			margin-bottom: 8px;
			font-weight: 800;
		}

		input {
			width: 100%;
			padding: 12px;
			background: white !important;
			border: 1.5px solid #cbd5e1 !important;
			border-radius: 12px;
			color: #0f172a !important;
			outline: none;
			font-weight: 600;
		}

		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 20px;
			margin-bottom: 25px;
		}

		.stat-card {
			background: white;
			border: 1px solid #e2e8f0;
			padding: 25px;
			border-radius: 24px;
			text-align: center;
			transition: 0.3s;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
		}

		.stat-card:hover {
			transform: translateY(-5px);
			border-color: var(--primary);
		}

		.stat-value {
			font-size: 2rem;
			font-weight: 800;
			color: var(--primary);
			margin: 10px 0;
		}

		.stat-label {
			font-size: 0.85rem;
			color: var(--text-muted);
			text-transform: uppercase;
			letter-spacing: 1px;
		}

		.content-card {
			background: white;
			border: 1px solid #e2e8f0;
			border-radius: 24px;
			padding: 25px;
			overflow: hidden;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
		}

		table {
			width: 100%;
			border-collapse: collapse;
		}

		th {
			text-align: left;
			padding: 15px;
			color: #64748b;
			font-size: 0.85rem;
			border-bottom: 2px solid #f1f5f9;
			text-transform: uppercase;
			font-weight: 800;
		}

		td {
			padding: 15px;
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
			font-size: 0.95rem;
		}

		tr:hover {
			background: rgba(255, 255, 255, 0.02);
		}

		.profit-pos {
			color: var(--primary);
			font-weight: 700;
		}

		.profit-neg {
			color: var(--danger);
			font-weight: 700;
		}

		.btn {
			padding: 12px 20px;
			border-radius: 12px;
			border: none;
			cursor: pointer;
			font-weight: 600;
			transition: 0.3s;
		}

		.btn-primary {
			background: var(--primary);
			color: white;
		}

		.btn-primary:hover {
			background: var(--primary-dark);
			transform: scale(1.02);
		}

		.chart-grid {
			display: grid;
			grid-template-columns: 2fr 1fr;
			gap: 20px;
		}

		.chart-box {
			background: white;
			border: 1px solid #e2e8f0;
			border-radius: 24px;
			padding: 20px;
			box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
		}

		#loading {
			position: fixed;
			inset: 0;
			background: rgba(15, 23, 42, 0.8);
			display: flex;
			justify-content: center;
			align-items: center;
			z-index: 1000;
		}

		.spinner {
			width: 50px;
			height: 50px;
			border: 5px solid var(--glass-border);
			border-top-color: var(--primary);
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			to {
				transform: rotate(360deg);
			}
		}

		@media (max-width: 1024px) {
			.stats-grid {
				grid-template-columns: repeat(2, 1fr);
			}

			.chart-grid {
				grid-template-columns: 1fr;
			}
		}

		@media (max-width: 768px) {
			body {
				padding: 10px;
			}

			.header {
				flex-direction: column;
				text-align: center;
				gap: 15px;
				padding: 20px 15px;
			}

			.header h1 {
				font-size: 1.5rem;
			}

			.tabs-container {
				width: 100%;
			}

			.tab-btn {
				flex: 1;
				padding: 10px 12px;
				font-size: 0.85rem;
			}

			.stats-grid {
				grid-template-columns: 1fr;
				gap: 15px;
			}

			.stat-card {
				padding: 20px;
			}

			.stat-value {
				font-size: 1.6rem;
			}

			.filter-section {
				grid-template-columns: 1fr;
			}

			/* Table Mobile Optimization: Card View */
			table thead {
				display: none;
			}

			table,
			tbody,
			tr,
			td {
				display: block;
				width: 100%;
			}

			tr {
				margin-bottom: 20px;
				background: rgba(255, 255, 255, 0.03);
				border-radius: 16px;
				padding: 15px;
				border: 1px solid var(--glass-border);
			}

			td {
				text-align: right;
				padding: 8px 0;
				border-bottom: 1px solid rgba(255, 255, 255, 0.05);
				display: flex;
				justify-content: space-between;
				align-items: center;
				font-size: 0.9rem;
			}

			td:last-child {
				border-bottom: none;
			}

			td::before {
				content: attr(data-label);
				float: left;
				font-weight: 700;
				color: var(--text-muted);
				text-transform: uppercase;
				font-size: 0.7rem;
				letter-spacing: 0.5px;
			}

			.content-card {
				padding: 15px;
				background: transparent;
				border: none;
			}

			.chart-box {
				padding: 15px;
			}

			.alert-banner {
				flex-direction: column;
				gap: 12px;
				text-align: center;
			}

			.alert-banner a {
				width: 100%;
				text-align: center;
			}
		}

		@media (max-width: 480px) {
			.stat-value {
				font-size: 1.4rem;
			}

			.btn {
				width: 100%;
				padding: 10px;
			}

			.header div[style*="display: flex"] {
				flex-direction: column;
				width: 100%;
			}
		}
	</style>
</head>

<body>

	<div id="loading">
		<div class="spinner"></div>
	</div>

	<div class="container">
		<div class="header">
			<div>
				<h1>üìä PH√ÇN T√çCH L·ª¢I NHU·∫¨N</h1>
				<p style="color: var(--text-muted); font-size: 0.9rem;" id="userDisplay">Dunvex Digital Management</p>
			</div>
			<div style="display: flex; gap: 10px;">
				<button class="btn btn-primary" onclick="loadReport()">L√ÄM M·ªöI D·ªÆ LI·ªÜU</button>
				<a href="index.html" class="btn btn-glass">
					<i class="fa-solid fa-house"></i> Trang ch·ªß
				</a>
			</div>
		</div>

		<div class="tabs-container">
			<button class="tab-btn active" onclick="switchTab('data', this)">B·∫¢NG D·ªÆ LI·ªÜU</button>
			<button class="tab-btn" onclick="switchTab('analysis', this)">PH√ÇN T√çCH BI·ªÇU ƒê·ªí</button>
		</div>

		<div class="filter-section">
			<div class="filter-group">
				<label>T·ª´ ng√†y</label>
				<input type="date" id="startDate">
			</div>
			<div class="filter-group">
				<label>ƒê·∫øn ng√†y</label>
				<input type="date" id="endDate">
			</div>
			<div class="filter-group">
				<label>T√¨m ki·∫øm th√¥ng minh</label>
				<input type="text" id="searchInput" placeholder="T√¨m ƒë∆°n h√†ng, s·∫£n ph·∫©m, nh√¢n vi√™n..."
					oninput="handleSearch()">
			</div>
		</div>

		<div class="stats-grid">
			<div class="stat-card">
				<div class="stat-label">T·ªïng L·ª£i Nhu·∫≠n</div>
				<div class="stat-value" id="totalProfit">0 ƒë</div>
				<div style="font-size: 0.75rem; color: var(--success);">‚Üë T·ª∑ l·ªá sinh l·ªùi g·ªôp</div>
			</div>
			<div class="stat-card">
				<div class="stat-label">S·ªë ƒê∆°n H√†ng Ch·ªët</div>
				<div class="stat-value" id="totalOrders">0</div>
				<div style="font-size: 0.75rem; color: var(--text-muted);">Ho√†n t·∫•t giao d·ªãch</div>
			</div>
			<div class="stat-card">
				<div class="stat-label">S·∫£n Ph·∫©m Top 1</div>
				<div class="stat-value" id="topProduct"
					style="font-size: 1.2rem; color: var(--accent); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
					-</div>
				<div style="font-size: 0.75rem; color: var(--text-muted);">ƒê√≥ng g√≥p l·ª£i nhu·∫≠n cao nh·∫•t</div>
			</div>
		</div>

		<!-- TAB CONTENT: DATA -->
		<!-- Quick Alert for Missing Prices -->
		<div id="priceAlert" class="alert-banner"
			style="display: none; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 12px; padding: 12px 20px; color: var(--warning); margin-bottom: 25px; align-items: center; justify-content: space-between;">
			<div style="display: flex; align-items: center; gap: 10px;">
				<span>‚ö†Ô∏è</span>
				<span style="font-size: 0.85rem; font-weight: 500;">Ph√°t hi·ªán s·∫£n ph·∫©m ch∆∞a c√≥ gi√° mua! D·ª± ki·∫øn l·ª£i
					nhu·∫≠n c√≥
					th·ªÉ b·ªã sai l·ªách.</span>
			</div>
			<a href="quan-ly-san-pham.html"
				style="font-size: 0.8rem; font-weight: 700; color: white; background: var(--warning); padding: 5px 12px; border-radius: 8px; text-decoration: none;">C·∫≠p
				nh·∫≠t ngay</a>
		</div>

		<div id="tabData" class="content-card">
			<div style="overflow-x: auto;">
				<table>
					<thead>
						<tr>
							<th>Ng√†y l√™n ƒë∆°n</th>
							<th>M√£ ƒë∆°n</th>
							<th>T√™n s·∫£n ph·∫©m</th>
							<th>S·ªë l∆∞·ª£ng</th>
							<th>Gi√° s·ªâ</th>
							<th>Gi√° b√°n</th>
							<th>L·ª£i nhu·∫≠n</th>
							<th>Nh√¢n vi√™n</th>
						</tr>
					</thead>
					<tbody id="reportTableBody">
						<!-- Data rows -->
					</tbody>
				</table>
			</div>
		</div>

		<!-- TAB CONTENT: ANALYSIS -->
		<div id="tabAnalysis" class="chart-grid" style="display: none;">
			<div class="chart-box">
				<div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
					<h3 style="font-family: Outfit;">L·ª£i nhu·∫≠n theo th·ªùi gian</h3>
					<select id="timeRange" style="width: auto; padding: 5px 10px;" onchange="updateTimeChart()">
						<option value="day">Theo Ng√†y</option>
						<option value="month">Theo Th√°ng</option>
						<option value="year">Theo NƒÉm</option>
					</select>
				</div>
				<canvas id="timeChart"></canvas>
			</div>
			<div style="display: flex; flex-direction: column; gap: 20px;">
				<div class="chart-box">
					<h3 style="margin-bottom: 20px; font-family: Outfit;">Top 5 S·∫£n Ph·∫©m</h3>
					<canvas id="productChart"></canvas>
				</div>
				<div class="chart-box">
					<h3 style="margin-bottom: 20px; font-family: Outfit;">Top 5 Nh√¢n Vi√™n</h3>
					<canvas id="staffChart"></canvas>
				</div>
			</div>
		</div>
	</div>

	<script>
		const API_URL = 'https://script.google.com/macros/s/AKfycbz356EtCf6FN7yXSOC6qLJ6f2Do8yYY_iuypN3TZtKFVNSmt1PIsoo3EXIGToE4tm5w1A/exec';


		let reportRawData = [];
		let summaryData = {};
		// currentUser defined in head
		document.getElementById('userDisplay').innerText = `T·ªï ch·ª©c: ${currentUser.adminEmail || currentUser.email}`;

		// Set default dates (current month)
		const now = new Date();
		const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
		const lastDay = new Date().toISOString().split('T')[0];
		document.getElementById('startDate').value = firstDay;
		document.getElementById('endDate').value = lastDay;

		async function loadReport() {
			document.getElementById('loading').style.display = 'flex';
			const startDate = document.getElementById('startDate').value;
			const endDate = document.getElementById('endDate').value;

			try {
				// Using the profit script URL
				// NOTE: In production, the user would deploy GAS_Profit_Script.txt as a Web App
				const SCRIPT_PROFIT_URL = 'https://script.google.com/macros/s/AKfycbyyP5qFv-s34oV0JvP9C63_498l3_93_49L9V9V9V/exec'; // Placeholder

				// For demonstration, let's assume we use the main script router if integrated, 
				// but usually these are separate Web Apps.

				const res = await fetch(API_URL, {
					method: 'POST',
					body: SecurityProvider.prepareRequest('get_profit_report', {
						userEmail: currentUser.email,
						isAdmin: currentUser.roleId === 'R001',
						adminEmail: currentUser.adminEmail,
						startDate,
						endDate
					})
				});

				const result = await res.json();
				if (result.success) {
					reportRawData = result.data;
					summaryData = result.summary;
					renderAll();
				} else {
					alert('L·ªói: ' + result.message);
				}
			} catch (e) {
				console.error(e);
			} finally {
				document.getElementById('loading').style.display = 'none';
			}
		}

		function renderAll() {
			renderTable(reportRawData);
			renderStats();
			initCharts();
		}

		function renderTable(data) {
			const tbody = document.getElementById('reportTableBody');
			tbody.innerHTML = data.map(r => `
                <tr>
                    <td data-label="Th·ªùi gian" style="color: var(--text-muted); font-size: 0.8rem;">${r.date}</td>
                    <td data-label="M√£ ƒë∆°n" style="font-weight: 600;">${r.orderId}</td>
                    <td data-label="S·∫£n ph·∫©m" title="${r.productName}">${r.productName}</td>
                    <td data-label="SL" style="text-align: center;">${r.quantity}</td>
                    <td data-label="Gi√° s·ªâ" class="${r.buyPrice === 0 ? 'price-missing' : ''}" title="${r.buyPrice === 0 ? 'Ch∆∞a c·∫≠p nh·∫≠t gi√° mua! L·ª£i nhu·∫≠n c√≥ th·ªÉ kh√¥ng ch√≠nh x√°c.' : ''}">
                        ${formatPrice(r.buyPrice)}
                    </td>
                    <td data-label="Gi√° b√°n" style="font-weight: 500;">${formatPrice(r.sellPrice)}</td>
                    <td data-label="L·ª£i nhu·∫≠n" class="${r.profit >= 0 ? 'profit-pos' : 'profit-neg'}">${formatPrice(r.profit)}</td>
                    <td data-label="Nh√¢n vi√™n" style="font-size: 0.85rem;">${r.creator.split('@')[0]}</td>
                </tr>
            `).join('');
		}

		function renderStats() {
			document.getElementById('totalProfit').innerText = formatPrice(summaryData.totalProfit) + ' ƒë';
			const uniqueOrders = new Set(reportRawData.map(r => r.orderId)).size;
			document.getElementById('totalOrders').innerText = uniqueOrders;

			// Top Product
			const products = summaryData.byProduct || {};
			let topP = "-";
			let maxProfit = -Infinity;
			for (let p in products) {
				if (products[p] > maxProfit) {
					maxProfit = products[p];
					topP = p;
				}
			}
			document.getElementById('topProduct').innerText = topP;

			// Handle Missing Price Alert
			const missingCount = reportRawData.filter(r => r.buyPrice === 0).length;
			const alertBanner = document.getElementById('priceAlert');
			if (missingCount > 0) {
				alertBanner.style.display = 'flex';
			} else {
				alertBanner.style.display = 'none';
			}
		}

		function handleSearch() {
			const q = document.getElementById('searchInput').value.toLowerCase();
			const filtered = reportRawData.filter(r =>
				r.orderId.toLowerCase().includes(q) ||
				r.productName.toLowerCase().includes(q) ||
				r.creator.toLowerCase().includes(q)
			);
			renderTable(filtered);
		}

		function formatPrice(n) {
			return Math.round(n).toLocaleString('vi-VN');
		}

		function switchTab(tab, btn) {
			document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
			btn.classList.add('active');

			document.getElementById('tabData').style.display = tab === 'data' ? 'block' : 'none';
			document.getElementById('tabAnalysis').style.display = tab === 'analysis' ? 'grid' : 'none';
		}

		// CHARTS LOGIC
		let timeChart, productChart, staffChart;

		function initCharts() {
			// Cleanup old charts
			if (timeChart) timeChart.destroy();
			if (productChart) productChart.destroy();
			if (staffChart) staffChart.destroy();

			const ctxTime = document.getElementById('timeChart').getContext('2d');
			const mode = document.getElementById('timeRange').value;

			// Aggregate data by selected mode
			const aggregated = {};
			reportRawData.forEach(r => {
				// Handle format: "HH:mm:ss dd/MM/yyyy" or "dd/MM/yyyy"
				let datePart = r.date;
				if (datePart.includes(' ')) {
					const parts = datePart.split(' ');
					// Find the part that looks like a date (has slashes)
					datePart = parts.find(p => p.includes('/')) || parts[0];
				}

				const [d, m, y] = datePart.split('/');
				let key = datePart;

				if (mode === 'month') key = `${m}/${y}`;
				if (mode === 'year') key = y;

				if (m && y) { // Only add if date is valid
					aggregated[key] = (aggregated[key] || 0) + r.profit;
				}
			});

			const labels = Object.keys(aggregated).sort((a, b) => {
				if (mode === 'day') {
					const [d1, m1, y1] = a.split('/');
					const [d2, m2, y2] = b.split('/');
					return new Date(y1, m1 - 1, d1) - new Date(y2, m2 - 1, d2);
				} else if (mode === 'month') {
					const [m1, y1] = a.split('/');
					const [m2, y2] = b.split('/');
					return new Date(y1, m1 - 1) - new Date(y2, m2 - 1);
				}
				return parseInt(a) - parseInt(b);
			});

			timeChart = new Chart(ctxTime, {
				type: 'bar',
				data: {
					labels: labels,
					datasets: [{
						label: 'L·ª£i Nhu·∫≠n',
						data: labels.map(l => aggregated[l]),
						backgroundColor: 'rgba(99, 102, 241, 0.7)',
						borderColor: '#6366f1',
						borderWidth: 1,
						borderRadius: 6,
						barPercentage: 0.6
					}]
				},
				options: {
					responsive: true,
					plugins: {
						legend: { display: false },
						tooltip: {
							callbacks: {
								label: (ctx) => `L·ª£i nhu·∫≠n: ${formatPrice(ctx.raw)} ƒë`
							}
						}
					},
					scales: {
						y: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(255,255,255,0.05)' } },
						x: { ticks: { color: '#cbd5e1' }, grid: { display: false } }
					}
				}
			});

			// Product Chart
			const ctxProd = document.getElementById('productChart').getContext('2d');
			const topProducts = Object.entries(summaryData.byProduct)
				.sort((a, b) => b[1] - a[1])
				.slice(0, 5);

			productChart = new Chart(ctxProd, {
				type: 'doughnut',
				data: {
					labels: topProducts.map(p => p[0]),
					datasets: [{
						data: topProducts.map(p => p[1]),
						backgroundColor: ['#6366f1', '#c084fc', '#22c55e', '#f59e0b', '#ef4444']
					}]
				},
				options: {
					responsive: true,
					plugins: { legend: { position: 'bottom', labels: { color: '#cbd5e1', font: { size: 10 } } } }
				}
			});

			// Staff Chart
			const ctxStaff = document.getElementById('staffChart').getContext('2d');
			const topStaff = Object.entries(summaryData.byStaff)
				.sort((a, b) => b[1] - a[1])
				.slice(0, 5);

			staffChart = new Chart(ctxStaff, {
				type: 'bar',
				data: {
					labels: topStaff.map(s => s[0].split('@')[0]),
					datasets: [{
						label: 'L·ª£i Nhu·∫≠n Ghi Nh·∫≠n',
						data: topStaff.map(s => s[1]),
						backgroundColor: 'rgba(192, 132, 252, 0.5)',
						borderColor: '#c084fc',
						borderWidth: 1
					}]
				},
				options: {
					indexAxis: 'y',
					responsive: true,
					plugins: { legend: { display: false } },
					scales: {
						x: { ticks: { color: '#cbd5e1' }, grid: { display: false } },
						y: { ticks: { color: '#cbd5e1' }, grid: { display: false } }
					}
				}
			});
		}

		function updateTimeChart() {
			// Just re-initialize the chart with the new range mode
			initCharts();
		}

		window.onload = loadReport;
	</script>
</body>

</html>